id,title,spec
C01-01,"Add REST bootstrap regression test","Create an integration test that validates REST routes are registered after normal plugin bootstrap (no manual controller instantiation). Steps: (1) In `tests/integration/`, add a new test (or update `tests/integration/RestApiTest.php`) that sets a fresh `WP_REST_Server`, runs `do_action('rest_api_init')`, and asserts routes include `/wpha/v1/dashboard/stats` and at least one other controller route (e.g. `/wpha/v1/media/scan`). (2) Ensure the test uses the plugin’s real load path (`wp-admin-health-suite.php` via `tests/bootstrap.php`). Acceptance: test should fail on current code (deferred REST provider never boots) and pass once Phase 1 bootstrap is implemented."
C01-02,"Add Integrations bootstrap regression test","Create an integration test proving integrations are initialized deterministically and can affect runtime behavior. Steps: (1) Add a test-only integration class under `tests/` (e.g. `tests/Mocks/TestIntegration.php`) implementing `WPAdminHealth\\Contracts\\IntegrationInterface` (or extending `includes/Integrations/AbstractIntegration` if convenient). (2) In the test, register it via `add_action('wpha_register_integrations', fn($manager) => $manager->register(new TestIntegration(...)))`. (3) Ensure integration init runs via the normal bootstrap path, then assert `apply_filters('wpha_media_is_attachment_used', false, 123)` becomes `true` (or assert the filter is attached). Acceptance: fails on current code (deferred IntegrationServiceProvider never boots) and passes after Phase 1."
C01-03,"Introduce always-loaded bootstrap hooks provider","Add a non-deferred provider responsible for registering WordPress hooks that must always exist. Steps: (1) Create `includes/Providers/BootstrapHooksServiceProvider.php` (or extend `includes/Providers/BootstrapServiceProvider.php`) to register hook-registrar services and call their `register()` methods in `boot()`. (2) Update `includes/Plugin.php` provider list to include this provider early enough that hooks are attached reliably. (3) Update provider contract tests (`tests/unit-standalone/Providers/ProviderContractTest.php`) to include/validate the new provider bindings. Acceptance: provider boots every request and attaches REST + integrations bootstrap hooks without eagerly instantiating heavy services."
C01-04,"Move REST route hook registration out of deferred provider","Fix REST route registration so it does not depend on `RESTServiceProvider::boot()`. Steps: (1) Create a hook registrar like `includes/Bootstrap/RestRoutesRegistrar.php` that adds `rest_api_init` and, on that hook, resolves controllers from the container and calls `register_routes()`. (2) Ensure resolving controllers triggers deferred provider registration as needed (by requesting controller class-strings). (3) Update `includes/Providers/RESTServiceProvider.php` so `boot()` is empty or removed; keep it as bindings-only and still deferred. Acceptance: `do_action('rest_api_init')` registers routes under normal plugin boot; `C01-01` passes."
C01-05,"Move integrations initialization out of deferred provider","Fix integration initialization so it does not depend on `IntegrationServiceProvider::boot()`. Steps: (1) Create a hook registrar like `includes/Bootstrap/IntegrationsRegistrar.php` that adds `plugins_loaded` (priority >= 20) and calls `$container->get(IntegrationManager::class)->discover()->init()`; ensure idempotency. (2) Register this registrar via the always-loaded bootstrap hooks provider. Acceptance: integrations initialize during normal boot and `C01-02` passes."
C01-06,"Refactor IntegrationServiceProvider to bindings-only","Update `includes/Providers/IntegrationServiceProvider.php` to be a clean deferred bindings provider: remove `boot()` and any hook registration, leaving only service bindings for the factory/manager and built-in integrations. Acceptance: integrations still initialize because bootstrap registrar triggers them; provider remains deferred and safe."
C01-07,"Phase 1 verification + docs updates","Verify Phase 1 end-to-end and update docs. Steps: (1) Run `composer test` and ensure REST/integration tests pass without manual controller instantiation. (2) Run `composer test:standalone` to ensure container/provider wiring remains correct. (3) Update documentation (at least `ARCHITECTURE_IMPROVEMENT_PLAN.md` and/or relevant `docs/*`) to reflect the new bootstrap mechanism (REST + integrations). Acceptance: tests green and docs match behavior."
C02-01,"Add ApplicationServiceProvider for use-cases","Introduce a non-deferred `includes/Providers/ApplicationServiceProvider.php` to bind application-layer use-cases so they are available for REST, cron, and admin actions without depending on the deferred REST provider. Include bindings for: `Application\\AI\\GenerateRecommendations`, `Application\\Media\\ProcessDuplicates`, `Application\\Performance\\CollectMetrics`, and consider moving existing use-cases (`RunScan`, `RunCleanup`, `RunOptimization`, `RunHealthCheck`) into this provider for single-authority wiring. Update `includes/Plugin.php` provider list and provider contract tests accordingly."
C02-02,"Implement GenerateRecommendations use-case","Implement `includes/Application/AI/GenerateRecommendations.php`. Requirements: constructor inject `WPAdminHealth\\AI\\Recommendations` (and optionally Settings/Cache if needed); implement `execute(array $options): array` supporting at minimum `force_refresh` and returning a stable schema (e.g., `{success, data:{recommendations:[]}, message}`). Add standalone/unit tests covering: (1) force refresh toggling, (2) output schema stability, (3) graceful handling when dependencies return empty."
C02-03,"Expose AI recommendations via REST","Add a REST endpoint for AI recommendations using the new use-case. Options: (A) new controller `includes/REST/RecommendationsController.php` with `rest_base = 'recommendations'`, or (B) add a `/dashboard/recommendations` route on `DashboardController`. Controller should depend only on Settings/Connection (if needed) + `GenerateRecommendations` use-case. Update route registration and add an integration test asserting `GET /wpha/v1/...` returns `{success:true,data:{recommendations:[...]}}` for an admin with nonce."
C02-04,"Implement ProcessDuplicates use-case","Implement `includes/Application/Media/ProcessDuplicates.php`. Requirements: inject `DuplicateDetectorInterface`, `ReferenceFinderInterface`, `SafeDeleteInterface`, `ExclusionsInterface`, and optional `ActivityLoggerInterface`; support `safe_mode`/`dry_run` options; return a stable schema with counts, byte estimates, and errors. Add tests using existing mocks for: duplicates found, preview-only behavior, and exclusion handling."
C02-05,"Implement CollectMetrics use-case","Implement `includes/Application/Performance/CollectMetrics.php`. Requirements: inject `AutoloadAnalyzerInterface`, `QueryMonitorInterface`, `PluginProfilerInterface`, `CacheChecker`, `SettingsInterface`, and optional `ActivityLoggerInterface`; return a stable schema that can power the performance UI and scheduled tasks (autoload stats, slow query summaries, plugin timing summaries, cache environment). Add tests verifying schema and safe-mode behavior where relevant."
C02-06,"Refactor REST controllers to use application layer consistently","Refactor REST controllers that currently orchestrate multiple domain services directly to depend on application-layer use-cases (where it reduces coupling). Target controllers: `includes/REST/Performance/QueryAnalysisController.php`, `includes/REST/Performance/PluginProfilerController.php`, `includes/REST/Performance/AutoloadController.php`, `includes/REST/Performance/CacheController.php`, and any dashboard recommendations path. Acceptance: controllers become thin (validation + call use-case + format_response), and response shapes remain backward compatible for the JS UI."
C02-07,"Align scheduled tasks with application layer","Refactor scheduled task implementations (`includes/Database/Tasks/DatabaseCleanupTask.php`, `includes/Media/Tasks/MediaScanTask.php`, `includes/Performance/Tasks/PerformanceCheckTask.php`) to call the same use-cases used by REST (e.g., `RunCleanup`/`RunOptimization`/`RunScan`/`CollectMetrics`). Ensure tasks honor safe mode, progress persistence, and return `TaskResult`-compatible arrays. Add/extend tests to verify task execution paths are unified."
C03-01,"Introduce LockService abstraction","Add a single lock abstraction used across the plugin. Steps: (1) Create `includes/Contracts/LockServiceInterface.php` (or appropriate location) with acquire/release semantics and TTL. (2) Implement `includes/Services/LockService.php` using MySQL `GET_LOCK` when a connection is available, with fallbacks to object cache or atomic `add_option`. (3) Bind it in an always-available provider (Services or a new Infrastructure provider). Acceptance: can be mocked in tests and works with/without object cache."
C03-02,"Refactor REST rate limiting to use LockService","Update `includes/REST/RestController.php` rate limiting logic to use `LockServiceInterface` for atomicity and consistent failure modes. Preserve the current security posture (fail closed when lock unavailable). Add/extend tests to validate: (1) rate limit exceeded returns proper WP_Error, (2) lock unavailable denies, (3) cache-based increment path behaves consistently."
C03-03,"Refactor SchedulerRegistry locking to use LockService","Update `includes/Scheduler/SchedulerRegistry.php` to delegate `acquire_lock`/`release_lock` to `LockServiceInterface` (or wrapper). Ensure locks are released on exceptions and that lock names remain stable. Add/extend tests around concurrent execution prevention."
C03-04,"Standardize cache keys and migrate Analyzer caching","Create a central cache key convention (e.g., `includes/Support/CacheKeys.php`) and migrate `includes/Database/Analyzer.php` transient usage to `CacheInterface` (or a dedicated cache adapter) while keeping TTL semantics. Add tests verifying cache hit/miss behavior and key names."
C03-05,"Migrate AI Recommendations caching to CacheInterface","Refactor `includes/AI/Recommendations.php` to use `CacheInterface` (and/or Options) for cached recommendations and dismissed recommendation state instead of raw transients. Make multisite scope explicit. Add tests for: cache set/get, dismissal filtering, and force refresh behavior."
C03-06,"Migrate HealthCalculator caching to CacheInterface","Refactor `includes/HealthCalculator.php` to use `CacheInterface` rather than direct transients while preserving setting-driven TTL (`health_score_cache_duration`). Add tests for TTL selection and force refresh bypass."
C03-07,"Add observability for lock/rate-limit events","Instrument lock contention and rate limit events with safe logging (no sensitive payloads). Use `ActivityLoggerInterface` when available (or a dedicated logger) and ensure logging is gated appropriately (settings/debug). Add doc notes explaining how to diagnose contention/rate limiting."
C03-08,"Safe-mode consistency audit + tests","Audit destructive operations (DB cleanup, media deletion) across REST, cron, and admin actions to ensure safe mode is enforced consistently (preview-only where required). Add integration tests toggling safe mode via settings/constants and verifying no destructive writes occur (or that results indicate preview-only)."
C04-01,"Define canonical JS API surface","Choose `assets/js/utils/api.js` as the canonical REST client and standardize on `window.WPAdminHealth.api` as the single supported global client. Update docs (add `docs/developers/js-api.md` or update existing docs) describing the stable JS API surface: `WPAdminHealth.api`, `WPAdminHealth.Events`, `WPAdminHealth.extensions`."
C04-02,"Deprecate/bridge legacy `WPAdminHealth.API` wrapper","Update `assets/js/admin.js` so `WPAdminHealth.API` delegates to `WPAdminHealth.api` (or wraps it) for backward compatibility. Ensure legacy page scripts that still reference `WPAdminHealth.API` continue to work. Add a deprecation warning only in debug/dev contexts."
C04-03,"Remove duplicate API client usage in entrypoints/components","Audit `assets/js/entries/*`, `assets/js/components/*`, and legacy page scripts for mixed usage of different REST clients and unify on the canonical client. Ensure consistent error handling via `ApiError` and consistent caching/retry semantics."
C04-04,"Add Jest contract tests for Extension API","Add/extend Jest tests for `assets/js/utils/extension-api.js` covering: widget registration/unregistration, zone rendering behavior, filter application ordering, and event subscription (`on`, `once`) delegation to `WPAdminHealth.Events`. Acceptance: tests assert the public contract remains stable."
C04-05,"Publish JS extension contract docs","Update docs to explicitly define what is public/stable for JS extensions (and versioning policy). Ensure examples match current code and reference the canonical client + extension API only."
C04-06,"Optional: add shared REST payload typing","Add JSDoc typedefs (or a lightweight TS setup if already acceptable) for key REST payloads used by dashboard/performance/media pages; ensure types are reused across API calls and components without changing build outputs."
C05-01,"Fix PSR-4 case-sensitivity mismatch for ACF integration","Rename `includes/Integrations/Acf.php` to `includes/Integrations/ACF.php` and ensure all references (`use` statements, factory/provider bindings) match the new path exactly. Run `./scripts/check-case-sensitivity.sh` and `php scripts/check-autoload-sanity.php`. Acceptance: case-sensitivity and autoload sanity checks pass on Linux CI."
C05-02,"Audit and fix remaining PSR-4/path case issues","Run the repo’s case-sensitivity and autoload sanity checks; fix any remaining mismatches between class names/namespaces and file paths, plus `require/include` casing. Update tests and docs as needed to align."
C05-03,"Document data model ownership for installer tables","Create a concise data model doc (e.g., `docs/architecture/data-model.md`) mapping each table created in `includes/Installer.php` to its runtime usage, retention policy, and cleanup/migration strategy: `wpha_scan_history`, `wpha_query_log`, `wpha_ajax_log`, `wpha_deleted_media`, `wpha_scheduled_tasks`."
C05-04,"Deprecate/remove unused schema (`wpha_scheduled_tasks`)","If `wpha_scheduled_tasks` is confirmed unused at runtime, implement a migration plan: stop creating it on fresh installs, handle upgrades safely, and update tests that assert its existence. Acceptance: no runtime code depends on the table and test suite remains green."
C05-05,"Finalize deprecation path for legacy `includes/RestApi.php`","Confirm `includes/RestApi.php` is not used at runtime (routes registered via providers/bootstrap). Update docs to reflect reality; either remove the class or keep as compatibility shim with a clear removal timeline. Ensure no tests rely on it."
C05-06,"Reduce template edge service-location where feasible","Continue reducing direct service location in templates: ensure `templates/admin/settings.php` always receives `SettingsViewModel` via `PageRenderer`; consider a similar injection path for network templates to avoid `Plugin::get_instance()` usage when possible. Keep templates thin and presentation-only."
C05-07,"Add ADRs for key architecture decisions","Create `docs/architecture/adr-*.md` for: DI container strategy, rules for deferred providers, REST/integration bootstrap approach, caching/locking abstraction, and JS public API contract. Keep ADRs short, dated, and actionable."
C05-08,"Documentation + placeholder cleanup","Update placeholder metadata (Author, Author URI, Plugin URI) and audit `docs/` for accuracy (remove stale statements about deprecated hooks firing). Ensure documentation matches the implemented architecture and bootstrap behavior."
