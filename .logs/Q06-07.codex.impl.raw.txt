**Status:** DONE

**Summary of changes**
- Harden nonce verification to accept `X-WP-Nonce` header or `_wpnonce` param fallback (`includes/REST/RestController.php#L297`).
- Redact/sanitize query analysis output (SQL literals + caller paths) unless debug mode + `WPHA_DEBUG` is enabled (`includes/REST/Performance/QueryAnalysisController.php#L97`).
- Standardize REST date outputs to RFC3339 and sanitize activity fields (`includes/REST/DashboardController.php#L325`).
- Sanitize media attachment REST fields (URLs, title, filename, date) and exclusions metadata (`includes/REST/Media/MediaHelper.php#L104`, `includes/REST/Media/MediaCleanupController.php#L402`, `includes/REST/MediaController.php#L989`).
- Sanitize revision-post rows returned via REST (`includes/REST/DatabaseController.php#L303`, `includes/REST/Database/TableAnalysisController.php#L210`).
- Tighten request arg sanitization/validation for boolean + enums (`includes/REST/Database/CleanupController.php#L172`, `includes/REST/Performance/HeartbeatController.php#L62`, `includes/REST/Performance/AutoloadController.php#L73`).
- Fix `/database/optimization/tables` to handle the current optimizer return shape (`includes/REST/Database/OptimizationController.php#L142`).

**How to verify**
- `npm run lint`
- `npm test`

**Risks / follow-ups**
- Query analysis now redacts SQL by default; to see raw SQL, enable the plugin’s debug mode and set `WPHA_DEBUG` to true (still trimmed to a max length).
- REST route duplication remains for media endpoints (both `MediaController` and the newer `Media/*` controllers register overlapping routes); consider de-duplicating to avoid ambiguous handler selection.

OpenAI Codex v0.86.0 (research preview)
--------
workdir: /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite
model: gpt-5.2
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: xhigh
reasoning summaries: auto
session id: 019bc834-bc7a-7920-9d6d-604e6a09daf7
--------
user
You are implementing task Q06-07 in this git repository.

1) Read the spec: .plans/Q06-07.md
2) Read handoff/context: .t2/handoff/Q06-07.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

mcp startup: no servers

thinking
**Planning task implementation**

I need to implement task Q06-07 in the wp-admin-health-suite repository. My first step is to read the specification and handoff documents. I’ll run lint and tests, and for that, I’ll use some shell commands. There are specific instructions from AGENTS that I have to follow. I can open and read the files directly using the functions.shell_command tool. I'll also create and update a plan as I go. My initial command will be to inspect the repository and read the necessary files in parallel.
Plan update
  → Read spec and handoff
  • Implement required changes
  • Run lint and tests
  • Summarize and hand off
exec
/bin/zsh -lc 'ls -la' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 64ms:
total 2200
drwxr-xr-x   55 ahmedyounis  staff    1760 Jan 16 09:09 .
drwxr-xr-x   43 ahmedyounis  staff    1376 Jan 11 22:56 ..
-rw-------@   1 ahmedyounis  staff     189 Jan  7 14:37 .babelrc
-rw-r--r--@   1 ahmedyounis  staff    1286 Jan  8 22:57 .eslintrc.json
drwxr-xr-x   14 ahmedyounis  staff     448 Jan 16 11:07 .git
drwxr-xr-x@   3 ahmedyounis  staff      96 Jan 14 06:48 .github
-rw-------@   1 ahmedyounis  staff     346 Jan  8 22:53 .gitignore
drwxr-xr-x@   4 ahmedyounis  staff     128 Jan  7 17:43 .husky
drwxr-xr-x@  10 ahmedyounis  staff     320 Jan 16 10:17 .idea
drwxr-xr-x@ 362 ahmedyounis  staff   11584 Jan 16 11:07 .logs
-rw-r--r--@   1 ahmedyounis  staff   28558 Jan 16 08:29 .phpunit.result.cache
drwxr-xr-x@ 121 ahmedyounis  staff    3872 Jan 16 11:07 .plans
-rw-r--r--@   1 ahmedyounis  staff     119 Jan  7 17:43 .prettierignore
-rw-r--r--@   1 ahmedyounis  staff     409 Jan  8 22:57 .prettierrc.json
drwx------@   3 ahmedyounis  staff      96 Jan  7 14:59 .scripts
drwxr-xr-x@   6 ahmedyounis  staff     192 Jan 16 06:56 .t2
-rw-r--r--@   1 ahmedyounis  staff    9207 Jan  8 22:57 ACCESSIBILITY.md
drwxr-xr-x@   4 ahmedyounis  staff     128 Jan  9 00:36 admin
drwxr-xr-x@   6 ahmedyounis  staff     192 Jan  7 10:29 assets
exec
/bin/zsh -lc "sed -n '1,200p' .plans/Q06-07.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
# Q06-07 — REST API Security Review

Review all REST endpoints for proper authentication (nonce verification), authorization (capability checks), input sanitization, output escaping, and rate limiting implementation.
exec
/bin/zsh -lc "sed -n '1,200p' .t2/handoff/Q06-07.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
# Handoff: Q06-07

Created: 2026-01-16T19:07:37.953124Z

Spec: .plans/Q06-07.md

thinking
**Locating REST endpoints**

I'm planning to locate the REST endpoints. My first step will be to run a command to search for `register_rest_route`, and I might also check for `wp_ajax` if needed. The main goal here is to focus on identifying those specific endpoints. I'll execute this command in the shell to get started. Let's see what results we find!
exec
/bin/zsh -lc "rg -n \"register_rest_route\\(\" -S ." in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 69ms:
./docs/developers/hooks.md:325:    register_rest_route( 'wpha/v1', '/custom-endpoint', array(
./docs/developers/hooks.md:602:    register_rest_route( 'wpha/v1', '/custom-health-check', array(
./includes/REST/Media/MediaScanController.php:75:		register_rest_route(
./includes/REST/Media/MediaAltTextController.php:82:		register_rest_route(
./includes/REST/Media/MediaAltTextController.php:96:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:86:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:109:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:131:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:144:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:174:		register_rest_route(
./includes/REST/Media/MediaCleanupController.php:196:		register_rest_route(
./includes/REST/Media/MediaAnalysisController.php:105:		register_rest_route(
./includes/REST/Media/MediaAnalysisController.php:118:		register_rest_route(
./includes/REST/Media/MediaAnalysisController.php:132:		register_rest_route(
./includes/REST/Media/MediaAnalysisController.php:146:		register_rest_route(
./includes/REST/DatabaseController.php:147:		register_rest_route(
./includes/REST/DatabaseController.php:160:		register_rest_route(
./includes/REST/DatabaseController.php:184:		register_rest_route(
./includes/REST/DatabaseController.php:197:		register_rest_route(
./includes/REST/DatabaseController.php:210:		register_rest_route(
exec
/bin/zsh -lc "sed -n '1,220p' includes/REST/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * REST Controller Base Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Controller;
use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}
exec
/bin/zsh -lc "sed -n '220,520p' includes/REST/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
	 * Delete a single item.
	 *
	 * @since 1.0.0
	 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function delete_item( $request ) {
		$id = $request->get_param( 'id' );
		return $this->format_response( true, array( 'id' => $id ), __( 'Item deleted successfully.', 'wp-admin-health-suite' ) );
	}

	/**
	 * Check permissions for the request.
	 *
	 * Verifies:
	 * - REST API is enabled
	 * - User authentication
	 * - manage_options capability
	 * - Nonce verification via X-WP-Nonce header
exec
/bin/zsh -lc "sed -n '520,860p' includes/REST/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:

		// Add debug information if debug mode is enabled.
		// Security: Only include basic metrics, never expose full queries or stack traces.
		if ( $this->is_debug_mode_enabled() ) {
			$connection = $this->get_connection();

			$response['debug'] = array(
				'queries'       => $connection->get_num_queries(),
				'memory_usage'  => size_format( memory_get_usage() ),
				'memory_peak'   => size_format( memory_get_peak_usage() ),
				'time_elapsed'  => timer_stop( 0, 3 ),
			);

			// Security: Only expose query timing for super admins with WPHA_DEBUG explicitly set.
			// Never expose full query text or stack traces via REST API.
			$query_log = $connection->get_query_log();
			if ( $this->can_view_detailed_debug() && defined( 'SAVEQUERIES' ) && SAVEQUERIES && ! empty( $query_log ) ) {
				$response['debug']['query_timing'] = array_map(
					function ( $query ) {
						return array(
exec
/bin/zsh -lc "ls -R includes/REST | sed -n '1,200p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
ActivityController.php
DashboardController.php
Database
DatabaseController.php
index.php
Media
MediaController.php
Performance
PerformanceController.php
RestController.php

includes/REST/Database:
CleanupController.php
OptimizationController.php
TableAnalysisController.php

includes/REST/Media:
MediaAltTextController.php
MediaAnalysisController.php
MediaCleanupController.php

thinking
**Ensuring controller security**

I need to double-check that every route uses a permission callback, like `check_permissions`. Additionally, I should ensure that arguments are properly sanitized and validated. It's interesting to think about output escaping as well; for REST responses, we should return sanitized data to avoid any unescaped HTML. Even though REST typically returns JSON, I'm concerned about not outputting unsanitized data and using tools like `esc_html`. Lastly, I should consider rate limiting in base permissions for extra security. Let's quickly review each controller file, starting with `ActivityController.php`.
exec
/bin/zsh -lc "sed -n '1,240p' includes/REST/ActivityController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
<?php
/**
 * Activity REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

exec
/bin/zsh -lc "sed -n '240,520p' includes/REST/ActivityController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 56ms:
		return $params;
	}
}
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/DashboardController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
<?php
/**
 * Dashboard REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\HealthCalculator;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}
exec
/bin/zsh -lc "sed -n '260,620p' includes/REST/DashboardController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
	}

	/**
	 * Get paginated activity log.
	 *
	 * Returns activity log entries from the scan history table with pagination support.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_activity( $request ) {
		$connection = $this->get_connection();

		$page     = $request->get_param( 'page' );
		$per_page = $request->get_param( 'per_page' );

		// Calculate offset.
		$offset = ( $page - 1 ) * $per_page;



thinking
**Reviewing output sanitization**

I'm realizing that the file is large and might require truncation, so I need to check the output sanitization. In the `get_activity` function, the `created_at` field returned raw data, which isn't sanitized. It would be a good idea to sanitize and convert that to RFC3339 for consistency, similar to what ActivityController did. Also, I need to address items like `items_found` and `items_cleaned` needing integer casting. Rate limiting is handled by the permission callback, but some endpoints could be missing checks. I should review all controllers systematically.
thinking
**Analyzing nonce checks in WordPress**

In WordPress core, the function `rest_cookie_check_errors` checks if cookie authentication is in use and that the user is logged in. It looks for the nonce in either the `X-WP-Nonce` header or `_wpnonce` request parameter. If the nonce is missing, it sets the current user to zero and can return an error if the nonce check fails.

What's interesting is that it seems to require a nonce for all requests using cookies, including GET requests, to prevent CSRF issues. However, plugins may not always check the `_wpnonce` parameter, typically sticking to the `X-WP-Nonce` header.
thinking
**Inspecting nonce verification in controllers**

I see that the spec mentions "nonce verification," and I'm glad we already check for that. However, other controllers might not be extending the base, which could be a concern. Some may be using `WP_REST_Controller` directly, and that's worth examining. I'll take a closer look at `includes/REST/DatabaseController.php` to see if it follows the same practices or if there are older methods in play that we should be aware of. Let's dig into this further!
exec
/bin/zsh -lc "sed -n '1,320p' includes/REST/DatabaseController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
<?php
/**
 * Database REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AnalyzerInterface;
use WPAdminHealth\Contracts\RevisionsManagerInterface;
use WPAdminHealth\Contracts\TransientsCleanerInterface;
use WPAdminHealth\Contracts\OrphanedCleanerInterface;
use WPAdminHealth\Contracts\TrashCleanerInterface;
use WPAdminHealth\Contracts\OptimizerInterface;
exec
/bin/zsh -lc "sed -n '320,780p' includes/REST/DatabaseController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
	 * Get transient list.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_transients( $request ) {
		// Check if using external object cache.
		if ( wp_using_ext_object_cache() ) {
			return $this->format_response(
				true,
				array(
					'total_count' => 0,
					'size_estimate' => 0,
					'expired_transients' => array(),
					'using_external_cache' => true,
					'message' => __( 'External object cache is in use. Transient data is not stored in the database.', 'wp-admin-health-suite' ),
				),
				__( 'Transient information retrieved successfully.', 'wp-admin-health-suite' )

thinking
**Searching for functions**

I need to continue exploring the code, especially looking for functions related to sanitization. I should check for things like options and tables as well. It’s a good idea to inspect sanitization functions at the bottom of the file. I’ll search within the file using a tool like `rg` to find instances of "sanitize_options" and see what I can uncover. That should help me understand how it all works!
exec
/bin/zsh -lc 'rg -n "function sanitize_" includes/REST/DatabaseController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 63ms:
842:	public function sanitize_options( $value ) {
875:	public function sanitize_table_names( $value ) {
exec
/bin/zsh -lc "sed -n '780,980p' includes/REST/DatabaseController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:

		switch ( $type ) {
			case 'revisions':
				$items_found   = isset( $result['deleted'] ) ? $result['deleted'] : 0;
				$items_cleaned = $items_found;
				$bytes_freed   = isset( $result['bytes_freed'] ) ? $result['bytes_freed'] : 0;
				break;

			case 'transients':
				$items_found   = isset( $result['deleted'] ) ? $result['deleted'] : 0;
				$items_cleaned = $items_found;
				$bytes_freed   = isset( $result['bytes_freed'] ) ? $result['bytes_freed'] : 0;
				break;

			case 'spam':
				$items_found   = isset( $result['deleted'] ) ? $result['deleted'] : 0;
				$items_cleaned = $items_found;
				break;

			case 'trash':

thinking
**Reviewing database sanitization**

I’m looking into the DatabaseController, which sanitizes options and table names, but it might be lacking in output sanitization. For example, the posts_with_most_revisions could include fields like post_title. I need to double-check what the RevisionsManager does. The spec mentions output escaping, so for REST, it’s crucial to sanitize output fields. I want to ensure that plugins aren't returning raw HTML or SQL queries, so I’ll also review service methods and possibly duplicate controllers in the includes/REST directory. I'll check includes/REST/MediaController.php too.
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Media REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;
use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\Contracts\ReferenceFinderInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;
exec
/bin/zsh -lc "sed -n '260,620p' includes/REST/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
		);

		// POST /wpha/v1/media/scan - Trigger full media scan.
		register_rest_route(
			$this->namespace,
			'/' . $this->rest_base . '/scan',
			array(
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'trigger_scan' ),
					'permission_callback' => array( $this, 'check_permissions' ),
				),
			)
		);

		// POST /wpha/v1/media/delete - Safe delete selected media items.
		register_rest_route(
			$this->namespace,
			'/' . $this->rest_base . '/delete',
			array(
exec
/bin/zsh -lc "sed -n '620,1120p' includes/REST/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
		$cursor   = $request->get_param( 'cursor' );
		$per_page = $request->get_param( 'per_page' ) ? absint( $request->get_param( 'per_page' ) ) : $this->per_page;

		// Apply cursor-based pagination.
		$start_index = $cursor ? absint( $cursor ) : 0;

		// AltTextChecker is limit-based; request enough items to serve this page.
		$all_missing = $this->alt_text_checker->find_missing_alt_text( $start_index + $per_page );
		$page_items  = array_slice( $all_missing, $start_index, $per_page );

		$alt_coverage = $this->alt_text_checker->get_alt_text_coverage();
		$total       = isset( $alt_coverage['images_without_alt'] ) ? absint( $alt_coverage['images_without_alt'] ) : count( $all_missing );

		$items = array();
		foreach ( $page_items as $item ) {
			$attachment_id = isset( $item['id'] ) ? absint( $item['id'] ) : 0;
			if ( ! $attachment_id ) {
				continue;
			}
			$items[] = array_merge( $this->get_attachment_details( $attachment_id ), $item );

thinking
**Checking attachment details**

I need to look into how the `MediaController` is using `check_permissions`. It seems there's a possibility that the output includes details from `get_attachment_details`, which might have unsanitized fields like the title. I should definitely double-check that method to ensure everything is secured. I’ll search within the file specifically for `get_attachment_details` to see what’s happening there and make sure everything is handled properly.
exec
/bin/zsh -lc 'rg -n "function get_attachment_details" -n includes/REST/MediaController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
882:	private function get_attachment_details( $attachment_id ) {
exec
/bin/zsh -lc "sed -n '820,940p' includes/REST/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
			$result['message']
		);
	}

	/**
	 * Restore media from trash.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function restore_media( $request ) {
		$deletion_id = $request->get_param( 'deletion_id' );

		$safe_mode = $this->is_safe_mode_enabled();
		if ( $safe_mode ) {
			$preview = array(
				'success'      => true,
				'safe_mode'    => true,
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Media/MediaHelper.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:
<?php
/**
 * Media Helper
 *
 * Provides shared utility methods for media controllers.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * MediaHelper class for shared media operations.
 *
 * @since 1.3.0


thinking
**Evaluating data sanitization**

I’m looking into how MediaHelper returns information like title, date, MIME type, and URLs. It’s crucial to sanitize these details because they might come directly from user input, and I don't want any potential risks like XSS in the admin UI. The spec emphasizes output escaping for safety. I should apply different sanitization functions, like `sanitize_text_field` for titles and filenames to ensure everything is clean. It’s better to be safe than sorry!
thinking
**Considering output sanitization**

I’m thinking about using `sanitize_text_field` or `sanitize_file_name` for output. I lean towards `sanitize_text_field`, but I need to be cautious because returning sanitized data might look different than expected, even though the spec requires it. Minimal implementation is key here! I also need to check `is_valid_upload_path` since that's important too. Now, I’ll dig into the `PerformanceController.php` file to see what’s going on and ensure everything aligns properly.
exec
/bin/zsh -lc "sed -n '1,340p' includes/REST/PerformanceController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 54ms:
<?php
/**
 * Performance REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AutoloadAnalyzerInterface;
use WPAdminHealth\Contracts\QueryMonitorInterface;
use WPAdminHealth\Contracts\PluginProfilerInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
exec
/bin/zsh -lc "sed -n '340,760p' includes/REST/PerformanceController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 41ms:
		);

		return $this->format_response(
			true,
			$response_data,
			__( 'Performance score retrieved successfully.', 'wp-admin-health-suite' )
		);
	}

	/**
	 * Get plugin impact analysis.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_plugin_impact( $request ) {
		if ( ! function_exists( 'get_plugins' ) ) {
			require_once ABSPATH . 'wp-admin/includes/plugin.php';
exec
/bin/zsh -lc 'rg -n "new (ActivityController|DashboardController|DatabaseController|MediaController|PerformanceController|MediaScanController|MediaAltTextController|MediaCleanupController|MediaAnalysisController|CacheController|QueryAnalysisController|HeartbeatController|AutoloadController|PluginProfilerController|PerformanceStatsController|TableAnalysisController|CleanupController|OptimizationController)" -S includes wp-admin-health-suite.php admin | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 72ms:
includes/Providers/RESTServiceProvider.php:110:				return new DatabaseController(
includes/Providers/RESTServiceProvider.php:131:				return new MediaController(
includes/Providers/RESTServiceProvider.php:153:				return new DashboardController(
includes/Providers/RESTServiceProvider.php:169:				return new PerformanceController(
includes/Providers/RESTServiceProvider.php:187:				return new ActivityController(
includes/Providers/RESTServiceProvider.php:202:				return new TableAnalysisController(
includes/Providers/RESTServiceProvider.php:221:				return new OptimizationController(
includes/Providers/RESTServiceProvider.php:237:				return new CleanupController(
includes/Providers/RESTServiceProvider.php:257:				return new PerformanceStatsController(
includes/Providers/RESTServiceProvider.php:272:				return new QueryAnalysisController(
exec
/bin/zsh -lc "sed -n '1,360p' includes/Providers/RESTServiceProvider.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * REST Service Provider
 *
 * Registers REST API controllers and services.
 *
 * @package WPAdminHealth\Providers
 */

namespace WPAdminHealth\Providers;

use WPAdminHealth\Container\ServiceProvider;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AnalyzerInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\RevisionsManagerInterface;
use WPAdminHealth\Contracts\TransientsCleanerInterface;
use WPAdminHealth\Contracts\OrphanedCleanerInterface;
use WPAdminHealth\Contracts\TrashCleanerInterface;

thinking
**Evaluating controller registration**

I’m noticing the service provider registers multiple controllers like PerformanceController and PerformanceStatsController, which could lead to duplication. If both are registered, we might end up with duplicate endpoints. I need to check the plugin that utilizes them. It seems the service provider binds them, but the route registration might stem from another class that calls register_routes for each one. I'll look into includes/REST/RestAPI and search for `rest_` to clarify things.
exec
/bin/zsh -lc "rg -n \"register_routes\\(\" includes | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
includes/REST/Media/MediaScanController.php:73:	public function register_routes(): void {
includes/REST/Media/MediaAltTextController.php:80:	public function register_routes(): void {
includes/REST/Media/MediaCleanupController.php:84:	public function register_routes(): void {
includes/REST/Media/MediaAnalysisController.php:103:	public function register_routes(): void {
includes/REST/Performance/CacheController.php:62:	public function register_routes(): void {
includes/REST/Performance/QueryAnalysisController.php:73:	public function register_routes(): void {
includes/REST/Performance/HeartbeatController.php:62:	public function register_routes(): void {
includes/REST/Performance/AutoloadController.php:73:	public function register_routes(): void {
includes/REST/Performance/PluginProfilerController.php:73:	public function register_routes(): void {
includes/REST/Performance/PerformanceStatsController.php:64:	public function register_routes(): void {
includes/REST/ActivityController.php:57:	public function register_routes() {
includes/REST/MediaController.php:166:	public function register_routes() {
includes/REST/PerformanceController.php:118:	public function register_routes() {
includes/REST/DashboardController.php:99:	public function register_routes() {
includes/REST/DatabaseController.php:145:	public function register_routes() {
includes/REST/Database/TableAnalysisController.php:107:	public function register_routes(): void {
includes/REST/Database/OptimizationController.php:73:	public function register_routes(): void {
includes/REST/Database/CleanupController.php:118:	public function register_routes(): void {
includes/REST/RestController.php:132:	public function register_routes() {
includes/RestApi.php:70:	public function register_routes() {
exec
/bin/zsh -lc "sed -n '1,220p' includes/RestApi.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * REST API Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * REST API class for handling REST API endpoints.
 *
 * @since 1.0.0
 */
class RestApi {
exec
/bin/zsh -lc "sed -n '360,520p' includes/Providers/RESTServiceProvider.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
			'rest.media.analysis_controller',
			function ( $container ) {
				if ( ! class_exists( MediaAnalysisController::class ) ) {
					return null;
				}

				return new MediaAnalysisController(
					$container->get( SettingsInterface::class ),
					$container->get( ConnectionInterface::class ),
					$container->get( ScannerInterface::class ),
					$container->get( DuplicateDetectorInterface::class ),
					$container->get( LargeFilesInterface::class )
				);
			}
		);

		// Register Media Alt Text Controller.
		$this->container->bind(
			'rest.media.alt_text_controller',
			function ( $container ) {

thinking
**Investigating service registration**

I'm looking into the service provider that registers routes for new modular controllers but not for the monolithic PerformanceController. It includes rest.performance.stats_controller, while RestApi.php still registers the old controllers, including PerformanceController. There might be two systems at play here. I need to check if RestApi.php is just an old, unused leftover. I'll search for `new RestApi` or `RESTServiceProvider` in the plugin class to clarify which one is being used.
exec
/bin/zsh -lc "rg -n \"new RestApi\\b|RESTServiceProvider\" -S wp-admin-health-suite.php includes | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
includes/Providers/RESTServiceProvider.php:57: * Class RESTServiceProvider
includes/Providers/RESTServiceProvider.php:63:class RESTServiceProvider extends ServiceProvider {
includes/Plugin.php:22:use WPAdminHealth\Providers\RESTServiceProvider;
includes/Plugin.php:211:			RESTServiceProvider::class,
exec
/bin/zsh -lc "sed -n '1,280p' includes/Plugin.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Main Plugin Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth;

use WPAdminHealth\Container\Container;
use WPAdminHealth\Container\ContainerInterface;
use WPAdminHealth\Container\ServiceProvider;
use WPAdminHealth\Integrations\IntegrationManager;
use WPAdminHealth\Providers\BootstrapServiceProvider;
use WPAdminHealth\Providers\CoreServiceProvider;
use WPAdminHealth\Providers\DatabaseServiceProvider;
use WPAdminHealth\Providers\InstallerServiceProvider;
use WPAdminHealth\Providers\IntegrationServiceProvider;
use WPAdminHealth\Providers\MediaServiceProvider;
use WPAdminHealth\Providers\MultisiteServiceProvider;

thinking
**Investigating plugin usage**

It seems like the plugin uses service providers, which makes me wonder if includes/RestApi.php is actually still active or if it's just leftover from old code. I’m also thinking about how the plugin initialization uses RESTServiceProvider to register routes, but the RestApi class itself isn't referenced anywhere. I should look in the main plugin file, `wp-admin-health-suite.php`, to see if RestApi is instantiated there. That might shed some light on this!
exec
/bin/zsh -lc "rg -n \"RestApi\\b\" -S ." in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 62ms:
./includes/RestApi.php:20:class RestApi {
./includes/Providers/BootstrapServiceProvider.php:5: * Registers core UI services: Admin, Assets, RestApi.
exec
/bin/zsh -lc "sed -n '1,240p' includes/Providers/BootstrapServiceProvider.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Bootstrap Service Provider
 *
 * Registers core UI services: Admin, Assets, RestApi.
 *
 * @package WPAdminHealth\Providers
 */

namespace WPAdminHealth\Providers;

use WPAdminHealth\Container\ServiceProvider;
use WPAdminHealth\Admin;
use WPAdminHealth\Assets;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}


thinking
**Reviewing REST endpoints**

I need to consider the spec on reviewing all REST endpoints, even those that aren’t currently registered but still part of the code. It’s probably best to update them just to be safe. I should also check occurrences of `register_rest_route` in all controllers to confirm they use `permission_callback`, ensuring that callbacks apply `check_permissions`. I’ll search `includes/REST` for these definitions and inspect modular controllers like `Performance/CacheController` for proper adherence.
exec
/bin/zsh -lc "sed -n '1,240p' includes/REST/Performance/QueryAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Query Analysis REST Controller
 *
 * Handles database query monitoring and analysis.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\QueryMonitorInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.

thinking
**Assessing visibility in PHP methods**

In PHP, changing a method's visibility from private to protected doesn't break the class itself, but we need to consider if it might affect subclasses. Actually, if there are no external calls to `RestController::can_view_detailed_debug()`, we're safe. I could change it to protected and possibly rename it, but keeping the name is fine if we update references. We should ensure that only sanitized query info is returned, avoiding full data exposure while considering potential file path leaks.
exec
/bin/zsh -lc 'rg -n "interface QueryMonitorInterface" -S includes' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
includes/Contracts/QueryMonitorInterface.php:25:interface QueryMonitorInterface {
exec
/bin/zsh -lc "sed -n '1,200p' includes/Contracts/QueryMonitorInterface.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Query Monitor Interface
 *
 * Defines the contract for monitoring and analyzing database queries.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface QueryMonitorInterface
 *
 * Contract for query monitoring operations.

thinking
**Inspecting query implementation**

I'm looking into the `capture_slow_queries` function, which returns an array with a query, but it seems like the `QueryAnalysisController` is assuming there are additional keys, such as component. I wonder if the actual implementation might return more than expected. I think I should inspect the `includes/Performance/QueryMonitor.php` file to see if there’s more information there. Let’s search for anything relevant!
exec
/bin/zsh -lc 'rg -n "class .*QueryMonitor" includes | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
includes/Performance/QueryMonitor.php:28:class QueryMonitor implements QueryMonitorInterface {
exec
/bin/zsh -lc "sed -n '1,260p' includes/Performance/QueryMonitor.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Query Monitor Class
 *
 * Provides query monitoring and analysis functionality.
 * Integrates with Query Monitor plugin when available, otherwise provides
 * standalone monitoring using WordPress SAVEQUERIES.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Performance;

use WPAdminHealth\Contracts\QueryMonitorInterface;
use WPAdminHealth\Contracts\ConnectionInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Database/TableAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Table Analysis REST Controller
 *
 * Handles database analysis and read-only endpoints.
 *
 * @package WPAdminHealth\REST\Database
 */

namespace WPAdminHealth\REST\Database;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AnalyzerInterface;
use WPAdminHealth\Contracts\RevisionsManagerInterface;
use WPAdminHealth\Contracts\TransientsCleanerInterface;
use WPAdminHealth\Contracts\OrphanedCleanerInterface;

thinking
**Reviewing database controllers**

I'm noticing some similarities with DatabaseController. I might need to sanitize the output for expired transients, but the service could already be handling that. I’ll need to check on it later. It looks like I'll also need to dive into OptimizationController to see what’s included in includes/REST/Database/OptimizationController.php. I want to make sure everything is optimized and working as intended!
exec
/bin/zsh -lc "sed -n '1,240p' includes/REST/Database/OptimizationController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 54ms:
<?php
/**
 * Optimization REST Controller
 *
 * Handles database and table optimization operations.
 *
 * @package WPAdminHealth\REST\Database
 */

namespace WPAdminHealth\REST\Database;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\OptimizerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '240,520p' includes/REST/Database/OptimizationController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
					'repair_failed',
					__( 'No tables specified for repair.', 'wp-admin-health-suite' )
				),
				400
			);
		}

		foreach ( $tables as $table ) {
			$result = $this->optimizer->repair_table( $table );
			if ( $result && isset( $result['success'] ) ) {
				$results[ $table ] = $result;
			}
		}

		if ( empty( $results ) ) {
			return $this->format_error_response(
				new WP_Error(
					'repair_failed',
					__( 'No tables were repaired. Please check the table names.', 'wp-admin-health-suite' )
				),

thinking
**Inspecting optimization controllers**

I'm checking the OptimizationController, and it looks good so far—it's using check_permissions and sanitizing table names. Now, I want to look at the CleanupController in includes/REST/Database/CleanupController.php. I think a quick inspection of this file will help me understand how it all ties together, ensuring everything aligns with best practices. It seems essential to keep everything in order and secure! Let's proceed with that inspection.
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Database/CleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Database Cleanup REST Controller
 *
 * Handles database cleanup operations.
 *
 * @package WPAdminHealth\REST\Database
 */

namespace WPAdminHealth\REST\Database;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AnalyzerInterface;
use WPAdminHealth\Contracts\RevisionsManagerInterface;
use WPAdminHealth\Contracts\TransientsCleanerInterface;
use WPAdminHealth\Contracts\OrphanedCleanerInterface;
exec
/bin/zsh -lc "sed -n '260,620p' includes/REST/Database/CleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 39ms:
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'clean_orphaned' ),
					'permission_callback' => array( $this, 'check_permissions' ),
					'args'                => array(
						'types' => array(
							'description'       => __( 'Types of orphaned data to clean.', 'wp-admin-health-suite' ),
							'type'              => 'array',
							'items'             => array(
								'type' => 'string',
								'enum' => array( 'postmeta', 'commentmeta', 'termmeta', 'relationships' ),
							),
							'default'           => array( 'postmeta', 'commentmeta', 'termmeta', 'relationships' ),
							'sanitize_callback' => array( $this, 'sanitize_orphaned_types' ),
							'validate_callback' => 'rest_validate_request_arg',
						),
					),
				),
			)
		);
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Performance/PerformanceStatsController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Performance Stats REST Controller
 *
 * Handles performance score calculation and recommendations.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Performance/PluginProfilerController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
<?php
/**
 * Plugin Profiler REST Controller
 *
 * Handles plugin impact analysis and profiling.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\PluginProfilerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.

thinking
**Sanitizing plugin names**

I’m looking at how PluginProfilerController handles plugin names from measurements. It currently just uses the measurement directly, which might be acceptable, but I could consider sanitizing the text field. It's good to be cautious about HTML tags potentially being included in plugin names. I think I'll use `wp_strip_all_tags` or `sanitize_text_field` for sanitization in the UI. There are also some unused estimate methods left, but I think that’s alright for now.
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Performance/CacheController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Cache REST Controller
 *
 * Handles object cache status and information.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
exec
/bin/zsh -lc "sed -n '1,320p' includes/REST/Performance/AutoloadController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Autoload REST Controller
 *
 * Handles autoload options analysis and management.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AutoloadAnalyzerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Performance/HeartbeatController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
<?php
/**
 * Heartbeat REST Controller
 *
 * Handles WordPress Heartbeat API control and settings.
 *
 * @package WPAdminHealth\REST\Performance
 */

namespace WPAdminHealth\REST\Performance;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
exec
/bin/zsh -lc "sed -n '1,240p' includes/REST/Media/MediaScanController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 44ms:
<?php
/**
 * Media Scan REST Controller
 *
 * Handles media scanning operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '1,260p' includes/REST/Media/MediaAltTextController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Media Alt Text REST Controller
 *
 * Handles alt text checking operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '1,340p' includes/REST/Media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
<?php
/**
 * Media Cleanup REST Controller
 *
 * Handles media cleanup operations including deletion, restoration, and exclusions.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;
use WPAdminHealth\Contracts\ExclusionsInterface;
use WPAdminHealth\REST\RestController;


thinking
**Evaluating media controllers**

I'm thinking about the MediaCleanupController and how it relates to the MediaController's safe delete feature. It seems to effectively hide the file path. Next, I need to check the get_exclusions method in this controller to make sure it's handling user information properly, like usernames. I plan to inspect this later, along with the MediaAnalysisController to ensure everything works as intended. There's quite a bit to look into!
exec
/bin/zsh -lc "sed -n '1,320p' includes/REST/Media/MediaAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Media Analysis REST Controller
 *
 * Handles media analysis and reporting operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;
use WPAdminHealth\REST\RestController;
exec
/bin/zsh -lc "sed -n '320,680p' includes/REST/Media/MediaAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:

	/**
	 * Get large files list.
	 *
	 * @since 1.0.0
	 * @since 1.3.0 Moved to MediaAnalysisController.
	 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_large( $request ) {
		$cursor    = $request->get_param( 'cursor' );
		$per_page  = $request->get_param( 'per_page' ) ? absint( $request->get_param( 'per_page' ) ) : $this->per_page;
		$threshold = $request->get_param( 'threshold' );

		$all_large_files = $this->large_files->find_large_files( $threshold );

		// Apply cursor-based pagination.
		$start_index = $cursor ? absint( $cursor ) : 0;
		$page_items  = array_slice( $all_large_files, $start_index, $per_page );





thinking
**Evaluating endpoint registration**

I’m looking into active endpoints and wondering about base ones like DatabaseController. I'm noticing that service provider register_routes includes various controllers, like rest.database_controller and rest.media_controller. That could result in overlapping endpoints, with both DatabaseController and TableAnalysisController defining similar routes. MediaController and MediaAnalysisController also seem to create duplicate routes. I’m pondering whether `register_rest_route` allows for multiple callbacks on the same route or if it just causes errors or overrides on duplicates. It seems like a tricky situation!
thinking
**Examining route registration behavior**

I’m considering what happens if I register the same route with the same method and callback. It seems like it would override the previous registration by replacing the `endpoints`. WP_REST_Server::register_route likely merges new endpoints if the route exists. I wonder if it allows duplicates with different methods, but then we'd have multiple endpoints for the same path, which could make things ambiguous if both have a GET method. It seems like later callbacks might be unreachable due to this duplication, which might not be secure.
thinking
**Analyzing potential route conflicts**

I've noticed that the older monolithic MediaController includes functions like deletion and analysis, while newer modular controllers add features like scan and cleanup. The service provider registers both types, which might cause duplicates or conflicts. MediaCleanupController also defines similar routes like /media/delete, leading to duplication. For DatabaseController, while it has routes like /database/clean, new controllers use different paths, so they’re not duplicates. I'm curious if PerformanceController is registered but might not be listed in register_routes. This seems complex!
thinking
**Clarifying controller registration**

I noticed that the provides array includes rest.performance_controller, but it's not in the register_routes list, meaning PerformanceController isn't registered. However, I'm pondering if the service provider binds it for other uses. It seems there may be duplicate routes with the monolithic MediaController and DashboardController. But wait—there's just one DashboardController and one ActivityController. Although the PerformanceStats endpoints appear to be distinct, I wonder about security. Each controller uses permission callbacks, but I’m concerned about input sanitization potentially being overlooked in some routes.
thinking
**Ensuring endpoint security and validation**

I need to make sure that any endpoints that accept arguments have proper sanitize callbacks and validations, as some might be missing. It’s also essential to check output escaping because REST responses could include sensitive information like file paths or user display names that should be sanitized. Rate limiting via check_permissions may not cover unauthenticated users, but it’s better than nothing. Additionally, we need to verify that the X-WP-Nonce header is present for all requests, as proper authentication is crucial. I should search for instances where `permission_callback` doesn’t use check_permissions.
exec
/bin/zsh -lc "rg -n \"permission_callback\\s*=>\\s*(?"'!array'"\\( \\"'$this, '"'check_permissions'\\))\" includes/REST includes/rest -S" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 2 in 60ms:
rg: regex parse error:
    (?:permission_callback\s*=>\s*(?!array\( $this, 'check_permissions'\)))
                                  ^^^
error: look-around, including look-ahead and look-behind, is not supported

Consider enabling PCRE2 with the --pcre2 flag, which can handle backreferences
and look-around.

thinking
**Considering regex options**

I’m looking into using Ripgrep, which typically employs Rust regex without lookahead features. To work around this, I’ll consider using the `--pcre2` option to enable Perl-Compatible Regular Expressions, which can accommodate lookaheads. This could enhance my search capabilities significantly. It’s a bit technical, but I think it’ll be worth it if I can get more precise results. I'll experiment with this change and see how it impacts my work.
exec
/bin/zsh -lc "rg -n --pcre2 \"permission_callback\\s*=>\\s*(?"'!array'"\\( \\"'$this, '"'check_permissions'\\))\" includes/REST includes/rest -S" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 1 in 60ms:

exec
/bin/zsh -lc 'rg -n "get_rest_api_rate_limit" -S includes | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
includes/Settings/SettingsRegistry.php:222:	public function get_rest_api_rate_limit(): int {
includes/REST/RestController.php:337:		$rate_limit = $settings->get_rest_api_rate_limit();
includes/Contracts/SettingsInterface.php:95:	public function get_rest_api_rate_limit(): int;
exec
/bin/zsh -lc "sed -n '180,260p' includes/Settings/SettingsRegistry.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
	 * @return array Merged defaults from all domains.
	 */
	public function get_default_settings(): array {
		$defaults = array();
		foreach ( $this->domains as $domain ) {
			$defaults = array_merge( $defaults, $domain->get_defaults() );
		}
		return $defaults;
	}

	/**
	 * Check if safe mode is enabled.
	 *
	 * @return bool True if safe mode is enabled.
	 */
	public function is_safe_mode_enabled(): bool {
		return (bool) $this->get_setting( 'safe_mode', false );
	}

	/**
exec
/bin/zsh -lc 'rg -n "file_path" includes/REST -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
includes/REST/Media/MediaCleanupController.php:298:					unset( $item['file_path'] );
includes/REST/Media/MediaHelper.php:58:	 * @param string $file_path The file path to validate.
includes/REST/Media/MediaHelper.php:61:	private static function is_valid_upload_path( string $file_path ): bool {
includes/REST/Media/MediaHelper.php:62:		$file_path = trim( $file_path );
includes/REST/Media/MediaHelper.php:64:		if ( '' === $file_path ) {
includes/REST/Media/MediaHelper.php:74:		$real_path = realpath( $file_path );
includes/REST/Media/MediaHelper.php:78:			$dir_path = realpath( dirname( $file_path ) );
includes/REST/Media/MediaHelper.php:82:			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
includes/REST/Media/MediaHelper.php:105:		$file_path = get_attached_file( $attachment_id );
includes/REST/Media/MediaHelper.php:112:		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
includes/REST/Media/MediaHelper.php:113:			$filename = basename( $file_path );
includes/REST/Media/MediaHelper.php:114:			$size     = filesize( $file_path );
includes/REST/MediaController.php:782:					unset( $item['file_path'] );
exec
/bin/zsh -lc "rg -n \"function get_expired_transients|get_expired_transients\\(\" -S includes | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
includes/REST/DatabaseController.php:346:			'expired_transients' => $this->transients_cleaner->get_expired_transients(),
includes/REST/Database/TableAnalysisController.php:253:			'expired_transients'  => $this->transients_cleaner->get_expired_transients(),
includes/AI/OneClickFix.php:382:		$expired_transients = $this->transients_cleaner->get_expired_transients();
includes/Contracts/TransientsCleanerInterface.php:44:	public function get_expired_transients( array $exclude_patterns = array() ): array;
includes/Database/TransientsCleaner.php:218:	public function get_expired_transients( array $exclude_patterns = array() ): array {
includes/Database/TransientsCleaner.php:332:		$expired_transients = $this->get_expired_transients();
includes/Database/TransientsCleaner.php:417:	 * @since 1.4.0 Improved to work with new get_expired_transients() format.
includes/Database/TransientsCleaner.php:432:		$expired_transients = $this->get_expired_transients( $exclude_patterns );
includes/Contracts/AnalyzerInterface.php:128:	public function get_expired_transients_count(): int;
includes/Database/Analyzer.php:441:	public function get_expired_transients_count(): int {
exec
/bin/zsh -lc "sed -n '200,320p' includes/Database/TransientsCleaner.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
		}

		// Divide by 2 because each transient has a value and a timeout option.
		return intval( $count / 2 );
	}

	/**
	 * Get expired transients.
	 *
	 * Returns expired transients from both the options table (regular transients)
	 * and sitemeta table (site transients on multisite).
	 *
	 * @since 1.0.0
	 * @since 1.4.0 Returns detailed array per interface, added multisite support.
	 *
	 * @param array $exclude_patterns Array of prefixes to exclude (e.g., ['wpha_', 'wc_']).
	 * @return array<array{name: string, size: int, expired_at: string, is_site_transient: bool}> Array of expired transient data.
	 */
	public function get_expired_transients( array $exclude_patterns = array() ): array {
		// If using external object cache, we can't get expired transients.

thinking
**Evaluating implementation steps**

I’m considering the need for stronger rate limiting and nonce mechanisms, but it seems like rate limiting might not even be in use since check_permissions isn't set as permission_callback for some endpoints. However, it looks like it is being used. I wonder if the spec expects us to create any missing tests? I’ll make sure to run npm tests. Let's update the plan: I’ll read through the spec and mark that part as completed before moving on to implementation.
Plan update
  ✓ Read spec and handoff
  → Implement required changes
  • Run lint and tests
  • Summarize and hand off

thinking
**Evaluating endpoint sanitization**

I need to implement changes and evaluate each endpoint for missing sanitization. I'll systematically check all controllers for any route arguments that could pose a risk. 

The RestController's base register_routes offers default endpoints that might not be in use. The ActivityController appears to use get_collection_params with sanitize and validate callbacks, which is good. 

However, I need to look into the DashboardController's get_activity_params method to ensure it's properly sanitizing inputs as well. It’ll help to use a search tool for that.
exec
/bin/zsh -lc 'rg -n "get_activity_params" -n includes/REST/DashboardController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
135:					'args'                => $this->get_activity_params(),
716:	public function get_activity_params() {
exec
/bin/zsh -lc "sed -n '700,780p' includes/REST/DashboardController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 54ms:
			"SELECT created_at FROM {$table_name}
			WHERE items_cleaned > 0
			ORDER BY created_at DESC
			LIMIT 1"
		);

		return $last_date;
	}

	/**
	 * Get activity endpoint parameters.
	 *
 * @since 1.0.0
 *
	 * @return array Collection parameters.
	 */
	public function get_activity_params() {
		return array(
			'page'     => array(
				'description'       => __( 'Current page of the collection.', 'wp-admin-health-suite' ),

thinking
**Evaluating rate limiting implementation**

I'm considering the specifications around implementing rate limiting. They suggest we should have an option to disable it, but that might not be necessary. I need to check the settings field definition, possibly in the domain file, to understand better how everything fits together. It seems there might be a search for something called rest_api_rate_limit that could give me some clarity. I'll look into it!
exec
/bin/zsh -lc 'rg -n "rest_api_rate_limit" -S includes | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
includes/REST/RestController.php:337:		$rate_limit = $settings->get_rest_api_rate_limit();
includes/Contracts/SettingsInterface.php:95:	public function get_rest_api_rate_limit(): int;
includes/Settings/SettingsRegistry.php:222:	public function get_rest_api_rate_limit(): int {
includes/Settings/SettingsRegistry.php:223:		return absint( $this->get_setting( 'rest_api_rate_limit', 60 ) );
includes/Settings/Domain/AdvancedSettings.php:56:			'rest_api_rate_limit' => array(
exec
/bin/zsh -lc "sed -n '1,120p' includes/Settings/Domain/AdvancedSettings.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Advanced Settings
 *
 * Advanced plugin settings including REST API, debug, and security.
 *
 * @package WPAdminHealth\Settings\Domain
 */

namespace WPAdminHealth\Settings\Domain;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Class AdvancedSettings
 *
 * Manages advanced plugin settings.
exec
/bin/zsh -lc 'rg -n "function get_posts_with_most_revisions" -S includes | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
includes/Database/RevisionsManager.php:446:	public function get_posts_with_most_revisions( int $limit = 10 ): array {
includes/Contracts/RevisionsManagerInterface.php:84:	public function get_posts_with_most_revisions( int $limit = 10 ): array;
exec
/bin/zsh -lc "sed -n '446,540p' includes/Database/RevisionsManager.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
	public function get_posts_with_most_revisions( int $limit = 10 ): array {
		$limit = absint( $limit );
		if ( $limit < 1 ) {
			$limit = 10;
		}

		$posts_table = $this->connection->get_posts_table();

		$query = $this->connection->prepare(
			"SELECT
				p.ID as post_id,
				p.post_title,
				p.post_type,
				COUNT(r.ID) as revision_count
			FROM {$posts_table} p
			INNER JOIN {$posts_table} r ON p.ID = r.post_parent
			WHERE r.post_type = %s
			GROUP BY p.ID
			ORDER BY revision_count DESC
			LIMIT %d",

thinking
**Assessing data sanitization risks**

I'm working with `get_posts_with_most_revisions`, which returns various data like `post_title` and `revision_count`. We can handle HTML sanitization in the REST response. In some controllers, we should probably return results as is, but that could pose a risk. I’ll sanitize `post_title` using `sanitize_text_field`, and ensure we apply other sanitizations appropriately. I need to check if other data sources, like `MediaAnalysis`, return sensitive file paths. I’ll gather more details on that.
exec
/bin/zsh -lc 'rg -n "function find_large_files" -S includes | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
includes/Media/Scanner.php:730:	public function find_large_files( $min_size_mb ) {
includes/Media/LargeFiles.php:142:	public function find_large_files( ?int $threshold_kb = null ): array {
includes/Contracts/LargeFilesInterface.php:35:	public function find_large_files( ?int $threshold_kb = null ): array;
exec
/bin/zsh -lc "sed -n '142,240p' includes/Media/LargeFiles.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
	public function find_large_files( ?int $threshold_kb = null ): array {
		if ( null === $threshold_kb ) {
			$threshold_kb = $this->default_threshold_kb;
		}

		$threshold_bytes = $threshold_kb * 1024;
		$large_files     = array();
		$batch_offset    = 0;
		$posts_table     = $this->connection->get_posts_table();

		while ( true ) {
			$query = $this->connection->prepare(
				"SELECT ID FROM {$posts_table}
				WHERE post_type = %s
				LIMIT %d OFFSET %d",
				'attachment',
				$this->batch_size,
				$batch_offset
			);

exec
/bin/zsh -lc 'rg -n "class Optimizer" -S includes/Database | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
includes/Database/Optimizer.php:28:class Optimizer implements OptimizerInterface {
exec
/bin/zsh -lc "sed -n '1,220p' includes/Database/Optimizer.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
<?php
/**
 * Database Optimizer Class
 *
 * Optimizes and repairs WordPress database tables.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Database;

use WPAdminHealth\Contracts\OptimizerInterface;
use WPAdminHealth\Contracts\ConnectionInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**



thinking
**Identifying potential issues in optimization**

I'm reviewing the Optimizer's functionality. It returns a table of names and other details, but there's a possible issue with the REST controller not handling the new format properly. The `OptimizationController` is pulling data from the optimizer, which currently returns an array of arrays, but the controller expects a string list. This seems like a bug, especially if it affects endpoints. I wonder if there’s a different optimizer class or if the method has changed without an update to the controller.
thinking
**Assessing potential bugs in production**

If the plugin is in production, it might be generating warnings or failing, which raises concerns since the user wants the spec implemented fully. The security review could involve verifying outputs, which might touch on the bug I've found. While I should be cautious about fixing unrelated bugs, this one is relevant to the REST endpoint and may need addressing. Yet, I also worry that changes could lead to test failures. I’ll look into the code for the `DatabaseController`, which might return similar arrays, indicating a need for consistency in the `OptimizationController`.
thinking
**Aligning with optimizer output**

I’m planning to update to align with the new optimizer output to ensure correctness, not just security. While the spec might not explicitly require updates related to security, output sanitization is crucial. A broken endpoint could complicate this, so I need to check the `OptimizerInterface` for the expected return format. Ensuring that all outputs are correct and properly sanitized is important for the integrity of the system.
exec
/bin/zsh -lc "sed -n '1,140p' includes/Contracts/OptimizerInterface.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
<?php
/**
 * Optimizer Interface
 *
 * Defines the contract for database optimization operations.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface OptimizerInterface
 *
 * Contract for database table optimization operations.


thinking
**Evaluating optimization and security**

In the OptimizerInterface documentation, the `get_tables_needing_optimization` function mentions returning an array of arrays with names and sizes. So, it seems there could be a bug related to this endpoint. The `optimize_table` method signature also appears to deviate from the implementation by returning different data. There might be issues if the interface isn't up to date. We should fix the `get_tables_needing_optimization` function accordingly while ensuring minimal changes. Lastly, we need to be cautious about arrays accepted by some endpoints to prevent memory issues.
thinking
**Considering input validation and resource limits**

I’m thinking about the rate limit and the maximum of 100 items per page. When it comes to arrays of IDs, it might be wise to limit their length, too, to avoid excessive resource usage, while keeping safety in mind. Aligning with the specifications, implementing input validation for a max length, maybe 100, could be beneficial, but I wonder if that might break something. Next, I’ll check `MediaCleanupController.php` for the `get_exclusions` output to inspect it further.
exec
/bin/zsh -lc 'rg -n "function get_exclusions|function add_exclusions|function remove_exclusion" includes/REST/Media/MediaCleanupController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
402:	public function get_exclusions( $request ) {
440:	public function add_exclusions( $request ) {
479:	public function remove_exclusion( $request ) {
exec
/bin/zsh -lc "sed -n '380,560p' includes/REST/Media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
			);
		}

		// Log to activity.
		$this->log_activity( 'media_restore', $result );

		return $this->format_response(
			true,
			$result,
			$result['message']
		);
	}

	/**
	 * Get all exclusions.
	 *
	 * @since 1.0.0
	 * @since 1.3.0 Moved to MediaCleanupController.
	 *
	 * @param WP_REST_Request $request Full details about the request.

thinking
**Investigating exclusions**

I'm thinking about whether exclusions include a reason. It seems like they merge with the $exclusion array. I need to check the ExclusionsInterface output to see if that’s the case, and I might need to inspect the Exclusions class for more information. Let’s search for details to clarify this further!
exec
/bin/zsh -lc 'rg -n "class Exclusions" -S includes | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
includes/Media/Exclusions.php:25:class Exclusions implements ExclusionsInterface {
exec
/bin/zsh -lc "sed -n '1,240p' includes/Media/Exclusions.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Media Exclusions Manager Class
 *
 * Manages media items excluded from cleanup suggestions.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Media;

use WPAdminHealth\Contracts\ExclusionsInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Media Exclusions manager for handling items excluded from scans and cleanup.





thinking
**Examining code testing and controllers**

I'm looking at the tasks, which include running `npm run lint` and `npm test`. While these might focus on JavaScript, our changes are in PHP, so testing may not be necessary. However, I’ll still proceed with the tests as requested.

I should check if there are existing tests for PHP or JavaScript. Also, opening the other controllers could reveal some issues. The monolithic MediaController might be active, potentially causing duplicates; it’s better to update both versions for security. That ensures whatever gets called will be safe and functional.
thinking
**Analyzing route registration and endpoints**

I’m examining the order of controller registrations: database_controller, media_controller, dashboard_controller, and others. When duplicates occur for routes like /media/unused, the first registration from MediaController will set the route, while any subsequent registrations that use the same path might be ignored. 

It looks like the WP REST server will call the first matching endpoint, so the actual route will use MediaController’s callback instead of MediaAnalysisController, suggesting that some modular controllers might not be used after all. This could potentially lead to dead code.
thinking
**Assessing endpoint duplicates and security**

I’m noticing duplicates again, likely with MediaController being the first registered. The active endpoints are primarily from MediaController, including various media actions like alt-text, scan, delete, and restore. Although modular controllers may hold similar functionalities, we still need to ensure MediaController's security.

Interestingly, DatabaseController and its new cleanup features don’t conflict, so both can coexist. I’ll need to address security issues for both old and new controllers. I want to check for any route arguments in monolithic controllers, such as PerformanceController, that may lack proper sanitation or validation.
thinking
**Planning security updates**

I’m considering the legacy RestApi class; it might still be in use, but I'm not certain if we should update it. The spec indicates all endpoints should be reviewed for security, so I'll focus on the monolithic PerformanceController, even if it's not explicitly registered, to ensure it is secure.

I’ll prioritize updating QueryAnalysisController since it's registered and needs missing sanitize callbacks addressed. I'll also ensure proper sanitization for MediaHelper output and DashboardController, as well as validating arguments in AutoloadController. I may also enhance nonce verification in RestController and implement strict capability checks for read-only endpoints. Alright, let’s outline these modifications!
thinking
**Enhancing nonce verification and sanitization**

I’m looking to improve nonce verification by accepting both the 'X-WP-Nonce' header and '_wpnonce' request parameter. I’ll validate these using `wp_verify_nonce` and sanitize with `sanitize_text_field`. Error codes like `rest_missing_nonce` are also necessary.

Next, I want to update the DashboardController to sanitize the `created_at` field. Then, for MediaHelper, I'll sanitize fields like title, filename, and URLs using appropriate functions like `sanitize_text_field` and `esc_url_raw`.

For DatabaseController and TableAnalysisController, I’ll create a method to sanitize revision rows. I’ll also ensure to sanitize excluded fields in MediaCleanupController and avoid exposing sensitive user IDs.

In QueryAnalysisController, I won’t return raw SQL by default; instead, I’ll provide safe fields and implement methods to handle query types properly, while ensuring conditional debugging outputs based on user permissions. Sounds like a solid plan!
exec
/bin/zsh -lc 'rg -n "function get_monitoring_status" -S includes/Performance/QueryMonitor.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
754:	public function get_monitoring_status(): array {
exec
/bin/zsh -lc "sed -n '754,820p' includes/Performance/QueryMonitor.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
	public function get_monitoring_status(): array {
		return array(
			'query_monitor_active' => $this->is_query_monitor_active(),
			'savequeries_enabled'  => defined( 'SAVEQUERIES' ) && SAVEQUERIES,
			'monitoring_enabled'   => $this->is_monitoring_enabled(),
			'default_threshold'    => self::DEFAULT_THRESHOLD,
			'log_ttl_days'         => self::LOG_TTL / DAY_IN_SECONDS,
		);
	}

	/**
	 * Check if monitoring is enabled.
	 *
	 * @return bool True if monitoring is enabled.
	 */
	private function is_monitoring_enabled() {
		return $this->is_query_monitor_active() || ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
	}
}

thinking
**Reviewing unit tests**

As part of the security review, I'm considering the addition of some unit tests for REST controllers. I see there's a tests folder, so I'll check what's already there. It seems like the `tests` directory might include PHP files, so I’ll need to take a closer look at the existing tests. Let's make a list to see what I have to work with!
exec
/bin/zsh -lc "ls -R tests | sed -n '1,200p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
bootstrap-standalone.php
bootstrap.php
factories
integration
IntegrationTest.php
Mocks
README.md
StandaloneTestCase.php
TestCase.php
unit
unit-standalone

tests/factories:
AttachmentFactory.php
CommentFactory.php
PostFactory.php

tests/integration:
RestApiTest.php

exec
/bin/zsh -lc "sed -n '1,260p' tests/integration/RestApiTest.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
<?php
/**
 * REST API Tests
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Tests;

use WP_REST_Request;
use WP_REST_Server;
use WPAdminHealth\REST\REST_Controller;

/**
 * Test REST API endpoints.
 *
 * Tests authentication, response format, pagination, actions,
 * rate limiting, and HTTP status codes.
 */
class RestApiTest extends TestCase {

thinking
**Investigating REST_Controller**

I'm checking this RestApiTest that refers to `WPAdminHealth\REST\REST_Controller`. They’re using `use WPAdminHealth\REST\REST_Controller;`, but our base class is `RestController`, not `REST_Controller`. That makes me wonder if the tests could be outdated. I think I should inspect the includes under REST to see if there is a class named `REST_Controller`. It’s important to confirm this and get things lined up correctly! I'm curious what I'll find.
exec
/bin/zsh -lc 'rg -n "class REST_Controller" -S includes | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:

exec
/bin/zsh -lc 'cat package.json' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
{
  "name": "wp-admin-health-suite",
  "version": "1.0.0",
  "description": "A comprehensive suite for monitoring and maintaining WordPress admin health and performance",
  "scripts": {
    "build": "webpack --mode production",
    "build:dev": "webpack --mode development",
    "watch": "webpack --mode development --watch",
    "dev": "webpack serve --mode development --open",
    "lint": "eslint assets/js --ext .js,.jsx",
    "lint:fix": "eslint assets/js --ext .js,.jsx --fix",
    "format": "prettier --write \"**/*.{js,jsx,json,css,scss,md}\"",
    "format:check": "prettier --check \"**/*.{js,jsx,json,css,scss,md}\"",
    "test": "jest --passWithNoTests",
    "prepare": "husky"
  },
  "keywords": [
    "wordpress",
    "plugin",
    "health",





thinking
**Planning PHP modifications**

I'm looking into the testing framework, which is Jest for JS, but our changes are in PHP. I know we should run lint/tests, even if they don't cover everything. It's important that the modifications don't break JS lint.

Now, I need to implement these changes step by step, starting with the RestController. I'll change `verify_nonce` to accept the `_wpnonce` parameter and adjust the visibility of `can_view_detailed_debug` and `get_query_type` methods from private to protected—those should be fine for wider access.
thinking
**Modifying nonce handling**

I’m considering modifying the `verify_nonce` method to accept `_wpnonce` and ensure it sanitizes the input. I’ll locate this method in `RestController.php` to apply the necessary patch.  

I also need to sanitize the nonce retrieved from headers using `sanitize_text_field(wp_unslash($nonce))`, while also checking if it's needed since it comes from the header. For the `$request->get_param('_wpnonce')`, I should sanitize it as well.  

Additionally, I'll allow the `X-WP-Nonce` header to accept lower-case and treat it case-insensitively. Finally, I’ll change `can_view_detailed_debug` from private to protected to enhance access.
thinking
**Updating query handling**

I'm thinking about updating the `get_query_type` method to become a protected function and adjusting the docblocks accordingly. Although this method is only used in the `RestController`, I plan to access it in `QueryAnalysisController` as well. 

I will change its visibility from private to protected, but I don’t think there will be naming conflicts. Additionally, I might add a new method for sanitizing output.

For the `can_view_detailed_debug` method, it checks the `WPHA_DEBUG` constant and `manage_network` on multisite. I might consider allowing a plugin setting to control debug mode. I note that `format_response` includes debug info if `is_debug_mode_enabled`, but detailed timing relies on `can_view_detailed_debug` and other conditions.
thinking
**Setting query visibility rules**

To view query timings, it looks like we need debug_mode enabled along with the `WPHA_DEBUG` constant and possibly `manage_network`, which feels quite strict. For the `QueryAnalysisController`, I think I want to show actual queries only when both debug_mode and `can_view_detailed_debug` are enabled. 

Currently, `can_view_detailed_debug` checks only the constant, which could be fine. However, to prevent potential data leaks, I might decide to require both. It's simpler to show raw queries when `can_view_detailed_debug` is true, but including debug_mode as an added requirement seems prudent. This will help maintain clarity on when query data is visible to users.
thinking
**Implementing security measures for query analysis**

It seems I should require both debug mode and detailed debug access to view sensitive debug data. I’m thinking of implementing a method in `RestController` to handle this. Instead, I could combine checks in `QueryAnalysisController` for ease, since it uses the protected method to determine debug mode access.

Next, I’ll focus on constructing `$slow_queries` within `get_query_analysis`. I’ll rewrite the loop to check if query details should be included, and sanitize outputs, especially for the `caller`. 

I want to avoid leaking raw SQL but might allow some visibility into query types. Given that the UI may expect the `query` field, I need to confirm this doesn’t break existing functionality. It’s important to check the JS assets for references to “performance/queries” or “slow_queries.”
exec
/bin/zsh -lc 'rg -n "performance/queries|slow_queries|query_analysis" assets/js -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
assets/js/performance.js:219:						data.slow_queries && data.slow_queries.length > 0
assets/js/performance.js:223:									data.slow_queries.map((query, index) =>
assets/js/performance.js:664:					apiFetch({ path: '/wpha/v1/performance/queries' }),
exec
/bin/zsh -lc "sed -n '180,280p' assets/js/performance.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
	 * Query Analysis Component
	 * @param root0
	 * @param root0.data
	 */
	function QueryAnalysis({ data }) {
		if (!data) {
			return wp.element.createElement(
				'p',
				null,
				'Loading query analysis...'
			);
		}

		return wp.element.createElement(
			'div',
			{ className: 'wpha-query-stats' },
			wp.element.createElement(
				'div',
				{ className: 'wpha-stat-item' },
				wp.element.createElement(





thinking
**Considering response shape**

The JavaScript expects specific elements like `query` and `caller` in `data.slow_queries`. If I remove those, the UI might show “undefined,” which would break it. I need to keep the response shape intact or update the front end accordingly. There are security considerations in returning full SQL queries; this could jeopardize sensitive information disclosures. However, using React’s `createElement` provides some protection against XSS since it escapes text by default. I need to decide carefully here about security and response content.
thinking
**Implementing specifications**

I need to ensure the specifications are implemented fully. Instead of removing queries, the intended fix might involve adding a missing nonce and rate limiting. The specification also requires output escaping, and while the UI does that, perhaps additional sanitization is needed. A workable approach could be to continue returning both `query` and `caller`, but in a sanitized format to remove sensitive information. This would help maintain UI functionality while ensuring security. I could show the redacted query in non-debug mode and provide a more detailed version in debugging situations.
thinking
**Redacting and sanitizing fields**

I can keep both the `query` and `caller` fields while ensuring they're properly redacted and sanitized. This way, I meet security needs without disrupting the UI. For redaction, I might replace quoted strings with `'?'` and substitute numbers with `?`. However, I need to be cautious, as redacting could affect usefulness. I should also limit paths like ABSPATH to reduce the risk of data leakage. Minimal redaction of user values, such as literals in WHERE clauses, seems like a good compromise to mitigate potential risks.
thinking
**Creating the SQL redaction function**

I'm planning to implement a function called `redact_sql($sql)` with several steps. First, I'll collapse whitespace for cleaner formatting and limit the query length to 500 characters. Then, I’ll replace single-quoted strings, double-quoted strings, and numbers with placeholders to ensure sensitive information is concealed while maintaining the structure of the query. I might also shorten the `caller` field to just the last part after ABSPATH. Adding a `query_hash` field to identify queries could enhance tracking. I’ll also sanitize the `caller` in `QueryAnalysisController`. This should help keep everything safe and tidy!
thinking
**Updating the sanitization process**

I'm considering using `str_replace` with paths like ABSPATH and WP_CONTENT_DIR to create relative paths by removing prefixes. This helps keep the output cleaner and ensures there are no newlines. For debugging, I want to determine if we can include a raw query, but the UI expects redacted queries. My idea is to provide the query redacted by default unless debug mode is active, then show the raw query. I’ll work on implementing functions that will properly sanitize both the caller and the query while limiting lengths and keeping the UI intact. Additionally, I need to ensure that any changes align with how the front end accesses these queries and maintains consistent output formatting.
exec
/bin/zsh -lc 'rg -n "created_at" assets/js -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
assets/js/components/ActivityTimeline.test.jsx:18:			created_at: '2024-01-01T12:00:00Z',
assets/js/components/ActivityTimeline.test.jsx:25:			created_at: '2024-01-02T14:30:00Z',
assets/js/components/ActivityTimeline.test.jsx:32:			created_at: '2024-01-03T10:15:00Z',
assets/js/components/ActivityTimeline.test.jsx:219:					created_at: '2024-01-01T12:00:00Z',
assets/js/components/ActivityTimeline.test.jsx:241:					created_at: '2024-01-01T12:00:00Z',
assets/js/components/ActivityTimeline.test.jsx:281:					created_at: '2024-01-01T12:00:00Z',
assets/js/components/ActivityTimeline.test.jsx:301:					created_at: '2024-01-01T12:00:00Z',
assets/js/components/ActivityTimeline.jsx:443:									dateTime={activity.created_at}
assets/js/components/ActivityTimeline.jsx:445:									{getRelativeTime(activity.created_at)}
exec
/bin/zsh -lc "sed -n '420,480p' assets/js/components/ActivityTimeline.jsx" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
											{activity.items_cleaned}{' '}
											{activity.items_cleaned === 1
												? 'item'
												: 'items'}{' '}
											affected
										</span>
									)}
									{activity.bytes_freed > 0 && (
										<span style={detailItemStyles}>
											<span
												className="dashicons dashicons-cloud"
												style={{
													fontSize: '14px',
													color: '#2271b1',
												}}
											/>
											{formatBytes(activity.bytes_freed)}{' '}
											freed
										</span>
									)}

thinking
**Clarifying timestamp formats**

I need to ensure that the ActivityTimeline uses the created_at timestamp in ISO string format (rfc3339). The tests utilize '2024-01-01T12:00:00Z', and it seems that ActivityController already handles this conversion. However, the DashboardController's get_activity function currently returns a MySQL string format (like '2026-01-16 09:...'). I wonder if the UI is parsing that to create relative time, possibly using date-fns? I’ll check the getRelativeTime function and look for parse in the same file.
exec
/bin/zsh -lc 'rg -n "function getRelativeTime" -n assets/js/components/ActivityTimeline.jsx' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 1 in 53ms:

exec
/bin/zsh -lc "rg -n \"getRelativeTime\\(\" assets/js/components/ActivityTimeline.jsx assets/js -S | head" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 56ms:
assets/js/components/ActivityTimeline.jsx:445:									{getRelativeTime(activity.created_at)}
assets/js/components/ActivityTimeline.jsx:445:									{getRelativeTime(activity.created_at)}
exec
/bin/zsh -lc "sed -n '1,120p' assets/js/components/ActivityTimeline.jsx" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
/**
 * Activity Timeline Component
 *
 * A React component that displays recent activity from the scan history.
 * Fetches from REST endpoint and shows the last 10 activities with icons,
 * descriptions, and formatted data.
 *
 * @package
 */

import React, { useState, useEffect } from 'react';

/**
 * Activity type to icon mapping
 */
const ACTIVITY_ICONS = {
	database_clean: 'dashicons-database',
	media_scan: 'dashicons-format-image',
	optimization: 'dashicons-performance',
	scheduled_task: 'dashicons-clock',


thinking
**Fixing date formatting**

I'm considering how to create a Date object from a date string and subtracting from the current time. JS Date can parse ISO formats, but it might not reliably handle 'YYYY-MM-DD HH:MM:SS' since it could treat it as local time. To ensure compatibility, I think converting created_at to RFC3339 is good, but I need to confirm that mysql_to_rfc3339 function is available and won't break anything. 

I also need to check other endpoints like MediaHelper for date formats and ensure that linter and tests pass.
thinking
**Implementing PHP modifications**

I'm planning to implement modifications across various PHP files step-by-step using apply_patch. 

First, I'll start with the changes in includes/REST/RestController.php. I need to add a fallback and sanitize the verify_nonce function. Also, I want to change the visibility of can_view_detailed_debug and get_query_type to protected. 

So, my next step will be to apply these changes in the code accordingly. I'll ensure everything aligns well!
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/RestController.php
@@ -298,2 +298,8 @@
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
@@ -561,3 +567,3 @@
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
@@ -583,3 +589,3 @@
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
apply_patch(auto_approved=true) exited 0 in 22ms:
Success. Updated the following files:
M includes/REST/RestController.php
file update:
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Patching status settings**

I should note that `$can_capture` is currently based on `status['monitoring_enabled']`. If that's not the case, then it relies on `SAVEQUERIES`, which we’ll keep in mind. The `savequeries` key is presently set to `$can_capture`, and the UI uses `data.savequeries` to decide whether to display slow queries, which needs to be a boolean. So, I think my next step is to make the necessary patch to the file.
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Performance/QueryAnalysisController.php
@@ -105,2 +105,6 @@
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
@@ -112,6 +116,11 @@
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
@@ -119,3 +128,3 @@
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
@@ -156,2 +165,76 @@
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
apply_patch(auto_approved=true) exited 0 in 31ms:
Success. Updated the following files:
M includes/REST/Performance/QueryAnalysisController.php
file update:
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );



thinking
**Updating code components**

I'm noticing that the QueryAnalysisController has new methods since version 1.6.1, and I’m questioning if the plugin version is actually 1.0.0. It might not be crucial, but I want to align with the existing version. The plugin has at least 1.6.0 in MediaHelper, making 1.6.1 a valid option. I'll also ensure we’re using functions like `sanitize_text_field` and `preg_replace`. Additionally, we've made `can_view_detailed_debug` and `is_debug_mode_enabled` protected, so they’re accessible, and I’ll update the DashboardController accordingly.
thinking
**Updating activity data sanitization**

In the `get_activity` function of the DashboardController, I'm seeing that the `created_at` field isn't being sanitized when returned through `array_map`. We need to update this, similar to the ActivityController, using `sanitize_text_field` and converting it to RFC3339 if the `mysql_to_rfc3339` function is available. 

I’ve noticed the snippet shows how `formatted_activities` are structured, so I’ll implement the same sanitization for `created_at` as well. Additionally, items like `items_found` should be processed with `absint`. Let’s patch these accordingly!
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/DashboardController.php
@@ -327,2 +327,10 @@
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
@@ -330,6 +338,6 @@
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
apply_patch(auto_approved=true) exited 0 in 37ms:
Success. Updated the following files:
M includes/REST/DashboardController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Updating Media Helper Output**

I'm focusing on updating the MediaHelper output sanitization in the MediaHelper.php file. The get_attachment_details function returns several elements like id, title, and filename. For sanitization, I'll apply `sanitize_text_field` to the title and potentially the filename, but I'm considering that it could have non-ASCII characters. I’ll also sanitize the `$mime_type` using `sanitize_mime_type`, while ensuring to handle potential null values. For URLs and links, I’ll use `esc_url_raw`. Lastly, I might convert the date to RFC3339 format if the function is available, which could help ensure consistency. I'll need to check if the UI uses this date format.
exec
/bin/zsh -lc "rg -n \"\\.date\\b|\\bdate\\b\" assets/js/media -S 2>/dev/null || true" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 67ms:

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Searching for assets**

I'm thinking about checking the assets, particularly in the `js` folder, maybe looking into `media.js`. I should search for terms like `thumbnail_url` or `file_size_formatted`. These elements seem key to whatever I’m working on, so it’s essential to find them. I'm curious to see what I’ll uncover while looking into these specific attributes! It could provide valuable insights or help me piece together what I'm trying to accomplish.
exec
/bin/zsh -lc "rg -n \"file_size_formatted|thumbnail_url|edit_link|mime_type|filename\\b\" assets/js -S | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 61ms:
assets/js/media-audit.js:363:						(item.filename || '').toLowerCase().includes(search) ||
assets/js/media-audit.js:456:				item.thumbnail || item.thumbnail_url || item.url || '';
assets/js/media-audit.js:457:			const mimeType = item.mime_type || '';
assets/js/media-audit.js:483:			html += '<td class="wpha-col-filename">';
assets/js/media-audit.js:486:				this.escapeHtml(item.filename || item.title || 'Untitled') +
assets/js/media-audit.js:580:				this.escapeHtml(group.filename || 'Unnamed Group') +
assets/js/media-audit.js:595:					item.thumbnail || item.thumbnail_url || item.url || '';
assets/js/media-audit.js:614:					'<p class="wpha-duplicate-filename">' +
assets/js/media-audit.js:615:					this.escapeHtml(item.filename) +
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Evaluating media audit considerations**

I’m looking into how the media audit in JS uses `escapeHtml` for rendering. This means server-side sanitization isn't absolutely critical, but it's still a good practice. I wonder if they might also utilize date functionalities or something similar. I think it would be helpful to check the media-audit documentation for a clearer understanding. Overall, it's a balance of good practices and the specific needs of the system!
exec
/bin/zsh -lc "rg -n \"item\\.date|created_at|uploaded\" assets/js/media-audit.js -S" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 35ms:
510:					this.formatDate(item.date) +
515:					this.formatDate(item.date) +
623:					this.formatDate(item.date) +
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "sed -n '460,540p' assets/js/media-audit.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:

			let html = '<tr data-id="' + item.id + '">';
			html += '<td class="wpha-col-checkbox">';
			html +=
				'<input type="checkbox" class="wpha-item-checkbox" data-id="' +
				item.id +
				'" ' +
				(isChecked ? 'checked' : '') +
				' />';
			html += '</td>';

			html += '<td class="wpha-col-preview">';
			if (isImage && previewUrl) {
				html +=
					'<img class="wpha-lazy-preview" data-src="' +
					previewUrl +
					'" alt="" width="50" height="50" />';
			} else {
				html +=
					'<span class="dashicons dashicons-media-default"></span>';
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Checking date formatting**

Alright, it looks like formatDate probably expects the date in a way that's parseable by the Date object. In the MediaHelper, the date comes from $post->post_date, which is in MySQL format. Their JavaScript likely uses new Date to handle it. I should check the implementation of formatDate to confirm how it works, so let’s do a search in the file to see what I can find about it!
exec
/bin/zsh -lc "rg -n \"formatDate\\(\" assets/js/media-audit.js -n | head -n 20" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
243:				? this.formatDate(data.last_scan)
510:					this.formatDate(item.date) +
515:					this.formatDate(item.date) +
623:					this.formatDate(item.date) +
1140:		formatDate(dateString) {
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "sed -n '1120,1185p' assets/js/media-audit.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
		/**
		 * Format bytes to human readable.
		 * @param bytes
		 */
		formatBytes(bytes) {
			if (bytes === 0) return '0 Bytes';
			const k = 1024;
			const sizes = ['Bytes', 'KB', 'MB', 'GB'];
			const i = Math.floor(Math.log(bytes) / Math.log(k));
			return (
				Math.round((bytes / Math.pow(k, i)) * 100) / 100 +
				' ' +
				sizes[i]
			);
		},

		/**
		 * Format date.
		 * @param dateString
		 */
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)


thinking
**Updating date formatting**

I'm looking at how to parse date strings with `new Date(dateString)`. While parsing 'YYYY-MM-DD HH:MM:SS' could work, it might vary across browsers. So, using ISO format seems like a better choice. For the `post_date`, I can convert it to RFC3339 format in `MediaHelper`, which would be a nice improvement. I also noticed the `last_scan` in `MediaAnalysisController` pulls from `last_results['scanned_at']`, which might also benefit from this RFC3339 change. Lastly, I’ll check the `file_size_formatted` and update everything in `MediaHelper` as needed.
thinking
**Patching media handling**

I’m looking over the pseudo code, starting with the title and date retrieval. The title gets sanitized, which is great. For the date, if it’s valid, I want to convert it using `mysql_to_rfc3339`, ensuring it returns the proper format. The MIME type is also sanitized, but it could be empty if the MIME type is invalid, which is a good safeguard. I need to confirm that the `type` returned by `get_media_type` matches expected values like 'document', 'image', and others. I think I’ll sanitize it with `sanitize_key` before finalizing these changes.
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Media/MediaHelper.php
@@ -107,2 +107,3 @@
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
@@ -123,2 +124,3 @@
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
@@ -126,7 +128,16 @@
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
@@ -135,3 +146,3 @@
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
@@ -140,3 +151,3 @@
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
@@ -147,3 +158,3 @@
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
apply_patch(auto_approved=true) exited 0 in 41ms:
Success. Updated the following files:
M includes/REST/Media/MediaHelper.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Considering code refinement**

I’m thinking it’s better to build an exclusion array with keys like 'attachment_id', 'excluded_at', 'reason', and 'excluded_by'. I might also incorporate other keys while keeping the existing ones. This approach seems to merge useful details and add 'excluded_by_name' as well. However, I should make sure that the front-end can still access 'excluded_at' and related data. I’ll have to search the JavaScript for 'excluded_by_name' to see how it’s being implemented.
exec
/bin/zsh -lc 'rg -n "excluded_by_name|exclusions" assets/js -S | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 99ms:

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Exploring media audit options**

I’m considering checking the admin pages related to media. It might be a PHP template. I wonder if the media audit uses REST endpoints like /media/exclusions. It could potentially display in the UI. I’ll search for "exclusions" in the assets/js/media-audit.js file to see what it reveals. There’s a good chance I can find the information I’m looking for there!
exec
/bin/zsh -lc 'rg -n "exclusions" assets/js/media-audit.js -S | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 64ms:

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc 'rg -n "media/exclusions" assets/js -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 1 in 60ms:

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Considering conflicting keys**

I think we should avoid any conflicting keys, like having 'id' in details and a separate 'attachment_id.' If 'attachment_id' is 0, I wonder if we should skip it, but I might still include it. The details could be for when attachment_id is 0, as MediaHelper uses get_post, so it's better to only include valid ones. We’ll also check exclusions to make sure we have valid attachments. Alright, let's get to patching!
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Media/MediaCleanupController.php
@@ -407,10 +407,26 @@
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
apply_patch(auto_approved=true) exited 0 in 51ms:
Success. Updated the following files:
M includes/REST/Media/MediaCleanupController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
Reconnecting... 2/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/MediaController.php
@@ -994,10 +994,26 @@
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
apply_patch(auto_approved=true) exited 0 in 56ms:
Success. Updated the following files:
M includes/REST/MediaController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/DatabaseController.php
@@ -305,2 +305,6 @@
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
@@ -308,3 +312,3 @@
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
@@ -319,2 +323,29 @@
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
apply_patch(auto_approved=true) exited 0 in 62ms:
Success. Updated the following files:
M includes/REST/DatabaseController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Database/TableAnalysisController.php
@@ -212,2 +212,6 @@
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
@@ -215,3 +219,3 @@
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
@@ -226,2 +230,29 @@
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
apply_patch(auto_approved=true) exited 0 in 71ms:
Success. Updated the following files:
M includes/REST/Database/TableAnalysisController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Database/CleanupController.php
@@ -185,2 +185,3 @@
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
apply_patch(auto_approved=true) exited 0 in 71ms:
Success. Updated the following files:
M includes/REST/Database/CleanupController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Performance/HeartbeatController.php
@@ -83,2 +83,3 @@
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
apply_patch(auto_approved=true) exited 0 in 77ms:
Success. Updated the following files:
M includes/REST/Performance/HeartbeatController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Updating controller options**

I need to update the AutoloadController's option_name to add a validate_callback. This should be included in the register_routes `args` for option_name. I’m also thinking that a sanitize_callback might already be in place, so I’ll mention that. It sounds like this patch should help ensure everything works smoothly. Just need to make sure I’m communicating clearly about these updates! Let’s patch this appropriately.
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Performance/AutoloadController.php
@@ -93,2 +93,3 @@
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
apply_patch(auto_approved=true) exited 0 in 79ms:
Success. Updated the following files:
M includes/REST/Performance/AutoloadController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );





Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
Reconnecting... 2/5 (stream disconnected before completion: Transport error: network error: error decoding response body)



thinking
**Checking controllers and sanitization**

I'm looking for any missing validate callbacks in the controllers, specifically for sanitization. I noticed that the Performance/PluginProfilerController has no arguments. The Media Cleanup has reasons and validate callbacks, which is good. Similarly, the Dashboard quick action uses a validate callback.

Now, it’s time to fix the bug in the OptimizationController and ensure the output is sanitized. The get_tables_needing_optimization function retrieves tables, and I’ll process their details properly to avoid issues.
thinking
**Mapping table details safely**

Instead of getting into the complexity, I can map through the `$tables` array directly. For each table, if it’s not an array, I’ll just continue. I can grab the `name`, `overhead`, `data_size`, `engine`, and check if it's large based on the `LARGE_TABLE_THRESHOLD`.

However, I know the interface documentation mentions that each table array includes fields like `name` and `overhead`, while the implementation adds `engine` and `is_large`. To ensure compatibility, it might be best to stick with only `table_name` and `overhead` for now, as adding new fields could cause issues in the front-end if it only expects those. It’s safer to keep it simple!
thinking
**Checking front-end endpoint usage**

I need to verify the front-end usage of the `/database/optimization/tables` endpoint. To do this, I’ll search the assets in the `js` folder for instances of "optimization/tables." This will help me understand how the front-end interacts with this endpoint and if any adjustments are necessary for compatibility. It’s essential to ensure that whatever changes I make to the backend won’t disrupt the front-end functionality. Let’s see what I find!
exec
/bin/zsh -lc 'rg -n "database/optimization|optimization/tables" assets/js -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 1 in 68ms:

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc 'rg -n "optimization/tables" -S admin includes templates assets/js | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
includes/REST/Database/OptimizationController.php:74:		// GET /wpha/v1/database/optimization/tables - Get tables needing optimization.
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Optimizing tables**

I see there's no usage of the endpoint yet, but it should work. That’s good news since we can fix everything without any concern. I think I also need to consider optimizing and repairing tables, ensuring that table names are sanitized from the request. Let's patch the function that retrieves tables needing optimization and make sure to sanitize the output for table names, which aligns with the specification for output escaping and input sanitization. I'll get on that!
Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)


thinking
I’m thinking we shouldn’t include any front-end references yet since they might not be ready. I need to be careful not to break any tests while making adjustments. It’s probably fine, but I want to ensure we're fixing things to use returned arrays. I’ll also need to patch the function for table optimization and sanitize the table names and engine. That means updating the OptimizationController file accordingly. Let's get to it!
thinking
I’m implementing this code to optimize tables needing attention. First, I’ll retrieve the tables and create an array for their details. For each table, if it’s an array, I’ll grab the name, sanitize it, and skip if it’s empty. Then, I’ll collect details like overhead, data size, engine, and whether it’s large. If it’s a string for backward compatibility, I’ll sanitize the name, get the overhead, and add that to the details. Also, I need to remember that `get_table_overhead` returns an integer or false, so I’ll use `absint` for safety. Let's patch it together!
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Database/OptimizationController.php
@@ -146,6 +146,29 @@
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
apply_patch(auto_approved=true) exited 0 in 86ms:
Success. Updated the following files:
M includes/REST/Database/OptimizationController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "rg -n \"Plugin Impact|plugin_data|plugins\\b\" assets/js/performance.js -S | head -n 80" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 62ms:
52:	 * Plugin Impact Table Component
54:	 * @param root0.plugins
58:	function PluginImpactTable({ plugins, sortBy, onSort }) {
59:		if (!plugins || plugins.length === 0) {
67:		const sortedPlugins = [...plugins].sort((a, b) => {
655:					plugins,
663:					apiFetch({ path: '/wpha/v1/performance/plugins' }),
672:				setPluginData(plugins.data.plugins);
704:					plugins: pluginData,
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "sed -n '40,120p' assets/js/performance.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
				if (skeleton) skeleton.style.display = 'none';
				if (valueEl) {
					valueEl.textContent = score;
					valueEl.style.display = 'block';
				}
			}
		}, [score]);

		return null;
	}

	/**
	 * Plugin Impact Table Component
	 * @param root0
	 * @param root0.plugins
	 * @param root0.sortBy
	 * @param root0.onSort
	 */
	function PluginImpactTable({ plugins, sortBy, onSort }) {
		if (!plugins || plugins.length === 0) {
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
exec
/bin/zsh -lc 'rg -n "file_path|path" includes/Media/SafeDelete.php | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
72:	 * Performs final path validation immediately before deletion to prevent
77:	 * @param string $file_path The file to delete.
81:	private function safe_unlink( string $file_path, string $base_dir ): bool {
82:		// Final validation: Check path is still within allowed directory.
83:		if ( ! $this->is_path_within( $file_path, $base_dir ) ) {
89:		if ( is_link( $file_path ) ) {
94:		if ( ! file_exists( $file_path ) ) {
98:		// Final check: Verify real path is still within base directory.
99:		// realpath() resolves the actual path on disk at this exact moment.
100:		$real_path = realpath( $file_path );
101:		$real_base = realpath( $base_dir );
103:		if ( false === $real_path || false === $real_base ) {
107:		// Ensure the resolved path is still within the base directory.
108:		if ( strpos( $real_path . '/', rtrim( $real_base, '/' ) . '/' ) !== 0 ) {
112:		return @unlink( $file_path );
118:	 * Performs final path validation immediately before operation.
122:	 * @param string $source      Source file path.
123:	 * @param string $dest        Destination file path.
129:		// Final validation: Verify paths are within allowed directories.
130:		if ( ! $this->is_path_within( $source, $source_base ) ) {
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "rg -n \"prepare_deletion\\(\" -n includes/Media/SafeDelete.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
280:	public function prepare_deletion( array $attachment_ids ): array {
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "sed -n '280,420p' includes/Media/SafeDelete.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
	public function prepare_deletion( array $attachment_ids ): array {
		if ( empty( $attachment_ids ) ) {
			return array(
				'success' => false,
				'message' => 'No valid attachment IDs provided.',
			);
		}

		$prepared_items = array();
		$errors = array();

		foreach ( $attachment_ids as $attachment_id ) {
			$attachment_id = absint( $attachment_id );

			// Verify attachment exists.
			$post = get_post( $attachment_id );
			if ( ! $post || 'attachment' !== $post->post_type ) {
				$errors[] = sprintf( 'Attachment %d does not exist.', $attachment_id );
				continue;
			}
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
Reconnecting... 2/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
exec
/bin/zsh -lc 'rg -n "slow_queries" includes/REST -S' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 69ms:
includes/REST/Performance/QueryAnalysisController.php:110:		$slow_queries = array();
includes/REST/Performance/QueryAnalysisController.php:112:			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
includes/REST/Performance/QueryAnalysisController.php:140:				$slow_queries[] = $item;
includes/REST/Performance/QueryAnalysisController.php:146:			$slow_queries,
includes/REST/Performance/QueryAnalysisController.php:154:			'slow_queries'  => array_slice( $slow_queries, 0, 20 ), // Top 20 slow queries.
includes/REST/PerformanceController.php:414:		$slow_queries = array();
includes/REST/PerformanceController.php:422:					$slow_queries[] = array(
includes/REST/PerformanceController.php:433:			$slow_queries,
includes/REST/PerformanceController.php:441:			'slow_queries'  => array_slice( $slow_queries, 0, 20 ), // Top 20 slow queries.
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );



thinking
**Reviewing code updates**

I’m considering updating the `MediaController` to improve functions like get_duplicates, particularly around handling `group['hash']` and `group['count']`. There's also a need to update the `RestController`'s docblock to clarify `_wpnonce`, although it might not be strictly necessary. 

I should check for any missing validation callbacks in route args, especially in `PerformanceController`. Finally, ensuring `sanitize_ids` returns unique values is crucial. We should also run linting checks on JavaScript and ensure the PHP code is syntactically correct by using `php -l`. Let’s proceed with that!
thinking
**Listing and validating modified files**

I’m checking the modified files, and there are quite a few: `RestController.php`, `QueryAnalysisController.php`, `DashboardController.php`, and several others in the Media and Database sections. With so many files, it makes sense to run `php -l` to validate them, and I think I could run that in parallel using `multi_tool_use.parallel`. That way, I can check for syntax errors more efficiently. Let’s move forward with that plan!
exec
/bin/zsh -lc 'php -l includes/REST/RestController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 361ms:
No syntax errors detected in includes/REST/RestController.php
exec
/bin/zsh -lc 'php -l includes/REST/Performance/QueryAnalysisController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 61ms:
No syntax errors detected in includes/REST/Performance/QueryAnalysisController.php
exec
/bin/zsh -lc 'php -l includes/REST/DashboardController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
No syntax errors detected in includes/REST/DashboardController.php
exec
/bin/zsh -lc 'php -l includes/REST/Media/MediaHelper.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
No syntax errors detected in includes/REST/Media/MediaHelper.php
exec
/bin/zsh -lc 'php -l includes/REST/Media/MediaCleanupController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 68ms:
No syntax errors detected in includes/REST/Media/MediaCleanupController.php
exec
/bin/zsh -lc 'php -l includes/REST/MediaController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
No syntax errors detected in includes/REST/MediaController.php
exec
/bin/zsh -lc 'php -l includes/REST/DatabaseController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 67ms:
No syntax errors detected in includes/REST/DatabaseController.php
exec
/bin/zsh -lc 'php -l includes/REST/Database/TableAnalysisController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 102ms:
No syntax errors detected in includes/REST/Database/TableAnalysisController.php
exec
/bin/zsh -lc 'php -l includes/REST/Database/CleanupController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 92ms:
No syntax errors detected in includes/REST/Database/CleanupController.php
exec
/bin/zsh -lc 'php -l includes/REST/Performance/HeartbeatController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 89ms:
No syntax errors detected in includes/REST/Performance/HeartbeatController.php
exec
/bin/zsh -lc 'php -l includes/REST/Performance/AutoloadController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 90ms:
No syntax errors detected in includes/REST/Performance/AutoloadController.php
exec
/bin/zsh -lc 'php -l includes/REST/Database/OptimizationController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 83ms:
No syntax errors detected in includes/REST/Database/OptimizationController.php
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

Reconnecting... 1/5 (stream disconnected before completion: Transport error: network error: error decoding response body)
Plan update
  ✓ Read spec and handoff
  ✓ Implement required changes
  → Run lint and tests
  • Summarize and hand off
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc 'npm run lint' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 2.20s:

> wp-admin-health-suite@1.0.0 lint
> eslint assets/js --ext .js,.jsx


/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/admin.js
    7:1  warning  Missing JSDoc @param "window" type    jsdoc/require-param-type
    8:1  warning  Missing JSDoc @param "$" type         jsdoc/require-param-type
  276:1  warning  Missing JSDoc @param "message" type   jsdoc/require-param-type
  277:1  warning  Missing JSDoc @param "duration" type  jsdoc/require-param-type

/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/charts.js
  7:1  warning  Missing JSDoc @param "window" type  jsdoc/require-param-type
  8:1  warning  Missing JSDoc @param "$" type       jsdoc/require-param-type

/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/components/HealthScoreCircle.jsx
  31:30  warning  'score' is missing in props validation    react/prop-types
  31:41  warning  'grade' is missing in props validation    react/prop-types
  31:54  warning  'loading' is missing in props validation  react/prop-types
  57:1   warning  Missing JSDoc @param "timestamp" type     jsdoc/require-param-type
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Running tests after linting**

I see that the lint check passed with exit code 0, which is good, even though there are warnings. It seems like I’m ready to move forward, so I’ll go ahead and run the npm test now. I'm curious to see if everything will work as expected or if any issues come up during testing. It’s always a bit nerve-wracking, but I’m doing my best to keep things on track!
exec
/bin/zsh -lc 'npm test' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 1.46s:

> wp-admin-health-suite@1.0.0 test
> jest --passWithNoTests

PASS assets/js/components/QuickActions.test.jsx
PASS assets/js/components/ActivityTimeline.test.jsx
  ● Console

    console.error
      Warning: An update to ActivityTimeline inside a test was not wrapped in act(...).
      
      When testing, code that causes React state updates should be wrapped into act(...):
      
      act(() => {
        /* fire events that update state */
      });
      /* assert on the output */
      
      This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
          at ActivityTimeline (/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/components/ActivityTimeline.jsx:108:46)
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Planning next steps**

So, tests passed, but there were warnings in the console—interesting. I should note those warnings and think about how to address them later. Next, my plan is to run lint tests to ensure everything's up to standard. Once that’s done, I'll move on to summarizing the results. I want to make sure I keep track of everything I’ve done so far, so I’m organized!
Plan update
  ✓ Read spec and handoff
  ✓ Implement required changes
  ✓ Run lint and tests
  → Summarize and hand off
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Examining version consistency**

I need to mark this task as DONE, but it’s essential to review all endpoints to ensure they use the correct permission callbacks. I haven't changed anything since there might be duplicates in controllers, which isn't a security risk but could be a follow-up concern. I noted that we used `@since 1.6.1` for new methods, but there’s some uncertainty about the plugin version. The version constant in wp-admin-health-suite.php might show 1.0.0, so I’ll check for any discrepancies.
exec
/bin/zsh -lc 'rg -n "WP_ADMIN_HEALTH_VERSION" -S wp-admin-health-suite.php includes | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 61ms:
wp-admin-health-suite.php:27:define( 'WP_ADMIN_HEALTH_VERSION', '1.0.0' );
includes/Installer.php:251:		update_option( self::VERSION_OPTION, WP_ADMIN_HEALTH_VERSION );
includes/Installer.php:386:		if ( version_compare( $current_version, WP_ADMIN_HEALTH_VERSION, '<' ) ) {
includes/Installer.php:414:		 * @param {string} WP_ADMIN_HEALTH_VERSION The version being upgraded to.
includes/Installer.php:416:		do_action( 'wpha_upgraded', $from_version, WP_ADMIN_HEALTH_VERSION );
includes/Settings/SettingsServiceProvider.php:334:			'version'   => WP_ADMIN_HEALTH_VERSION,
includes/Plugin.php:95:		$this->version     = defined( 'WP_ADMIN_HEALTH_VERSION' ) ? WP_ADMIN_HEALTH_VERSION : '1.0.0';
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );


thinking
**Evaluating documentation consistency**

I'm noting that the constant is set at 1.0.0, yet there's an inconsistency with the `@since` tags, especially with one being 1.6.1. These documentation blocks might reference future versions, which could be more confusing for users. For instance, the MediaHelper indicates `@since 1.6.0`, but the constant remains at 1.0.0. I should also check if the plugin uses PHPStan, and if not, I need to plan my next summary steps.
Plan update
  ✓ Read spec and handoff
  ✓ Implement required changes
  ✓ Run lint and tests
  ✓ Summarize and hand off
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

exec
/bin/zsh -lc "nl -ba includes/REST/RestController.php | sed -n '250,360p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
   250			if ( ! $settings->is_rest_api_enabled() ) {
   251				return new WP_Error(
   252					'rest_api_disabled',
   253					__( 'REST API is currently disabled.', 'wp-admin-health-suite' ),
   254					array( 'status' => 403 )
   255				);
   256			}
   257	
   258			// Check if user is logged in.
   259			if ( ! is_user_logged_in() ) {
   260				return new WP_Error(
   261					'rest_not_logged_in',
   262					__( 'You are not currently logged in.', 'wp-admin-health-suite' ),
   263					array( 'status' => 401 )
   264				);
   265			}
   266	
   267			// Check if user has manage_options capability.
   268			if ( ! current_user_can( 'manage_options' ) ) {
   269				return new WP_Error(
exec
/bin/zsh -lc "nl -ba includes/REST/Performance/QueryAnalysisController.php | sed -n '60,220p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
    60			QueryMonitorInterface $query_monitor
    61		) {
    62			parent::__construct( $settings, $connection );
    63			$this->query_monitor = $query_monitor;
    64		}
    65	
    66		/**
    67		 * Register routes for the controller.
    68		 *
    69		 * @since 1.3.0
    70		 *
    71		 * @return void
    72		 */
    73		public function register_routes(): void {
    74			// GET /wpha/v1/performance/queries.
    75			register_rest_route(
    76				$this->namespace,
    77				'/' . $this->rest_base,
    78				array(
    79					array(
exec
/bin/zsh -lc "nl -ba includes/REST/DashboardController.php | sed -n '300,420p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:
   300				"SELECT COUNT(*) FROM {$table_name}"
   301			);
   302	
   303			// Fetch paginated activities.
   304			$query = $connection->prepare(
   305				"SELECT id, scan_type, items_found, items_cleaned, bytes_freed, created_at
   306				FROM {$table_name}
   307				ORDER BY created_at DESC
   308				LIMIT %d OFFSET %d",
   309				$per_page,
   310				$offset
   311			);
   312	
   313			$activities = $query ? $connection->get_results( $query, 'ARRAY_A' ) : null;
   314	
   315			if ( null === $activities ) {
   316				return $this->format_error_response(
   317					new WP_Error(
   318						'database_error',
   319						__( 'Database error occurred while fetching activities.', 'wp-admin-health-suite' )
exec
/bin/zsh -lc "nl -ba includes/REST/Media/MediaHelper.php | sed -n '90,190p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
    90	
    91			return true;
    92		}
    93	
    94		/**
    95		 * Get attachment details with thumbnail URL.
    96		 *
    97		 * Consolidated method to avoid code duplication across media controllers.
    98		 *
    99		 * @since 1.3.0
   100		 *
   101		 * @param int $attachment_id Attachment ID.
   102		 * @return array Attachment details.
   103		 */
   104		public static function get_attachment_details( int $attachment_id ): array {
   105			$file_path = get_attached_file( $attachment_id );
   106	
   107			$url = wp_get_attachment_url( $attachment_id );
   108			$url = $url ? esc_url_raw( $url ) : '';
   109	
exec
/bin/zsh -lc "nl -ba includes/REST/Media/MediaCleanupController.php | sed -n '390,480p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 39ms:
   390			);
   391		}
   392	
   393		/**
   394		 * Get all exclusions.
   395		 *
   396		 * @since 1.0.0
   397		 * @since 1.3.0 Moved to MediaCleanupController.
   398		 *
   399		 * @param WP_REST_Request $request Full details about the request.
   400		 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
   401		 */
   402		public function get_exclusions( $request ) {
   403			$exclusions = $this->exclusions->get_exclusions();
   404	
   405			// Enrich with attachment details.
   406			$enriched_exclusions = array();
   407			foreach ( $exclusions as $exclusion ) {
   408				$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
   409				$details       = MediaHelper::get_attachment_details( $attachment_id );
exec
/bin/zsh -lc "nl -ba includes/REST/MediaController.php | sed -n '920,1040p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:
   920		 */
   921		public function sanitize_ids( $value ) {
   922			if ( ! is_array( $value ) ) {
   923				return array();
   924			}
   925	
   926			$ids = array_filter( array_map( 'absint', $value ) );
   927			$ids = array_values( array_unique( $ids ) );
   928	
   929			return $ids;
   930		}
   931	
   932		/**
   933		 * Log activity to scan history.
   934		 *
   935		 * @since 1.0.0
   936		 * @since 1.3.0 Uses ConnectionInterface instead of global $wpdb.
   937		 *
   938		 * @param string $type   The operation type.
   939		 * @param array  $result The result data.
exec
/bin/zsh -lc "nl -ba includes/REST/DatabaseController.php | sed -n '260,360p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
   260			);
   261		}
   262	
   263		/**
   264		 * Get all analyzer statistics.
   265		 *
   266	 * @since 1.0.0
   267	 *
   268		 * @param WP_REST_Request $request Full details about the request.
   269		 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
   270		 */
   271		public function get_stats( $request ) {
   272			$analyzer = $this->get_analyzer();
   273	
   274			$stats = array(
   275				'database_size'           => $analyzer->get_database_size(),
   276				'table_sizes'             => $analyzer->get_table_sizes(),
   277				'revisions_count'         => $analyzer->get_revisions_count(),
   278				'auto_drafts_count'       => $analyzer->get_auto_drafts_count(),
   279				'trashed_posts_count'     => $analyzer->get_trashed_posts_count(),
exec
/bin/zsh -lc "nl -ba includes/REST/Database/TableAnalysisController.php | sed -n '180,280p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
   180		public function get_stats( $request ) {
   181			$stats = array(
   182				'database_size'            => $this->analyzer->get_database_size(),
   183				'table_sizes'              => $this->analyzer->get_table_sizes(),
   184				'revisions_count'          => $this->analyzer->get_revisions_count(),
   185				'auto_drafts_count'        => $this->analyzer->get_auto_drafts_count(),
   186				'trashed_posts_count'      => $this->analyzer->get_trashed_posts_count(),
   187				'spam_comments_count'      => $this->analyzer->get_spam_comments_count(),
   188				'trashed_comments_count'   => $this->analyzer->get_trashed_comments_count(),
   189				'expired_transients_count' => $this->analyzer->get_expired_transients_count(),
   190				'orphaned_postmeta_count'  => $this->analyzer->get_orphaned_postmeta_count(),
   191				'orphaned_commentmeta_count' => $this->analyzer->get_orphaned_commentmeta_count(),
   192				'orphaned_termmeta_count'  => $this->analyzer->get_orphaned_termmeta_count(),
   193			);
   194	
   195			return $this->format_response(
   196				true,
   197				$stats,
   198				__( 'Database statistics retrieved successfully.', 'wp-admin-health-suite' )
   199			);
exec
/bin/zsh -lc "nl -ba includes/REST/Database/CleanupController.php | sed -n '140,220p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
   140								'default'           => array(),
   141								'sanitize_callback' => array( $this, 'sanitize_options' ),
   142								'validate_callback' => 'rest_validate_request_arg',
   143							),
   144						),
   145					),
   146				)
   147			);
   148	
   149			// POST /wpha/v1/database/cleanup/revisions - Clean revisions.
   150			register_rest_route(
   151				$this->namespace,
   152				'/' . $this->rest_base . '/revisions',
   153				array(
   154					array(
   155						'methods'             => \WP_REST_Server::CREATABLE,
   156						'callback'            => array( $this, 'clean_revisions' ),
   157						'permission_callback' => array( $this, 'check_permissions' ),
   158						'args'                => array(
   159							'keep_per_post' => array(
exec
/bin/zsh -lc "nl -ba includes/REST/Performance/HeartbeatController.php | sed -n '60,140p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 42ms:
    60		 * @return void
    61		 */
    62		public function register_routes(): void {
    63			// GET /wpha/v1/performance/heartbeat.
    64			register_rest_route(
    65				$this->namespace,
    66				'/' . $this->rest_base,
    67				array(
    68					array(
    69						'methods'             => \WP_REST_Server::READABLE,
    70						'callback'            => array( $this, 'get_heartbeat_settings' ),
    71						'permission_callback' => array( $this, 'check_permissions' ),
    72					),
    73					array(
    74						'methods'             => \WP_REST_Server::CREATABLE,
    75						'callback'            => array( $this, 'update_heartbeat_settings' ),
    76						'permission_callback' => array( $this, 'check_permissions' ),
    77						'args'                => array(
    78							'location' => array(
    79								'description'       => __( 'The location to update settings for.', 'wp-admin-health-suite' ),
exec
/bin/zsh -lc "nl -ba includes/REST/Performance/AutoloadController.php | sed -n '70,140p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:
    70		 *
    71		 * @return void
    72		 */
    73		public function register_routes(): void {
    74			// GET /wpha/v1/performance/autoload.
    75			register_rest_route(
    76				$this->namespace,
    77				'/' . $this->rest_base,
    78				array(
    79					array(
    80						'methods'             => \WP_REST_Server::READABLE,
    81						'callback'            => array( $this, 'get_autoload_analysis' ),
    82						'permission_callback' => array( $this, 'check_permissions' ),
    83					),
    84					array(
    85						'methods'             => \WP_REST_Server::CREATABLE,
    86						'callback'            => array( $this, 'update_autoload' ),
    87						'permission_callback' => array( $this, 'check_permissions' ),
    88						'args'                => array(
    89							'option_name' => array(
exec
/bin/zsh -lc "nl -ba includes/REST/Database/OptimizationController.php | sed -n '90,180p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
    90				'/' . $this->rest_base . '/optimize',
    91				array(
    92					array(
    93						'methods'             => \WP_REST_Server::CREATABLE,
    94						'callback'            => array( $this, 'optimize_tables' ),
    95						'permission_callback' => array( $this, 'check_permissions' ),
    96						'args'                => array(
    97							'tables' => array(
    98								'description'       => __( 'Specific tables to optimize. If empty, optimizes all tables needing optimization.', 'wp-admin-health-suite' ),
    99								'type'              => 'array',
   100								'items'             => array( 'type' => 'string' ),
   101								'default'           => array(),
   102								'sanitize_callback' => array( $this, 'sanitize_table_names' ),
   103								'validate_callback' => 'rest_validate_request_arg',
   104							),
   105						),
   106					),
   107				)
   108			);
   109	
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

codex
**Status:** DONE

**Summary of changes**
- Harden nonce verification to accept `X-WP-Nonce` header or `_wpnonce` param fallback (`includes/REST/RestController.php#L297`).
- Redact/sanitize query analysis output (SQL literals + caller paths) unless debug mode + `WPHA_DEBUG` is enabled (`includes/REST/Performance/QueryAnalysisController.php#L97`).
- Standardize REST date outputs to RFC3339 and sanitize activity fields (`includes/REST/DashboardController.php#L325`).
- Sanitize media attachment REST fields (URLs, title, filename, date) and exclusions metadata (`includes/REST/Media/MediaHelper.php#L104`, `includes/REST/Media/MediaCleanupController.php#L402`, `includes/REST/MediaController.php#L989`).
- Sanitize revision-post rows returned via REST (`includes/REST/DatabaseController.php#L303`, `includes/REST/Database/TableAnalysisController.php#L210`).
- Tighten request arg sanitization/validation for boolean + enums (`includes/REST/Database/CleanupController.php#L172`, `includes/REST/Performance/HeartbeatController.php#L62`, `includes/REST/Performance/AutoloadController.php#L73`).
- Fix `/database/optimization/tables` to handle the current optimizer return shape (`includes/REST/Database/OptimizationController.php#L142`).

**How to verify**
- `npm run lint`
- `npm test`

**Risks / follow-ups**
- Query analysis now redacts SQL by default; to see raw SQL, enable the plugin’s debug mode and set `WPHA_DEBUG` to true (still trimmed to a max length).
- REST route duplication remains for media endpoints (both `MediaController` and the newer `Media/*` controllers register overlapping routes); consider de-duplicating to avoid ambiguous handler selection.
file update:
diff --git a/includes/REST/DashboardController.php b/includes/REST/DashboardController.php
index 36b54e02bab31ebf1704be0981ac2160d52c34a4..f48e51183b36118fc5790463a1074bb1a8164077
--- a/includes/REST/DashboardController.php
+++ b/includes/REST/DashboardController.php
@@ -325,13 +325,21 @@
 		// Format the activities data.
 		$formatted_activities = array_map(
 			function ( $activity ) {
+				$created_at = isset( $activity['created_at'] ) ? sanitize_text_field( $activity['created_at'] ) : '';
+				if ( '' !== $created_at && function_exists( 'mysql_to_rfc3339' ) ) {
+					$rfc3339 = mysql_to_rfc3339( $created_at );
+					if ( false !== $rfc3339 ) {
+						$created_at = $rfc3339;
+					}
+				}
+
 				return array(
 					'id'            => (int) $activity['id'],
 					'scan_type'     => sanitize_text_field( $activity['scan_type'] ),
-					'items_found'   => (int) $activity['items_found'],
-					'items_cleaned' => (int) $activity['items_cleaned'],
-					'bytes_freed'   => (int) $activity['bytes_freed'],
-					'created_at'    => $activity['created_at'],
+					'items_found'   => isset( $activity['items_found'] ) ? absint( $activity['items_found'] ) : 0,
+					'items_cleaned' => isset( $activity['items_cleaned'] ) ? absint( $activity['items_cleaned'] ) : 0,
+					'bytes_freed'   => isset( $activity['bytes_freed'] ) ? absint( $activity['bytes_freed'] ) : 0,
+					'created_at'    => $created_at,
 				);
 			},
 			$activities
diff --git a/includes/REST/Database/CleanupController.php b/includes/REST/Database/CleanupController.php
index a21450520501404b6ad31309b5ed427f5aa22a0c..8cbc8f191f5c6156f5a43aad977fad787a823474
--- a/includes/REST/Database/CleanupController.php
+++ b/includes/REST/Database/CleanupController.php
@@ -183,6 +183,7 @@
 							'description'       => __( 'Only delete expired transients.', 'wp-admin-health-suite' ),
 							'type'              => 'boolean',
 							'default'           => true,
+							'sanitize_callback' => 'rest_sanitize_boolean',
 							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'exclude_patterns' => array(
diff --git a/includes/REST/Database/OptimizationController.php b/includes/REST/Database/OptimizationController.php
index 4841335a04005449ef62dc454350bd3ece84a210..abbcbbef5c0e2621aae081b7f7920042f0e4cb8c
--- a/includes/REST/Database/OptimizationController.php
+++ b/includes/REST/Database/OptimizationController.php
@@ -144,10 +144,33 @@
 
 		$table_details = array();
 		foreach ( $tables as $table ) {
-			$overhead = $this->optimizer->get_table_overhead( $table );
+			// Back-compat: allow either the newer array format or legacy string list.
+			if ( is_array( $table ) ) {
+				$table_name = isset( $table['name'] ) ? sanitize_text_field( (string) $table['name'] ) : '';
+				if ( '' === $table_name ) {
+					continue;
+				}
+
+				$table_details[] = array(
+					'table_name' => $table_name,
+					'overhead'   => isset( $table['overhead'] ) ? absint( $table['overhead'] ) : 0,
+					'data_size'  => isset( $table['data_size'] ) ? absint( $table['data_size'] ) : 0,
+					'engine'     => isset( $table['engine'] ) ? sanitize_text_field( (string) $table['engine'] ) : '',
+					'is_large'   => isset( $table['is_large'] ) ? (bool) $table['is_large'] : false,
+				);
+				continue;
+			}
+
+			$table_name = sanitize_text_field( (string) $table );
+			if ( '' === $table_name ) {
+				continue;
+			}
+
+			$overhead = $this->optimizer->get_table_overhead( $table_name );
+
 			$table_details[] = array(
-				'table_name' => $table,
-				'overhead'   => $overhead ? $overhead : 0,
+				'table_name' => $table_name,
+				'overhead'   => false !== $overhead ? absint( $overhead ) : 0,
 			);
 		}
 
diff --git a/includes/REST/Database/TableAnalysisController.php b/includes/REST/Database/TableAnalysisController.php
index 001f955518d95508507ce361f4ee34084ed364af..346e5576aa949c0e0b2262278e080cf505eec20f
--- a/includes/REST/Database/TableAnalysisController.php
+++ b/includes/REST/Database/TableAnalysisController.php
@@ -210,10 +210,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count'              => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate'            => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -224,6 +228,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
 	 * @since 1.3.0
diff --git a/includes/REST/DatabaseController.php b/includes/REST/DatabaseController.php
index e112b6aefc8b6575f3bae7d89352bb2edea2fd41..78ebed3cc2e5dbee05555b1f76e367820ee63e90
--- a/includes/REST/DatabaseController.php
+++ b/includes/REST/DatabaseController.php
@@ -303,10 +303,14 @@
 	public function get_revisions( $request ) {
 		$limit = $request->get_param( 'limit' );
 
+		$posts_with_most_revisions = $this->sanitize_posts_with_most_revisions(
+			$this->revisions_manager->get_posts_with_most_revisions( absint( $limit ) )
+		);
+
 		$data = array(
 			'total_count' => $this->revisions_manager->get_all_revisions_count(),
 			'size_estimate' => $this->revisions_manager->get_revisions_size_estimate(),
-			'posts_with_most_revisions' => $this->revisions_manager->get_posts_with_most_revisions( $limit ),
+			'posts_with_most_revisions' => $posts_with_most_revisions,
 		);
 
 		return $this->format_response(
@@ -317,6 +321,33 @@
 	}
 
 	/**
+	 * Sanitize posts_with_most_revisions result rows for REST output.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param array $rows Raw rows from RevisionsManager.
+	 * @return array Sanitized rows.
+	 */
+	private function sanitize_posts_with_most_revisions( array $rows ): array {
+		$sanitized = array();
+
+		foreach ( $rows as $row ) {
+			if ( ! is_array( $row ) ) {
+				continue;
+			}
+
+			$sanitized[] = array(
+				'post_id'        => isset( $row['post_id'] ) ? absint( $row['post_id'] ) : 0,
+				'post_title'     => isset( $row['post_title'] ) ? sanitize_text_field( (string) $row['post_title'] ) : '',
+				'post_type'      => isset( $row['post_type'] ) ? sanitize_key( (string) $row['post_type'] ) : '',
+				'revision_count' => isset( $row['revision_count'] ) ? absint( $row['revision_count'] ) : 0,
+			);
+		}
+
+		return $sanitized;
+	}
+
+	/**
 	 * Get transient list.
 	 *
  * @since 1.0.0
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 28a7e1f289c445799f9e60fb2bfb82483f446cfa..4e6188c8301a776e2a07af3d09bd579364e97ed9
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -405,14 +405,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = MediaHelper::get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = MediaHelper::get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 845b0bf71b13d0976ef950eab8456351129570f0..ef3df00cdfd62efbfcca4a0ebcd5a8ab036e2d12
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -105,6 +105,7 @@
 		$file_path = get_attached_file( $attachment_id );
 
 		$url = wp_get_attachment_url( $attachment_id );
+		$url = $url ? esc_url_raw( $url ) : '';
 
 		$filename  = '';
 		$file_size = 0;
@@ -121,31 +122,41 @@
 		if ( ! $thumbnail_url ) {
 			$thumbnail_url = $url;
 		}
+		$thumbnail_url = $thumbnail_url ? esc_url_raw( $thumbnail_url ) : '';
 
 		$post = get_post( $attachment_id );
 
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
+		$title = $post ? sanitize_text_field( $post->post_title ) : '';
+
+		$date = $post ? sanitize_text_field( $post->post_date ) : '';
+		if ( '' !== $date && function_exists( 'mysql_to_rfc3339' ) ) {
+			$rfc3339 = mysql_to_rfc3339( $date );
+			if ( false !== $rfc3339 ) {
+				$date = $rfc3339;
+			}
+		}
+
 		$mime_type = get_post_mime_type( $attachment_id );
+		$mime_type = $mime_type ? sanitize_mime_type( (string) $mime_type ) : '';
 
-		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
+		$type = self::get_media_type( $mime_type );
 
 		return array(
 			'id'                  => $attachment_id,
 			'title'               => $title,
-			'filename'            => $filename,
+			'filename'            => sanitize_text_field( $filename ),
 			'file_size'           => $file_size,
 			'file_size_formatted' => size_format( $file_size ),
 			'mime_type'           => $mime_type,
 			'thumbnail_url'       => $thumbnail_url,
-			'edit_link'           => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
+			'edit_link'           => esc_url_raw( admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ) ),
 
 			// UI-friendly aliases.
 			'size'      => $file_size,
 			'thumbnail' => $thumbnail_url,
 			'url'       => $url,
 			'date'      => $date,
-			'type'      => $type,
+			'type'      => sanitize_key( $type ),
 		);
 	}
 
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index b7e755212b03660157266f316dee6a9b0ffa316f..ac38f3cb90b02f0b06576492bd4fe864f0414216
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -992,14 +992,30 @@
 		// Enrich with attachment details.
 		$enriched_exclusions = array();
 		foreach ( $exclusions as $exclusion ) {
-			$attachment_id = $exclusion['attachment_id'];
-			$details = $this->get_attachment_details( $attachment_id );
+			$attachment_id = isset( $exclusion['attachment_id'] ) ? absint( $exclusion['attachment_id'] ) : 0;
+			$details       = $this->get_attachment_details( $attachment_id );
+
+			$excluded_by = isset( $exclusion['excluded_by'] ) ? absint( $exclusion['excluded_by'] ) : 0;
+			$user        = $excluded_by ? get_user_by( 'id', $excluded_by ) : null;
+			$excluded_by_name = $user ? sanitize_text_field( (string) $user->display_name ) : __( 'Unknown', 'wp-admin-health-suite' );
+
+			$excluded_at = isset( $exclusion['excluded_at'] ) ? sanitize_text_field( (string) $exclusion['excluded_at'] ) : '';
+			if ( '' !== $excluded_at && function_exists( 'mysql_to_rfc3339' ) ) {
+				$rfc3339 = mysql_to_rfc3339( $excluded_at );
+				if ( false !== $rfc3339 ) {
+					$excluded_at = $rfc3339;
+				}
+			}
 
-			$user = get_user_by( 'id', $exclusion['excluded_by'] );
-			$excluded_by_name = $user ? $user->display_name : __( 'Unknown', 'wp-admin-health-suite' );
+			$sanitized_exclusion = array(
+				'attachment_id' => $attachment_id,
+				'excluded_at'   => $excluded_at,
+				'reason'        => isset( $exclusion['reason'] ) ? sanitize_text_field( (string) $exclusion['reason'] ) : '',
+				'excluded_by'   => $excluded_by,
+			);
 
 			$enriched_exclusions[] = array_merge(
-				$exclusion,
+				$sanitized_exclusion,
 				$details,
 				array( 'excluded_by_name' => $excluded_by_name )
 			);
diff --git a/includes/REST/Performance/AutoloadController.php b/includes/REST/Performance/AutoloadController.php
index 557de33e3d5e16524ad9add030ab732a342f3602..5b1da68ce311de72eee9bf3adbf86a3ec3c13ee1
--- a/includes/REST/Performance/AutoloadController.php
+++ b/includes/REST/Performance/AutoloadController.php
@@ -91,6 +91,7 @@
 							'type'              => 'string',
 							'required'          => true,
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'autoload'    => array(
 							'description'       => __( 'Whether to autoload the option.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/HeartbeatController.php b/includes/REST/Performance/HeartbeatController.php
index a0c078c3fa822414f61cad47342427ffc3dfe73c..a8ab708bc87118ebedfa6eeca9821ff67c25db78
--- a/includes/REST/Performance/HeartbeatController.php
+++ b/includes/REST/Performance/HeartbeatController.php
@@ -81,6 +81,7 @@
 							'required'          => true,
 							'enum'              => array( 'dashboard', 'editor', 'frontend' ),
 							'sanitize_callback' => 'sanitize_text_field',
+							'validate_callback' => 'rest_validate_request_arg',
 						),
 						'enabled'  => array(
 							'description'       => __( 'Whether heartbeat is enabled.', 'wp-admin-health-suite' ),
diff --git a/includes/REST/Performance/QueryAnalysisController.php b/includes/REST/Performance/QueryAnalysisController.php
index a47e7ac103277590bfcfae8dcfd8087a967399f4..af752b925caa4535365f97cb3f1fddfba379a2d4
--- a/includes/REST/Performance/QueryAnalysisController.php
+++ b/includes/REST/Performance/QueryAnalysisController.php
@@ -103,6 +103,10 @@
 		$status       = $this->query_monitor->get_monitoring_status();
 		$can_capture  = isset( $status['monitoring_enabled'] ) ? (bool) $status['monitoring_enabled'] : ( defined( 'SAVEQUERIES' ) && SAVEQUERIES );
 
+		// Only show raw SQL when explicitly enabled (WPHA_DEBUG) and debug mode is on.
+		// Otherwise, return a redacted query string to reduce accidental data exposure.
+		$include_raw_sql = $this->is_debug_mode_enabled() && $this->can_view_detailed_debug();
+
 		$slow_queries = array();
 		if ( $can_capture ) {
 			$captured = $this->query_monitor->capture_slow_queries( $threshold_ms );
@@ -110,14 +114,19 @@
 				$sql     = isset( $query['sql'] ) ? $query['sql'] : ( $query['query'] ?? '' );
 				$time_ms = isset( $query['time'] ) ? (float) $query['time'] : 0.0;
 
+				$sql_string = is_string( $sql ) ? $sql : '';
+				$query_hash = '' !== $sql_string ? substr( md5( $sql_string ), 0, 12 ) : '';
+
 				$item = array(
-					'query'  => $sql,
-					'time'   => round( $time_ms / 1000, 5 ),
-					'caller' => isset( $query['caller'] ) ? (string) $query['caller'] : 'unknown',
+					'query'      => $this->sanitize_sql_for_output( $sql_string, ! $include_raw_sql ),
+					'query_hash' => $query_hash,
+					'query_type' => $this->get_query_type( $sql_string ),
+					'time'       => round( $time_ms / 1000, 5 ),
+					'caller'     => $this->sanitize_caller_for_output( isset( $query['caller'] ) ? (string) $query['caller'] : '' ),
 				);
 
 				if ( isset( $query['component'] ) ) {
-					$item['component'] = (string) $query['component'];
+					$item['component'] = sanitize_text_field( (string) $query['component'] );
 				}
 
 				if ( isset( $query['is_duplicate'] ) ) {
@@ -154,4 +163,78 @@
 			__( 'Query analysis retrieved successfully.', 'wp-admin-health-suite' )
 		);
 	}
+
+	/**
+	 * Sanitize SQL for REST output.
+	 *
+	 * Collapses whitespace, optionally redacts literals, and enforces a length limit.
+	 * This is for display purposes only and is never executed.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $sql           SQL query string.
+	 * @param bool   $redact_values Whether to redact string/numeric literals.
+	 * @return string Sanitized SQL string for output.
+	 */
+	private function sanitize_sql_for_output( string $sql, bool $redact_values ): string {
+		$sql = trim( $sql );
+		if ( '' === $sql ) {
+			return '';
+		}
+
+		// Normalize whitespace for readability and to reduce accidental leakage of formatting.
+		$sql = preg_replace( '/\\s+/', ' ', $sql );
+		$sql = is_string( $sql ) ? $sql : '';
+
+		if ( $redact_values ) {
+			// Redact common literal formats to reduce exposure of user/content data.
+			// Replace quoted strings with '?' placeholders.
+			$sql = preg_replace( "/'(?:\\\\\\\\.|[^'\\\\\\\\])*'/", "'?'", $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+			$sql = preg_replace( '/"(?:\\\\\\\\.|[^"\\\\\\\\])*"/', '"?"', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+
+			// Replace numeric literals (including decimals) with '?'.
+			$sql = preg_replace( '/\\b\\d+(?:\\.\\d+)?\\b/', '?', $sql );
+			$sql = is_string( $sql ) ? $sql : '';
+		}
+
+		// Enforce a max length to avoid huge payloads.
+		$max_len = 500;
+		if ( strlen( $sql ) > $max_len ) {
+			$sql = substr( $sql, 0, $max_len ) . '…';
+		}
+
+		return sanitize_text_field( $sql );
+	}
+
+	/**
+	 * Sanitize caller information for REST output.
+	 *
+	 * Removes absolute path prefixes where possible and enforces a length limit.
+	 *
+	 * @since 1.6.1
+	 *
+	 * @param string $caller Caller string.
+	 * @return string Sanitized caller string.
+	 */
+	private function sanitize_caller_for_output( string $caller ): string {
+		$caller = sanitize_text_field( $caller );
+
+		if ( defined( 'ABSPATH' ) && is_string( ABSPATH ) && '' !== ABSPATH ) {
+			$caller = str_replace( ABSPATH, '', $caller );
+		}
+
+		$caller = trim( $caller );
+		if ( '' === $caller ) {
+			return 'unknown';
+		}
+
+		$max_len = 200;
+		if ( strlen( $caller ) > $max_len ) {
+			$caller = substr( $caller, 0, $max_len ) . '…';
+		}
+
+		return $caller;
+	}
 }
diff --git a/includes/REST/RestController.php b/includes/REST/RestController.php
index 86fb33587239195e80ec029053a7e65e40c90ee5..84501a7d73b247964866e86c8c9a531fe828fef7
--- a/includes/REST/RestController.php
+++ b/includes/REST/RestController.php
@@ -296,6 +296,12 @@
 	 */
 	protected function verify_nonce( $request ) {
 		$nonce = $request->get_header( 'X-WP-Nonce' );
+		if ( empty( $nonce ) ) {
+			// Back-compat: allow `_wpnonce` param for clients that can't set headers.
+			$nonce = $request->get_param( '_wpnonce' );
+		}
+
+		$nonce = is_string( $nonce ) ? sanitize_text_field( $nonce ) : '';
 
 		if ( empty( $nonce ) ) {
 			return new WP_Error(
@@ -559,7 +565,7 @@
 	 *
 	 * @return bool True if user can view detailed debug info.
 	 */
-	private function can_view_detailed_debug(): bool {
+	protected function can_view_detailed_debug(): bool {
 		// Require explicit WPHA_DEBUG constant for detailed debug output.
 		if ( ! defined( 'WPHA_DEBUG' ) || ! WPHA_DEBUG ) {
 			return false;
@@ -581,7 +587,7 @@
 	 * @param string $query The SQL query.
 	 * @return string The query type (SELECT, INSERT, UPDATE, DELETE, or OTHER).
 	 */
-	private function get_query_type( string $query ): string {
+	protected function get_query_type( string $query ): string {
 		$query = trim( strtoupper( $query ) );
 
 		$types = array( 'SELECT', 'INSERT', 'UPDATE', 'DELETE', 'REPLACE', 'CREATE', 'ALTER', 'DROP', 'TRUNCATE', 'SHOW', 'DESCRIBE' );

tokens used
298,716
