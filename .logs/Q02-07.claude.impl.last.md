---

## Status: DONE

## Summary of Changes

The `includes/database/OrphanedTables.php` file has been reviewed and improved with the following changes:

### 1. **Fixed Inaccurate Detection of Tables from Deactivated Plugins** (Critical Fix)
- **Before**: The code matched tables against hardcoded patterns regardless of whether the owning plugin was active. This meant WooCommerce tables would never be flagged as orphaned even if WooCommerce was deactivated.
- **After**: Implemented a plugin-to-table mapping system (`$plugin_table_mapping`) that only protects tables if their owning plugin is currently ACTIVE. Tables from deactivated plugins will now correctly be flagged as orphaned.

### 2. **Added New Methods for Shared Table Handling**
- `get_shared_table_patterns()` - Returns patterns for tables that may be used by multiple plugins (e.g., Action Scheduler)
- `is_potentially_shared_table()` - Checks if a table matches shared patterns
- Orphaned tables that match shared patterns now include a warning message to alert users

### 3. **Added Potential Owner Identification**
- `identify_potential_owner()` - Identifies which plugin likely created an orphaned table based on naming patterns
- This helps users understand the origin of orphaned tables before deciding to delete them

### 4. **Enhanced find_orphaned_tables() Output**
- Each orphaned table now includes:
  - `is_shared_table` (bool) - Whether the table may be shared by multiple plugins
  - `warning` (string) - Warning message for shared tables
  - `potential_owner` (string|null) - Human-readable name of the likely owner plugin

### 5. **Added New Filters for Extensibility**
- `wpha_shared_table_patterns` - Allows customization of shared table patterns
- `wpha_orphaned_tables` - Allows filtering the final list of orphaned tables
- `wpha_table_potential_owner` - Allows plugins to identify their own tables

### 6. **Expanded Plugin Coverage**
Added support for additional popular plugins:
- Gravity Forms
- WPForms
- Jetpack
- TablePress
- UpdraftPlus
- All-in-One WP Migration
- Ninja Forms
- Redirection
- WP Statistics
- MailPoet
- WPML
- LiteSpeed Cache

### Safe Deletion Safeguards (Already Present, Verified Working)
- ✅ Confirmation hash (HMAC-SHA256) required for deletion
- ✅ Table prefix validation
- ✅ Table name sanitization (alphanumeric + underscores only)
- ✅ Deletion lock to prevent concurrent deletions
- ✅ TOCTOU protection (re-verifies orphan status before deletion)
- ✅ Never auto-deletes - requires explicit confirmation

## How to Verify

```bash
# Run lint (should pass with only pre-existing warnings)
npm run lint

# Run tests (all should pass)
npm test

# Verify PHP code style (only filename warnings remain, which are project convention)
./vendor/bin/phpcs --standard=WordPress includes/database/OrphanedTables.php
```

## Risks / Follow-ups

1. **Risk**: The plugin-to-table mapping is manually maintained. New plugins or renamed plugin files would need to be added to the mapping.
   - **Mitigation**: The `wpha_registered_plugin_tables` filter allows plugins to register their own tables at runtime.

2. **Risk**: Some plugins might have non-standard naming conventions not covered by the pattern matching.
   - **Mitigation**: The `wpha_orphaned_tables` filter allows users to add custom logic to prevent false positives.

3. **Follow-up**: Consider adding a settings option to toggle between "strict mode" (only protect explicitly active plugin tables) and "conservative mode" (protect all known plugin patterns).

4. **Follow-up**: The `wp_wpha_scan_history` table (our own plugin table) is always protected via hardcoding. This should be extended via the filter mechanism for consistency.
