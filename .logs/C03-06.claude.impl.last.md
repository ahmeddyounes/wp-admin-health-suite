---

## Status: DONE

## Summary of Changes

### 1. `includes/Support/CacheKeys.php`
- Added `HEALTH_SCORE` constant for centralized cache key (`'health_score'`)
- Updated `get_all_keys()` to include the new key

### 2. `includes/HealthCalculator.php`
- Added `CacheInterface` and `CacheKeys` imports
- Added `CacheInterface $cache` property
- Updated constructor to accept `CacheInterface` as second parameter
- Renamed `CACHE_KEY` constant to `DEFAULT_CACHE_EXPIRATION` (1 hour)
- Updated `calculate_overall_score()`:
  - Uses `$this->cache->get(CacheKeys::HEALTH_SCORE)` instead of `get_transient()`
  - Uses `$this->cache->set(CacheKeys::HEALTH_SCORE, $result, $this->get_cache_expiration())` instead of `set_transient()`
- Updated `clear_cache()` to use `$this->cache->delete(CacheKeys::HEALTH_SCORE)`
- Preserved setting-driven TTL via `health_score_cache_duration` (1-24 hours, clamped)

### 3. `includes/Providers/CoreServiceProvider.php`
- Updated HealthCalculator binding to inject `CacheInterface` as second parameter

### 4. `tests/unit-standalone/Support/CacheKeysTest.php`
- Added `test_health_score_key_defined()` test
- Updated `test_cache_keys_naming_convention()` regex to include `health_` prefix

### 5. `tests/unit-standalone/HealthCalculatorCacheTest.php` (new file)
- Created comprehensive test suite with 20 tests covering:
  - Cache key usage (`HEALTH_SCORE` constant)
  - Cache hit/miss behavior
  - Force refresh bypass
  - TTL selection (default, settings-driven, min/max clamping)
  - Edge cases
- Uses `TestableHealthCalculator` subclass to avoid WordPress `get_plugins()` dependency

## How to Verify

```bash
# Lint (should show only warnings, no errors)
npm run lint

# JavaScript tests (451 tests)
npm test

# PHP standalone tests (filter specific tests)
./vendor/bin/phpunit --configuration phpunit-standalone.xml --filter HealthCalculatorCacheTest
./vendor/bin/phpunit --configuration phpunit-standalone.xml --filter CacheKeysTest
```

## Risks / Follow-ups

1. **WordPress Integration Testing**: The standalone tests use a `TestableHealthCalculator` subclass to avoid WordPress dependency. Full integration tests with WordPress should verify the actual behavior.

2. **Breaking Change**: The `HealthCalculator` constructor signature changed - now requires `CacheInterface` as second parameter. Any code instantiating `HealthCalculator` directly (outside the DI container) needs updating.

3. **Private Method Limitation**: `calculate_plugin_performance_score()` is private, making it impossible to mock in subclasses. The test workaround uses a `TestableHealthCalculator` with hardcoded plugin performance score.
