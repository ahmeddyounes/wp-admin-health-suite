---

## Status: DONE

## Summary of Changes

Successfully centralized all JavaScript API calls to use the centralized API client (`assets/js/utils/api.js`) instead of direct `wp.apiFetch` calls.

### Production Files Modified:

1. **assets/js/performance.js** - Converted all 7 `wp.apiFetch` calls to use the centralized API client with proper cache invalidation and toast error notifications.

2. **assets/js/database-health.js** - Converted all 7 `wp.apiFetch` calls to use the centralized API client with proper caching and toast error notifications.

3. **assets/js/media-audit.js** - Converted all 4 `wp.apiFetch` calls (loadStats, loadTabData, handleRescan, executeBulkAction) to use the centralized API client with cache invalidation on mutations.

4. **assets/js/components/ActivityTimeline.jsx** - Converted to use `apiClient.get()` instead of `wp.apiFetch` with proper parameter handling.

5. **assets/js/components/Recommendations.jsx** - Converted `handleDismiss()` and `handleFixNow()` to use `apiClient.post()` with endpoint path normalization.

### Test Files Modified:

1. **jest.setup.js** - Added global mock for the centralized API client.

2. **assets/js/utils/api.test.js** - Added `jest.unmock('./api.js')` to allow testing the actual implementation.

3. **assets/js/components/ActivityTimeline.test.jsx** - Updated all tests to use the mocked `apiClient` instead of `wp.apiFetch`.

4. **assets/js/components/Recommendations.test.jsx** - Updated all tests to use the mocked `apiClient.post()` instead of `global.wp.apiFetch`.

## How to Verify

```bash
# Run linting (should have 0 errors, 158 warnings)
npm run lint

# Run tests (all 417 tests should pass)
npm test
```

## Risks / Follow-ups

1. **Global API client exposure**: The IIFE-based files (performance.js, database-health.js, media-audit.js) access the API client via `window.WPAdminHealth.api`. If the API client bundle doesn't load before these files, they will fall back gracefully but without API functionality. This is properly handled with initialization checks.

2. **Cache invalidation patterns**: The cache invalidation is implemented for mutations (POST requests), but more aggressive invalidation patterns could be added if stale data becomes an issue.

3. **Toast notifications**: Error handling now uses `window.WPAdminHealth?.Toast?.error()` for user feedback. Ensure the Toast component is available in all contexts where these scripts run.
