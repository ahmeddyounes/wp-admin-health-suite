---

## Status: DONE

## Summary of Changes

### New Files
- **`includes/Services/ObservabilityEventLogger.php`** - Central observability logging service that:
  - Listens to lock/rate-limit hooks via WordPress actions
  - Gates logging behind debug mode (settings, WPHA_DEBUG, or WP_DEBUG + WP_DEBUG_LOG)
  - Buffers events and flushes to error_log on shutdown or buffer limit (50 events)
  - Sanitizes all logged data (no sensitive payloads)
  - Provides event type constants for lock events (`lock_acquired`, `lock_contention`, `lock_released`, `lock_timeout`, `lock_stale_recovery`) and rate-limit events (`rate_limit_hit`, `rate_limit_exceeded`, `rate_limit_unavailable`)

### Modified Files
1. **`includes/REST/RestController.php`** - Added rate limit hooks:
   - `wpha_rate_limit_hit` - fired when rate limit counter increments
   - `wpha_rate_limit_exceeded` - fired when rate limit is exceeded
   - `wpha_rate_limit_unavailable` - fired when rate limiter fails to acquire lock

2. **`includes/Scheduler/SchedulerRegistry.php`** - Added lock hooks:
   - `wpha_lock_acquired` - fired when lock is successfully acquired
   - `wpha_lock_contention` - fired when lock acquisition fails (contention)
   - `wpha_lock_released` - fired when lock is released (with held_time)
   - `wpha_lock_stale_recovery` - fired when stale lock is recovered

3. **`includes/Providers/ServicesServiceProvider.php`** - Registered `ObservabilityEventLogger` as a singleton service and calls `register()` in boot phase

4. **`docs/developers/hooks.md`** - Added comprehensive documentation:
   - New "Observability Hooks" section documenting all hooks
   - "Diagnosing Lock Contention & Rate Limiting" section with troubleshooting guide
   - Example monitoring setup code

## How to Verify

```bash
# Lint (passes with only pre-existing warnings, 0 errors)
npm run lint

# Tests (451 tests pass)
npm test

# Manual verification - Enable debug mode and observe logs:
# 1. Set WPHA_DEBUG constant in wp-config.php: define('WPHA_DEBUG', true);
# 2. Or enable debug mode in plugin settings
# 3. Trigger scheduled tasks and REST API requests
# 4. Check PHP error log for [WP Admin Health] entries
```

## Risks / Follow-ups

1. **No PHP unit tests** - The `ObservabilityEventLogger` class doesn't have dedicated PHP unit tests. Consider adding tests in a future task if PHP test infrastructure exists.

2. **Performance** - Logging is gated behind debug mode to prevent production impact. The 80% threshold on rate limit hit events prevents excessive logging during normal operation.

3. **Log destination** - Currently uses `error_log()`. Future enhancement could integrate with a dedicated logging service or file-based rotation.

4. **Buffer persistence** - Events are buffered in memory and flushed on shutdown. If PHP crashes, buffered events may be lost. This is acceptable for debug/observability purposes.
