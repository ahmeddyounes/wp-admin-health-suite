---

## Status: DONE

## Summary of Changes

### Files Created
- **`tests/unit-standalone/Database/OrphanedTablesTest.php`** - 27 unit tests covering:
  - Core table exclusion (WordPress core tables never flagged as orphaned)
  - Plugin table detection (tables from active plugins are protected)
  - Drop safeguards (confirmation hash validation, prefix validation, TOCTOU protection)
  - SQL safety rules enforcement (valid table names only)

### Files Modified
- **`tests/Mocks/MockConnection.php`** (line 499) - Added `s` (dotall) regex flag to fix multiline query pattern matching

### Key Fixes Applied During Implementation
1. **Cache compatibility**: Created `TestableMemoryCache` class that returns `false` on cache miss (matching WordPress transient API behavior) instead of `null`
2. **Regex multiline matching**: Added `s` flag to MockConnection's regex so `.*` patterns match newlines in SQL queries

## How to Verify

```bash
# Run JavaScript tests
npm test

# Run linter
npm run lint

# Run PHP standalone tests for OrphanedTables specifically
./vendor/bin/phpunit tests/unit-standalone/Database/OrphanedTablesTest.php --bootstrap tests/bootstrap-standalone.php

# Run all PHP standalone tests
./vendor/bin/phpunit tests/unit-standalone/ --bootstrap tests/bootstrap-standalone.php
```

## Risks / Follow-ups

1. **MockConnection regex change** - The `s` flag addition is backwards-compatible but affects all tests using MockConnection with multiline query patterns. All existing tests continue to pass.

2. **TestableMemoryCache is test-only** - The class is defined within the test file itself. If other test files need this behavior, consider extracting to `tests/Mocks/TestableMemoryCache.php`.

3. **Global state in tests** - Tests rely on `$GLOBALS['wpha_test_active_plugins']` for simulating active plugins. This is properly cleaned up in `tearDown()`.
