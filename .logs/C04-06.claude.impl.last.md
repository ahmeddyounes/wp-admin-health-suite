---

## Status: DONE

## Summary of Changes

Implemented task observability for scheduled tasks via `ActivityLoggerInterface`:

1. **Created `TaskActivityLogger.php`** (`includes/Scheduler/TaskActivityLogger.php`)
   - Standalone utility class for logging task executions
   - Methods: `log_task_start`, `log_task_completed`, `log_task_interrupted`, `log_task_error`
   - Uses scan type prefix `task_` for activity log entries

2. **Modified `AbstractScheduledTask.php`** (`includes/Scheduler/AbstractScheduledTask.php`)
   - Added lifecycle notification methods that fire WordPress hooks:
     - `notify_task_started()` → fires `wpha_task_started`
     - `notify_task_completed()` → fires `wpha_task_completed`
     - `notify_task_interrupted()` → fires `wpha_task_interrupted`
     - `notify_task_failed()` → fires `wpha_task_failed`
   - Added `get_elapsed_time()` helper

3. **Modified `ProgressStore.php`** (`includes/Scheduler/ProgressStore.php`)
   - Added pruning capability: `prune_stale(int $max_age_seconds = 86400)`
   - Added `count()` method for counting entries
   - Added `get_statistics()` for observability metrics

4. **Modified `AdvancedSettings.php`** (`includes/Settings/Domain/AdvancedSettings.php`)
   - Added `activity_log_max_rows` setting (default: 10000, range: 1000-100000)
   - Added `progress_retention_hours` setting (default: 24, range: 1-168)

5. **Created `TaskObservabilityService.php`** (`includes/Scheduler/TaskObservabilityService.php`)
   - Central service wiring task lifecycle hooks to ActivityLoggerInterface
   - Handles throttled auto-pruning of stale progress data
   - Listens to `wpha_activity_log_pruned` for coordinated cleanup

6. **Modified `SchedulerServiceProvider.php`** (`includes/Providers/SchedulerServiceProvider.php`)
   - Registered `ProgressStore` and `TaskObservabilityService` as singletons
   - Added `setup_observability_hooks()` in `boot()` method

7. **Updated `hooks.md`** (`docs/developers/hooks.md`)
   - Documented 5 new hooks: `wpha_task_started`, `wpha_task_completed`, `wpha_task_interrupted`, `wpha_task_failed`, `wpha_activity_log_pruned`
   - Added version notes for 1.8.0

## How to Verify

```bash
npm run lint     # Passes (warnings only, no errors)
npm test         # All 417 tests pass
```

## Risks / Follow-ups

1. **Task implementations need updating**: The lifecycle hooks are defined, but individual task classes (`DatabaseCleanupTask`, `MediaScanTask`, `PerformanceCheckTask`) need to call `notify_task_started()`, `notify_task_completed()`, etc. at appropriate points in their execution flow.

2. **ActivityLogger pruning hook**: The `wpha_activity_log_pruned` hook is expected to be fired by `ActivityLogger` when it prunes entries. If that hook doesn't exist yet, it needs to be added to the `ActivityLogger` class for coordinated pruning to work.

3. **Settings UI**: The new settings (`activity_log_max_rows`, `progress_retention_hours`) are registered but may need frontend controls in the admin settings page if not auto-generated.
