---

**Status: DONE**

## Summary of Changes

Enhanced `includes/Media/Tasks/MediaScanTask.php` with the following features:

### 1. Locking Mechanism to Prevent Concurrent Scans
- Added `LOCK_TRANSIENT` constant for transient-based locking
- Added `LOCK_DURATION` (10 minutes) for lock timeout
- Implemented `acquire_lock()`, `release_lock()`, `refresh_lock()` methods
- Added `is_scan_running()` public method for external status checks
- Added `force_release_lock()` public method for admin override
- Lock includes timestamp to detect and handle stale locks

### 2. Incremental Scanning Support
- Added `PROGRESS_OPTION_KEY` for persisting scan progress
- Implemented `load_progress()`, `save_progress()`, `clear_progress()` methods
- Progress tracking includes: completed tasks, partial results, errors, and interruption timestamp
- Scan resumes from where it left off on subsequent runs
- Added `get_progress()`, `has_pending_progress()`, `reset_progress()` public methods

### 3. Resource-Efficient Processing
- Added `DEFAULT_TIME_LIMIT` (25 seconds) and `TIME_BUFFER` (3 seconds) constants
- Implemented `configure_time_limit()` to respect PHP max_execution_time
- Added `is_time_limit_approaching()` check before each subtask
- Task automatically saves progress and exits gracefully when time limit approaches
- Result includes `was_interrupted`, `errors`, and `elapsed_time` for monitoring

### 4. Error Recovery
- Wrapped subtask execution in try-catch via `execute_subtask_with_recovery()`
- Individual subtask failures don't stop the entire scan
- Errors are tracked per-subtask and included in results
- Scan continues with remaining tasks even after errors

### 5. Action Hooks for Extensibility
- Added `wpha_media_scan_before_execute` hook
- Added `wpha_media_scan_after_execute` hook  
- Added `wpha_media_scan_before_subtask` hook
- Added `wpha_media_scan_after_subtask` hook

## How to Verify

```bash
# Run linting (JS)
npm run lint

# Run tests (JS)
npm test

# Run PHP code standards check
./vendor/bin/phpcs --standard=phpcs.xml includes/Media/Tasks/MediaScanTask.php

# Run PHP unit tests
./vendor/bin/phpunit --configuration phpunit-standalone.xml
```

## Risks / Follow-ups

1. **Lock stale detection**: The 10-minute lock duration is a reasonable default, but for very large media libraries, scans might legitimately take longer. Consider making this configurable.

2. **Progress storage**: Progress is stored in `wp_options` which is autoloaded by default. Using `update_option(..., false)` avoids autoloading, but for very large libraries with many results, consider using a separate table or transient with larger data capacity.

3. **Batch size for underlying detectors**: The `DEFAULT_BATCH_SIZE` constant is defined but the underlying detector interfaces (`DuplicateDetectorInterface`, `LargeFilesInterface`, `AltTextCheckerInterface`) may not all support batched queries. Their implementations may need updates for true incremental processing of very large media libraries.
