Status: DONE

Summary of changes
- Hardened attachment file operations: only read `filesize()` for paths validated inside uploads, with URL-based filename fallback (`includes/REST/Media/MediaHelper.php:22`).
- Made destructive media endpoints respect Safe Mode (preview-only; no move/restore), and removed absolute `file_path` from delete responses (`includes/REST/MediaController.php:687`, `includes/REST/Media/MediaCleanupController.php:218`).
- Added `/wpha/v1/media/missing-alt` alias route and de-duped/filtered ID sanitization (`includes/REST/MediaController.php:248`, `includes/REST/Media/MediaAltTextController.php:95`).

How to verify
- `npm run lint`
- `npm test`

Risks / follow-ups
- If any client relied on `prepared_items[].file_path`, it must be updated (field no longer returned).
- Safe Mode now blocks delete/restore (must disable Safe Mode to execute).
- JS bundles use REST namespace `wp-admin-health/v1` while PHP controllers are on `wpha/v1` (e.g. `assets/js/admin.js:42`); consider aligning/aliasing namespaces if the UI isn’t reaching the endpoints.

OpenAI Codex v0.86.0 (research preview)
--------
workdir: /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite
model: gpt-5.2
provider: openai
approval: never
sandbox: workspace-write [workdir, /tmp, $TMPDIR]
reasoning effort: xhigh
reasoning summaries: auto
session id: 019bc7f4-8d92-7471-8d5e-0c0e4cd084b9
--------
user
You are implementing task Q06-04 in this git repository.

1) Read the spec: .plans/Q06-04.md
2) Read handoff/context: .t2/handoff/Q06-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

mcp startup: no servers

thinking
**Implementing task Q06-04**

I'm set to implement task Q06-04 in the repository wp-admin-health-suite. First, I need to read the spec and handoff files. I’m using shell commands via functions.shell_command, and since we’re in workspace-write mode, I’ll read and write within the repo without needing approval. I’ll follow any AGENTS.md instructions too. The user has already provided root AGENTS guidance, but I’ll check for other AGENTS in the repo. My plan is to read the spec and handoff, inspect the code, and implement changes before running tests and summarizing. Time to get started!
Plan update
  → Read spec and handoff docs
  • Inspect codebase and locate changes
  • Implement Q06-04 changes
  • Run lint and tests
  • Summarize and provide verification

thinking
**Executing commands for instructions**

I'm gearing up to run shell commands to read files and identify relevant instructions. I plan on using `rg` to locate the term "AGENTS." It seems like it would be beneficial to run multiple commands in parallel, so I’ll use `multi_tool_use.parallel` to handle that. I’ll execute the commands to retrieve the specifications and find those AGENTS efficiently. Let's get this rolling!
exec
/bin/zsh -lc 'ls -la .plans .t2/handoff || true' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 121ms:
.plans:
total 928
drwxr-xr-x@ 118 ahmedyounis  staff  3776 Jan 16 09:14 .
drwxr-xr-x   55 ahmedyounis  staff  1760 Jan 16 09:09 ..
-rw-r--r--@   1 ahmedyounis  staff   721 Jan  7 10:27 M00-01.md
-rw-r--r--@   1 ahmedyounis  staff   604 Jan  7 10:33 M00-02.md
-rw-r--r--@   1 ahmedyounis  staff   660 Jan  7 10:41 M00-03.md
-rw-r--r--@   1 ahmedyounis  staff   602 Jan  7 10:43 M00-04.md
-rw-r--r--@   1 ahmedyounis  staff   620 Jan  7 10:47 M00-05.md
-rw-r--r--@   1 ahmedyounis  staff   648 Jan  7 10:50 M00-06.md
-rw-r--r--@   1 ahmedyounis  staff   645 Jan  7 10:53 M00-07.md
-rw-r--r--@   1 ahmedyounis  staff   573 Jan  7 10:56 M01-01.md
-rw-r--r--@   1 ahmedyounis  staff   572 Jan  7 11:04 M01-02.md
-rw-r--r--@   1 ahmedyounis  staff   559 Jan  7 11:06 M01-03.md
-rw-r--r--@   1 ahmedyounis  staff   605 Jan  7 11:09 M01-04.md
-rw-r--r--@   1 ahmedyounis  staff   551 Jan  7 11:12 M01-05.md
-rw-r--r--@   1 ahmedyounis  staff   598 Jan  7 11:21 M01-06.md
-rw-r--r--@   1 ahmedyounis  staff   665 Jan  7 11:25 M02-01.md
-rw-r--r--@   1 ahmedyounis  staff   666 Jan  7 11:28 M02-02.md
-rw-r--r--@   1 ahmedyounis  staff   623 Jan  7 11:30 M02-03.md
exec
/bin/zsh -lc "sed -n '1,200p' .plans/Q06-04.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 30ms:
# Q06-04 — Media REST Controllers Review

Review includes/rest/MediaController.php and includes/rest/media/ controllers for media audit endpoints. Verify file operations security, proper response pagination, and error handling.
exec
/bin/zsh -lc "sed -n '1,200p' .t2/handoff/Q06-04.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 29ms:
# Handoff: Q06-04

Created: 2026-01-16T17:14:17.473410Z

Spec: .plans/Q06-04.md


## 2026-01-16T17:15:55.890913Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task Q06-04 in this git repository.

1) Read the spec: .plans/Q06-04.md
2) Read handoff/context: .t2/handoff/Q06-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
exec
/bin/zsh -lc 'find .. -name AGENTS.md -print' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite exited 124 in 10.00s:



thinking
**Inspecting repositories**

I’m noticing that the repo snapshot shows modifications in two files, but they seem already modified from previous tasks. Our current task is focused on Media REST controllers and ensuring security, along with things like response pagination and error handling. I need to check the relevant MediaController files. I should also locate AGENTS instructions within the repo since the user provided root AGENTS but might have shared additional information. There’s mention of instructions being included without needing to re-read them, so I’ll clarify that.
thinking
**Searching for AGENTS**

I should search for AGENTS.md quickly using a command like find . -name AGENTS.md. I also need to check the git status to see any modifications or logs. These might be from previous tasks, so I should consider whether to ignore or adjust them. Since we’re now implementing Q06-04, it'll be crucial to make sure any changes I make don’t undo what’s already there. However, if modifications are uncommitted, I can leave them for now as they were already present. I'll also run commands to open the spec file fully and list the includes/rest directory.
exec
/bin/zsh -lc 'find . -name AGENTS.md -print' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 824ms:

exec
/bin/zsh -lc "sed -n '1,200p' .plans/Q06-04.md && echo '---' && sed -n '200,400p' .plans/Q06-04.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 31ms:
# Q06-04 — Media REST Controllers Review

Review includes/rest/MediaController.php and includes/rest/media/ controllers for media audit endpoints. Verify file operations security, proper response pagination, and error handling.
---
exec
/bin/zsh -lc 'ls -la includes/rest includes/rest/media 2>/dev/null || true' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 34ms:
includes/rest:
total 288
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 09:09 .
drwxr-xr-x@ 27 ahmedyounis  staff    864 Jan 16 07:08 ..
-rw-------@  1 ahmedyounis  staff   4336 Jan 16 04:25 ActivityController.php
-rw-------@  1 ahmedyounis  staff  20728 Jan 16 09:09 DashboardController.php
drwxr-xr-x@  5 ahmedyounis  staff    160 Jan 16 09:13 Database
-rw-------@  1 ahmedyounis  staff  27027 Jan 16 04:26 DatabaseController.php
-rw-------@  1 ahmedyounis  staff     28 Jan  7 10:52 index.php
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 08:24 Media
-rw-------@  1 ahmedyounis  staff  30807 Jan 16 08:24 MediaController.php
drwxr-xr-x@  8 ahmedyounis  staff    256 Jan 16 05:28 Performance
-rw-------@  1 ahmedyounis  staff  28180 Jan 16 04:34 PerformanceController.php
-rw-------@  1 ahmedyounis  staff  19086 Jan 16 09:06 RestController.php

includes/rest/media:
total 88
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 08:24 .
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 09:09 ..
-rw-r--r--@  1 ahmedyounis  staff   4667 Jan 16 06:19 MediaAltTextController.php
exec
/bin/zsh -lc 'git status --porcelain' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 38ms:
 M .t2/state.json
 M includes/Contracts/ExclusionsInterface.php
?? .logs/Q06-03.gitcommit.txt
?? .logs/Q06-04.claude.impl.last.md
?? .logs/Q06-04.claude.impl.raw.txt
?? .plans/Q06-04.md
?? .t2/handoff/Q06-04.md

thinking
**Reviewing spec file and directories**

I'm checking the spec file, which is quite brief, focusing on includes/rest/MediaController.php and media audit endpoints. I should verify the security of file operations, response pagination, and error handling. It seems there might be issues, and the command search for AGENTS.md returned nothing. Maybe the file isn't present or user instructions don't refer to an actual file. I’ll move on to inspecting the code and review all relevant controllers in the includes/rest/Media directory.
exec
/bin/zsh -lc 'ls -la includes/rest/Media && rg -n "class Media" -S includes/rest/MediaController.php includes/rest/media/*.php includes/rest/Media/*.php | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
total 88
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 08:24 .
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 09:09 ..
-rw-r--r--@  1 ahmedyounis  staff   4667 Jan 16 06:19 MediaAltTextController.php
-rw-r--r--@  1 ahmedyounis  staff  12169 Jan 16 06:13 MediaAnalysisController.php
-rw-r--r--@  1 ahmedyounis  staff  13973 Jan 16 08:24 MediaCleanupController.php
-rw-r--r--@  1 ahmedyounis  staff   3355 Jan 16 06:12 MediaHelper.php
-rw-r--r--@  1 ahmedyounis  staff   2918 Jan 16 05:28 MediaScanController.php
includes/rest/media/MediaHelper.php:22:class MediaHelper {
includes/rest/Media/MediaAnalysisController.php:35:class MediaAnalysisController extends RestController {
includes/rest/media/MediaAnalysisController.php:35:class MediaAnalysisController extends RestController {
includes/rest/media/MediaCleanupController.php:33:class MediaCleanupController extends RestController {
includes/rest/Media/MediaCleanupController.php:33:class MediaCleanupController extends RestController {
includes/rest/Media/MediaScanController.php:32:class MediaScanController extends RestController {
includes/rest/Media/MediaAltTextController.php:32:class MediaAltTextController extends RestController {
includes/rest/media/MediaAltTextController.php:32:class MediaAltTextController extends RestController {
includes/rest/media/MediaScanController.php:32:class MediaScanController extends RestController {
includes/rest/Media/MediaHelper.php:22:class MediaHelper {

thinking
**Investigating directory duplication**

I’m noticing duplicates in the includes/rest/media and includes/rest/Media directories, which seem to have the same files. This duplication could be due to case sensitivity in the file system. On Mac, the file system is typically case-insensitive, meaning both paths refer to the same directory, even though `ls` lists them separately. When I check `ls -la includes/rest/Media`, it shows the same files. I’ll need to modify the code to use just one consistent path, likely `includes/rest/media`. I should also look at MediaController.php for clarity.
exec
/bin/zsh -lc "sed -n '1,220p' includes/rest/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
<?php
/**
 * Media REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;
use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\Contracts\ReferenceFinderInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;
exec
/bin/zsh -lc "sed -n '220,520p' includes/rest/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:
								'description'       => __( 'Minimum file size in KB.', 'wp-admin-health-suite' ),
								'type'              => 'integer',
								'default'           => 500,
								'minimum'           => 1,
								'sanitize_callback' => 'absint',
								'validate_callback' => 'rest_validate_request_arg',
							),
						)
					),
				),
			)
		);

		// GET /wpha/v1/media/alt-text - Get images missing alt text.
		register_rest_route(
			$this->namespace,
			'/' . $this->rest_base . '/alt-text',
			array(
				array(
					'methods'             => \WP_REST_Server::READABLE,
exec
/bin/zsh -lc "sed -n '520,920p' includes/rest/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 41ms:
				'copies' => $copies_details,
			);
		}

		$has_more = ( $start_index + $per_page ) < count( $all_groups );
		$next_cursor = $has_more ? ( $start_index + $per_page ) : null;

		return $this->format_response(
			true,
			array(
				'groups' => $groups,
				'total' => count( $all_groups ),
				'cursor' => $next_cursor,
				'has_more' => $has_more,
			),
			__( 'Duplicate groups retrieved successfully.', 'wp-admin-health-suite' )
		);
	}

	/**
exec
/bin/zsh -lc "sed -n '920,1320p' includes/rest/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 36ms:
				'items_found'   => absint( $items_found ),
				'items_cleaned' => absint( $items_cleaned ),
				'bytes_freed'   => 0,
				'created_at'    => current_time( 'mysql' ),
			),
			array( '%s', '%d', '%d', '%d', '%s' )
		);
	}

	/**
	 * Get all exclusions.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_exclusions( $request ) {
		$exclusions = $this->exclusions->get_exclusions();

exec
/bin/zsh -lc 'rg -n "function safe_delete" -n includes/rest/MediaController.php && rg -n "Safe delete" includes/rest/MediaController.php | head' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 61ms:
687:	public function safe_delete( $request ) {
94:	 * Safe delete instance.
123:	 * @param SafeDeleteInterface        $safe_delete        Safe delete instance.
260:		// POST /wpha/v1/media/delete - Safe delete selected media items.
680:	 * Safe delete selected media items.
exec
/bin/zsh -lc "sed -n '640,840p' includes/rest/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 38ms:
	}

	/**
	 * Trigger full media scan.
	 *
 * @since 1.0.0
 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function trigger_scan( $request ) {
		// Schedule scan in background using action scheduler.
		if ( function_exists( 'as_enqueue_async_action' ) ) {
			as_enqueue_async_action( 'wpha_media_scan', array(), 'wpha_media' );

			return $this->format_response(
				true,
				array(
					'status' => 'scheduled',
					'message' => __( 'Media scan has been scheduled to run in the background.', 'wp-admin-health-suite' ),

thinking
**Inspecting safe deletion process**

I’m checking how the safe_delete method operates. It appears to prepare for deletion rather than execute it, using prepare_deletion. This might indicate that files are moved to trash instead of being permanently deleted. I need to examine the SafeDelete service more closely. The spec mentions reviewing certain controller files for media audit endpoints, so I'll focus on those, especially the MediaCleanupController. I'll open those files for a thorough inspection.
exec
/bin/zsh -lc "sed -n '1,260p' includes/rest/media/MediaScanController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 44ms:
<?php
/**
 * Media Scan REST Controller
 *
 * Handles media scanning operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '1,260p' includes/rest/media/MediaAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 43ms:
<?php
/**
 * Media Analysis REST Controller
 *
 * Handles media analysis and reporting operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;
use WPAdminHealth\REST\RestController;
exec
/bin/zsh -lc "sed -n '1,260p' includes/rest/media/MediaAltTextController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 54ms:
<?php
/**
 * Media Alt Text REST Controller
 *
 * Handles alt text checking operations.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\REST\RestController;

// Exit if accessed directly.
exec
/bin/zsh -lc "sed -n '1,340p' includes/rest/media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Media Cleanup REST Controller
 *
 * Handles media cleanup operations including deletion, restoration, and exclusions.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;
use WPAdminHealth\Contracts\ExclusionsInterface;
use WPAdminHealth\REST\RestController;

exec
/bin/zsh -lc "sed -n '1,260p' includes/rest/media/MediaHelper.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 56ms:
<?php
/**
 * Media Helper
 *
 * Provides shared utility methods for media controllers.
 *
 * @package WPAdminHealth\REST\Media
 */

namespace WPAdminHealth\REST\Media;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * MediaHelper class for shared media operations.
 *
 * @since 1.3.0

thinking
**Continuing the reading process**

I’ve been looking through various controllers, like MediaScanController and MediaAnalysisController. I still need to finish up with MediaAnalysisController and MediaCleanupController since I've only gotten through 260 out of 340 lines. It seems like they might follow a similar structure to MediaController, which involves pagination and related functions. I should keep reading the rest to get a complete understanding of their functionalities. Let's dive back in and wrap this up!
exec
/bin/zsh -lc "sed -n '260,520p' includes/rest/media/MediaAnalysisController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
			array(
				'items'    => $items,
				'total'    => $scan_result['total'],
				'cursor'   => $next_cursor,
				'has_more' => $has_more,
			),
			__( 'Unused media retrieved successfully.', 'wp-admin-health-suite' )
		);
	}

	/**
	 * Get duplicate file groups.
	 *
	 * @since 1.0.0
	 * @since 1.3.0 Moved to MediaAnalysisController.
	 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function get_duplicates( $request ) {
exec
/bin/zsh -lc "sed -n '340,760p' includes/rest/media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 35ms:

			$enriched_exclusions[] = array_merge(
				$exclusion,
				$details,
				array( 'excluded_by_name' => $excluded_by_name )
			);
		}

		return $this->format_response(
			true,
			array(
				'exclusions' => $enriched_exclusions,
				'total'      => count( $enriched_exclusions ),
			),
			__( 'Exclusions retrieved successfully.', 'wp-admin-health-suite' )
		);
	}

	/**
	 * Add exclusions.
exec
/bin/zsh -lc "sed -n '1,260p' includes/rest/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 62ms:
<?php
/**
 * REST Controller Base Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Controller;
use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}
exec
/bin/zsh -lc "sed -n '260,520p' includes/rest/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 66ms:
			return new WP_Error(
				'rest_not_logged_in',
				__( 'You are not currently logged in.', 'wp-admin-health-suite' ),
				array( 'status' => 401 )
			);
		}

		// Check if user has manage_options capability.
		if ( ! current_user_can( 'manage_options' ) ) {
			return new WP_Error(
				'rest_forbidden',
				__( 'Sorry, you are not allowed to do that.', 'wp-admin-health-suite' ),
				array( 'status' => 403 )
			);
		}

		// Verify nonce.
		$nonce_check = $this->verify_nonce( $request );
		if ( is_wp_error( $nonce_check ) ) {
			return $nonce_check;


thinking
**Evaluating media endpoint security**

I'm thinking about how the RestController manages options and nonce, along with rate limiting, which makes media endpoints accessible only to admins. This setup reduces risk in file operations, but I have to be cautious with safe_delete since it can delete attachments. It's crucial to ensure attachments belong to the site. There could be vulnerabilities exposing file paths. Error handling and pagination need attention, especially in MediaController when counting unused media, as it currently truncates results over 1000.
thinking
**Investigating media scanning methods**

I’m looking into the scan_unused_media function, which may return an array that includes total counts and availability indicators. But it looks like they only count the array length, which might lead to an undercount of unused media. I think we should be using scan_result['total'] instead, or check if there's a get_unused_media_count method available in the scanner interface.

Also, I notice there's potential duplication in how get_stats handles large files—it might not return the full list. We might just need the count for stats, but I should inspect the scanner's implementation further.
exec
/bin/zsh -lc 'rg -n "function scan_unused_media" -S includes | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 77ms:
includes/Media/Scanner.php:847:	public function scan_unused_media( int $batch_size = 100, int $offset = 0 ): array {
includes/Contracts/ScannerInterface.php:41:	public function scan_unused_media( int $batch_size = 100, int $offset = 0 ): array;
exec
/bin/zsh -lc "sed -n '820,960p' includes/Media/Scanner.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 67ms:
	 * @return int Progress percentage (0-100).
	 */
	public function get_scan_progress() {
		$progress = get_transient( $this->transient_prefix . 'progress' );
		return false !== $progress ? absint( $progress ) : 0;
	}

	/**
	 * Scan for unused media files.
	 *
	 * Provides paginated scanning for client-side progress tracking.
	 * Uses ORDER BY ID ASC for consistent pagination.
	 *
	 * @since 1.1.0
	 * @since 1.3.0 Uses ConnectionInterface instead of global $wpdb.
	 * @since 1.4.0 Added memory awareness.
	 *
	 * @param int $batch_size Number of attachments to scan per batch.
	 * @param int $offset     Starting offset for pagination.
	 * @return array{


thinking
**Analyzing media ID tracking**

I’m thinking through the process of how the scan_unused_media function returns an array of unused IDs from a current batch, including both scanned offset and count, compared to total attachments. The get_unused endpoint seems to return a total that could refer to the total attachments rather than just unused. Is it representing total attachments scanned for progress? I’m questioning if total should indicate unused items, but they might define 'total' differently. It’s a bit confusing!
thinking
**Examining media statistics**

I’m looking at the get_stats function, where scan_unused_media(1000, 0) is called to count unused items in the first 1000 scanned attachments. This count doesn’t represent total unused items across all attachments, which makes the unused_count in the stats misleading. It might be better to use scanner->get_media_summary or transient results from the last scan. I’ll need to check into the scanner's find_unused_media method as well. Let's dig into get_media_summary!
exec
/bin/zsh -lc 'rg -n "function get_media_summary" -n includes/Media/Scanner.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 75ms:
1066:	public function get_media_summary(): array {
exec
/bin/zsh -lc "sed -n '1040,1140p' includes/Media/Scanner.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 72ms:
			if ( $parent && 'trash' !== $parent->post_status ) {
				$usages[] = array(
					'type'  => 'parent',
					'id'    => (int) $parent->ID,
					'title' => $parent->post_title,
				);
			}
		}

		return $usages;
	}

	/**
	 * Get a summary of the media library.
	 *
	 * @since 1.1.0
	 *
	 * @return array{
	 *     total_count: int,
	 *     total_size: int,



thinking
**Evaluating media statistics**

I’m looking into how the scanner computes the unused_count by calling find_unused_media. It seems heavy. The MediaController appears to use scan_unused_media(1000,0) to navigate memory limitations and reduce heavy scanning. However, that might lead to inaccuracies in counts. Maybe scan_unused_media provides a real-time list for progress tracking? The "statistics" endpoint should ideally show accurate counts, and I need to check for proper response pagination and security in file operations. It’s essential to clarify these specifics!
thinking
**Assessing file operation security**

I’m considering how file operations could be vulnerable. It's important to use WP_Filesystem or ensure paths are confined to the uploads directory to prevent reading arbitrary files. The function get_attached_file does use the _wp_attached_file meta path, which is relative to uploads, but if an attacker modifies the meta, they could access files outside this area. I also need to validate file paths before calling file_exists or filesize to avoid potential warnings or information leaks. Plus, there’s a need to ensure IDs in safe_delete correspond to actual attachments. Validation is crucial!
thinking
**Reviewing parameter sanitization and duplication**

I’m exploring how request->get_param might be sanitized in the WP REST server by calling the sanitize callback. The safe_delete function, however, doesn't seem to check for additional types. In functions like get_unused, get_duplicates, and others, they utilize $request->get_param and then proceed with absint, which is okay. 

But I’m noticing duplication between MediaController and newer controllers, which could suggest that the plugin is transitioning. I should look closer into the SafeDelete service for any potential insecurities in file operations. It's important to ensure everything is consistent and secure!
exec
/bin/zsh -lc 'rg -n "class .*SafeDelete" -S includes | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 68ms:
includes/Media/SafeDelete.php:26:class SafeDelete implements SafeDeleteInterface {
exec
/bin/zsh -lc "sed -n '1,260p' includes/Media/SafeDelete.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Safe Delete Class
 *
 * Implements two-step deletion for media files with recovery capability.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Media;

use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
exec
/bin/zsh -lc "sed -n '260,560p' includes/Media/SafeDelete.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 65ms:
			$attachment_id,
			substr( md5( uniqid( (string) wp_rand(), true ) ), 0, 8 ),
			microtime( true )
		);

		if ( '' !== $prefix ) {
			$unique_id .= '_' . $prefix;
		}

		return $unique_id . '_' . sanitize_file_name( $original_name );
	}

	/**
	 * Prepare deletion by moving files to trash and storing metadata.
	 *
	 * @since 1.0.0
	 *
	 * @param array $attachment_ids Array of attachment IDs to prepare for deletion.
	 * @return array Result with success status and deletion ID.
	 */
exec
/bin/zsh -lc "sed -n '560,900p' includes/Media/SafeDelete.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 64ms:
				$original_thumb_dir = dirname( $original_thumb );
				if ( ! is_dir( $original_thumb_dir ) ) {
					wp_mkdir_p( $original_thumb_dir );
				}

				// Use safe_rename() for TOCTOU protection on thumbnails.
				$this->safe_rename( $trash_thumb, $original_thumb, $trash_dir, $uploads_dir );
			}
		}

		// Recreate the attachment post.
		$attachment_data = array(
			'post_title' => $metadata['post_title'],
			'post_content' => $metadata['post_content'],
			'post_excerpt' => $metadata['post_excerpt'],
			'post_mime_type' => $metadata['post_mime_type'],
			'post_parent' => $metadata['post_parent'],
			'guid' => $metadata['guid'],
			'post_type' => 'attachment',
			'post_status' => 'inherit',


thinking
**Evaluating security validations**

I’m looking at the SafeDelete class which has several security validations like safe unlinking and renaming, ensuring operations are within the base directory and validating with a realpath check. That's reassuring. However, the spec mentions checking the controllers for any file operations security issues. I might need to look into those controllers that deal with file analysis, cleanup, or file operations. There could be endpoints that may accept or delete files via a file path, so I should examine MediaCleanupController too.
thinking
**Inspecting media analysis endpoints**

I’m considering whether there are endpoints for media analysis that take a "threshold" parameter for large files, which is then passed to the large_files->find_large_files($threshold) function. It looks like this function might expect the threshold in kilobytes but takes the value as it is. The request makes a sanitized call with $request->get_param('threshold'). I should look into the MediaController to confirm if it indeed expects the threshold in KB and then check the LargeFilesInterface and its implementation.
exec
/bin/zsh -lc "rg -n \"interface LargeFilesInterface\" -S includes/Contracts && sed -n '1,120p' includes/Contracts/LargeFilesInterface.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 85ms:
includes/Contracts/LargeFilesInterface.php:25:interface LargeFilesInterface {
<?php
/**
 * Large Files Interface
 *
 * Defines the contract for detecting and managing large media files.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface LargeFilesInterface
 *
exec
/bin/zsh -lc 'rg -n "class .*Large" includes/Media | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 70ms:
includes/Media/LargeFiles.php:27:class LargeFiles implements LargeFilesInterface {
exec
/bin/zsh -lc "sed -n '1,260p' includes/Media/LargeFiles.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 64ms:
<?php
/**
 * Large File Identifier Class
 *
 * Identifies large media files and provides optimization suggestions.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Media;

use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\ExclusionsInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}


thinking
**Evaluating response structure**

I think everything could be fine, but I need to ensure that there's proper response pagination. It’s important to have consistent data keys, maybe using 'items' instead of 'groups.' 

Also, I should consider error handling; the controllers don’t seem to check for WP_Error or any invalid results from the underlying services. For example, the duplicate_detector->get_duplicate_groups might return a WP_Error. I’ll need to check the DuplicateDetectorInterface and its implementation for clarity.
exec
/bin/zsh -lc "sed -n '1,160p' includes/Contracts/DuplicateDetectorInterface.php && rg -n \"class Duplicate\" includes/Media | head -n 20" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 73ms:
<?php
/**
 * Duplicate Detector Interface
 *
 * Defines the contract for detecting duplicate media files.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface DuplicateDetectorInterface
 *
 * Contract for duplicate media detection operations.
exec
/bin/zsh -lc "sed -n '1,260p' includes/Media/DuplicateDetector.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 67ms:
<?php
/**
 * Duplicate File Detector Class
 *
 * Detects duplicate media files in the WordPress media library.
 * Uses multiple detection strategies: exact hash matching, filename pattern matching,
 * and dimension/size similarity detection for comprehensive duplicate identification.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Media;

use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\ExclusionsInterface;
use Generator;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
exec
/bin/zsh -lc "sed -n '260,460p' includes/Media/DuplicateDetector.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 72ms:
		$duplicates = $this->find_duplicates();
		$groups     = array();

		foreach ( $duplicates as $hash => $attachment_ids ) {
			if ( count( $attachment_ids ) < 2 ) {
				continue;
			}

			// Filter out excluded items.
			$attachment_ids = $this->exclusions->filter_excluded( $attachment_ids );

			// Re-check count after filtering.
			if ( count( $attachment_ids ) < 2 ) {
				continue;
			}

			// Determine the original (oldest by date or first uploaded).
			$original_id = $this->determine_original( $attachment_ids );
			$copies      = array_values( array_diff( $attachment_ids, array( $original_id ) ) );






thinking
**Considering file handling improvements**

I’m thinking about how `file_exists` can return true for directories or special files, which might affect `filesize`. I need to inspect the `MediaHelper` code for potential improvements. 

First, it makes sense to validate that `$attachment_id` is indeed an attachment before retrieving the file. It’s important to check that the `file_path` is within the uploads directory to prevent unauthorized access. A helper method could be implemented for this, especially since similar methods exist in other classes. We should also update the private `get_attachment_details` method in `MediaController` accordingly.
thinking
**Examining attachment handling issues**

I'm noticing that controllers might not handle invalid attachments very well. The `get_attachment_details` method uses `get_post`, but if it returns empty values, things like `edit_link` could still be set, which isn't ideal. The spec feels vague here; I might be missing a bigger issue.

In `MediaCleanupController`, when they call `get_user_by`, if a user is deleted, it defaults to 'Unknown,' which is fine. However, the `safe_delete` route only sanitizes IDs but doesn't filter out duplicates or zeros, which could be a concern. Just thinking out loud about whether we should enforce better permission checks for safe delete operations.
thinking
**Considering safe delete functionality**

I’m thinking the spec might need additional checks to ensure attachments being deleted aren't still in use. It seems that `SafeDelete->prepare_deletion` just moves files to the trash without verifying if they're currently referenced elsewhere, which raises some security concerns.

Also, while it creates an `index.php` for security in the trash directory, it lacks an `.htaccess` file. Another consideration is that controllers might not validate the deletion record ID when restoring; you could potentially restore any record, even those older than retention periods or already permanently deleted. That's definitely worth looking into!
thinking
**Evaluating deletion and restoration processes**

I see that the system doesn't check for retention when restoring files; it uses `days_remaining`, but the restore method doesn’t consider `retention_days`. This means that files could potentially be restored even after the expiry date, even if they've been purged automatically, which isn’t mentioned in the spec.

We should verify the security of deletion operations to ensure files are moved safely. But controllers might not handle errors correctly. If `safe_delete->prepare_deletion` returns false, controllers send a 400 error, but if some deletions succeed while others fail, they return a success status of 200. Maybe they should return a 207 status for partial success instead? Also, when restoring, if there are failures like 404 or 410 errors, it might be worth addressing that as well.
thinking
**Assessing error handling improvements**

I’m thinking about the spec regarding error handling and whether we should return a 404 for "deletion record not found" instead of a 400. It makes sense to map errors to the appropriate HTTP status codes; for example, 400 for invalid input, 404 for not found, and 403 for unauthorized access. 

The `safe_delete->prepare_deletion` method can return a success false message when no items are prepared due to invalid IDs or missing files. Currently, it returns a 400 error for 'deletion_failed', but maybe a 404 or 422 would be more suitable. 

I see that the spec is quite brief, and there may be more context in the handoff documents. It looks like previous attempts failed due to usage, but we need to delve into tasks Q06-01 through Q06-04 to examine the related security reviews and any potential code improvements. I'll check those plans for further insight.
exec
/bin/zsh -lc "sed -n '1,220p' .plans/Q06-01.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 36ms:
# Q06-01 — REST Controller Base Review

Review includes/rest/RestController.php for proper base controller implementation, common functionality, error handling patterns, and response formatting standards.
exec
/bin/zsh -lc "sed -n '1,220p' .plans/Q06-02.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 30ms:
# Q06-02 — Dashboard REST Controller Review

Review includes/rest/DashboardController.php for dashboard data endpoints, health score calculation API, activity fetching, and proper caching of expensive calculations.
exec
/bin/zsh -lc "sed -n '1,220p' .plans/Q06-03.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 30ms:
# Q06-03 — Database REST Controllers Review

Review includes/rest/DatabaseController.php and includes/rest/database/ controllers for all database operation endpoints. Check input validation, permission checks, and proper error responses.
exec
/bin/zsh -lc "sed -n '1,220p' .t2/handoff/Q06-03.md 2>/dev/null || true" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 68ms:
# Handoff: Q06-03

Created: 2026-01-16T17:11:28.871670Z

Spec: .plans/Q06-03.md


## 2026-01-16T17:14:11.845857Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task Q06-03 in this git repository.

1) Read the spec: .plans/Q06-03.md
2) Read handoff/context: .t2/handoff/Q06-03.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 

thinking
**Updating plan statuses**

I’ve read the spec and the handoff, so I can say that step 1 is complete. Now, I need to update the plan accordingly. It feels good to tick that off the list! I'll make sure to clearly note the updates so I don’t forget anything crucial. It's all about keeping everything organized to ensure the next steps flow smoothly. Let’s get to work on that update!
Plan update
Loaded Q06-04 spec/handoff and started reviewing Media REST controllers and related helpers for security, pagination, and error handling gaps.
  ✓ Read spec and handoff docs
  → Inspect codebase and locate changes
  • Implement Q06-04 changes
  • Run lint and tests
  • Summarize and provide verification

thinking
**Inspecting controller issues**

I need to look into the usage of MediaController versus new controllers. I wonder if the plugin is using MediaController or if it's using separate controllers. My plan is to search in the includes for any instances of "new MediaController" and also check includes/rest/index or the plugin's bootstrapping process. I'll make sure to search for any registration of controllers while I’m at it. Let's see what I find!
exec
/bin/zsh -lc 'rg -n "MediaController|MediaAnalysisController|MediaCleanupController|MediaAltTextController|MediaScanController" includes | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 85ms:
includes/REST/Media/MediaScanController.php:32:class MediaScanController extends RestController {
includes/REST/Media/MediaScanController.php:92:	 * @since 1.3.0 Moved to MediaScanController.
includes/REST/Media/MediaAltTextController.php:32:class MediaAltTextController extends RestController {
includes/REST/Media/MediaAltTextController.php:100:	 * @since 1.3.0 Moved to MediaAltTextController.
includes/REST/Media/MediaCleanupController.php:33:class MediaCleanupController extends RestController {
includes/REST/Media/MediaCleanupController.php:213:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:290:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:324:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:362:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:401:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:432:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:461:	 * @since 1.3.0 Moved to MediaCleanupController.
includes/REST/Media/MediaCleanupController.php:478:	 * @since 1.3.0 Moved to MediaCleanupController. Uses ConnectionInterface instead of global $wpdb.
includes/RestApi.php:109:		require_once WP_ADMIN_HEALTH_PLUGIN_DIR . 'includes/rest/MediaController.php';
includes/RestApi.php:110:		$media_controller = new REST\MediaController(
includes/REST/Media/MediaAnalysisController.php:35:class MediaAnalysisController extends RestController {
includes/REST/Media/MediaAnalysisController.php:176:	 * @since 1.3.0 Moved to MediaAnalysisController.
includes/REST/Media/MediaAnalysisController.php:235:	 * @since 1.3.0 Moved to MediaAnalysisController.
includes/REST/Media/MediaAnalysisController.php:274:	 * @since 1.3.0 Moved to MediaAnalysisController.
includes/REST/Media/MediaAnalysisController.php:325:	 * @since 1.3.0 Moved to MediaAnalysisController.

thinking
**Inspecting REST API structure**

I’m noticing that the includes/RestApi.php file is requiring MediaController and creating an instance of it. However, it also seems there's a RESTServiceProvider introducing new controllers. This means the plugin might be mixing both old and new components. I think it’s a good idea to inspect the includes/RestApi.php file along with the service provider to clarify how they interact. Let’s open the includes/RestApi.php file to dig deeper!
exec
/bin/zsh -lc "sed -n '1,220p' includes/RestApi.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 72ms:
<?php
/**
 * REST API Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * REST API class for handling REST API endpoints.
 *
 * @since 1.0.0
 */
class RestApi {

thinking
**Inspecting REST controllers**

It looks like the RestApi currently registers only the MediaController, but the RESTServiceProvider could be relevant for Dependency Injection. It seems like the plugin might be transitioning to this provider while still using the old REST controllers; both file naming conventions suggest that might be the case. The specifications for Q06-04 reference both MediaController and media controllers, so to be safe, our changes should cater to both. I’ll definitely check the MediaHelper and MediaController functions as well.
exec
/bin/zsh -lc "sed -n '1,220p' includes/Providers/RESTServiceProvider.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 60ms:
<?php
/**
 * REST Service Provider
 *
 * Registers REST API controllers and services.
 *
 * @package WPAdminHealth\Providers
 */

namespace WPAdminHealth\Providers;

use WPAdminHealth\Container\ServiceProvider;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\AnalyzerInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\RevisionsManagerInterface;
use WPAdminHealth\Contracts\TransientsCleanerInterface;
use WPAdminHealth\Contracts\OrphanedCleanerInterface;
use WPAdminHealth\Contracts\TrashCleanerInterface;


thinking
**Inspecting file operations security**

I’m looking at how this service provider manages both old and new media controllers, probably to keep compatibility while separating endpoints. Our changes should apply to both types and the MediaHelper. Now, about file operations security: I noticed that some endpoints, like get_attachment_details, don’t expose full paths, which is good. However, the safe_delete method returns a full file path that could be a security concern, potentially revealing server paths. Perhaps it would be better to expose just the file name instead.
thinking
**Assessing security of file paths**

I’m examining how the endpoint provides an absolute path to the trash directory on the server, which could accidentally reveal file system paths to admins. While admins already have manage_options, I think it’s better not to expose the full path—just the file name, as a security best practice. I noticed that safe_delete doesn’t include paths in errors, and restore_media doesn’t output paths either. It seems like they might want to eliminate file paths from responses altogether. I should search for occurrences of "file_path" or "path" in the media controllers.
exec
/bin/zsh -lc 'rg -n "file_path|path" includes/rest/MediaController.php includes/rest/media/*.php | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 67ms:
includes/rest/media/MediaHelper.php:35:		$file_path = get_attached_file( $attachment_id );
includes/rest/media/MediaHelper.php:36:		$filename  = $file_path ? basename( $file_path ) : '';
includes/rest/media/MediaHelper.php:37:		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
includes/rest/MediaController.php:795:		$file_path = get_attached_file( $attachment_id );
includes/rest/MediaController.php:796:		$filename  = $file_path ? basename( $file_path ) : '';
includes/rest/MediaController.php:797:		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;




thinking
**Reviewing file path security**

I'm considering how controllers use `file_path` in `get_attachment_details`. The `safe_delete` function returns `file_path` from the service, but it may also expose the path in its responses through `$result`. This could be a potential path leak, which contradicts the spec's focus on file operation security. It suggests that `safe_delete` should either remove `file_path` or sanitize it to just the file name. I also notice that `MediaController` returns an admin URL, which might require additional checks in other endpoints.
thinking
**Implementing task improvements**

I’m looking at tasks we could implement to enhance security in various functions. For instance, in `MediaHelper::get_attachment_details`, validating file paths for uploads is crucial to guard against non-files. The same applies to `MediaController::get_attachment_details`. 

In the `safe_delete` endpoints, it might be wise to remove absolute file paths from responses or replace them with sanitized names. Also, I see that while `sanitize_ids` may help, it doesn't filter out zeros or duplicates, so we could improve that. Lastly, ensuring accurate pagination in `get_stats` would be beneficial for media overview statistics.
thinking
**Examining MediaAnalysisController**

I'm looking into how the `MediaAnalysisController` handles scanning unused media. It uses `scan_unused_media`, which returns a total count of attachments and a list of unused items found. However, the behavior isn't typical pagination; the page size is based on scanned attachments, not the unused ones returned. This could lead to situations where the UI shows pages with fewer items than expected. It seems the intent was to show scanning progress and accumulate unused IDs rather than standard pagination, even though the endpoint claims to provide a "paginated list of unused media."
thinking
**Investigating pagination issues**

I suspect there could be a bug in the pagination implementation. It seems they might want to collect unused attachments after scanning all of them, then slice the results, but that's quite resource-intensive. However, they may have a service that caches these scan results in `wp_admin_health_media_scan_results`. I see that `get_stats` retrieves the last scan using `get_transient('wp_admin_health_media_scan_results')`, which suggests that the scanner could be storing results there. I’ll need to search for how `wp_admin_health_media_scan_results` is used to clarify this.
exec
/bin/zsh -lc 'rg -n "wp_admin_health_media_scan_results" -S includes | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
includes/AI/Recommendations.php:403:			$scan_results = get_transient( 'wp_admin_health_media_scan_results' );
includes/REST/Media/MediaAnalysisController.php:204:		$last_results = get_transient( 'wp_admin_health_media_scan_results' );
includes/REST/MediaController.php:421:		$last_results = get_transient( 'wp_admin_health_media_scan_results' );
exec
/bin/zsh -lc "rg -n \"set_transient\\(\\s*'wp_admin_health_media_scan_results'\" -S includes | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 56ms:


thinking
**Searching for media scan results**

I’m considering the lack of a set_transient call, so maybe they’re using something like update_option instead. It feels a bit off, but there’s a chance I might find useful information if I search for "media_scan_results". I have to explore this further to understanding what’s happening. It’s a bit like a puzzle, trying to figure out the right function to use in this case. Let's see what I find!
exec
/bin/zsh -lc 'rg -n "media_scan_results" -S includes | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 56ms:
includes/REST/Media/MediaAnalysisController.php:204:		$last_results = get_transient( 'wp_admin_health_media_scan_results' );
includes/REST/MediaController.php:421:		$last_results = get_transient( 'wp_admin_health_media_scan_results' );
includes/AI/Recommendations.php:403:			$scan_results = get_transient( 'wp_admin_health_media_scan_results' );

thinking
**Investigating transient settings**

I’m noticing that this transient is read but never set, which seems like a bug. I should check if it might be set in JavaScript or in another file that’s not included, perhaps in tasks? Actually, it could be the action scheduler that sets it, like with `wpha_media_scan`. It sounds like a good idea to search for the 'wpha_media_scan' action to see where it's being addressed!
exec
/bin/zsh -lc 'rg -n "wpha_media_scan" -S . | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 55ms:
./includes/Settings/SettingsServiceProvider.php:660:			'wpha_media_scan'        => array(
./includes/Settings/SettingsServiceProvider.php:808:		$hooks = array( 'wpha_database_cleanup', 'wpha_media_scan', 'wpha_performance_check' );
./includes/Media/Tasks/MediaScanTask.php:63:	const LOCK_TRANSIENT = 'wpha_media_scan_lock';
./includes/Media/Tasks/MediaScanTask.php:77:	const PROGRESS_OPTION_KEY = 'wpha_media_scan_progress';
./includes/Media/Tasks/MediaScanTask.php:227:		 * @hook wpha_media_scan_before_execute
./includes/Media/Tasks/MediaScanTask.php:233:		do_action( 'wpha_media_scan_before_execute', $scan_tasks, $completed_tasks, $options );
./includes/Media/Tasks/MediaScanTask.php:267:			 * @hook wpha_media_scan_before_subtask
./includes/Media/Tasks/MediaScanTask.php:272:			do_action( 'wpha_media_scan_before_subtask', $task, $options );
./includes/Media/Tasks/MediaScanTask.php:290:			 * @hook wpha_media_scan_after_subtask
./includes/Media/Tasks/MediaScanTask.php:296:			do_action( 'wpha_media_scan_after_subtask', $task, $result, $options );
./includes/Media/Tasks/MediaScanTask.php:322:		 * @hook wpha_media_scan_after_execute
./includes/Media/Tasks/MediaScanTask.php:329:		do_action( 'wpha_media_scan_after_execute', $scan_results, $subtask_errors, $was_interrupted, $elapsed_time );
./includes/Media/Tasks/MediaScanTask.php:745:		 * @hook wpha_media_scan_completed
./includes/Media/Tasks/MediaScanTask.php:749:		do_action( 'wpha_media_scan_completed', $results );
./tests/IntegrationTest.php:92:		wp_clear_scheduled_hook( 'wpha_media_scan' );
./tests/IntegrationTest.php:317:		$next_media_scan = wp_next_scheduled( 'wpha_media_scan' );
./includes/REST/Media/MediaScanController.php:100:			as_enqueue_async_action( 'wpha_media_scan', array(), 'wpha_media' );
./includes/Providers/SchedulerServiceProvider.php:182:		add_action( 'wpha_media_scan', array( $this, 'execute_media_scan' ) );
./includes/Installer.php:283:			'wpha_media_scan'        => array(
./includes/Installer.php:557:			'wpha_media_scan',

thinking
**Inspecting MediaScanTask**

I'm looking into the MediaScanTask to check the scan results and caching options. I plan to search within the file for references like 'set_transient' or 'wp_admin_health_media_scan_results.' It seems like using `rg` to search within the file will be an efficient way to find those details. I want to make sure I'm thorough in this investigation to understand the best way to approach it.
exec
/bin/zsh -lc 'rg -n "scan_results|transient|wp_admin_health_media" includes/Media/Tasks/MediaScanTask.php | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
59:	 * Lock transient name.
208:		$scan_results = array(
249:						'duplicates'      => $scan_results['duplicates'],
250:						'large_files'     => $scan_results['large_files'],
251:						'missing_alt'     => $scan_results['missing_alt'],
252:						'total_issues'    => $scan_results['total_issues'],
253:						'total_bytes'     => $scan_results['total_bytes'],
281:				$this->merge_subtask_results( $scan_results, $task, $result );
312:			$this->store_scan_results( $scan_results );
324:		 * @param array $scan_results    The scan results.
329:		do_action( 'wpha_media_scan_after_execute', $scan_results, $subtask_errors, $was_interrupted, $elapsed_time );
335:				$scan_results['total_issues'],
336:				$scan_results['total_bytes'],
342:		$result                    = $this->create_result( $scan_results['total_issues'], $scan_results['total_bytes'], empty( $subtask_errors ) );
432:		$existing_lock = get_transient( self::LOCK_TRANSIENT );
445:		return set_transient( self::LOCK_TRANSIENT, time(), self::LOCK_DURATION );
456:		return set_transient( self::LOCK_TRANSIENT, time(), self::LOCK_DURATION );
467:		return delete_transient( self::LOCK_TRANSIENT );
478:		$lock = get_transient( self::LOCK_TRANSIENT );
591:	 * @param array  $scan_results Main scan results (modified by reference).
exec
/bin/zsh -lc "sed -n '180,360p' includes/Media/Tasks/MediaScanTask.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
		$this->scanner            = $scanner;
		$this->duplicate_detector = $duplicate_detector;
		$this->large_files        = $large_files;
		$this->alt_text_checker   = $alt_text_checker;
		$this->time_limit         = self::DEFAULT_TIME_LIMIT;
	}

	/**
	 * {@inheritdoc}
	 *
	 * @since 1.2.0
	 * @since 1.6.0 Added locking, incremental scanning, and timeout handling.
	 */
	public function execute( array $options = array() ): array {
		$this->start_time = microtime( true );
		$this->configure_time_limit( $options );

		$this->log( 'Starting media scan task' );

		// Attempt to acquire lock to prevent concurrent scans.
exec
/bin/zsh -lc "sed -n '660,760p' includes/Media/Tasks/MediaScanTask.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
	 *
	 * @return array Current progress data.
	 */
	public function get_progress(): array {
		return $this->load_progress();
	}

	/**
	 * Check if a previous run was interrupted and needs resuming.
	 *
	 * @since 1.6.0
	 *
	 * @return bool True if there's saved progress to resume.
	 */
	public function has_pending_progress(): bool {
		$progress = get_option( self::PROGRESS_OPTION_KEY, array() );
		return ! empty( $progress );
	}

	/**


thinking
**Evaluating MediaScanTask processes**

I noticed that MediaScanTask stores results in the wpha_scan_history database table instead of transient storage, which seems unused. The get_stats function attempts to retrieve last_results, but they are never set, making last_scan always null. This isn’t mentioned in the spec but could be tied to error handling and caching. It might be beneficial to improve the system to utilize the scan history for the last scan, as it stores records with a created_at timestamp. However, controllers are struggling to access this data.
thinking
**Investigating scan history usage**

I think we might be able to fix the issue by reading from the scan history table to retrieve the last media scan using a connection to query. That seems useful. However, the Q06-02 spec regarding dashboard caching might have already covered some of this, but I'm focusing on Q06-04, which may not address it. So, I should check how DashboardController utilizes the scan history; that could provide some insights. Let's search for the usage of 'wpha_scan_history' to get a clearer picture.
exec
/bin/zsh -lc 'rg -n "wpha_scan_history" -S includes/rest includes/REST | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 126ms:
includes/REST/ActivityController.php:95:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/Media/MediaCleanupController.php:486:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/Media/MediaCleanupController.php:486:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/ActivityController.php:95:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/MediaController.php:892:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/DatabaseController.php:769:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/MediaController.php:892:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/DatabaseController.php:769:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/DashboardController.php:281:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/DashboardController.php:381:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/DashboardController.php:692:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/DashboardController.php:281:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/DashboardController.php:381:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/DashboardController.php:692:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/Database/CleanupController.php:758:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/Database/CleanupController.php:758:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/REST/Database/OptimizationController.php:303:		$table_name = $connection->get_prefix() . 'wpha_scan_history';
includes/rest/Database/OptimizationController.php:303:		$table_name = $connection->get_prefix() . 'wpha_scan_history';




thinking
**Analyzing cursor parameters**

I’m considering the cursor parameter, which is an integer, so using absint makes sense. However, I see a potential bug: in the get_unused function, $cursor is a parameter but defaults to 0 in get_pagination_params. This means if not provided, $cursor will be 0, and the condition $cursor ? absint($cursor) : 0 works because 0 is falsy. Yet, if cursor is the string "0," that also evaluates to falsy in PHP. 

Now, looking at get_stats, it calls scan_unused_media(1000,0) for unused media counts, which could be imprecise. They might have chosen 1000 for an approximation, but media statistics might need accurate counts for health scores. In DashboardController, they might use the same counts and rely on scan history. I'm curious how AI Recommendations interacts with scan results, which seem to use transient data, though it’s never set.
thinking
**Reviewing file path security**

I’m looking into whether Q06-04 aims to enhance security for the MediaHelper file path, like validating attachments and sanitizing file names and sizes. That seems plausible for typical security reviews. On a Mac file system, there are duplicate paths like includes/rest/Media and includes/rest/media, which could create cross-platform issues on Linux that’s case-sensitive. This might cause conflicts with require_once statements. 

In RestApi.php, the file is correctly referenced with a capital "M." For new controllers, if there’s inconsistency in casing, that could lead to autoload failures on Linux. So, ensuring consistent file path casing is crucial for plugin deployment on Linux!
thinking
**Examining directory case sensitivity**

I'm investigating the possibility of duplicate directories in the repository, like "rest" vs. "REST" and "Media" vs. "media." My search results show that there could be both directories, such as includes/rest/media and includes/REST/Media. On a Mac, they would be treated as the same because it's case-insensitive, but with Git, that could create conflicting issues. 

If both directories exist in the repository, it might lead to confusion. My earlier `ls` command indicated that "Media" is indeed capitalized, pointing to how sensitive the filesystem is about casing. It seems likely that the actual directory in Git is "includes/rest/Media."
thinking
**Clarifying directory paths**

I need to clarify that while we referenced includes/rest/media, that path might not exist on Linux due to case sensitivity. When I ran `ls includes/rest`, it showed directories like "Media," "Database," and "Performance," all capitalized. But when I checked `ls includes/rest/media`, it worked because of case-insensitivity. 

However, in Git, the directory is actually includes/rest/Media with a capital "M." The search results also indicated a potential directory includes/REST, which adds to the confusion. To understand the actual directories better, I think I should check with `ls -la includes | head`.
exec
/bin/zsh -lc 'ls -la includes | head -n 60' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
total 224
drwxr-xr-x@ 27 ahmedyounis  staff    864 Jan 16 07:08 .
drwxr-xr-x  55 ahmedyounis  staff   1760 Jan 16 09:09 ..
-rw-------@  1 ahmedyounis  staff   1309 Jan  9 00:36 Admin.php
drwxr-xr-x@  5 ahmedyounis  staff    160 Jan 16 09:03 AI
-rw-r--r--@  1 ahmedyounis  staff   9138 Jan 14 06:38 Assets.php
-rw-------@  1 ahmedyounis  staff   2007 Jan 16 07:08 autoload.php
-rw-r--r--@  1 ahmedyounis  staff  13169 Jan 16 04:41 BatchProcessor.php
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 04:37 Cache
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan  9 00:39 Container
drwxr-xr-x@ 26 ahmedyounis  staff    832 Jan 16 09:15 Contracts
drwxr-xr-x@ 11 ahmedyounis  staff    352 Jan 16 07:43 Database
-rw-------@  1 ahmedyounis  staff    791 Jan  7 15:04 Database.php
drwxr-xr-x@  6 ahmedyounis  staff    192 Jan 16 06:18 Exceptions
-rw-------@  1 ahmedyounis  staff  13462 Jan 16 04:23 HealthCalculator.php
-rw-------@  1 ahmedyounis  staff     35 Jan  7 10:29 index.php
-rw-r--r--@  1 ahmedyounis  staff  17859 Jan 16 04:42 Installer.php
drwxr-xr-x@  9 ahmedyounis  staff    288 Jan  9 00:44 Integrations
drwxr-xr-x@ 11 ahmedyounis  staff    352 Jan 16 08:21 Media
-rw-r--r--@  1 ahmedyounis  staff   8687 Jan 16 00:59 Multisite.php
exec
/bin/zsh -lc 'ls -la includes/REST && ls -la includes/REST/Media' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 61ms:
total 288
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 09:09 .
drwxr-xr-x@ 27 ahmedyounis  staff    864 Jan 16 07:08 ..
-rw-------@  1 ahmedyounis  staff   4336 Jan 16 04:25 ActivityController.php
-rw-------@  1 ahmedyounis  staff  20728 Jan 16 09:09 DashboardController.php
drwxr-xr-x@  5 ahmedyounis  staff    160 Jan 16 09:13 Database
-rw-------@  1 ahmedyounis  staff  27027 Jan 16 04:26 DatabaseController.php
-rw-------@  1 ahmedyounis  staff     28 Jan  7 10:52 index.php
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 08:24 Media
-rw-------@  1 ahmedyounis  staff  30807 Jan 16 08:24 MediaController.php
drwxr-xr-x@  8 ahmedyounis  staff    256 Jan 16 05:28 Performance
-rw-------@  1 ahmedyounis  staff  28180 Jan 16 04:34 PerformanceController.php
-rw-------@  1 ahmedyounis  staff  19086 Jan 16 09:06 RestController.php
total 88
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 08:24 .
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 09:09 ..
-rw-r--r--@  1 ahmedyounis  staff   4667 Jan 16 06:19 MediaAltTextController.php
-rw-r--r--@  1 ahmedyounis  staff  12169 Jan 16 06:13 MediaAnalysisController.php
-rw-r--r--@  1 ahmedyounis  staff  13973 Jan 16 08:24 MediaCleanupController.php
-rw-r--r--@  1 ahmedyounis  staff   3355 Jan 16 06:12 MediaHelper.php



thinking
**Inspecting codebase issues**

I'm looking at using includes/REST for the task. It seems I need to check specific files like MediaController.php and MediaHelper.php to find issues. The first step is to inspect the codebase for possible changes, including file path validation and removing absolute file paths from certain responses. 

I notice that current implementations aren't checking if paths are within the uploads directory. So, I think implementing a function in MediaHelper to validate paths is a good idea, using wp_upload_dir as a basis.
thinking
**Implementing upload path validation**

I’m thinking about creating a small helper function inside MediaHelper to check if a file path is within the uploads directory. This function could be private and static, used by get_attachment_details. I might utilize wp_upload_dir and realpath for this.

In get_attachment_details, I’ll retrieve the file path using get_attached_file. Then, I want to get the filename and initialize the file size to 0. I’ll check if the file path is valid, exists, and is indeed a file before retrieving its size, but I’m wondering about using @filesize to avoid warnings. I think there's a safe approach to this!
thinking
**Considering error handling and UI feedback**

I’m realizing I should probably catch exceptions since functions like file_exists and filesize don’t throw errors. I’m also thinking about the safe_delete path leak, as it returns 'file_path' as a full path in prepared_items. The UI likely doesn’t need this full path; it might be better to only show the file name and give an option to restore.

I need to check how the UI uses this response. I’ll search the frontend source for 'prepared_items' and see if any plugin JavaScript files are involved.
exec
/bin/zsh -lc 'rg -n "prepared_items|excluded_ids|deletion_id" -S . | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 59ms:
./tasks.csv:30:M03-06,"Safe Media Deletion System","Create /includes/media/class-safe-delete.php. Methods: prepare_deletion(attachment_ids), execute_deletion(deletion_id), restore_deleted(deletion_id), get_deletion_queue(), get_deleted_history(). Workflow: 1) User selects items, 2) prepare_deletion moves files to /wp-content/wpha-trash/ and stores metadata, 3) Items recoverable for 30 days, 4) execute_deletion permanently removes after confirmation. Store in custom table: wpha_deleted_media (id, attachment_id, file_path, metadata JSON, deleted_at, permanent_at). Acceptance: Two-step deletion prevents accidents, restore works perfectly, auto-purge after 30 days."
./docs/developers/rest-api.md:954:		"prepared_items": [123, 124, 125],
./docs/developers/rest-api.md:955:		"deletion_id": 42,
./docs/developers/rest-api.md:974:	"deletion_id": 42
./docs/developers/rest-api.md:984:  -d '{"deletion_id": 42}'
./docs/developers/rest-api.md:2020:							"raw": "{\n  \"deletion_id\": 42\n}"
./includes/Contracts/SafeDeleteInterface.php:35:	 * @return array{success: bool, prepared_items: array<int>, errors: array<string>, message: string} Preparation result.
./includes/Contracts/SafeDeleteInterface.php:44:	 * @param int $deletion_id Deletion ID from the deletion queue.
./includes/Contracts/SafeDeleteInterface.php:47:	public function execute_deletion( int $deletion_id ): array;
./includes/Contracts/SafeDeleteInterface.php:54:	 * @param int $deletion_id Deletion ID from the deletion queue.
./includes/Contracts/SafeDeleteInterface.php:57:	public function restore_deleted( int $deletion_id ): array;
./includes/Media/SafeDelete.php:288:		$prepared_items = array();
./includes/Media/SafeDelete.php:353:				$deletion_id = $this->connection->get_insert_id();
./includes/Media/SafeDelete.php:358:				$prepared_items[] = array(
./includes/Media/SafeDelete.php:360:					'deletion_id' => $deletion_id,
./includes/Media/SafeDelete.php:369:			'success' => ! empty( $prepared_items ),
./includes/Media/SafeDelete.php:370:			'prepared_items' => $prepared_items,
./includes/Media/SafeDelete.php:374:				count( $prepared_items ),
./includes/Media/SafeDelete.php:385:	 * @param int $deletion_id Deletion ID to permanently remove.
./includes/Media/SafeDelete.php:388:	public function execute_deletion( int $deletion_id ): array {
exec
/bin/zsh -lc "sed -n '900,1040p' docs/developers/rest-api.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 34ms:
		"message": "Media scan has been scheduled to run in the background."
	},
	"message": "Media scan scheduled successfully."
}
```

**Response (without Action Scheduler)**:

```json
{
	"success": true,
	"data": {
		"status": "completed",
		"results": {
			"scanned": 450,
			"unused": 23,
			"duplicates": 5
		}
	},
	"message": "Media scan completed successfully."


thinking
**Evaluating API response changes**

I’m thinking about transforming the response to exclude the file_path for security reasons, which shouldn't impact service tests. I wonder if there are tests specifically for API output. This WordPress plugin has PHP unit tests, and potentially Node tests for JavaScript. I should check the package.json to run lint and tests via npm. If any tests are expecting file_path in the API response, they might fail, but probably not. Let's search for those references in the tests directory.
thinking
**Investigating test frameworks**

I'm thinking about how npm test might actually run PHPUnit in this WordPress plugin context, but it could also be running Jest. It’s a bit confusing since there are different testing frameworks involved. I really need to inspect the package.json file to clarify which tests are being executed. It’s crucial to confirm whether we’re dealing with PHP unit tests or JavaScript tests, so let’s dive into that file and take a closer look.
exec
/bin/zsh -lc 'cat package.json' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 40ms:
{
  "name": "wp-admin-health-suite",
  "version": "1.0.0",
  "description": "A comprehensive suite for monitoring and maintaining WordPress admin health and performance",
  "scripts": {
    "build": "webpack --mode production",
    "build:dev": "webpack --mode development",
    "watch": "webpack --mode development --watch",
    "dev": "webpack serve --mode development --open",
    "lint": "eslint assets/js --ext .js,.jsx",
    "lint:fix": "eslint assets/js --ext .js,.jsx --fix",
    "format": "prettier --write \"**/*.{js,jsx,json,css,scss,md}\"",
    "format:check": "prettier --check \"**/*.{js,jsx,json,css,scss,md}\"",
    "test": "jest --passWithNoTests",
    "prepare": "husky"
  },
  "keywords": [
    "wordpress",
    "plugin",
    "health",

thinking
**Evaluating testing procedures**

I realize that running `npm test` only runs Jest for JavaScript and not for PHP unit tests. Since our changes are in PHP, there may not be any tests. However, we still need to run `npm run lint` and `npm test` as specified; they might pass. I can adjust the API response without test coverage but need to ensure I don’t break any JavaScript code in assets that uses this API. Let's check the front-end code in assets/js for references like '/media/delete'.
exec
/bin/zsh -lc 'rg -n "media/(delete|restore|unused|duplicates|large|alt-text|stats)" assets/js -S | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 80ms:
assets/js/media-audit.js:182:				path: '/wpha/v1/media/stats',
assets/js/media-audit.js:290:					apiPath = '/wpha/v1/media/unused';
assets/js/media-audit.js:293:					apiPath = '/wpha/v1/media/duplicates';
assets/js/media-audit.js:296:					apiPath = '/wpha/v1/media/large-files';
assets/js/media-audit.js:965:					? '/wpha/v1/media/delete'
exec
/bin/zsh -lc "sed -n '140,380p' assets/js/media-audit.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
				'change',
				'.wpha-select-all',
				this.handleSelectAll.bind(this)
			);
			$(document).on(
				'change',
				'.wpha-item-checkbox',
				this.handleItemSelect.bind(this)
			);

			// Bulk actions
			$(document).on(
				'click',
				'.wpha-bulk-apply-btn',
				this.handleBulkAction.bind(this)
			);

			// Individual actions
			$(document).on(
				'click',

thinking
**Investigating API Endpoints**

It seems the API endpoints used in JavaScript are different from what I'm expecting. For example, it utilizes '/wpha/v1/media/large-files' instead of the anticipated '/media/large'. I'll check the MediaController for route names in the register_routes function, which mentions endpoints like '/media/large' and '/media/alt-text'. JS also uses endpoints like '/media/large-files' and '/media/missing-alt'. I need to explore further, possibly looking for other controllers or alias routes related to 'large-files'. Let's search for the route registration for that.
exec
/bin/zsh -lc 'rg -n "large-files|missing-alt" includes/REST -S | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:


thinking
**Evaluating response pagination**

I'm considering the need to verify proper response pagination in the endpoints. It's possible they should support pagination parameters. I think I need to look at the `media-audit.js` file to see what the UI expects from the API. For instance, for the unused tab, it seems to expect a full list of unused items, while the duplicates tab likely needs grouped data. If the UI calculates total pages based on items per page, restful endpoints should return all items for proper functioning.
exec
/bin/zsh -lc "rg -n \"response\\.data\\.items|has_more|cursor\" assets/js/media-audit.js | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:

exec
/bin/zsh -lc 'ls -la assets/js | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
total 216
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 03:04 .
drwxr-xr-x@  6 ahmedyounis  staff    192 Jan  7 10:29 ..
-rw-r--r--@  1 ahmedyounis  staff  24109 Jan 16 03:03 admin.js
-rw-r--r--@  1 ahmedyounis  staff  14698 Jan 16 03:04 charts.js
drwxr-xr-x@ 12 ahmedyounis  staff    384 Jan 16 00:58 components
-rw-r--r--@  1 ahmedyounis  staff  15604 Jan  7 17:43 database-health.js
drwxr-xr-x@ 13 ahmedyounis  staff    416 Jan  7 14:44 dist
drwxr-xr-x@  7 ahmedyounis  staff    224 Jan 16 03:05 entries
-rw-------@  1 ahmedyounis  staff     35 Jan  7 10:29 index.php
-rw-r--r--@  1 ahmedyounis  staff  26383 Jan 16 00:56 media-audit.js
-rw-r--r--@  1 ahmedyounis  staff  18190 Jan  7 17:43 performance.js
drwxr-xr-x@  3 ahmedyounis  staff     96 Jan  7 17:43 utils

thinking
**Inspecting media-audit use**

I see that there's a file named media-audit.js, and it seems to be utilized, possibly on the admin page. It would be a good idea to inspect admin.js to see if it loads any modules. I’ll search for “media-audit” within admin.js to find any relevant entries. This could help clarify how this file is connected to the rest of the system, which might lead to some interesting findings!
exec
/bin/zsh -lc 'rg -n "media-audit" assets/js | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 38ms:
assets/js/entries/media-audit.js:18:import '../media-audit.js';
assets/js/media-audit.js:1112:			$('.wpha-media-audit-wrap h1').after($notice);
assets/js/media-audit.js:1172:		if ($('.wpha-media-audit').length) {
exec
/bin/zsh -lc "sed -n '1,80p' assets/js/entries/media-audit.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 39ms:
/**
 * Media Audit Entry Point
 *
 * Main entry point for the media audit admin page.
 * Imports and initializes page-specific functionality.
 *
 * @package
 */

import React from 'react';
import { createRoot } from 'react-dom/client';

// Import React components
import MetricCard from '../components/MetricCard.jsx';

// Import core admin utilities
import '../admin.js';
import '../media-audit.js';

// Make components globally available for use in WordPress templates




thinking
**Analyzing API routes**

I'm looking into how the media audit entrypoint uses `media-audit.js`. It references API paths like `/wpha/v1/media/large-files` and `/missing-alt`, but I notice that MediaController has different paths like `/large` and `/alt-text`. This mismatch stands out. 

I've confirmed the paths used in JavaScript match expected routes for most functions, but large-files and missing-alt are off. To fix this, I propose creating alias routes to ensure compatibility and maintain proper error handling.
thinking
**Reviewing controller endpoints**

I’m focusing on the controllers to ensure that the endpoints exist and their route names are correct. The spec didn’t highlight the mismatched endpoints, but it’s essential for the media audit review. The UI might be using new endpoints due to changes, which could explain any discrepancies. 

Also, I notice the UI expects a response in array format, particularly for large-files and missing-alt. However, other endpoints like `/media/unused` return an object format. I need to clarify how the MediaController manages its response so everything aligns properly.
thinking
**Investigating UI data handling**

I’m realizing that if the response.data is an object instead of an array, it could break the UI. Initially, dataCache[tab] is empty, but if response.data is set and it’s an object, the later call to filterData would fail because it expects an array.

I need to double-check the MediaController’s format_response method; it wraps the data, meaning response.data could be in an unexpected format. If get_unused is passing an object, then trying to spread that could cause issues, particularly since filterData expects an array. I should look at the filterData function again to confirm.
thinking
**Examining data structure**

I’m considering that if data is an object, it could throw a TypeError saying that data is not iterable. This means the UI would fail for the unused data. 

I'm wondering if dataCache[tab] is actually set up as an object containing a property named items, which would mean filterData might be using data.items. To clarify this situation, I need to investigate where dataCache is initialized. I should search through the code for that specific initialization.
exec
/bin/zsh -lc 'rg -n "dataCache" -n assets/js/media-audit.js | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 40ms:
37:		dataCache: {
186:						this.dataCache.stats = response.data;
282:			if (this.dataCache[tab].length > 0) {
313:						this.dataCache[tab] = response.data;
335:			let data = this.filterData(tab, this.dataCache[tab]);
770:						Object.keys(this.dataCache).forEach((key) => {
772:								this.dataCache[key] = [];
976:						this.dataCache[tab] = this.dataCache[tab].filter(
exec
/bin/zsh -lc "sed -n '1,120p' assets/js/media-audit.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 32ms:
/**
 * Media Audit JavaScript
 *
 * Handles media audit scanning, filtering, sorting, and bulk operations.
 *
 * @param $
 * @package
 */

(function ($) {
	'use strict';

	const MediaAudit = {
		/**
		 * Current tab.
		 */
		currentTab: 'unused',

		/**
		 * Items per page.


thinking
**Evaluating pagination implementation**

I'm noticing that controllers are using cursor-based pagination, which might not align with the current UI expectations. It seems there could have been a time when the UI depended on full arrays, but the newer controller versions now support cursor/per_page for enhanced performance. If the UI is still set to expect arrays and local pagination, there might be a mismatch. Perhaps the fix involves ensuring the server-side pagination aligns with the new controller specifications, and then updating the UI accordingly.
thinking
**Considering UI and data structure changes**

I’m thinking that adapting the UI might be necessary, perhaps by returning data.items while also including the older array format at the root. This could help maintain backward compatibility. I could return response.data as an array while adding pagination info in the headers. It might also be worthwhile to check the JavaScript code for any expectations regarding response formats, such as response.data.items. I’ll look for terms like "cursor" or "has_more" in the assets/js files.
exec
/bin/zsh -lc 'rg -n "cursor|has_more|per_page" assets/js -S | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 58ms:
assets/js/components/QuickActions.jsx:265:		cursor: 'pointer',
assets/js/components/QuickActions.jsx:274:		cursor: 'not-allowed',
assets/js/components/QuickActions.jsx:364:		cursor: 'pointer',
assets/js/components/QuickActions.jsx:377:		cursor: 'pointer',
assets/js/components/QuickActions.jsx:607:									cursor: 'pointer',
assets/js/components/MetricCard.jsx:91:		cursor: isClickable ? 'pointer' : 'default',
assets/js/components/Recommendations.jsx:283:		cursor: 'pointer',
assets/js/components/Recommendations.jsx:412:								cursor: 'pointer',
assets/js/components/Recommendations.jsx:449:							cursor: 'pointer',
assets/js/components/Recommendations.jsx:614:		cursor: 'pointer',
assets/js/components/Recommendations.jsx:690:		cursor: 'pointer',
assets/js/components/ActivityTimeline.jsx:262:		cursor: 'pointer',

thinking
**Checking pagination structure**

I'm noticing that there's no usage of cursor or per_page in the API, and it seems like the UI is likely using full arrays with local pagination. It makes me wonder if the controllers doing cursor-based pagination are either new or not integrated with the UI yet. The spec mentions "proper response pagination," so that might mean controllers should return arrays with meta data for client-side pagination. I'll check the developer documentation again for any unused endpoints and the response shape for this. Let's search for "Get Unused Media" in the docs!
exec
/bin/zsh -lc 'rg -n "media/unused" -n docs/developers/rest-api.md | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 40ms:
701:**Endpoint**: `GET /wpha/v1/media/unused`
711:curl -X GET "https://your-site.com/wp-json/wpha/v1/media/unused?per_page=20" \
1867:							"raw": "{{base_url}}/wp-json/wpha/v1/media/unused?per_page=20",
exec
/bin/zsh -lc "sed -n '660,760p' docs/developers/rest-api.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 43ms:
```

---

### Media Endpoints

#### Get Media Statistics

Retrieve comprehensive media library statistics.

**Endpoint**: `GET /wpha/v1/media/stats`

**Response**:

```json
{
	"success": true,
	"data": {
		"total_count": 450,
		"total_size": 157286400,

thinking
**Identifying implementation issues**

I’m noticing in the documentation that the unused response has a total of 23 items, which means it should represent the count of unused items, not the total attachments. In our MediaController, the function get_unused returns a total count of all media instead of just the unused ones. That’s definitely a bug! The cursor is also mixed up, using the count of scanned attachments instead of the offset in the unused items list. I need to read more docs to clarify the situation with duplicates and large items.
exec
/bin/zsh -lc "sed -n '760,900p' docs/developers/rest-api.md" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 36ms:
		"groups": [
			{
				"hash": "abc123def456",
				"count": 3,
				"original": {
					"id": 100,
					"title": "original-image",
					"filename": "image.jpg",
					"file_size": 1048576,
					"file_size_formatted": "1 MB",
					"mime_type": "image/jpeg",
					"thumbnail_url": "https://example.com/.../image-150x150.jpg",
					"edit_link": "https://example.com/wp-admin/post.php?post=100&action=edit"
				},
				"copies": [
					{
						"id": 101,
						"title": "image-copy",
						"filename": "image-1.jpg",
						"file_size": 1048576,
exec
/bin/zsh -lc 'rg -n "function find_unused_media" -S includes/Media/Scanner.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 34ms:
486:	public function find_unused_media() {
exec
/bin/zsh -lc "sed -n '460,560p' includes/Media/Scanner.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
							if ( file_exists( $thumb_path ) ) {
								$total_size += filesize( $thumb_path );
							}
						}
					}
				}
			}

			// Update progress periodically.
			$this->update_progress( $processed, $total_count );
		}

		return $total_size;
	}

	/**
	 * Find unused media attachments.
	 *
	 * Uses generator-based iteration for memory efficiency with large libraries.
	 *


thinking
**Considering unused media endpoints**

I’m looking into how find_unused_media returns a full list of unused attachments, which is quite resource-intensive. It seems acceptable for the /unused endpoint since it’s used by the UI for displaying these attachments. Retaining all results might be necessary, and we could think about using cached results from MediaScanTask. However, it appears the current scan task doesn't compute the unused list, making things a bit tricky. Balancing resource usage with functionality might be a requirement here.
thinking
**Inspecting scan tasks**

I’m looking at how MediaScanTask determines which scan tasks to include. It seems to cover tasks like duplicates, large files, and missing alt text, but I wonder if it also considers unused attachments. I should specifically check the `determine_scan_tasks` function to see if "unused" comes up in the search results. This could help clarify whether it’s addressing unused media within the scanning process. Let’s dig deeper!
exec
/bin/zsh -lc 'rg -n "unused" includes/Media/Tasks/MediaScanTask.php | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:




thinking
**Evaluating pagination implementation**

I'm investigating the idea of server-side pagination in our system. The current UI code doesn’t seem to support this, so maybe there's an updated UI design I need to consider. It looks like tasks in the .plans might reflect some newer design elements. I should check the tasks.csv for details like "Media Audit endpoint pagination." The spec for Q06-04 indicates a review, but I need to ensure the controllers handle pagination correctly based on the documentation.
thinking
**Fixing pagination on /unused endpoint**

I need to address the /unused endpoint to ensure it has the correct pagination. One option is to compute the full list of unused attachments, but that could be resource-intensive, especially if we cache the results per user. The method scanner->find_unused_media uses a generator that's memory aware, which might help manage the load. Alternatively, scanner->scan_unused_media has an incremental approach but struggles to provide a total unused count. I could call scan_unused_media repeatedly until I gather enough items for the requested page while attempting to compute the necessary totals.
thinking
**Optimizing unused count calculation**

To compute the total unused count, I could scan all attachments and count the unused ones, but that would be expensive. A better approach might be to use scanner->find_unused_media to get a complete list of unused IDs, which I can then store in a transient cache for efficiency. This method would help with pagination and performance since I’d only need to scan once per period. However, for large libraries, storing a large array of IDs could be cumbersome. I should also consider querying attachments not referenced, perhaps using the `ReferenceFinderInterface` for better results.
exec
/bin/zsh -lc "sed -n '1,200p' includes/Contracts/ReferenceFinderInterface.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
<?php
/**
 * Reference Finder Interface
 *
 * Defines the contract for finding media references across the site.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface ReferenceFinderInterface
 *
 * Contract for media reference detection operations.

thinking
**Checking error handling**

I'm thinking about error handling now. I should handle any WP_Error that could be returned by the underlying services. It's possible that not many services do this, but I wonder if functions like alt_text_checker->get_alt_text_coverage or find_missing_alt_text could return a WP_Error? I’ll need to inspect the AltTextChecker interface and its implementation to figure this out. Let’s make sure I’m thorough in this investigation!
exec
/bin/zsh -lc "sed -n '1,220p' includes/Contracts/AltTextCheckerInterface.php && rg -n \"class AltText\" -S includes/Media | head -n 40" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
<?php
/**
 * Alt Text Checker Interface
 *
 * Defines the contract for checking image alt text coverage.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface AltTextCheckerInterface
 *
 * Contract for alt text checking operations.
exec
/bin/zsh -lc "sed -n '1,260p' includes/Media/AltTextChecker.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
<?php
/**
 * Alt Text Checker Class
 *
 * Identifies images missing alt text and provides suggestions.
 * Supports decorative image handling and multilingual content via WPML/Polylang.
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\Media;

use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\ExclusionsInterface;
use WPAdminHealth\Integrations\Multilingual;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;




thinking
**Optimizing caching strategies**

I’m considering generator-based approaches along with memory awareness, even if they might be a bit heavy. I think caching results temporarily could be useful to avoid re-scanning every request, especially since this is a REST endpoint called often by the UI. I wonder if they have any tasks to scan for unused items. 

Implementing an improved `scan_unused_media` method to return the total unused count makes sense. I'll add pagination options too, but I need to keep in mind that results might change due to admin exclusions.
thinking
**Considering caching strategies**

I’m thinking about including a `cache_key` based on the blog ID and maybe the user while keeping manage_options global. Using WordPress transients sounds good for storing unused media IDs, but large arrays might exceed the option size. Still, thousands of integers might be manageable.

However, scanning each request could get expensive. I wonder if the plugin expects incremental scanning instead of computing a full list every time. The documentation seems to indicate a total number, so it looks like scanning on each request is indeed expected for pagination.
thinking
**Refining pagination strategy**

Okay, so if I support cursor/per_page, I might need to compute the entire list with each request and then slice it, which could be a heavy process. I wonder if I should be checking references to compute the unused list for each request, but that might complicate things. 

Given that the spec is focused on review, I can make minimal improvements while maintaining incremental scanning. For `get_unused`, I’ll set the total to match `scan_result['total']`, since that reflects the unused count. However, I need to ensure that proper pagination aligns with the actual unused items, not just the scanning process. That could lead to instability in results as items change during paging.
thinking
**Checking task expectations**

I want to inspect tasks.csv to see what’s expected, especially regarding earlier milestones that mention "Media audit endpoints." This could help clarify if server-side pagination is intended. The relevant spec is Q06-04, so perhaps I should specifically look for "media audit endpoints" in tasks.csv. 

I might use a search tool like rg to efficiently locate those terms. It feels important to confirm these details for a proper implementation!
exec
/bin/zsh -lc 'rg -n "Media Audit|unused|duplicates|large-files|missing-alt" tasks.csv | head -n 50' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
5:M00-04,"Admin Menu & Page Registration","Create /admin/class-admin.php registering admin menu. Add top-level menu 'Admin Health' with dashicons-heart icon at position 80. Submenus: Dashboard, Database Health, Media Audit, Performance, Settings. Use add_menu_page() and add_submenu_page(). Capability: manage_options. Hook into admin_menu priority 10. Each page loads corresponding template from /templates/admin/. Add admin body class 'wpha-admin-page' for styling scope. Acceptance: All menu items appear correctly, pages load without errors, proper capability checks prevent unauthorized access."
8:M00-07,"Health Score Calculator Engine","Create /includes/class-health-calculator.php computing overall site health score (0-100). Factors weighted: database_bloat (25%), unused_media (20%), plugin_performance (25%), revision_count (15%), transient_bloat (15%). Each factor returns 0-100 subscore. Grade mapping: A (90-100), B (80-89), C (70-79), D (60-69), F (<60). Methods: calculate_overall_score(), get_grade(), get_factor_scores(), get_recommendations(). Cache result in transient for 1 hour (wpha_health_score). Acceptance: Score accurately reflects site state, recommendations are actionable, caching prevents repeated heavy queries."
25:M03-01,"Media Scanner Core Class","Create /includes/media/class-scanner.php. Methods: scan_all_media(), get_media_count(), get_media_total_size(), find_unused_media(), find_duplicate_files(), find_large_files(min_size_mb), find_missing_alt_text(), get_scan_progress(). Unused detection: check post_content, postmeta (gallery, featured), widget content, customizer, ACF fields, Elementor data, WooCommerce galleries. Store scan results in transient with timestamp. Batch processing: 50 attachments per batch. Acceptance: Accurately detects unused media, no false positives on actually-used images, handles large libraries (50k+) without timeout."
27:M03-03,"Duplicate File Detector","Create /includes/media/class-duplicate-detector.php. Methods: find_duplicates(), get_duplicate_groups(), get_potential_savings(). Detection methods: exact file hash (md5_file), filename pattern matching (image-1.jpg, image-2.jpg), same dimensions + similar size. Group duplicates by original and copies. Calculate total savings if duplicates removed. Exclude different sizes of same image (thumbnails). Handle missing files gracefully. Acceptance: Correctly groups duplicates, distinguishes thumbnails from true duplicates, calculates accurate savings."
28:M03-04,"Large File Identifier","Create /includes/media/class-large-files.php. Methods: find_large_files(threshold_kb), get_optimization_suggestions(), get_size_distribution(). Default threshold: 500KB. For each large file return: ID, filename, current size, suggested max size, potential savings, dimensions. Suggestions based on: images over 2000px on either dimension, unoptimized formats (BMP, TIFF), PNGs that should be JPGs. Size distribution: buckets (<100KB, 100-500KB, 500KB-1MB, 1-5MB, >5MB) with counts. Acceptance: Accurately identifies large files, suggestions are actionable, distribution helps understand library composition."
31:M03-07,"Media Audit REST Endpoints","Create /includes/rest/class-media-controller.php. Endpoints: GET /wpha/v1/media/stats (overview stats), GET /wpha/v1/media/unused (paginated unused media list), GET /wpha/v1/media/duplicates (duplicate groups), GET /wpha/v1/media/large (large files list), GET /wpha/v1/media/alt-text (missing alt text), POST /wpha/v1/media/scan (trigger full scan), POST /wpha/v1/media/delete (safe delete selected), POST /wpha/v1/media/restore (restore from trash). Pagination: 50 items per page, cursor-based. Include thumbnail URLs in responses. Acceptance: All endpoints paginate correctly, scan runs in background, delete/restore work reliably."
32:M03-08,"Media Audit Admin Page","Create /templates/admin/media-audit.php with React app. Sections: Scan status banner (last scan time, 'Rescan' button), Stats overview (total media, unused count, duplicates count, potential savings), Tabbed results view (Unused, Duplicates, Large Files, Missing Alt Text). Each tab: sortable/filterable table, thumbnail preview, checkbox selection, bulk actions. Bulk actions: Delete Selected, Ignore Selected (adds to exclusion list). Duplicate view: grouped display with 'Keep Original' selector. Acceptance: Tables perform well with 1000+ items, bulk selection works, previews load lazily."
45:M06-01,"Settings Page Framework","Create /includes/class-settings.php using WordPress Settings API. Sections: General, Database Cleanup, Media Audit, Performance, Scheduling, Advanced. Register settings with register_setting(), add_settings_section(), add_settings_field(). Sanitization callbacks for each field type. Default values in activation. Export/import settings as JSON. Reset to defaults option. Acceptance: All settings save correctly, sanitization prevents invalid data, export/import works, reset works."
48:M06-04,"Media Audit Settings","Settings fields: unused_media_scan_depth (posts only, all content, deep scan), large_file_threshold_kb (100-5000), duplicate_detection_method (hash, filename, both), excluded_media_ids (comma-separated), media_trash_retention_days (7-90), scan_acf_fields (bool), scan_elementor (bool), scan_woocommerce (bool). Acceptance: Scan depth affects what's checked, thresholds work correctly, builder integrations toggle properly."
62:M08-04,"User Documentation - Media Audit","Create /docs/media-audit.md. Sections: How Media Scanning Works, Understanding 'Unused' Media (false positives, limitations), Duplicate Detection, Large File Optimization, Missing Alt Text (why it matters, bulk fixing), Safe Deletion Process (trash, restore, permanent). Integration notes for page builders. Acceptance: User understands scan limitations, knows how to safely clean media."
69:M09-03,"Media Module Tests","Create /tests/test-media-scanner.php. Test cases: unused media detection with various content types, duplicate detection accuracy, large file threshold works, exclusions are respected, safe delete and restore works. Fixtures: attachments with and without references, various file sizes. Mock page builder content. Acceptance: Media scanning edge cases covered, no false positives in controlled tests."
76:M10-03,"WooCommerce Integration","Create /includes/integrations/class-woocommerce.php. Detect WooCommerce active. Additional cleanups: expired sessions (woocommerce_sessions table), orphaned variation meta, transients (wc_ prefix with caution). Media scan: include product gallery images. Performance: WooCommerce-specific slow query detection. Conditional loading only when WooCommerce active. Acceptance: WooCommerce cleanups work safely, product images never flagged as unused, performance insights WooCommerce-specific."
79:M10-06,"WPML/Polylang Compatibility","Create /includes/integrations/class-multilingual.php. Detect WPML or Polylang active. Ensure translated media not flagged as unused. Handle duplicate translations in media scanning. Respect language context in admin pages. Acceptance: Translated content media detected correctly, language-specific scans work, no false positives on translated media."





thinking
**Evaluating JS implementation**

I’m considering that the JS file might be outdated or could get updated later on. My main goal is to fully implement the spec, even if that means not fixing the UI. However, if there's a mismatch, the plugin might not work properly, even though the spec doesn't really mention anything about it. This task focuses on "Media REST Controllers Review," so I’ll check other JS files for proper endpoints and consider implementing server-side pagination as the spec expects.
thinking
**Implementing pagination and caching**

I need to support cursor-based pagination using offset and per_page. To achieve that, I can slice the array with `array_slice($unused_ids, $start_index, $per_page)`. The cursor represents the offset, and the next_cursor will be `start_index + per_page` if there are more items; otherwise, it'll be null. The total count will be the length of $unused_ids. 

Calling `scanner->find_unused_media` for requests could be heavy, so I’m considering caching by storing the list in a transient with a timestamp. It might be beneficial to implement this caching technique in the controller, especially since heavy operations can be optimized.
thinking
**Considering caching options**

It seems like there might already be caching for scanning results with a timestamp, but the current scanner class only stores progress, which suggests the plugin may lack efficient caching. Even though our task doesn't involve full caching implementation, I think adding simple caching in the controller for the unused list could enhance performance. However, I need to be careful about potential size restrictions in the database. 

Alternatively, I’m considering implementing pagination by scanning unused media in batches to gather enough unused IDs for the requested page, while also ensuring we provide the total count as expected in the documentation.
thinking
**Assessing total count calculation**

I realize we could compute the total count of unused attachments while scanning all attachments, which would essentially be a full scan. However, I might be able to count only the total unused items without storing all IDs by scanning attachments and collecting those within the page range.

To do this effectively, I’ll need to establish consistent ordering of unused items, perhaps by their attachment ID in ascending order. While scanning, I can count unused attachments and select those that fit within the desired range. Although this involves a full scan, it's the most memory-efficient approach, even if it’s resource-intensive.
thinking
**Exploring scanning options**

I’m thinking about implementing early bail if scanning becomes too heavy, even though the spec doesn’t mention it. Perhaps the `scanner->scan_unused_media` function is designed for incremental scanning to prevent a full scan in a single request. It seems like the UI might call it repeatedly to gather results over time. 

I should take a closer look at how `scan_unused_media` is used, possibly in JavaScript or other areas, so I’ll search for that specific usage to gain more insight.
exec
/bin/zsh -lc "rg -n \"scan_unused_media\\(\" -S . | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 64ms:
./includes/Media/Scanner.php:847:	public function scan_unused_media( int $batch_size = 100, int $offset = 0 ): array {
./includes/Contracts/ScannerInterface.php:41:	public function scan_unused_media( int $batch_size = 100, int $offset = 0 ): array;
./includes/REST/Media/MediaAnalysisController.php:187:		$scan_result  = $this->scanner->scan_unused_media( 1000, 0 );
./includes/REST/Media/MediaAnalysisController.php:246:		$scan_result = $this->scanner->scan_unused_media( $per_page, $start_index );
./includes/REST/MediaController.php:400:		$scan_result  = $scanner->scan_unused_media( 1000, 0 );
./includes/REST/MediaController.php:465:		$scan_result = $scanner->scan_unused_media( $per_page, $start_index );






thinking
**Assessing media scanning methods**

I'm figuring out that only controllers use the scan_unused_media method, specifically for the /unused endpoint. It seems like this method was meant for incremental scanning, but the tasks.csv indicates that pagination should be applied to that list. I'm wondering if they implemented scan_unused_media for memory awareness but didn't properly adjust the semantics. Maybe Q06-04 needs to correct this mismatch by using find_unused_media more effectively. I also see that find_unused_media is heavy but memory-efficient. I'll implement the controller to call $scanner->find_unused_media() and then cache results, perhaps with transient storage to manage efficiency.
thinking
**Reviewing scanning processes**

I'm considering that for large libraries, scanning could potentially time out. It might be better to handle the scan task in the background and store the results there. However, given the focus on validation in Q06 review tasks, heavy caching isn't the priority. I'll aim for minimal, correct semantics while being safe. But there are definitely memory and time concerns with find_unused_media; it checks all attachments, which can be slow. It looks like scan_unused_media was introduced to avoid timeouts with incremental scans, but the docs and UI need updating. I'll also check the logic in scanner->is_attachment_used, as it's complex and could be a bit heavy.
thinking
**Evaluating scanning methods in API**

Using find_unused_media in a REST endpoint could cause timeouts, so they opted for scan_unused_media to handle batch scanning, which is more suitable for large libraries. It seems their design aims to paginate the scanning process instead of just listing unused items, with the API returning results from each batch. The tasks.csv indicates acceptance criteria for cursor-based pagination, but Q06-04 emphasizes verifying file operation security and memory limits, which could relate to this scanning process. However, the documentation for /unused shows discrepancies that don't align with scan_unused_media. I'll need more context on expectations or tests.
thinking
**Assessing documentation and endpoint design**

I’m thinking the documentation might be outdated, but perhaps the design is that the /media/unused endpoint returns an object with unused attachments found in the scanned batch, with the total referring to attachments scanned. However, the docs suggest it should retrieve a paginated list of unused files, which makes me unsure. In terms of progress display, the UI currently doesn’t show that. Looking at the /duplicates endpoint, this one scans the entire library, and while it's heavy, they’ve implemented a generator for memory monitoring. But it retrieves all groups at once, which could be an issue. If duplicate detection is taxing, they likely need caching, but it seems they haven't done that yet.
thinking
**Analyzing plugin performance and structure**

I’m considering whether the plugin can handle heavy operations since scanning large files is taxing, yet they haven't implemented caching. Using find_unused_media isn’t unusual, but maybe scan_unused_media was intended for memory awareness. The spec emphasizes proper response pagination, yet get_unused isn't using it correctly. To resolve that, I should adjust it to compute and slice the unused IDs like other methods. 

I also see that get_stats needs to update the unused_count, which presently relies on scan_unused_media, making it inaccurate. It seems using scanner->find_unused_media to compute total count could lead to heavy scanning. Perhaps stats should instead rely on cached results from the last scan or provide approximate values, especially since miscounts could affect the UI. If the library exceeds 1000 attachments, relying on the first 1000 is misleading. The plugin feels inconsistent; it’s possible they’re transitioning to React, but remnants of jQuery remain. This raises questions about their design choices and potential backend adjustments.
thinking
**Focusing on controller improvements**

I'm realizing that Q06-04 tasks focus specifically on controllers, so I should implement improvements there without being too worried about breaking the UI. However, I need to keep in mind that these changes might further disrupt the UI if it expects arrays. Currently, the UI is already not functioning well because of the existing controllers. Maybe there’s something in the PHP templates that adapt the data? I want to check out templates/admin/media-audit.php to see how it loads the data and if it utilizes the new endpoints.
exec
/bin/zsh -lc "sed -n '1,220p' templates/admin/media-audit.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 44ms:
<?php
/**
 * Media Audit Template
 *
 * @package WPAdminHealth
 */

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}
?>

<div class="wrap wpha-media-audit-wrap">
	<h1><?php echo esc_html( get_admin_page_title() ); ?></h1>

	<div class="wpha-media-audit">
		<!-- Scan Status Banner -->
		<div class="wpha-scan-status-banner">
			<div class="wpha-scan-status-banner-skeleton"></div>





thinking
**Evaluating UI and API consistency**

The template uses jQuery with placeholders for content and expects arrays for local pagination. The API should return full or consistent lists, but the documentation mentions server-side pagination. The current plugin is inconsistent since the UI uses local pagination but doesn't fetch more pages. It might be easiest to adjust the API endpoints to return arrays instead of objects, aligning them with the UI's expectations. I'm wondering how the UI manages `loadTabData`, as it caches the entire response without additional page fetches.
thinking
**Analyzing API and UI functionality**

If the API only returns the first page with `has_more` set to true, the UI would assume that’s the entire dataset, potentially missing additional items. That could create inconsistencies, especially with stats badges showing counts. To ensure the UI functions correctly, the API might need to return full arrays instead of using server pagination. While the docs indicate server pagination, our main task is doing a Q06-04 review, which may require focusing on alignment with the documentation rather than UI specifics. We might want to explore the commit history, although direct access is limited.
thinking
**Reviewing response pagination**

The spec emphasizes proper response pagination. The current controllers handle pagination with cursor and `per_page`, but I'm questioning if that's truly proper because the UI expects full arrays and conducts its own pagination. During the Q06 tasks, they might be reviewing these controllers to ensure that new paginated responses function correctly. This likely includes making sure the `total` fields accurately represent total items for each endpoint, such as fixing the `/unused` total. I should check the documentation for `/unused` to confirm it requires a total unused count.
thinking
**Considering UI and API compatibility**

The UI's local pagination might function if we set `response.data` to an array of all unused items instead of paginating. However, the docs expect an object. We could return both the object with items and metadata, but that creates complexity. Implementing the `/unused` endpoint properly with pagination could break the UI. Since the UI is used currently, it might not be practical to make changes without proper tests. Our ultimate goal is to follow the spec closely, which focuses on reviewing controllers without worrying about the UI.
thinking
**Improving controllers for pagination**

We need to implement improvements to the controllers for secure file operations and correct pagination according to the docs. However, it’s important to avoid making significant changes that could break functionality, so backward compatibility is key. I think we can design API responses to include an object with items, total, cursor, and `has_more`, or maybe even include an array. The UI currently isn't set to handle `dataCache[tab]` correctly, but we could add a `data` property that contains the array and put metadata in headers. Let's examine the `format_response` method to see how it wraps the information in a `WP_REST_Response`.
exec
/bin/zsh -lc "rg -n \"function format_response\" -n includes/REST/RestController.php && sed -n '520,760p' includes/REST/RestController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 43ms:
514:	protected function format_response( $success, $data = null, $message = '', $status = 200 ) {

		// Add debug information if debug mode is enabled.
		// Security: Only include basic metrics, never expose full queries or stack traces.
		if ( $this->is_debug_mode_enabled() ) {
			$connection = $this->get_connection();

			$response['debug'] = array(
				'queries'       => $connection->get_num_queries(),
				'memory_usage'  => size_format( memory_get_usage() ),
				'memory_peak'   => size_format( memory_get_peak_usage() ),
				'time_elapsed'  => timer_stop( 0, 3 ),
			);

			// Security: Only expose query timing for super admins with WPHA_DEBUG explicitly set.
			// Never expose full query text or stack traces via REST API.
			$query_log = $connection->get_query_log();
			if ( $this->can_view_detailed_debug() && defined( 'SAVEQUERIES' ) && SAVEQUERIES && ! empty( $query_log ) ) {
				$response['debug']['query_timing'] = array_map(
					function ( $query ) {
exec
/bin/zsh -lc "rg -n \"is_safe_mode_enabled\\(\" includes/REST | head -n 50" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 47ms:
includes/REST/DatabaseController.php:405:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:299:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:371:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:406:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:440:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:475:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/Database/CleanupController.php:509:		$safe_mode = $this->is_safe_mode_enabled();
includes/REST/RestController.php:662:	protected function is_safe_mode_enabled() {
includes/REST/RestController.php:663:		return $this->get_settings()->is_safe_mode_enabled();
exec
/bin/zsh -lc "sed -n '260,340p' includes/REST/Database/CleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 42ms:
				array(
					'methods'             => \WP_REST_Server::CREATABLE,
					'callback'            => array( $this, 'clean_orphaned' ),
					'permission_callback' => array( $this, 'check_permissions' ),
					'args'                => array(
						'types' => array(
							'description'       => __( 'Types of orphaned data to clean.', 'wp-admin-health-suite' ),
							'type'              => 'array',
							'items'             => array(
								'type' => 'string',
								'enum' => array( 'postmeta', 'commentmeta', 'termmeta', 'relationships' ),
							),
							'default'           => array( 'postmeta', 'commentmeta', 'termmeta', 'relationships' ),
							'sanitize_callback' => array( $this, 'sanitize_orphaned_types' ),
							'validate_callback' => 'rest_validate_request_arg',
						),
					),
				),
			)
		);
exec
/bin/zsh -lc "sed -n '340,420p' includes/REST/Database/CleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 42ms:
			$result['safe_mode'] = true;
			$result['preview_only'] = true;
		}

		// Log to activity.
		$this->log_activity( $type, $result );

		return $this->format_response(
			true,
			$result,
			sprintf(
				/* translators: %s: cleanup type */
				__( '%s cleanup completed successfully.', 'wp-admin-health-suite' ),
				ucfirst( $type )
			)
		);
	}

	/**
	 * Clean revisions.





thinking
**Improving data validation**

I’m realizing that the safe_delete function currently filters excluded items by checking for invalid IDs, specifically avoiding id 0. However, the sanitize_ids function could allow for 0 since it uses array_map(absint). If excluded functions treat 0 as a valid ID, this might cause issues. It would be better to ensure that arrays contain unique non-zero IDs by adding sanitization. Also, we need to improve the sanitize_ids method to remove zeros and duplicates for better security. Lastly, file path validation within uploads should be added in MediaController.
thinking
**Centralizing media methods**

I’m thinking it’s better to use MediaHelper to centralize our functions. The MediaController has a private method that we could update similarly. We could also try calling MediaHelper::get_attachment_details, but it's in a different namespace, which might cause circular reference issues. Instead, it might be more consistent to update the get_attachment_details method in MediaController to validate the upload path. We can implement similar path validation in MediaHelper, using realpath carefully while allowing symlinks. However, we must ensure the resolved path remains within uploads for security. If a file doesn’t exist, setting the file size to 0 seems fine.
thinking
**Handling remote attachments**

When dealing with remote attachments, get_attached_file may return a local path even if the file doesn't exist, so setting the size to 0 is fine. For error handling in safe_delete and restore, I should wrap the service results and consider WP_Error. Additionally, functions like get_large may call services that rely on file checks, which could trigger warnings. The new includes/rest/media controllers utilize MediaHelper for get_attachment_details, so adjusting MediaHelper will benefit all. We also need to ensure that MediaController's methods and safe_delete in both MediaController and MediaCleanupController are updated for better sanitization. Lastly, we might need to check for route name mismatches with JavaScript.
thinking
**Considering alias routes**

I’m thinking about the possibility of implementing alias routes for maintaining backward compatibility and assisting the UI. This approach seems safe and unobtrusive. However, it would require modifications to the controllers to register these additional routes. While the spec doesn’t explicitly require this, it could be beneficial. We should avoid overstepping, as the spec is minimal. The media audit endpoints involve large files and missing alt tags. Since the JavaScript uses the /media/large-files route, not having it could break the plugin's UI and might be considered an error handling issue.
thinking
I'm considering the possibility of adding alias routes in MediaController and potentially new controllers to improve UI functionality. This approach could stay within scope since we're still working with controllers, but we need to maintain consistent and non-conflicting route names. For example, I could add alias routes like /wpha/v1/media/large-files for getting large files and /wpha/v1/media/missing-alt for missing alt text. However, the UI is currently expecting these endpoints, and the discrepancy needs to be addressed. I should check if the UI allows for alternative responses or if adjustments are needed elsewhere.
exec
/bin/zsh -lc 'rg -n "media-audit" includes/Assets.php assets/js/dist -S | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 57ms:
includes/Assets.php:138:			'admin-health_page_admin-health-media'        => 'media-audit.css',
includes/Assets.php:171:			'admin-health_page_admin-health-media'   => 'media-audit',
assets/js/dist/media-audit.bundle.js:1:(()=>{var t={20(t,e,a){"use strict";var n=a(609),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,o=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(t,e,a){var n,i={},l=null,u=null;for(n in void 0!==a&&(l=""+a),void 0!==e.key&&(l=""+e.key),void 0!==e.ref&&(u=e.ref),e)s.call(e,n)&&!c.hasOwnProperty(n)&&(i[n]=e[n]);if(t&&t.defaultProps)for(n in e=t.defaultProps)void 0===i[n]&&(i[n]=e[n]);return{$$typeof:r,type:t,key:l,ref:u,props:i,_owner:o.current}}e.jsx=l,e.jsxs=l},210(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function a(e,a,n){return(a=function(e){var a=function(e,a){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,a||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===a?String:Number)(e)}(e,"string");return"symbol"==t(a)?a:a+""}(a))in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}!function(t,n){"use strict";var r=t.wp&&t.wp.apiFetch,i=(t.wp.i18n||{__:function(t){return t}}).__;t.WPAdminHealth=t.WPAdminHealth||{};var s={namespace:"wp-admin-health/v1",buildPath:function(t){return t=t.replace(/^\//,""),"/".concat(this.namespace,"/").concat(t)},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"GET",params:e})},post:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"POST",data:e})},put:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"PUT",data:e})},delete:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"DELETE",data:e})},request:function(t){var n=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!r)return Promise.reject(new Error(i("wp.apiFetch is not available","wp-admin-health-suite")));var c=this.buildPath(t),l=s.maxRetries||2,u=function(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach(function(e){a(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({path:c,method:s.method||"GET"},s);return r(u).catch(function(e){if(o<l&&n.shouldRetry(e)){var a=1e3*Math.pow(2,o);return new Promise(function(e){setTimeout(function(){e(n.request(t,s,o+1))},a)})}var r=h.getUserFriendlyMessage(e);throw new Error(r)})},shouldRetry:function(t){var e;if(!t.response)return!0;var a=(null===(e=t.response)||void 0===e?void 0:e.status)||0;return a>=500&&a<600}},o={container:null,init:function(){this.container||(this.container=n("<div>",{class:"wpha-toast-container","aria-live":"polite","aria-atomic":"true"}),n("body").append(this.container))},show:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;this.init();var s=n("<div>",{class:"wpha-toast wpha-toast-".concat(a),role:"alert"}),o=this.getIcon(a),c=n("<div>",{class:"wpha-toast-content",html:'<span class="wpha-toast-icon">'.concat(o,'</span><span class="wpha-toast-message">').concat(t,"</span>")}),l=n("<button>",{class:"wpha-toast-close",type:"button","aria-label":i("Close","wp-admin-health-suite"),html:"&times;"});return l.on("click",function(){return e.dismiss(s)}),s.append(c,l),this.container.append(s),setTimeout(function(){return s.addClass("wpha-toast-show")},10),r>0&&setTimeout(function(){return e.dismiss(s)},r),s},dismiss:function(t){t.removeClass("wpha-toast-show"),setTimeout(function(){return t.remove()},300)},getIcon:function(t){var e={success:"&#10004;",error:"&#10006;",warning:"&#9888;",info:"&#8505;"};return e[t]||e.info},success:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"success",e)},error:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;return this.show(t,"error",e)},warning:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6e3;return this.show(t,"warning",e)},info:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"info",e)}},c={confirm:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a={title:i("Confirm","wp-admin-health-suite"),message:i("Are you sure?","wp-admin-health-suite"),confirmText:i("Confirm","wp-admin-health-suite"),cancelText:i("Cancel","wp-admin-health-suite"),confirmClass:"button-primary",cancelClass:"button-secondary",danger:!1},r=n.extend({},a,e);return new Promise(function(e){var a=t.createModal(r,e);n("body").append(a),setTimeout(function(){return a.addClass("wpha-modal-show")},10)})},createModal:function(t,e){var a=this,r=n("<div>",{class:"wpha-modal-overlay",role:"dialog","aria-modal":"true","aria-labelledby":"wpha-modal-title"}),i=n("<div>",{class:"wpha-modal"}),s=n("<div>",{class:"wpha-modal-header",html:'<h3 id="wpha-modal-title">'.concat(t.title,"</h3>")}),o=n("<div>",{class:"wpha-modal-body",html:"<p>".concat(t.message,"</p>")}),c=n("<div>",{class:"wpha-modal-footer"}),l=n("<button>",{class:"button ".concat(t.confirmClass," ").concat(t.danger?"wpha-danger":""),type:"button",text:t.confirmText}),u=n("<button>",{class:"button ".concat(t.cancelClass),type:"button",text:t.cancelText});return l.on("click",function(){a.closeModal(r),e(!0)}),u.on("click",function(){a.closeModal(r),e(!1)}),r.on("click",function(t){t.target===r[0]&&(a.closeModal(r),e(!1))}),n(document).on("keydown.wpha-modal",function(t){"Escape"===t.key&&(a.closeModal(r),e(!1))}),c.append(u,l),i.append(s,o,c),r.append(i),r},closeModal:function(t){t.removeClass("wpha-modal-show"),n(document).off("keydown.wpha-modal"),setTimeout(function(){return t.remove()},300)}},l={trackers:{},create:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a={title:i("Processing…","wp-admin-health-suite"),message:"",showPercentage:!0,container:null},r=n.extend({},a,e),s=this.buildTracker(t,r);return r.container?n(r.container).append(s.element):n("body").append(s.element),this.trackers[t]=s,s},buildTracker:function(t,e){var a=this,r=n("<div>",{class:"wpha-progress-tracker",id:"wpha-progress-".concat(t),role:"progressbar","aria-valuenow":"0","aria-valuemin":"0","aria-valuemax":"100"}),i=n("<div>",{class:"wpha-progress-title",text:e.title}),s=n("<div>",{class:"wpha-progress-message",text:e.message}),o=n("<div>",{class:"wpha-progress-bar-container"}),c=n("<div>",{class:"wpha-progress-bar",style:"width: 0%"}),l=n("<div>",{class:"wpha-progress-percentage",text:"0%"});return o.append(c),r.append(i,s,o),e.showPercentage&&r.append(l),{element:r,bar:c,message:s,percentage:l,settings:e,update:function(e,n){return a.update(t,e,n)},complete:function(e){return a.complete(t,e)},error:function(e){return a.error(t,e)},remove:function(){return a.remove(t)}}},update:function(t,e,a){var n=this.trackers[t];n&&(e=Math.max(0,Math.min(100,e)),n.bar.css("width","".concat(e,"%")),n.element.attr("aria-valuenow",e),n.settings.showPercentage&&n.percentage.text("".concat(Math.round(e),"%")),a&&n.message.text(a))},complete:function(t,e){var a=this,n=this.trackers[t];n&&(this.update(t,100,e||i("Complete!","wp-admin-health-suite")),n.element.addClass("wpha-progress-complete"),setTimeout(function(){return a.remove(t)},2e3))},error:function(t,e){var a=this.trackers[t];a&&(a.element.addClass("wpha-progress-error"),a.message.text(e||i("An error occurred","wp-admin-health-suite")))},remove:function(t){var e=this.trackers[t];e&&(e.element.fadeOut(300,function(){n(this).remove()}),delete this.trackers[t])}},u={prefix:"wpha_",buildKey:function(t){return this.prefix+t},isAvailable:function(){try{var t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.isAvailable())return e;try{var a=localStorage.getItem(this.buildKey(t));return null!==a?JSON.parse(a):e}catch(t){return e}},set:function(t,e){if(!this.isAvailable())return!1;try{return localStorage.setItem(this.buildKey(t),JSON.stringify(e)),!0}catch(t){return!1}},remove:function(t){if(!this.isAvailable())return!1;try{return localStorage.removeItem(this.buildKey(t)),!0}catch(t){return!1}},clear:function(){var t=this;if(!this.isAvailable())return!1;try{return Object.keys(localStorage).forEach(function(e){e.startsWith(t.prefix)&&localStorage.removeItem(e)}),!0}catch(t){return!1}},getAll:function(){var t=this;if(!this.isAvailable())return{};try{var e={};return Object.keys(localStorage).forEach(function(a){if(a.startsWith(t.prefix)){var n=a.substring(t.prefix.length);e[n]=t.get(n)}}),e}catch(t){return{}}}},d={listeners:{},on:function(t,e){var a=this;return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),function(){return a.off(t,e)}},off:function(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(function(t){return t!==e}))},trigger:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.listeners[t]){this.listeners[t].forEach(function(t){try{t(e)}catch(t){}});var a=new CustomEvent("wpha:".concat(t),{detail:e,bubbles:!0});document.dispatchEvent(a)}},once:function(t,e){var a=this,n=function(r){e(r),a.off(t,n)};this.on(t,n)}},h={messages:{network_error:i("Network error. Please check your connection and try again.","wp-admin-health-suite"),server_error:i("Server error. Please try again later.","wp-admin-health-suite"),permission_error:i("You do not have permission to perform this action.","wp-admin-health-suite"),validation_error:i("Please check your input and try again.","wp-admin-health-suite"),timeout_error:i("Request timed out. Please try again.","wp-admin-health-suite"),unknown_error:i("An unexpected error occurred. Please try again.","wp-admin-health-suite")},getUserFriendlyMessage:function(t){if("string"==typeof t)return t;if(t.response){var e=t.response.status;if(403===e||401===e)return this.messages.permission_error;if(e>=400&&e<500)return t.response.message||this.messages.validation_error;if(e>=500)return this.messages.server_error}return t.message&&t.message.includes("NetworkError")?this.messages.network_error:t.message&&t.message.includes("timeout")?this.messages.timeout_error:t.message||this.messages.unknown_error},handle:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=n.extend({},{showToast:!0,logToConsole:!0,triggerEvent:!0},e),r=this.getUserFriendlyMessage(t);return a.logToConsole,a.showToast&&o.error(r),a.triggerEvent&&d.trigger("error",{error:t,message:r}),r}};n.extend(t.WPAdminHealth,{API:s,Toast:o,Modal:c,Progress:l,Storage:u,Events:d,ErrorHandler:h,utils:{debounce:function(t,e){var a;return function(){for(var n=this,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];clearTimeout(a),a=setTimeout(function(){return t.apply(n,i)},e)}},throttle:function(t,e){var a;return function(){if(!a){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];t.apply(this,r),a=!0,setTimeout(function(){return a=!1},e)}}},formatBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===t)return"0 Bytes";var a=e<0?0:e,n=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,n)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB"][n]},formatNumber:function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}}),n(document).ready(function(){o.init(),t.addEventListener("error",function(t){h.handle(t.error,{showToast:!1})}),t.addEventListener("unhandledrejection",function(t){h.handle(t.reason,{showToast:!1})}),"undefined"!=typeof wpAdminHealthData&&d.trigger("ready",{version:wpAdminHealthData.version})})}(window,jQuery)},338(t,e,a){"use strict";var n=a(795);e.H=n.createRoot,n.hydrateRoot},609(t){"use strict";t.exports=window.React},795(t){"use strict";t.exports=window.ReactDOM},848(t,e,a){"use strict";t.exports=a(20)},903(){function t(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,a){if(t){if("string"==typeof t)return e(t,a);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,a):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}!function(e){"use strict";var a={currentTab:"unused",itemsPerPage:50,currentPages:{unused:1,duplicates:1,"large-files":1,"missing-alt":1},dataCache:{stats:null,unused:[],duplicates:[],"large-files":[],"missing-alt":[]},currentSort:{unused:{field:"date",order:"desc"},duplicates:{field:"size",order:"desc"},"large-files":{field:"size",order:"desc"},"missing-alt":{field:"date",order:"desc"}},currentFilters:{unused:{search:"",type:""},duplicates:{search:""},"large-files":{search:"",size:""},"missing-alt":{search:""}},selectedItems:{unused:new Set,duplicates:new Set,"large-files":new Set,"missing-alt":new Set},init:function(){this.cacheDom(),this.bindEvents(),this.loadStats(),this.loadTabData(this.currentTab)},cacheDom:function(){this.$scanBanner=e(".wpha-scan-status-banner"),this.$rescanBtn=e(".wpha-rescan-btn"),this.$statsCards=e(".wpha-stats-overview"),this.$tabBtns=e(".wpha-tab-btn"),this.$tabPanels=e(".wpha-tab-panel")},bindEvents:function(){e(document).on("click",".wpha-tab-btn",this.handleTabSwitch.bind(this)),e(document).on("click",".wpha-rescan-btn",this.handleRescan.bind(this)),e(document).on("click",".wpha-sortable",this.handleSort.bind(this)),e(document).on("input",".wpha-search-input",this.handleSearchFilter.bind(this)),e(document).on("change",".wpha-filter-select",this.handleTypeFilter.bind(this)),e(document).on("change",".wpha-size-filter-select",this.handleSizeFilter.bind(this)),e(document).on("change",".wpha-select-all",this.handleSelectAll.bind(this)),e(document).on("change",".wpha-item-checkbox",this.handleItemSelect.bind(this)),e(document).on("click",".wpha-bulk-apply-btn",this.handleBulkAction.bind(this)),e(document).on("click",".wpha-delete-btn",this.handleDelete.bind(this)),e(document).on("click",".wpha-ignore-btn",this.handleIgnore.bind(this)),e(document).on("click",".wpha-page-btn",this.handlePageChange.bind(this))},loadStats:function(){var t=this;wp.apiFetch({path:"/wpha/v1/media/stats"}).then(function(e){e.success&&e.data&&(t.dataCache.stats=e.data,t.renderStats(e.data),t.renderScanStatus(e.data))}).catch(function(e){t.hideSkeletons(t.$statsCards),t.hideSkeletons(t.$scanBanner)})},renderStats:function(t){var a,n=this;[{value:t.total_count||0,selector:0},{value:t.unused_count||0,selector:1},{value:t.duplicate_count||0,selector:2},{value:this.formatBytes((null===(a=t.potential_savings)||void 0===a?void 0:a.bytes)||0),selector:3}].forEach(function(t){var e=n.$statsCards.find(".wpha-stat-card").eq(t.selector);e.find(".wpha-stat-value").text(t.value),e.find(".wpha-stat-card-skeleton").hide(),e.find(".wpha-stat-card-content").show()}),e('.wpha-tab-btn[data-tab="unused"] .wpha-tab-badge').text(t.unused_count||0),e('.wpha-tab-btn[data-tab="duplicates"] .wpha-tab-badge').text(t.duplicate_count||0),e('.wpha-tab-btn[data-tab="large-files"] .wpha-tab-badge').text(t.large_files_count||0),e('.wpha-tab-btn[data-tab="missing-alt"] .wpha-tab-badge').text(t.missing_alt_count||0)},renderScanStatus:function(t){var e=t.last_scan?this.formatDate(t.last_scan):wpAdminHealthData.i18n.no_data||"Never";this.$scanBanner.find(".wpha-scan-status-value").text(e),this.$scanBanner.find(".wpha-scan-status-banner-skeleton").hide(),this.$scanBanner.find(".wpha-scan-status-content").show(),this.$rescanBtn.prop("disabled",!1)},handleTabSwitch:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("tab");n!==this.currentTab&&(this.$tabBtns.removeClass("wpha-tab-active"),a.addClass("wpha-tab-active"),this.$tabPanels.removeClass("wpha-tab-active"),e('.wpha-tab-panel[data-tab="'.concat(n,'"]')).addClass("wpha-tab-active"),this.currentTab=n,this.loadTabData(n))},loadTabData:function(t){var a=this;if(this.dataCache[t].length>0)this.renderTabData(t);else{var n="";switch(t){case"unused":n="/wpha/v1/media/unused";break;case"duplicates":n="/wpha/v1/media/duplicates";break;case"large-files":n="/wpha/v1/media/large-files";break;case"missing-alt":n="/wpha/v1/media/missing-alt"}var r=e('.wpha-tab-panel[data-tab="'.concat(t,'"]')),i=r.find(".wpha-tab-panel-skeleton");i.show(),wp.apiFetch({path:n}).then(function(e){e.success&&e.data&&(a.dataCache[t]=e.data,a.renderTabData(t))}).catch(function(t){i.hide(),a.showEmptyState(r)})}},renderTabData:function(t){var a=e('.wpha-tab-panel[data-tab="'.concat(t,'"]'));a.find(".wpha-tab-panel-skeleton").hide();var n=this.filterData(t,this.dataCache[t]);n=this.sortData(t,n),"duplicates"===t?this.renderDuplicates(a,n):this.renderTable(a,t,n),this.renderPagination(a,t,n.length),this.updateBulkActions(a,t)},filterData:function(e,a){var n=this.currentFilters[e],r=t(a);if(n.search){var i=n.search.toLowerCase();r=r.filter(function(t){return(t.filename||"").toLowerCase().includes(i)||(t.title||"").toLowerCase().includes(i)})}if(n.type&&(r=r.filter(function(t){return t.type===n.type})),n.size){var s={"1mb":1048576,"5mb":5242880,"10mb":10485760}[n.size]||0;r=r.filter(function(t){return t.size>s})}return r},sortData:function(e,a){var n=this.currentSort[e],r=t(a);return r.sort(function(t,e){var a=t[n.field],r=e[n.field];return"string"==typeof a&&(a=a.toLowerCase(),r=r.toLowerCase()),"asc"===n.order?a>r?1:-1:a<r?1:-1}),r},renderTable:function(t,e,a){var n=this,r=t.find(".wpha-media-table tbody"),i=(this.currentPages[e]-1)*this.itemsPerPage,s=i+this.itemsPerPage,o=a.slice(i,s);if(0!==o.length){var c=o.map(function(t){return n.renderTableRow(e,t)}).join("");r.html(c),this.lazyLoadPreviews(r)}else r.html('<tr><td colspan="6" class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No items found.")+"</td></tr>")},renderTableRow:function(t,e){var a=this.selectedItems[t].has(e.id),n=e.thumbnail||e.thumbnail_url||e.url||"",r=e.mime_type||"",i="image"===e.type||r.startsWith("image/"),s='<tr data-id="'+e.id+'">';s+='<td class="wpha-col-checkbox">',s+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+e.id+'" '+(a?"checked":"")+" />",s+="</td>",s+='<td class="wpha-col-preview">',s+=i&&n?'<img class="wpha-lazy-preview" data-src="'+n+'" alt="" width="50" height="50" />':'<span class="dashicons dashicons-media-default"></span>',s+="</td>",s+='<td class="wpha-col-filename">',s+="<strong>"+this.escapeHtml(e.filename||e.title||"Untitled")+"</strong>",s+="</td>";var o=e.size||e.file_size||e.current_size||0;return"large-files"===t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-dimensions">'+(e.width&&e.height?e.width+" × "+e.height:"--")+"</td>"):"missing-alt"!==t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>"):s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>",s+='<td class="wpha-col-actions">',"missing-alt"!==t&&(s+='<button class="button button-small wpha-delete-btn" data-id="'+e.id+'" title="Delete">',s+='<span class="dashicons dashicons-trash"></span>',s+="</button> "),s+='<button class="button button-small wpha-ignore-btn" data-id="'+e.id+'" title="Ignore">',s+='<span class="dashicons dashicons-hidden"></span>',s+="</button>",s+="</td>",s+="</tr>"},renderDuplicates:function(t,e){var a=this,n=t.find(".wpha-duplicates-container"),r=(this.currentPages.duplicates-1)*this.itemsPerPage,i=r+this.itemsPerPage,s=e.slice(r,i);if(0!==s.length){var o=s.map(function(t){return a.renderDuplicateGroup(t)}).join("");n.html(o),this.lazyLoadPreviews(n)}else n.html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No duplicate groups found.")+"</div>")},renderDuplicateGroup:function(t){var e=this,a='<div class="wpha-duplicate-group">';return a+='<div class="wpha-duplicate-group-header">',a+="<h4>"+this.escapeHtml(t.filename||"Unnamed Group")+"</h4>",a+='<span class="wpha-duplicate-count">'+t.items.length+" duplicates • "+this.formatBytes(t.total_size)+"</span>",a+="</div>",a+='<div class="wpha-duplicate-items">',t.items.forEach(function(t,n){var r=e.selectedItems.duplicates.has(t.id),i=0===n,s=t.thumbnail||t.thumbnail_url||t.url||"";a+='<div class="wpha-duplicate-item" data-id="'+t.id+'">',a+='<div class="wpha-duplicate-item-preview">',a+=s?'<img class="wpha-lazy-preview" data-src="'+s+'" alt="" width="100" height="100" />':'<span class="dashicons dashicons-media-default"></span>',a+="</div>",a+='<div class="wpha-duplicate-item-info">',a+='<p class="wpha-duplicate-filename">'+e.escapeHtml(t.filename)+"</p>",a+='<p class="wpha-duplicate-meta">'+e.formatBytes(t.size||t.file_size||t.current_size||0)+" • "+e.formatDate(t.date)+"</p>",a+='<div class="wpha-duplicate-actions">',a+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+t.id+'" '+(r?"checked":"")+" /> ",i&&(a+='<span class="wpha-badge wpha-badge-primary">Original</span>'),a+="</div>",a+="</div>",a+="</div>"}),a+="</div>",a+="</div>"},renderPagination:function(t,e,a){var n=t.find(".wpha-pagination-controls"),r=t.find(".wpha-showing-text"),i=this.currentPages[e],s=Math.ceil(a/this.itemsPerPage),o=(i-1)*this.itemsPerPage+1,c=Math.min(i*this.itemsPerPage,a),l="duplicates"===e?"groups":"items";if(r.text("Showing ".concat(o,"-").concat(c," of ").concat(a," ").concat(l)),s<=1)n.html("");else{var u="";u+='<button class="button wpha-page-btn" data-page="'+(i-1)+'" '+(1===i?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-left-alt2"></span>',u+="</button> ";var d=Math.max(1,i-Math.floor(2.5)),h=Math.min(s,d+5-1);h-d<4&&(d=Math.max(1,h-5+1)),d>1&&(u+='<button class="button wpha-page-btn" data-page="1">1</button> ',d>2&&(u+='<span class="wpha-page-dots">...</span> '));for(var p=d;p<=h;p++){u+='<button class="button wpha-page-btn'+(p===i?" button-primary":"")+'" data-page="'+p+'">'+p+"</button> "}h<s&&(h<s-1&&(u+='<span class="wpha-page-dots">...</span> '),u+='<button class="button wpha-page-btn" data-page="'+s+'">'+s+"</button> "),u+='<button class="button wpha-page-btn" data-page="'+(i+1)+'" '+(i===s?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-right-alt2"></span>',u+="</button>",n.html(u)}},updateBulkActions:function(t,e){var a=this.selectedItems[e].size>0;t.find(".wpha-bulk-action-select, .wpha-bulk-apply-btn").prop("disabled",!a)},handleRescan:function(t){var a=this;t.preventDefault();var n=e(t.currentTarget);n.prop("disabled")||(n.prop("disabled",!0).addClass("wpha-loading"),n.find(".dashicons").addClass("wpha-spin"),wp.apiFetch({path:"/wpha/v1/media/scan",method:"POST"}).then(function(t){t.success&&(Object.keys(a.dataCache).forEach(function(t){"stats"!==t&&(a.dataCache[t]=[])}),a.loadStats(),a.loadTabData(a.currentTab),a.showNotice("success",wpAdminHealthData.i18n.success||"Scan completed successfully."))}).catch(function(t){a.showNotice("error",wpAdminHealthData.i18n.error||"Scan failed.")}).finally(function(){n.prop("disabled",!1).removeClass("wpha-loading"),n.find(".dashicons").removeClass("wpha-spin")}))},handleSort:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("sort"),r=this.currentTab,i=this.currentSort[r],s="desc";i.field===n&&(s="asc"===i.order?"desc":"asc"),this.currentSort[r]={field:n,order:s},a.siblings(".wpha-sortable").removeClass("wpha-sorted-asc wpha-sorted-desc").find(".dashicons").removeClass("dashicons-arrow-up dashicons-arrow-down").addClass("dashicons-sort"),a.addClass("asc"===s?"wpha-sorted-asc":"wpha-sorted-desc").find(".dashicons").removeClass("dashicons-sort").addClass("asc"===s?"dashicons-arrow-up":"dashicons-arrow-down"),this.renderTabData(r)},handleSearchFilter:function(t){var a=e(t.currentTarget),n=this.currentTab,r=a.val().trim();this.currentFilters[n].search=r,this.currentPages[n]=1,this.renderTabData(n)},handleTypeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters.unused.type=a,this.currentPages.unused=1,this.renderTabData("unused")},handleSizeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters["large-files"].size=a,this.currentPages["large-files"]=1,this.renderTabData("large-files")},handleSelectAll:function(t){var a=this,n=e(t.currentTarget).is(":checked"),r=this.currentTab,i=e('.wpha-tab-panel[data-tab="'.concat(r,'"]'));i.find(".wpha-item-checkbox").prop("checked",n).each(function(t,i){var s=e(i).data("id");n?a.selectedItems[r].add(s):a.selectedItems[r].delete(s)}),this.updateBulkActions(i,r)},handleItemSelect:function(t){var a=e(t.currentTarget),n=a.data("id"),r=a.is(":checked"),i=this.currentTab,s=e('.wpha-tab-panel[data-tab="'.concat(i,'"]'));r?this.selectedItems[i].add(n):this.selectedItems[i].delete(n),this.updateBulkActions(s,i)},handleBulkAction:function(t){t.preventDefault();var a=this.currentTab,n=e('.wpha-tab-panel[data-tab="'.concat(a,'"]')).find(".wpha-bulk-action-select").val(),r=Array.from(this.selectedItems[a]);if(n&&0!==r.length){var i="delete"===n?"Are you sure you want to delete "+r.length+" item(s)? This action cannot be undone.":"Are you sure you want to ignore "+r.length+" item(s)?";confirm(i)&&this.executeBulkAction(n,r,a)}},executeBulkAction:function(t,e,a){var n=this,r="delete"===t?"/wpha/v1/media/delete":"/wpha/v1/media/ignore";wp.apiFetch({path:r,method:"POST",data:{ids:e}}).then(function(t){t.success&&(n.dataCache[a]=n.dataCache[a].filter(function(t){return!e.includes(t.id)}),n.selectedItems[a].clear(),n.renderTabData(a),n.loadStats(),n.showNotice("success",t.data.message||"Action completed successfully."))}).catch(function(t){n.showNotice("error",wpAdminHealthData.i18n.error||"Action failed.")})},handleDelete:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");confirm("Are you sure you want to delete this item? This action cannot be undone.")&&this.executeBulkAction("delete",[a],this.currentTab)},handleIgnore:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");this.executeBulkAction("ignore",[a],this.currentTab)},handlePageChange:function(t){t.preventDefault();var a=e(t.currentTarget);if(!a.prop("disabled")){var n=parseInt(a.data("page")),r=this.currentTab;this.currentPages[r]=n,this.renderTabData(r),e(".wpha-results-section")[0].scrollIntoView({behavior:"smooth",block:"start"})}},lazyLoadPreviews:function(t){t.find(".wpha-lazy-preview").each(function(t,a){var n=e(a),r=n.data("src");if(r){var i=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&(n.attr("src",r),i.unobserve(t.target))})});i.observe(a)}})},showEmptyState:function(t){t.find(".wpha-tab-panel-content").html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No data available.")+"</div>")},showNotice:function(t,a){var n=e('<div class="notice notice-'+t+' is-dismissible"><p>'+a+"</p></div>");e(".wpha-media-audit-wrap h1").after(n),setTimeout(function(){n.fadeOut(function(){return n.remove()})},5e3)},formatBytes:function(t){if(0===t)return"0 Bytes";var e=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,e)*100)/100+" "+["Bytes","KB","MB","GB"][e]},formatDate:function(t){if(!t)return"--";var e=new Date(t);return e.toLocaleDateString()+" "+e.toLocaleTimeString()},escapeHtml:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})},hideSkeletons:function(t){t.find('[class*="-skeleton"]').hide()}};e(document).ready(function(){e(".wpha-media-audit").length&&a.init()})}(jQuery)}},e={};function a(n){var r=e[n];if(void 0!==r)return r.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,a),i.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";var t=a(609),e=a.n(t),n=a(338),r=a(848);function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function s(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function o(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?s(Object(a),!0).forEach(function(e){c(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function c(t,e,a){return(e=function(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var n=a.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function l(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var n,r,i,s,o=[],c=!0,l=!1;try{if(i=(a=a.call(t)).next,0===e){if(Object(a)!==a)return;c=!1}else for(;!(c=(n=i.call(a)).done)&&(o.push(n.value),o.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=a.return&&(s=a.return(),Object(s)!==s))return}finally{if(l)throw r}}return o}}(t,e)||function(t,e){if(t){if("string"==typeof t)return u(t,e);var a={}.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?u(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}var d={up:"↑",down:"↓",neutral:"→"},h={up:"#d63638",down:"#00a32a",neutral:"#646970"};const p=function(t){var a=t.title,n=t.value,i=t.unit,s=void 0===i?"":i,c=t.trend,u=void 0===c?"neutral":c,p=t.trendValue,f=void 0===p?null:p,m=t.icon,b=void 0===m?"dashicons-chart-bar":m,v=t.onClick,w=void 0===v?null:v,g=["up","down","neutral"].includes(u)?u:"neutral",y=d[g],S=h[g],x=null!==f?"".concat(y," ").concat(f,"%"):y,P="".concat(a,": ").concat(n," ").concat(s).concat(null!==f?", trend ".concat(g," by ").concat(f," percent"):""),T="function"==typeof w,k={display:"flex",alignItems:"center",padding:"20px",backgroundColor:"#fff",border:"1px solid #c3c4c7",borderRadius:"4px",cursor:T?"pointer":"default",transition:"all 0.2s ease",outline:"none",minHeight:"100px"},O={fontSize:"14px",fontWeight:"600",color:S,marginLeft:"4px"},C=l(e().useState(!1),2),_=C[0],D=C[1];return(0,r.jsxs)("div",{className:"metric-card",role:T?"button":"article",tabIndex:T?0:void 0,"aria-label":P,onClick:T?w:void 0,onKeyPress:function(t){!T||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),w())},onMouseEnter:function(){return D(!0)},onMouseLeave:function(){return D(!1)},style:o(o({},k),_&&T?{boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",transform:"translateY(-2px)",borderColor:"#2271b1"}:{}),children:[(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"48px",height:"48px",marginRight:"16px",flexShrink:0},children:(0,r.jsx)("span",{className:"dashicons ".concat(b),style:{fontSize:"32px",width:"32px",height:"32px",color:"#2271b1"},"aria-hidden":"true"})}),(0,r.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,r.jsx)("h3",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600",color:"#1d2327",lineHeight:"1.4"},children:a}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"baseline",gap:"8px",flexWrap:"wrap"},children:[(0,r.jsx)("span",{style:{fontSize:"28px",fontWeight:"700",color:"#1d2327",lineHeight:"1.2"},children:n}),s&&(0,r.jsx)("span",{style:{fontSize:"14px",fontWeight:"400",color:"#646970",lineHeight:"1.2"},children:s}),null!==f&&(0,r.jsx)("span",{style:O,"aria-label":"Trend ".concat(g," by ").concat(f," percent"),children:x})]})]})]})};a(210),a(903);window.WPAdminHealthComponents=window.WPAdminHealthComponents||{},Object.assign(window.WPAdminHealthComponents,{MetricCard:p,React:e(),createRoot:n.H}),document.addEventListener("DOMContentLoaded",function(){})})()})();
assets/js/dist/media-audit.bundle.js:2://# sourceMappingURL=media-audit.bundle.js.map
assets/js/dist/assets.php:1:<?php return array('dashboard.bundle.js' => array('dependencies' => array('react', 'react-dom', 'wp-polyfill'), 'version' => '2f499e6a231900480a52'), 'database-health.bundle.js' => array('dependencies' => array('react', 'react-dom', 'wp-polyfill'), 'version' => '37a7f93fe5f34154a9f8'), 'media-audit.bundle.js' => array('dependencies' => array('react', 'react-dom', 'wp-polyfill'), 'version' => 'ee3115e3c4aa2b23be6f'), 'performance.bundle.js' => array('dependencies' => array('react', 'react-dom', 'wp-polyfill'), 'version' => 'f085ffda28a000d63016'), 'settings.bundle.js' => array('dependencies' => array('react', 'react-dom', 'wp-polyfill'), 'version' => '63cf68a823542f6233a4'));
assets/js/dist/media-audit.bundle.js.map:1:{"version":3,"file":"media-audit.bundle.js","mappings":"wCASiBA,EAAE,EAAQ,KAASC,EAAEC,OAAOC,IAAI,iBAAiBC,EAAEF,OAAOC,IAAI,kBAAkBE,EAAEC,OAAOC,UAAUC,eAAeC,EAAET,EAAEU,mDAAmDC,kBAAkBC,EAAE,CAACC,KAAI,EAAGC,KAAI,EAAGC,QAAO,EAAGC,UAAS,GAChP,SAASC,EAAEC,EAAEC,EAAEC,GAAG,IAAIC,EAAEC,EAAE,CAAC,EAAEC,EAAE,KAAKC,EAAE,KAAiF,IAAIH,UAAhF,IAASD,IAAIG,EAAE,GAAGH,QAAG,IAASD,EAAEN,MAAMU,EAAE,GAAGJ,EAAEN,UAAK,IAASM,EAAEL,MAAMU,EAAEL,EAAEL,KAAcK,EAAEd,EAAEoB,KAAKN,EAAEE,KAAKT,EAAEJ,eAAea,KAAKC,EAAED,GAAGF,EAAEE,IAAI,GAAGH,GAAGA,EAAEQ,aAAa,IAAIL,KAAKF,EAAED,EAAEQ,kBAAe,IAASJ,EAAED,KAAKC,EAAED,GAAGF,EAAEE,IAAI,MAAM,CAACM,SAAS1B,EAAE2B,KAAKV,EAAEL,IAAIU,EAAET,IAAIU,EAAEK,MAAMP,EAAEQ,OAAOrB,EAAEsB,QAAQ,CAAoBC,EAAQC,IAAIhB,EAAEe,EAAQE,KAAKjB,C,43BCC1W,SAAWkB,EAAQC,GAClB,aAGA,IAAMC,EAAWF,EAAOG,IAAMH,EAAOG,GAAGD,SAQhCE,GAAOJ,EAAOG,GAAGE,MAAQ,CAAED,GAAI,SAACE,GAAI,OAAKA,CAAI,IAA7CF,GAKRJ,EAAOO,cAAgBP,EAAOO,eAAiB,CAAC,EAShD,IAAMC,EAAM,CAIXC,UAAW,qBAQXC,UAAS,SAACC,GAGT,OADAA,EAAWA,EAASC,QAAQ,MAAO,IAC5B,IAAPC,OAAWC,KAAKL,UAAS,KAAAI,OAAIF,EAC9B,EASAI,IAAG,SAACJ,GAAuB,IAAbK,EAAMC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACvB,OAAOH,KAAKM,QAAQT,EAAU,CAC7BU,OAAQ,MACRL,OAAAA,GAEF,EASAM,KAAI,SAACX,GAAqB,IAAXY,EAAIN,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACtB,OAAOH,KAAKM,QAAQT,EAAU,CAC7BU,OAAQ,OACRE,KAAAA,GAEF,EASAC,IAAG,SAACb,GAAqB,IAAXY,EAAIN,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACrB,OAAOH,KAAKM,QAAQT,EAAU,CAC7BU,OAAQ,MACRE,KAAAA,GAEF,EAEA,gBAOOZ,GAAqB,IAAXY,EAAIN,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACxB,OAAOH,KAAKM,QAAQT,EAAU,CAC7BU,OAAQ,SACRE,KAAAA,GAEF,EAUAH,QAAO,SAACT,GAAqC,IAAAc,EAAA,KAA3BC,EAAOT,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAAGU,EAAOV,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,EACzC,IAAKf,EACJ,OAAO0B,QAAQC,OACd,IAAIC,MACH1B,EACC,+BACA,2BAMJ,IAAM2B,EAAOjB,KAAKJ,UAAUC,GACtBqB,EAAaN,EAAQM,YAAc,EAGnCC,E,2VAAcC,CAAA,CACnBH,KAAAA,EACAV,OAAQK,EAAQL,QAAU,OACvBK,GAGJ,OAAOxB,EAAS+B,GAAe,MAAO,SAACE,GAEtC,GAAIR,EAAUK,GAAcP,EAAKW,YAAYD,GAAQ,CACpD,IAAME,EAA+B,IAAvBC,KAAKC,IAAI,EAAGZ,GAC1B,OAAO,IAAIC,QAAQ,SAACY,GACnBC,WAAW,WACVD,EACCf,EAAKL,QAAQT,EAAUe,EAASC,EAAU,GAE5C,EAAGU,EACJ,EACD,CAGA,IAAMK,EAAeC,EAAaC,uBAAuBT,GACzD,MAAM,IAAIL,MAAMY,EACjB,EACD,EAQAN,YAAW,SAACD,GAAO,IAAAU,EAElB,IAAKV,EAAMW,SAAU,OAAO,EAC5B,IAAMC,GAAuB,QAAdF,EAAAV,EAAMW,gBAAQ,IAAAD,OAAA,EAAdA,EAAgBE,SAAU,EACzC,OAAOA,GAAU,KAAOA,EAAS,GAClC,GAUKC,EAAQ,CAIbC,UAAW,KAKXC,KAAI,WACCpC,KAAKmC,YAETnC,KAAKmC,UAAYhD,EAAE,QAAS,CAC3BkD,MAAO,uBACP,YAAa,SACb,cAAe,SAGhBlD,EAAE,QAAQmD,OAAOtC,KAAKmC,WACvB,EAUAI,KAAI,SAACC,GAAyC,IAAAC,EAAA,KAAhC9D,EAAIwB,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,OAAQuC,EAAQvC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,IACvCH,KAAKoC,OAEL,IAAMO,EAAQxD,EAAE,QAAS,CACxBkD,MAAA,yBAAAtC,OAAgCpB,GAChCiE,KAAM,UAGDC,EAAO7C,KAAK8C,QAAQnE,GACpBoE,EAAU5D,EAAE,QAAS,CAC1BkD,MAAO,qBACPW,KAAM,iCAAFjD,OAAmC8C,EAAI,4CAAA9C,OAA2CyC,EAAO,aAGxFS,EAAW9D,EAAE,WAAY,CAC9BkD,MAAO,mBACP1D,KAAM,SACN,aAAcW,EAAG,QAAS,yBAC1B0D,KAAM,YAgBP,OAbAC,EAASC,GAAG,QAAS,kBAAMT,EAAKU,QAAQR,EAAM,GAE9CA,EAAML,OAAOS,EAASE,GACtBjD,KAAKmC,UAAUG,OAAOK,GAGtBhB,WAAW,kBAAMgB,EAAMS,SAAS,kBAAkB,EAAE,IAGhDV,EAAW,GACdf,WAAW,kBAAMc,EAAKU,QAAQR,EAAM,EAAED,GAGhCC,CACR,EAOAQ,QAAO,SAACR,GACPA,EAAMU,YAAY,mBAClB1B,WAAW,kBAAMgB,EAAMW,QAAQ,EAAE,IAClC,EAQAR,QAAO,SAACnE,GACP,IAAM4E,EAAQ,CACbC,QAAS,WACTnC,MAAO,WACPoC,QAAS,UACTC,KAAM,WAEP,OAAOH,EAAM5E,IAAS4E,EAAMG,IAC7B,EAOAF,QAAO,SAAChB,GAA0B,IAAjBE,EAAQvC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,IAC3B,OAAOH,KAAKuC,KAAKC,EAAS,UAAWE,EACtC,EAEArB,MAAK,SAACmB,GAA0B,IAAjBE,EAAQvC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,IACzB,OAAOH,KAAKuC,KAAKC,EAAS,QAASE,EACpC,EAEAe,QAAO,SAACjB,GAA0B,IAAjBE,EAAQvC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,IAC3B,OAAOH,KAAKuC,KAAKC,EAAS,UAAWE,EACtC,EAEAgB,KAAI,SAAClB,GAA0B,IAAjBE,EAAQvC,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,IACxB,OAAOH,KAAKuC,KAAKC,EAAS,OAAQE,EACnC,GAUKiB,EAAQ,CAObC,QAAO,WAAe,IAAAC,EAAA,KAAdjD,EAAOT,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACZ2D,EAAW,CAChBC,MAAOzE,EAAG,UAAW,yBACrBkD,QAASlD,EAAG,gBAAiB,yBAC7B0E,YAAa1E,EAAG,UAAW,yBAC3B2E,WAAY3E,EAAG,SAAU,yBACzB4E,aAAc,iBACdC,YAAa,mBACbC,QAAQ,GAGHC,EAAWlF,EAAEmF,OAAO,CAAC,EAAGR,EAAUlD,GAExC,OAAO,IAAIE,QAAQ,SAACY,GACnB,IAAM6C,EAAQV,EAAKW,YAAYH,EAAU3C,GACzCvC,EAAE,QAAQmD,OAAOiC,GACjB5C,WAAW,kBAAM4C,EAAMnB,SAAS,kBAAkB,EAAE,GACrD,EACD,EASAoB,YAAW,SAACH,EAAU3C,GAAS,IAAA+C,EAAA,KACxBC,EAAUvF,EAAE,QAAS,CAC1BkD,MAAO,qBACPO,KAAM,SACN,aAAc,OACd,kBAAmB,qBAGd2B,EAAQpF,EAAE,QAAS,CACxBkD,MAAO,eAGFsC,EAASxF,EAAE,QAAS,CACzBkD,MAAO,oBACPW,KAAM,6BAAFjD,OAA+BsE,EAASN,MAAK,WAG5Ca,EAAOzF,EAAE,QAAS,CACvBkD,MAAO,kBACPW,KAAM,MAAFjD,OAAQsE,EAAS7B,QAAO,UAGvBqC,EAAS1F,EAAE,QAAS,CACzBkD,MAAO,sBAGFyC,EAAa3F,EAAE,WAAY,CAChCkD,MAAA,UAAAtC,OAAiBsE,EAASH,aAAY,KAAAnE,OAAIsE,EAASD,OAAS,cAAgB,IAC5EzF,KAAM,SACNa,KAAM6E,EAASL,cAGVe,EAAY5F,EAAE,WAAY,CAC/BkD,MAAA,UAAAtC,OAAiBsE,EAASF,aAC1BxF,KAAM,SACNa,KAAM6E,EAASJ,aAiChB,OA9BAa,EAAW5B,GAAG,QAAS,WACtBuB,EAAKO,WAAWN,GAChBhD,GAAQ,EACT,GAEAqD,EAAU7B,GAAG,QAAS,WACrBuB,EAAKO,WAAWN,GAChBhD,GAAQ,EACT,GAGAgD,EAAQxB,GAAG,QAAS,SAAC5E,GAChBA,EAAE2G,SAAWP,EAAQ,KACxBD,EAAKO,WAAWN,GAChBhD,GAAQ,GAEV,GAGAvC,EAAE+F,UAAUhC,GAAG,qBAAsB,SAAC5E,GACvB,WAAVA,EAAEV,MACL6G,EAAKO,WAAWN,GAChBhD,GAAQ,GAEV,GAEAmD,EAAOvC,OAAOyC,EAAWD,GACzBP,EAAMjC,OAAOqC,EAAQC,EAAMC,GAC3BH,EAAQpC,OAAOiC,GAERG,CACR,EAOAM,WAAU,SAACN,GACVA,EAAQrB,YAAY,mBACpBlE,EAAE+F,UAAUC,IAAI,sBAChBxD,WAAW,kBAAM+C,EAAQpB,QAAQ,EAAE,IACpC,GAUK8B,EAAW,CAIhBC,SAAU,CAAC,EASXC,OAAM,SAACC,GAAkB,IAAd3E,EAAOT,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EACf2D,EAAW,CAChBC,MAAOzE,EAAG,cAAe,yBACzBkD,QAAS,GACTgD,gBAAgB,EAChBrD,UAAW,MAGNkC,EAAWlF,EAAEmF,OAAO,CAAC,EAAGR,EAAUlD,GAClC6E,EAAUzF,KAAK0F,aAAaH,EAAIlB,GAStC,OAPIA,EAASlC,UACZhD,EAAEkF,EAASlC,WAAWG,OAAOmD,EAAQE,SAErCxG,EAAE,QAAQmD,OAAOmD,EAAQE,SAG1B3F,KAAKqF,SAASE,GAAME,EACbA,CACR,EASAC,aAAY,SAACH,EAAIlB,GAAU,IAAAuB,EAAA,KACpBD,EAAUxG,EAAE,QAAS,CAC1BkD,MAAO,wBACPkD,GAAI,iBAAFxF,OAAmBwF,GACrB3C,KAAM,cACN,gBAAiB,IACjB,gBAAiB,IACjB,gBAAiB,QAGZmB,EAAQ5E,EAAE,QAAS,CACxBkD,MAAO,sBACP7C,KAAM6E,EAASN,QAGVvB,EAAUrD,EAAE,QAAS,CAC1BkD,MAAO,wBACP7C,KAAM6E,EAAS7B,UAGVqD,EAAe1G,EAAE,QAAS,CAC/BkD,MAAO,gCAGFyD,EAAM3G,EAAE,QAAS,CACtBkD,MAAO,oBACP0D,MAAO,cAGFC,EAAa7G,EAAE,QAAS,CAC7BkD,MAAO,2BACP7C,KAAM,OAUP,OAPAqG,EAAavD,OAAOwD,GACpBH,EAAQrD,OAAOyB,EAAOvB,EAASqD,GAE3BxB,EAASmB,gBACZG,EAAQrD,OAAO0D,GAGT,CACNL,QAAAA,EACAG,IAAAA,EACAtD,QAAAA,EACAwD,WAAAA,EACA3B,SAAAA,EACA4B,OAAQ,SAACC,EAAUC,GAAG,OAAKP,EAAKK,OAAOV,EAAIW,EAAUC,EAAI,EACzDC,SAAU,SAACD,GAAG,OAAKP,EAAKQ,SAASb,EAAIY,EAAI,EACzC9E,MAAO,SAAC8E,GAAG,OAAKP,EAAKvE,MAAMkE,EAAIY,EAAI,EACnC7C,OAAQ,WAAF,OAAQsC,EAAKtC,OAAOiC,EAAG,EAE/B,EASAU,OAAM,SAACV,EAAIW,EAAU1D,GACpB,IAAMiD,EAAUzF,KAAKqF,SAASE,GACzBE,IAELS,EAAW1E,KAAK6E,IAAI,EAAG7E,KAAK8E,IAAI,IAAKJ,IAErCT,EAAQK,IAAIS,IAAI,QAAS,GAAFxG,OAAKmG,EAAQ,MACpCT,EAAQE,QAAQa,KAAK,gBAAiBN,GAElCT,EAAQpB,SAASmB,gBACpBC,EAAQO,WAAWxG,KAAK,GAADO,OAAIyB,KAAKiF,MAAMP,GAAS,MAG5C1D,GACHiD,EAAQjD,QAAQhD,KAAKgD,GAEvB,EAQA4D,SAAQ,SAACb,EAAI/C,GAAS,IAAAkE,EAAA,KACfjB,EAAUzF,KAAKqF,SAASE,GACzBE,IAELzF,KAAKiG,OACJV,EACA,IACA/C,GAAWlD,EAAG,YAAa,0BAE5BmG,EAAQE,QAAQvC,SAAS,0BAEzBzB,WAAW,kBAAM+E,EAAKpD,OAAOiC,EAAG,EAAE,KACnC,EAQAlE,MAAK,SAACkE,EAAI/C,GACT,IAAMiD,EAAUzF,KAAKqF,SAASE,GACzBE,IAELA,EAAQE,QAAQvC,SAAS,uBACzBqC,EAAQjD,QAAQhD,KACfgD,GAAWlD,EAAG,oBAAqB,0BAErC,EAOAgE,OAAM,SAACiC,GACN,IAAME,EAAUzF,KAAKqF,SAASE,GACzBE,IAELA,EAAQE,QAAQgB,QAAQ,IAAK,WAC5BxH,EAAEa,MAAMsD,QACT,UAEOtD,KAAKqF,SAASE,GACtB,GAUKqB,EAAU,CAIfC,OAAQ,QAQRC,SAAQ,SAAClJ,GACR,OAAOoC,KAAK6G,OAASjJ,CACtB,EAOAmJ,YAAW,WACV,IACC,IAAMC,EAAO,mBAGb,OAFAC,aAAaC,QAAQF,EAAMA,GAC3BC,aAAaE,WAAWH,IACjB,CACR,CAAE,MAAO1I,GACR,OAAO,CACR,CACD,EASA2B,IAAG,SAACrC,GAA0B,IAArBwJ,EAAYjH,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,KACvB,IAAKH,KAAK+G,cAAe,OAAOK,EAEhC,IACC,IAAMC,EAAOJ,aAAaK,QAAQtH,KAAK8G,SAASlJ,IAChD,OAAgB,OAATyJ,EAAgBE,KAAKC,MAAMH,GAAQD,CAC3C,CAAE,MAAO9I,GAER,OAAO8I,CACR,CACD,EASAK,IAAG,SAAC7J,EAAK8J,GACR,IAAK1H,KAAK+G,cAAe,OAAO,EAEhC,IAEC,OADAE,aAAaC,QAAQlH,KAAK8G,SAASlJ,GAAM2J,KAAKI,UAAUD,KACjD,CACR,CAAE,MAAOpJ,GAER,OAAO,CACR,CACD,EAQAgF,OAAM,SAAC1F,GACN,IAAKoC,KAAK+G,cAAe,OAAO,EAEhC,IAEC,OADAE,aAAaE,WAAWnH,KAAK8G,SAASlJ,KAC/B,CACR,CAAE,MAAOU,GAER,OAAO,CACR,CACD,EAOAsJ,MAAK,WAAG,IAAAC,EAAA,KACP,IAAK7H,KAAK+G,cAAe,OAAO,EAEhC,IAOC,OANa1J,OAAOyK,KAAKb,cACpBc,QAAQ,SAACnK,GACTA,EAAIoK,WAAWH,EAAKhB,SACvBI,aAAaE,WAAWvJ,EAE1B,IACO,CACR,CAAE,MAAOU,GAER,OAAO,CACR,CACD,EAOA2J,OAAM,WAAG,IAAAC,EAAA,KACR,IAAKlI,KAAK+G,cAAe,MAAO,CAAC,EAEjC,IACC,IAAMoB,EAAQ,CAAC,EAQf,OAPa9K,OAAOyK,KAAKb,cACpBc,QAAQ,SAACnK,GACb,GAAIA,EAAIoK,WAAWE,EAAKrB,QAAS,CAChC,IAAMuB,EAAWxK,EAAIyK,UAAUH,EAAKrB,OAAOzG,QAC3C+H,EAAMC,GAAYF,EAAKjI,IAAImI,EAC5B,CACD,GACOD,CACR,CAAE,MAAO7J,GAER,MAAO,CAAC,CACT,CACD,GAUKgK,EAAS,CAIdC,UAAW,CAAC,EASZrF,GAAE,SAACsF,EAAWC,GAAU,IAAAC,EAAA,KAQvB,OAPK1I,KAAKuI,UAAUC,KACnBxI,KAAKuI,UAAUC,GAAa,IAG7BxI,KAAKuI,UAAUC,GAAWG,KAAKF,GAGxB,kBAAMC,EAAKvD,IAAIqD,EAAWC,EAAS,CAC3C,EAQAtD,IAAG,SAACqD,EAAWC,GACTzI,KAAKuI,UAAUC,KAEpBxI,KAAKuI,UAAUC,GAAaxI,KAAKuI,UAAUC,GAAWI,OACrD,SAACC,GAAE,OAAKA,IAAOJ,CAAQ,GAEzB,EAQAK,QAAO,SAACN,GAAsB,IAAX/H,EAAIN,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAC1B,GAAKH,KAAKuI,UAAUC,GAApB,CAEAxI,KAAKuI,UAAUC,GAAWT,QAAQ,SAACU,GAClC,IACCA,EAAShI,EACV,CAAE,MAAOnC,GAKT,CACD,GAGA,IAAMyK,EAAQ,IAAIC,YAAY,QAADjJ,OAASyI,GAAa,CAClDS,OAAQxI,EACRyI,SAAS,IAEVhE,SAASiE,cAAcJ,EAlBe,CAmBvC,EAQAK,KAAI,SAACZ,EAAWC,GAAU,IAAAY,EAAA,KACnBC,EAAU,SAAC7I,GAChBgI,EAAShI,GACT4I,EAAKlE,IAAIqD,EAAWc,EACrB,EAEAtJ,KAAKkD,GAAGsF,EAAWc,EACpB,GAUKzH,EAAe,CAIpB0H,SAAU,CACTC,cAAelK,EACd,6DACA,yBAEDmK,aAAcnK,EACb,wCACA,yBAEDoK,iBAAkBpK,EACjB,qDACA,yBAEDqK,iBAAkBrK,EACjB,yCACA,yBAEDsK,cAAetK,EACd,uCACA,yBAEDuK,cAAevK,EACd,kDACA,0BAUFwC,uBAAsB,SAACT,GAEtB,GAAqB,iBAAVA,EACV,OAAOA,EAIR,GAAIA,EAAMW,SAAU,CACnB,IAAMC,EAASZ,EAAMW,SAASC,OAE9B,GAAe,MAAXA,GAA6B,MAAXA,EACrB,OAAOjC,KAAKuJ,SAASG,iBAGtB,GAAIzH,GAAU,KAAOA,EAAS,IAC7B,OACCZ,EAAMW,SAASQ,SAAWxC,KAAKuJ,SAASI,iBAI1C,GAAI1H,GAAU,IACb,OAAOjC,KAAKuJ,SAASE,YAEvB,CAGA,OAAIpI,EAAMmB,SAAWnB,EAAMmB,QAAQsH,SAAS,gBACpC9J,KAAKuJ,SAASC,cAIlBnI,EAAMmB,SAAWnB,EAAMmB,QAAQsH,SAAS,WACpC9J,KAAKuJ,SAASK,cAIfvI,EAAMmB,SAAWxC,KAAKuJ,SAASM,aACvC,EAQAE,OAAM,SAAC1I,GAAqB,IAAdT,EAAOT,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,CAAC,EAOlBkE,EAAWlF,EAAEmF,OAAO,CAAC,EANV,CAChB0F,WAAW,EACXC,cAAc,EACdC,cAAc,GAGyBtJ,GAClC4B,EAAUxC,KAAK8B,uBAAuBT,GAc5C,OAZIgD,EAAS4F,aAIT5F,EAAS2F,WACZ9H,EAAMb,MAAMmB,GAGT6B,EAAS6F,cACZ5B,EAAOQ,QAAQ,QAAS,CAAEzH,MAAAA,EAAOmB,QAAAA,IAG3BA,CACR,GAQDrD,EAAEmF,OAAOpF,EAAOO,cAAe,CAC9BC,IAAAA,EACAwC,MAAAA,EACAyB,MAAAA,EACAyB,SAAAA,EACAwB,QAAAA,EACA0B,OAAAA,EACAzG,aAAAA,EAGAsI,MAAO,CAQNC,SAAQ,SAACC,EAAMC,GACd,IAAIC,EACJ,OAAO,WAAmB,QAAAC,EAAA,KAAAC,EAAAtK,UAAAC,OAANsK,EAAI,IAAAC,MAAAF,GAAAG,EAAA,EAAAA,EAAAH,EAAAG,IAAJF,EAAIE,GAAAzK,UAAAyK,GACvBC,aAAaN,GACbA,EAAU5I,WAAW,kBAAM0I,EAAKS,MAAMN,EAAME,EAAK,EAAEJ,EACpD,CACD,EASAS,SAAQ,SAACV,EAAMW,GACd,IAAIC,EACJ,OAAO,WACN,IAAKA,EAAY,SAAAC,EAAA/K,UAAAC,OADEsK,EAAI,IAAAC,MAAAO,GAAAC,EAAA,EAAAA,EAAAD,EAAAC,IAAJT,EAAIS,GAAAhL,UAAAgL,GAEtBd,EAAKS,MAAM9K,KAAM0K,GACjBO,GAAa,EACbtJ,WAAW,kBAAOsJ,GAAa,CAAK,EAAGD,EACxC,CACD,CACD,EASAI,YAAW,SAACC,GAAqB,IAAdC,EAAQnL,UAAAC,OAAA,QAAAC,IAAAF,UAAA,GAAAA,UAAA,GAAG,EAC7B,GAAc,IAAVkL,EAAa,MAAO,UAExB,IACME,EAAKD,EAAW,EAAI,EAAIA,EAExBE,EAAIhK,KAAKiK,MAAMjK,KAAKkK,IAAIL,GAAS7J,KAAKkK,IAHlC,OAKV,OACCC,YAAYN,EAAQ7J,KAAKC,IANhB,KAMuB+J,IAAII,QAAQL,IAC5C,IALa,CAAC,QAAS,KAAM,KAAM,KAAM,MAMnCC,EAER,EAQAK,aAAY,SAACC,GACZ,OAAOA,EAAIC,WAAWjM,QAAQ,wBAAyB,IACxD,KAQFX,EAAE+F,UAAU8G,MAAM,WAEjB9J,EAAME,OAGNlD,EAAO+M,iBAAiB,QAAS,SAAUlD,GAC1ClH,EAAakI,OAAOhB,EAAM1H,MAAO,CAAE2I,WAAW,GAC/C,GAGA9K,EAAO+M,iBAAiB,qBAAsB,SAAUlD,GACvDlH,EAAakI,OAAOhB,EAAMmD,OAAQ,CAAElC,WAAW,GAChD,GAGiC,oBAAtBmC,mBAEV7D,EAAOQ,QAAQ,QAAS,CAAEsD,QAASD,kBAAkBC,SAEvD,EACA,CAjhCD,CAihCGlN,OAAQmN,O,8BC1hCPjP,EAAI,EAAQ,KAEd2B,EAAQ,EAAa3B,EAAEkP,WACDlP,EAAEmP,W,sBCL1BC,EAAOzN,QAAUG,OAAc,K,sBCA/BsN,EAAOzN,QAAUG,OAAiB,Q,0BCGhCsN,EAAOzN,QAAU,EAAjB,G,uuBCMF,SAAWI,GACV,aAEA,IAAMsN,EAAa,CAIlBC,WAAY,SAKZC,aAAc,GAKdC,aAAc,CACbC,OAAQ,EACRC,WAAY,EACZ,cAAe,EACf,cAAe,GAMhBC,UAAW,CACVC,MAAO,KACPH,OAAQ,GACRC,WAAY,GACZ,cAAe,GACf,cAAe,IAMhBG,YAAa,CACZJ,OAAQ,CAAEK,MAAO,OAAQC,MAAO,QAChCL,WAAY,CAAEI,MAAO,OAAQC,MAAO,QACpC,cAAe,CAAED,MAAO,OAAQC,MAAO,QACvC,cAAe,CAAED,MAAO,OAAQC,MAAO,SAMxCC,eAAgB,CACfP,OAAQ,CAAEQ,OAAQ,GAAI1O,KAAM,IAC5BmO,WAAY,CAAEO,OAAQ,IACtB,cAAe,CAAEA,OAAQ,GAAIC,KAAM,IACnC,cAAe,CAAED,OAAQ,KAM1BE,cAAe,CACdV,OAAQ,IAAIW,IACZV,WAAY,IAAIU,IAChB,cAAe,IAAIA,IACnB,cAAe,IAAIA,KAMpBpL,KAAI,WACHpC,KAAKyN,WACLzN,KAAK0N,aACL1N,KAAK2N,YACL3N,KAAK4N,YAAY5N,KAAK0M,WACvB,EAKAe,SAAQ,WACPzN,KAAK6N,YAAc1O,EAAE,4BACrBa,KAAK8N,WAAa3O,EAAE,oBACpBa,KAAK+N,YAAc5O,EAAE,wBACrBa,KAAKgO,SAAW7O,EAAE,iBAClBa,KAAKiO,WAAa9O,EAAE,kBACrB,EAKAuO,WAAU,WAETvO,EAAE+F,UAAUhC,GACX,QACA,gBACAlD,KAAKkO,gBAAgBC,KAAKnO,OAI3Bb,EAAE+F,UAAUhC,GACX,QACA,mBACAlD,KAAKoO,aAAaD,KAAKnO,OAIxBb,EAAE+F,UAAUhC,GACX,QACA,iBACAlD,KAAKqO,WAAWF,KAAKnO,OAItBb,EAAE+F,UAAUhC,GACX,QACA,qBACAlD,KAAKsO,mBAAmBH,KAAKnO,OAE9Bb,EAAE+F,UAAUhC,GACX,SACA,sBACAlD,KAAKuO,iBAAiBJ,KAAKnO,OAE5Bb,EAAE+F,UAAUhC,GACX,SACA,2BACAlD,KAAKwO,iBAAiBL,KAAKnO,OAI5Bb,EAAE+F,UAAUhC,GACX,SACA,mBACAlD,KAAKyO,gBAAgBN,KAAKnO,OAE3Bb,EAAE+F,UAAUhC,GACX,SACA,sBACAlD,KAAK0O,iBAAiBP,KAAKnO,OAI5Bb,EAAE+F,UAAUhC,GACX,QACA,uBACAlD,KAAK2O,iBAAiBR,KAAKnO,OAI5Bb,EAAE+F,UAAUhC,GACX,QACA,mBACAlD,KAAK4O,aAAaT,KAAKnO,OAExBb,EAAE+F,UAAUhC,GACX,QACA,mBACAlD,KAAK6O,aAAaV,KAAKnO,OAIxBb,EAAE+F,UAAUhC,GACX,QACA,iBACAlD,KAAK8O,iBAAiBX,KAAKnO,MAE7B,EAKA2N,UAAS,WAAG,IAAAhN,EAAA,KACXtB,GAAGD,SAAS,CACX6B,KAAM,yBAEL8N,KAAK,SAAC/M,GACFA,EAASwB,SAAWxB,EAASvB,OAChCE,EAAKoM,UAAUC,MAAQhL,EAASvB,KAChCE,EAAKqO,YAAYhN,EAASvB,MAC1BE,EAAKsO,iBAAiBjN,EAASvB,MAEjC,GAAE,MACK,SAACY,GAEPV,EAAKuO,cAAcvO,EAAKoN,aACxBpN,EAAKuO,cAAcvO,EAAKkN,YACzB,EACF,EAMAmB,YAAW,SAACvO,GAAM,IAAA0O,EAAA1M,EAAA,KACH,CACb,CAAEiF,MAAOjH,EAAK2O,aAAe,EAAGC,SAAU,GAC1C,CAAE3H,MAAOjH,EAAK6O,cAAgB,EAAGD,SAAU,GAC3C,CAAE3H,MAAOjH,EAAK8O,iBAAmB,EAAGF,SAAU,GAC9C,CACC3H,MAAO1H,KAAKoL,aAAkC,QAAtB+D,EAAA1O,EAAK+O,yBAAiB,IAAAL,OAAA,EAAtBA,EAAwB9D,QAAS,GACzDgE,SAAU,IAINtH,QAAQ,SAAC0H,GACd,IAAMC,EAAQjN,EAAKsL,YACjB4B,KAAK,mBACLC,GAAGH,EAAKJ,UACVK,EAAMC,KAAK,oBAAoBnQ,KAAKiQ,EAAK/H,OACzCgI,EAAMC,KAAK,4BAA4BE,OACvCH,EAAMC,KAAK,2BAA2BpN,MACvC,GAGApD,EAAE,oDAAoDK,KACrDiB,EAAK6O,cAAgB,GAEtBnQ,EAAE,wDAAwDK,KACzDiB,EAAK8O,iBAAmB,GAEzBpQ,EAAE,yDAAyDK,KAC1DiB,EAAKqP,mBAAqB,GAE3B3Q,EAAE,yDAAyDK,KAC1DiB,EAAKsP,mBAAqB,EAE5B,EAMAd,iBAAgB,SAACxO,GAChB,IAAMuP,EAAWvP,EAAKwP,UACnBjQ,KAAKkQ,WAAWzP,EAAKwP,WACrB9D,kBAAkB5M,KAAK4Q,SAAW,QAErCnQ,KAAK6N,YAAY8B,KAAK,2BAA2BnQ,KAAKwQ,GACtDhQ,KAAK6N,YAAY8B,KAAK,qCAAqCE,OAC3D7P,KAAK6N,YAAY8B,KAAK,6BAA6BpN,OACnDvC,KAAK8N,WAAWsC,KAAK,YAAY,EAClC,EAMAlC,gBAAe,SAAC5P,GACfA,EAAE+R,iBACF,IAAMC,EAAOnR,EAAEb,EAAEiS,eACXC,EAAMF,EAAK7P,KAAK,OAElB+P,IAAQxQ,KAAK0M,aAKjB1M,KAAKgO,SAAS3K,YAAY,mBAC1BiN,EAAKlN,SAAS,mBAEdpD,KAAKiO,WAAW5K,YAAY,mBAC5BlE,EAAE,6BAADY,OAA8ByQ,EAAG,OAAMpN,SAAS,mBAEjDpD,KAAK0M,WAAa8D,EAClBxQ,KAAK4N,YAAY4C,GAClB,EAMA5C,YAAW,SAAC4C,GAAK,IAAA3M,EAAA,KAEhB,GAAI7D,KAAK+M,UAAUyD,GAAKpQ,OAAS,EAChCJ,KAAKyQ,cAAcD,OADpB,CAKA,IAAIE,EAAU,GACd,OAAQF,GACP,IAAK,SACJE,EAAU,wBACV,MACD,IAAK,aACJA,EAAU,4BACV,MACD,IAAK,cACJA,EAAU,6BACV,MACD,IAAK,cACJA,EAAU,6BAIZ,IAAMC,EAASxR,EAAE,6BAADY,OAA8ByQ,EAAG,OAC3CI,EAAYD,EAAOhB,KAAK,4BAE9BiB,EAAUrO,OAEVlD,GAAGD,SAAS,CACX6B,KAAMyP,IAEL3B,KAAK,SAAC/M,GACFA,EAASwB,SAAWxB,EAASvB,OAChCoD,EAAKkJ,UAAUyD,GAAOxO,EAASvB,KAC/BoD,EAAK4M,cAAcD,GAErB,GAAE,MACK,SAACnP,GAEPuP,EAAUf,OACVhM,EAAKgN,eAAeF,EACrB,EApCD,CAqCD,EAMAF,cAAa,SAACD,GACb,IAAMG,EAASxR,EAAE,6BAADY,OAA8ByQ,EAAG,OAC/BG,EAAOhB,KAAK,4BAEpBE,OAGV,IAAIpP,EAAOT,KAAK8Q,WAAWN,EAAKxQ,KAAK+M,UAAUyD,IAC/C/P,EAAOT,KAAK+Q,SAASP,EAAK/P,GAGd,eAAR+P,EACHxQ,KAAKgR,iBAAiBL,EAAQlQ,GAE9BT,KAAKiR,YAAYN,EAAQH,EAAK/P,GAG/BT,KAAKkR,iBAAiBP,EAAQH,EAAK/P,EAAKL,QACxCJ,KAAKmR,kBAAkBR,EAAQH,EAChC,EAOAM,WAAU,SAACN,EAAK/P,GACf,IAAM2Q,EAAUpR,KAAKoN,eAAeoD,GAChCa,EAAQC,EAAO7Q,GAGnB,GAAI2Q,EAAQ/D,OAAQ,CACnB,IAAMA,EAAS+D,EAAQ/D,OAAOkE,cAC9BF,EAAWA,EAASzI,OACnB,SAACvB,GAAI,OACHA,EAAKmK,UAAY,IAAID,cAAczH,SAASuD,KAC5ChG,EAAKtD,OAAS,IAAIwN,cAAczH,SAASuD,EAAO,EAEpD,CAUA,GAPI+D,EAAQzS,OACX0S,EAAWA,EAASzI,OACnB,SAACvB,GAAI,OAAKA,EAAK1I,OAASyS,EAAQzS,IAAI,IAKlCyS,EAAQ9D,KAAM,CACjB,IAKMmE,EALY,CACjB,MAAO,QACP,MAAO,QACP,OAAQ,UAEiBL,EAAQ9D,OAAS,EAC3C+D,EAAWA,EAASzI,OAAO,SAACvB,GAAI,OAAKA,EAAKiG,KAAOmE,CAAO,EACzD,CAEA,OAAOJ,CACR,EAOAN,SAAQ,SAACP,EAAK/P,GACb,IAAMiR,EAAO1R,KAAKiN,YAAYuD,GACxBmB,EAAML,EAAO7Q,GAkBnB,OAhBAkR,EAAOD,KAAK,SAACxT,EAAGE,GACf,IAAIwT,EAAO1T,EAAEwT,EAAKxE,OACd2E,EAAOzT,EAAEsT,EAAKxE,OAQlB,MALoB,iBAAT0E,IACVA,EAAOA,EAAKL,cACZM,EAAOA,EAAKN,eAGM,QAAfG,EAAKvE,MACDyE,EAAOC,EAAO,GAAK,EAEpBD,EAAOC,EAAO,GAAK,CAC3B,GAEOF,CACR,EAQAV,YAAW,SAACN,EAAQH,EAAK/P,GAAM,IAAAgE,EAAA,KACxBqN,EAASnB,EAAOhB,KAAK,2BAErBoC,GADO/R,KAAK4M,aAAa4D,GACT,GAAKxQ,KAAK2M,aAC1BqF,EAAMD,EAAQ/R,KAAK2M,aACnBsF,EAAWxR,EAAKyR,MAAMH,EAAOC,GAEnC,GAAwB,IAApBC,EAAS7R,OAAb,CASA,IAAM4C,EAAOiP,EACXE,IAAI,SAAC9K,GAAI,OAAK5C,EAAK2N,eAAe5B,EAAKnJ,EAAK,GAC5CgL,KAAK,IACPP,EAAO9O,KAAKA,GAGZhD,KAAKsS,iBAAiBR,EARtB,MANCA,EAAO9O,KACN,iDACEmJ,kBAAkB5M,KAAK4Q,SAAW,mBACnC,aAYJ,EAOAiC,eAAc,SAAC5B,EAAKnJ,GACnB,IAAMkL,EAAYvS,KAAKuN,cAAciD,GAAKgC,IAAInL,EAAK9B,IAC7CkN,EACLpL,EAAKqL,WAAarL,EAAKsL,eAAiBtL,EAAKuL,KAAO,GAC/CC,EAAWxL,EAAKyL,WAAa,GAC7BC,EACS,UAAd1L,EAAK1I,MAAoBkU,EAAS7K,WAAW,UAE1ChF,EAAO,gBAAkBqE,EAAK9B,GAAK,KACvCvC,GAAQ,iCACRA,GACC,8DACAqE,EAAK9B,GACL,MACCgN,EAAY,UAAY,IACzB,MACDvP,GAAQ,QAERA,GAAQ,gCAEPA,GADG+P,GAAWN,EAEb,4CACAA,EACA,qCAGA,0DAEFzP,GAAQ,QAERA,GAAQ,iCACRA,GACC,WACAhD,KAAKgT,WAAW3L,EAAKmK,UAAYnK,EAAKtD,OAAS,YAC/C,YACDf,GAAQ,QAER,IAAMiQ,EACL5L,EAAKiG,MAAQjG,EAAK6L,WAAa7L,EAAK8L,cAAgB,EA8CrD,MA7CY,gBAAR3C,GACHxN,GACC,6BACAhD,KAAKoL,YAAY6H,GACjB,QACDjQ,GACC,oCACCqE,EAAK+L,OAAS/L,EAAKgM,OACjBhM,EAAK+L,MAAQ,MAAQ/L,EAAKgM,OAC1B,MACH,SACiB,gBAAR7C,GACVxN,GACC,6BACAhD,KAAKoL,YAAY6H,GACjB,QACDjQ,GACC,6BACAhD,KAAKkQ,WAAW7I,EAAKiM,MACrB,SAEDtQ,GACC,6BACAhD,KAAKkQ,WAAW7I,EAAKiM,MACrB,QAGFtQ,GAAQ,gCACI,gBAARwN,IACHxN,GACC,gEACAqE,EAAK9B,GACL,oBACDvC,GAAQ,kDACRA,GAAQ,cAETA,GACC,gEACAqE,EAAK9B,GACL,oBACDvC,GAAQ,mDACRA,GAAQ,YACRA,GAAQ,QAERA,GAAQ,OAET,EAOAgO,iBAAgB,SAACL,EAAQlQ,GAAM,IAAAmF,EAAA,KACxB2N,EAAa5C,EAAOhB,KAAK,8BAEzBoC,GADO/R,KAAK4M,aAAaE,WACT,GAAK9M,KAAK2M,aAC1BqF,EAAMD,EAAQ/R,KAAK2M,aACnBsF,EAAWxR,EAAKyR,MAAMH,EAAOC,GAEnC,GAAwB,IAApBC,EAAS7R,OAAb,CAUA,IAAM4C,EAAOiP,EACXE,IAAI,SAACqB,GAAK,OAAK5N,EAAK6N,qBAAqBD,EAAM,GAC/CnB,KAAK,IACPkB,EAAWvQ,KAAKA,GAGhBhD,KAAKsS,iBAAiBiB,EARtB,MAPCA,EAAWvQ,KACV,kCACEmJ,kBAAkB5M,KAAK4Q,SACvB,8BACD,SAYJ,EAMAsD,qBAAoB,SAACD,GAAO,IAAA9M,EAAA,KACvB1D,EAAO,qCAmEX,OAlEAA,GAAQ,4CACRA,GACC,OACAhD,KAAKgT,WAAWQ,EAAMhC,UAAY,iBAClC,QACDxO,GACC,sCACAwQ,EAAMrL,MAAM/H,OACZ,iBACAJ,KAAKoL,YAAYoI,EAAME,YACvB,UACD1Q,GAAQ,SACRA,GAAQ,qCAERwQ,EAAMrL,MAAMJ,QAAQ,SAACV,EAAMsM,GAC1B,IAAMpB,EAAY7L,EAAK6G,cAAcT,WAAW0F,IAAInL,EAAK9B,IACnDqO,EAAuB,IAAVD,EACblB,EACLpL,EAAKqL,WAAarL,EAAKsL,eAAiBtL,EAAKuL,KAAO,GAErD5P,GACC,6CACAqE,EAAK9B,GACL,KACDvC,GAAQ,4CAEPA,GADGyP,EAEF,4CACAA,EACA,uCAGA,0DAEFzP,GAAQ,SACRA,GAAQ,yCACRA,GACC,sCACA0D,EAAKsM,WAAW3L,EAAKmK,UACrB,OACDxO,GACC,kCACA0D,EAAK0E,YACJ/D,EAAKiG,MAAQjG,EAAK6L,WAAa7L,EAAK8L,cAAgB,GAErD,MACAzM,EAAKwJ,WAAW7I,EAAKiM,MACrB,OACDtQ,GAAQ,uCACRA,GACC,8DACAqE,EAAK9B,GACL,MACCgN,EAAY,UAAY,IACzB,OACGqB,IACH5Q,GACC,+DAEFA,GAAQ,SACRA,GAAQ,SACRA,GAAQ,QACT,GAEAA,GAAQ,SACRA,GAAQ,QAET,EAQAkO,iBAAgB,SAACP,EAAQH,EAAKqD,GAC7B,IAAMC,EAAcnD,EAAOhB,KAAK,6BAC1BoE,EAAQpD,EAAOhB,KAAK,sBACpBqE,EAAOhU,KAAK4M,aAAa4D,GACzByD,EAAazS,KAAK0S,KAAKL,EAAa7T,KAAK2M,cACzCoF,GAASiC,EAAO,GAAKhU,KAAK2M,aAAe,EACzCqF,EAAMxQ,KAAK8E,IAAI0N,EAAOhU,KAAK2M,aAAckH,GAGzCM,EAAe,eAAR3D,EAAuB,SAAW,QAG/C,GAFAuD,EAAMvU,KAAK,WAADO,OAAYgS,EAAK,KAAAhS,OAAIiS,EAAG,QAAAjS,OAAO8T,EAAU,KAAA9T,OAAIoU,IAEnDF,GAAc,EACjBH,EAAY9Q,KAAK,QADlB,CAKA,IAAIA,EAAO,GAGXA,GACC,oDACCgR,EAAO,GACR,MACU,IAATA,EAAa,WAAa,IAC3B,IACDhR,GAAQ,4DACRA,GAAQ,aAGR,IACIoR,EAAY5S,KAAK6E,IAAI,EAAG2N,EAAOxS,KAAKiK,MAAM4I,MACxCC,EAAU9S,KAAK8E,IAAI2N,EAAYG,EAFlB,EAE2C,GAE1DE,EAAUF,EAAYC,IACzBD,EAAY5S,KAAK6E,IAAI,EAAGiO,EALN,EAK6B,IAG5CF,EAAY,IACfpR,GACC,iEACGoR,EAAY,IACfpR,GAAQ,6CAIV,IAAK,IAAIwI,EAAI4I,EAAW5I,GAAK8I,EAAS9I,IAAK,CAE1CxI,GACC,uCAFgBwI,IAAMwI,EAGV,kBAAoB,IAChC,gBACAxI,EACA,KACAA,EACA,YACF,CAEI8I,EAAUL,IACTK,EAAUL,EAAa,IAC1BjR,GAAQ,4CAETA,GACC,mDACAiR,EACA,KACAA,EACA,cAIFjR,GACC,oDACCgR,EAAO,GACR,MACCA,IAASC,EAAa,WAAa,IACpC,IACDjR,GACC,6DACDA,GAAQ,YAER8Q,EAAY9Q,KAAKA,EAlEjB,CAmED,EAOAmO,kBAAiB,SAACR,EAAQH,GACzB,IAAM+D,EAAevU,KAAKuN,cAAciD,GAAKlD,KAAO,EACpDqD,EACEhB,KAAK,kDACLS,KAAK,YAAamE,EACrB,EAMAnG,aAAY,SAAC9P,GAAG,IAAAuJ,EAAA,KACfvJ,EAAE+R,iBACF,IAAMC,EAAOnR,EAAEb,EAAEiS,eAEbD,EAAKF,KAAK,cAIdE,EAAKF,KAAK,YAAY,GAAMhN,SAAS,gBACrCkN,EAAKX,KAAK,cAAcvM,SAAS,aAEjC/D,GAAGD,SAAS,CACX6B,KAAM,sBACNV,OAAQ,SAEPwO,KAAK,SAAC/M,GACFA,EAASwB,UAEZnG,OAAOyK,KAAKD,EAAKkF,WAAWhF,QAAQ,SAACnK,GACxB,UAARA,IACHiK,EAAKkF,UAAUnP,GAAO,GAExB,GAEAiK,EAAK8F,YACL9F,EAAK+F,YAAY/F,EAAK6E,YAGtB7E,EAAK2M,WACJ,UACArI,kBAAkB5M,KAAKiE,SACtB,gCAGJ,GAAE,MACK,SAACnC,GAEPwG,EAAK2M,WACJ,QACArI,kBAAkB5M,KAAK8B,OAAS,eAElC,GAAE,QACO,WACRiP,EAAKF,KAAK,YAAY,GAAO/M,YAAY,gBACzCiN,EAAKX,KAAK,cAActM,YAAY,YACrC,GACF,EAMAgL,WAAU,SAAC/P,GACVA,EAAE+R,iBACF,IAAMoE,EAAMtV,EAAEb,EAAEiS,eACVrD,EAAQuH,EAAIhU,KAAK,QACjB+P,EAAMxQ,KAAK0M,WACXO,EAAcjN,KAAKiN,YAAYuD,GAGjCrD,EAAQ,OACRF,EAAYC,QAAUA,IACzBC,EAA8B,QAAtBF,EAAYE,MAAkB,OAAS,OAGhDnN,KAAKiN,YAAYuD,GAAO,CAAEtD,MAAAA,EAAOC,MAAAA,GAGjCsH,EAAIC,SAAS,kBACXrR,YAAY,oCACZsM,KAAK,cACLtM,YAAY,2CACZD,SAAS,kBAEXqR,EAAIrR,SACO,QAAV+J,EAAkB,kBAAoB,oBAErCwC,KAAK,cACLtM,YAAY,kBACZD,SACU,QAAV+J,EACG,qBACA,wBAGLnN,KAAKyQ,cAAcD,EACpB,EAMAlC,mBAAkB,SAAChQ,GAClB,IAAMqW,EAASxV,EAAEb,EAAEiS,eACbC,EAAMxQ,KAAK0M,WACXhF,EAAQiN,EAAOC,MAAMC,OAE3B7U,KAAKoN,eAAeoD,GAAKnD,OAAS3F,EAClC1H,KAAK4M,aAAa4D,GAAO,EACzBxQ,KAAKyQ,cAAcD,EACpB,EAMAjC,iBAAgB,SAACjQ,GAChB,IACMoJ,EADUvI,EAAEb,EAAEiS,eACEqE,MAEtB5U,KAAKoN,eAAeP,OAAOlO,KAAO+I,EAClC1H,KAAK4M,aAAaC,OAAS,EAC3B7M,KAAKyQ,cAAc,SACpB,EAMAjC,iBAAgB,SAAClQ,GAChB,IACMoJ,EADUvI,EAAEb,EAAEiS,eACEqE,MAEtB5U,KAAKoN,eAAe,eAAeE,KAAO5F,EAC1C1H,KAAK4M,aAAa,eAAiB,EACnC5M,KAAKyQ,cAAc,cACpB,EAMAhC,gBAAe,SAACnQ,GAAG,IAAA4J,EAAA,KAEZqK,EADYpT,EAAEb,EAAEiS,eACMuE,GAAG,YACzBtE,EAAMxQ,KAAK0M,WACXiE,EAASxR,EAAE,6BAADY,OAA8ByQ,EAAG,OAEjDG,EACEhB,KAAK,uBACLS,KAAK,UAAWmC,GAChBwC,KAAK,SAACvJ,EAAGwJ,GACT,IAAMzP,EAAKpG,EAAE6V,GAAIvU,KAAK,MAClB8R,EACHrK,EAAKqF,cAAciD,GAAKyE,IAAI1P,GAE5B2C,EAAKqF,cAAciD,GAAI,OAAQjL,EAEjC,GAEDvF,KAAKmR,kBAAkBR,EAAQH,EAChC,EAMA9B,iBAAgB,SAACpQ,GAChB,IAAM4W,EAAY/V,EAAEb,EAAEiS,eAChBhL,EAAK2P,EAAUzU,KAAK,MACpB8R,EAAY2C,EAAUJ,GAAG,YACzBtE,EAAMxQ,KAAK0M,WACXiE,EAASxR,EAAE,6BAADY,OAA8ByQ,EAAG,OAE7C+B,EACHvS,KAAKuN,cAAciD,GAAKyE,IAAI1P,GAE5BvF,KAAKuN,cAAciD,GAAI,OAAQjL,GAGhCvF,KAAKmR,kBAAkBR,EAAQH,EAChC,EAMA7B,iBAAgB,SAACrQ,GAChBA,EAAE+R,iBACF,IAAMG,EAAMxQ,KAAK0M,WAEXyI,EADShW,EAAE,6BAADY,OAA8ByQ,EAAG,OAC3Bb,KAAK,4BAA4BiF,MACjDzM,EAAQwC,MAAMyK,KAAKpV,KAAKuN,cAAciD,IAE5C,GAAK2E,GAA2B,IAAjBhN,EAAM/H,OAArB,CAIA,IAAMiV,EACM,WAAXF,EACG,mCACDhN,EAAM/H,OACN,0CACC,mCACD+H,EAAM/H,OACN,YAEEwD,QAAQyR,IAIbrV,KAAKsV,kBAAkBH,EAAQhN,EAAOqI,EAftC,CAgBD,EAQA8E,kBAAiB,SAACH,EAAQhN,EAAOqI,GAAK,IAAA9H,EAAA,KAC/BgI,EACM,WAAXyE,EACG,wBACA,wBAEJ9V,GAAGD,SAAS,CACX6B,KAAMyP,EACNnQ,OAAQ,OACRE,KAAM,CAAE8U,IAAKpN,KAEZ4G,KAAK,SAAC/M,GACFA,EAASwB,UAEZkF,EAAKqE,UAAUyD,GAAO9H,EAAKqE,UAAUyD,GAAK5H,OACzC,SAACvB,GAAI,OAAMc,EAAM2B,SAASzC,EAAK9B,GAAG,GAInCmD,EAAK6E,cAAciD,GAAK5I,QAGxBc,EAAK+H,cAAcD,GACnB9H,EAAKiF,YAELjF,EAAK8L,WACJ,UACAxS,EAASvB,KAAK+B,SACb,kCAGJ,GAAE,MACK,SAACnB,GAEPqH,EAAK8L,WACJ,QACArI,kBAAkB5M,KAAK8B,OAAS,iBAElC,EACF,EAMAuN,aAAY,SAACtQ,GACZA,EAAE+R,iBACF,IACM9K,EADOpG,EAAEb,EAAEiS,eACD9P,KAAK,MAGnBmD,QACA,6EAMF5D,KAAKsV,kBAAkB,SAAU,CAAC/P,GAAKvF,KAAK0M,WAC7C,EAMAmC,aAAY,SAACvQ,GACZA,EAAE+R,iBACF,IACM9K,EADOpG,EAAEb,EAAEiS,eACD9P,KAAK,MAErBT,KAAKsV,kBAAkB,SAAU,CAAC/P,GAAKvF,KAAK0M,WAC7C,EAMAoC,iBAAgB,SAACxQ,GAChBA,EAAE+R,iBACF,IAAMC,EAAOnR,EAAEb,EAAEiS,eAEjB,IAAID,EAAKF,KAAK,YAAd,CAIA,IAAM4D,EAAOwB,SAASlF,EAAK7P,KAAK,SAC1B+P,EAAMxQ,KAAK0M,WAEjB1M,KAAK4M,aAAa4D,GAAOwD,EACzBhU,KAAKyQ,cAAcD,GAGnBrR,EAAE,yBAAyB,GAAGsW,eAAe,CAC5CC,SAAU,SACVC,MAAO,SAXR,CAaD,EAMArD,iBAAgB,SAACiB,GAChBA,EAAW5D,KAAK,sBAAsBoF,KAAK,SAACvJ,EAAGoK,GAC9C,IAAMC,EAAO1W,EAAEyW,GACTE,EAAMD,EAAKpV,KAAK,OAEtB,GAAIqV,EAAK,CACR,IAAMC,EAAW,IAAIC,qBAAqB,SAACC,GAC1CA,EAAQlO,QAAQ,SAACmO,GACZA,EAAMC,iBACTN,EAAKrP,KAAK,MAAOsP,GACjBC,EAASK,UAAUF,EAAMjR,QAE3B,EACD,GAEA8Q,EAASM,QAAQT,EAClB,CACD,EACD,EAMA/E,eAAc,SAACF,GACdA,EACEhB,KAAK,2BACL3M,KACA,kCACEmJ,kBAAkB5M,KAAK4Q,SACvB,sBACD,SAEJ,EAOAqE,WAAU,SAAC7V,EAAM6D,GAChB,IAAM8T,EAAUnX,EACf,6BACCR,EACA,uBACA6D,EACA,cAEFrD,EAAE,6BAA6BoX,MAAMD,GAGrC3U,WAAW,WACV2U,EAAQ3P,QAAQ,kBAAM2P,EAAQhT,QAAQ,EACvC,EAAG,IACJ,EAMA8H,YAAW,SAACC,GACX,GAAc,IAAVA,EAAa,MAAO,UACxB,IAEMG,EAAIhK,KAAKiK,MAAMjK,KAAKkK,IAAIL,GAAS7J,KAAKkK,IAFlC,OAGV,OACClK,KAAKiF,MAAO4E,EAAQ7J,KAAKC,IAJhB,KAIuB+J,GAAM,KAAO,IAC7C,IAJa,CAAC,QAAS,KAAM,KAAM,MAK7BA,EAER,EAMA0E,WAAU,SAACsG,GACV,IAAKA,EAAY,MAAO,KACxB,IAAMlD,EAAO,IAAImD,KAAKD,GACtB,OAAOlD,EAAKoD,qBAAuB,IAAMpD,EAAKqD,oBAC/C,EAMA3D,WAAU,SAACxT,GACV,IAAM2S,EAAM,CACX,IAAK,QACL,IAAK,OACL,IAAK,OACL,IAAK,SACL,IAAK,UAEN,OAAO3S,EAAKM,QAAQ,WAAY,SAAC1C,GAAC,OAAK+U,EAAI/U,EAAE,EAC9C,EAMA8R,cAAa,SAACqE,GACbA,EAAW5D,KAAK,wBAAwBE,MACzC,GAID1Q,EAAE+F,UAAU8G,MAAM,WACb7M,EAAE,qBAAqBiB,QAC1BqM,EAAWrK,MAEb,EACA,CA9oCD,CA8oCGiK,O,GCtpCCuK,EAA2B,CAAC,EAGhC,SAASC,EAAoBC,GAE5B,IAAIC,EAAeH,EAAyBE,GAC5C,QAAqBzW,IAAjB0W,EACH,OAAOA,EAAahY,QAGrB,IAAIyN,EAASoK,EAAyBE,GAAY,CAGjD/X,QAAS,CAAC,GAOX,OAHAiY,EAAoBF,GAAUtK,EAAQA,EAAOzN,QAAS8X,GAG/CrK,EAAOzN,OACf,CCrBA8X,EAAoBrZ,EAAKgP,IACxB,IAAIyK,EAASzK,GAAUA,EAAO0K,WAC7B,IAAO1K,EAAiB,QACxB,IAAM,EAEP,OADAqK,EAAoBxY,EAAE4Y,EAAQ,CAAE/Y,EAAG+Y,IAC5BA,GCLRJ,EAAoBxY,EAAI,CAACU,EAASoY,KACjC,IAAI,IAAIvZ,KAAOuZ,EACXN,EAAoBO,EAAED,EAAYvZ,KAASiZ,EAAoBO,EAAErY,EAASnB,IAC5EP,OAAOga,eAAetY,EAASnB,EAAK,CAAE0Z,YAAY,EAAMrX,IAAKkX,EAAWvZ,MCJ3EiZ,EAAoBO,EAAI,CAACG,EAAKnH,IAAU/S,OAAOC,UAAUC,eAAeiB,KAAK+Y,EAAKnH,G,2wECclF,IAAMoH,EAAmB,CACxBC,GAAI,IACJC,KAAM,IACNC,QAAS,KAMJC,EAAe,CACpBH,GAAI,UACJC,KAAM,UACNC,QAAS,WA8LV,QA9KmB,SAAHE,GAQV,IAPL9T,EAAK8T,EAAL9T,MACA2D,EAAKmQ,EAALnQ,MAAKoQ,EAAAD,EACL1D,KAAAA,OAAI,IAAA2D,EAAG,GAAEA,EAAAC,EAAAF,EACTG,MAAAA,OAAK,IAAAD,EAAG,UAASA,EAAAE,EAAAJ,EACjBK,WAAAA,OAAU,IAAAD,EAAG,KAAIA,EAAAE,EAAAN,EACjBhV,KAAAA,OAAI,IAAAsV,EAAG,sBAAqBA,EAAAC,EAAAP,EAC5BQ,QAAAA,OAAO,IAAAD,EAAG,KAAIA,EAGRE,EAAa,CAAC,KAAM,OAAQ,WAAWxO,SAASkO,GACnDA,EACA,UACGO,EAAiBf,EAAiBc,GAClCE,EAAaZ,EAAaU,GAG1BG,EACU,OAAfP,EAAmB,GAAAnY,OACbwY,EAAc,KAAAxY,OAAImY,EAAU,KAC/BK,EAGEG,EAAY,GAAH3Y,OAAMgE,EAAK,MAAAhE,OAAK2H,EAAK,KAAA3H,OAAIoU,GAAIpU,OAC5B,OAAfmY,EAAmB,WAAAnY,OACLuY,EAAU,QAAAvY,OAAOmY,EAAU,YACtC,IAIES,EAAiC,mBAAZN,EAWrBO,EAAa,CAClBC,QAAS,OACTC,WAAY,SACZC,QAAS,OACTC,gBAAiB,OACjBC,OAAQ,oBACRC,aAAc,MACdC,OAAQR,EAAc,UAAY,UAClCS,WAAY,gBACZC,QAAS,OACTC,UAAW,SAqENC,EAAc,CACnBC,SAAU,OACVC,WAAY,MACZC,MAAOlB,EACPmB,WAAY,OAI0CC,EAAAC,EAArBC,IAAAA,UAAe,GAAM,GAAhDC,EAASH,EAAA,GAAEI,EAAYJ,EAAA,GAE9B,OACCK,EAAAA,EAAAA,MAAA,OACCC,UAAU,cACVtX,KAAM+V,EAAc,SAAW,UAC/BwB,SAAUxB,EAAc,OAAItY,EAC5B,aAAYqY,EACZL,QAASM,EAAcN,OAAUhY,EACjC+Z,WAxGqB,SAAC9b,IACnBqa,GAA0B,UAAVra,EAAEV,KAA6B,MAAVU,EAAEV,MAC1CU,EAAE+R,iBACFgI,IAEF,EAoGEgC,aAAc,WAAF,OAAQL,GAAa,EAAK,EACtCM,aAAc,WAAF,OAAQN,GAAa,EAAM,EACvCjU,MAAK3E,EAAAA,EAAA,GACDwX,GACCmB,GAAapB,EAvFA,CACnB4B,UAAW,+BACXC,UAAW,mBACXC,YAAa,WAoFkC,CAAC,GAC7CC,SAAA,EAGFC,EAAAA,EAAAA,KAAA,OAAK5U,MApFqB,CAC3B8S,QAAS,OACTC,WAAY,SACZ8B,eAAgB,SAChBxH,MAAO,OACPC,OAAQ,OACRwH,YAAa,OACbC,WAAY,GA6EqBJ,UAC/BC,EAAAA,EAAAA,KAAA,QACCT,UAAS,aAAAna,OAAe8C,GACxBkD,MA5Ee,CAClByT,SAAU,OACVpG,MAAO,OACPC,OAAQ,OACRqG,MAAO,WAyEJ,cAAY,YAKdO,EAAAA,EAAAA,MAAA,OAAKlU,MA1Ee,CACrBgV,KAAM,EACNC,SAAU,GAwEiBN,SAAA,EACzBC,EAAAA,EAAAA,KAAA,MAAI5U,MArEa,CACnBkV,OAAQ,YACRzB,SAAU,OACVC,WAAY,MACZC,MAAO,UACPwB,WAAY,OAgEaR,SAAE3W,KACzBkW,EAAAA,EAAAA,MAAA,OAAKlU,MA7DqB,CAC5B8S,QAAS,OACTC,WAAY,WACZqC,IAAK,MACLC,SAAU,QAyDyBV,SAAA,EAChCC,EAAAA,EAAAA,KAAA,QAAM5U,MAtDU,CACnByT,SAAU,OACVC,WAAY,MACZC,MAAO,UACPwB,WAAY,OAkDgBR,SAAEhT,IAC1ByM,IAAQwG,EAAAA,EAAAA,KAAA,QAAM5U,MA/CA,CAClByT,SAAU,OACVC,WAAY,MACZC,MAAO,UACPwB,WAAY,OA2CwBR,SAAEvG,IACnB,OAAf+D,IACAyC,EAAAA,EAAAA,KAAA,QACC5U,MAAOwT,EACP,sBAAAxZ,OAAqBuY,EAAU,QAAAvY,OAAOmY,EAAU,YAAWwC,SAE1DjC,YAOR,E,cClMAvZ,OAAOmc,wBAA0Bnc,OAAOmc,yBAA2B,CAAC,EACpEhe,OAAOie,OAAOpc,OAAOmc,wBAAyB,CAC7CE,WAAAA,EACAzB,MAAAA,IACAxN,WAAAA,EAAAA,IAIDpH,SAAS+G,iBAAiB,mBAAoB,WAE9C,E","sources":["webpack://wp-admin-health-suite/./node_modules/react/cjs/react-jsx-runtime.production.min.js","webpack://wp-admin-health-suite/./assets/js/admin.js","webpack://wp-admin-health-suite/./node_modules/react-dom/client.js","webpack://wp-admin-health-suite/external window \"React\"","webpack://wp-admin-health-suite/external window \"ReactDOM\"","webpack://wp-admin-health-suite/./node_modules/react/jsx-runtime.js","webpack://wp-admin-health-suite/./assets/js/media-audit.js","webpack://wp-admin-health-suite/webpack/bootstrap","webpack://wp-admin-health-suite/webpack/runtime/compat get default export","webpack://wp-admin-health-suite/webpack/runtime/define property getters","webpack://wp-admin-health-suite/webpack/runtime/hasOwnProperty shorthand","webpack://wp-admin-health-suite/./assets/js/components/MetricCard.jsx","webpack://wp-admin-health-suite/./assets/js/entries/media-audit.js"],"sourcesContent":["/**\n * @license React\n * react-jsx-runtime.production.min.js\n *\n * Copyright (c) Facebook, Inc. and its affiliates.\n *\n * This source code is licensed under the MIT license found in the\n * LICENSE file in the root directory of this source tree.\n */\n'use strict';var f=require(\"react\"),k=Symbol.for(\"react.element\"),l=Symbol.for(\"react.fragment\"),m=Object.prototype.hasOwnProperty,n=f.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,p={key:!0,ref:!0,__self:!0,__source:!0};\nfunction q(c,a,g){var b,d={},e=null,h=null;void 0!==g&&(e=\"\"+g);void 0!==a.key&&(e=\"\"+a.key);void 0!==a.ref&&(h=a.ref);for(b in a)m.call(a,b)&&!p.hasOwnProperty(b)&&(d[b]=a[b]);if(c&&c.defaultProps)for(b in a=c.defaultProps,a)void 0===d[b]&&(d[b]=a[b]);return{$$typeof:k,type:c,key:e,ref:h,props:d,_owner:n.current}}exports.Fragment=l;exports.jsx=q;exports.jsxs=q;\n","/**\n * Admin JavaScript - Core\n *\n * Core admin JavaScript for WP Admin Health Suite.\n * Provides utilities, API wrapper, notifications, event system, and error handling.\n *\n * @param window\n * @param $\n * @package\n */\n\n(function (window, $) {\n\t'use strict';\n\n\t// Ensure wp.apiFetch is available\n\tconst apiFetch = window.wp && window.wp.apiFetch;\n\tif (!apiFetch) {\n\t\tconsole.error(\n\t\t\t'wp.apiFetch is not available. Admin functionality may be limited.'\n\t\t);\n\t}\n\n\t// Ensure wp.i18n is available for translations\n\tconst { __ } = window.wp.i18n || { __: (text) => text };\n\n\t/**\n\t * Main WPAdminHealth namespace\n\t */\n\twindow.WPAdminHealth = window.WPAdminHealth || {};\n\n\t// ============================================================================\n\t// API WRAPPER\n\t// ============================================================================\n\n\t/**\n\t * API wrapper for making REST API calls\n\t */\n\tconst API = {\n\t\t/**\n\t\t * Base namespace for REST API\n\t\t */\n\t\tnamespace: 'wp-admin-health/v1',\n\n\t\t/**\n\t\t * Build full API path\n\t\t *\n\t\t * @param {string} endpoint - API endpoint path\n\t\t * @return {string} Full API path\n\t\t */\n\t\tbuildPath(endpoint) {\n\t\t\t// Remove leading slash if present\n\t\t\tendpoint = endpoint.replace(/^\\//, '');\n\t\t\treturn `/${this.namespace}/${endpoint}`;\n\t\t},\n\n\t\t/**\n\t\t * Make GET request\n\t\t *\n\t\t * @param {string} endpoint - API endpoint\n\t\t * @param {Object} params   - Query parameters\n\t\t * @return {Promise} API response promise\n\t\t */\n\t\tget(endpoint, params = {}) {\n\t\t\treturn this.request(endpoint, {\n\t\t\t\tmethod: 'GET',\n\t\t\t\tparams,\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Make POST request\n\t\t *\n\t\t * @param {string} endpoint - API endpoint\n\t\t * @param {Object} data     - Request body data\n\t\t * @return {Promise} API response promise\n\t\t */\n\t\tpost(endpoint, data = {}) {\n\t\t\treturn this.request(endpoint, {\n\t\t\t\tmethod: 'POST',\n\t\t\t\tdata,\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Make PUT request\n\t\t *\n\t\t * @param {string} endpoint - API endpoint\n\t\t * @param {Object} data     - Request body data\n\t\t * @return {Promise} API response promise\n\t\t */\n\t\tput(endpoint, data = {}) {\n\t\t\treturn this.request(endpoint, {\n\t\t\t\tmethod: 'PUT',\n\t\t\t\tdata,\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Make DELETE request\n\t\t *\n\t\t * @param {string} endpoint - API endpoint\n\t\t * @param {Object} data     - Request body data\n\t\t * @return {Promise} API response promise\n\t\t */\n\t\tdelete(endpoint, data = {}) {\n\t\t\treturn this.request(endpoint, {\n\t\t\t\tmethod: 'DELETE',\n\t\t\t\tdata,\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Generic request method with retry logic\n\t\t *\n\t\t * @param {string} endpoint - API endpoint\n\t\t * @param {Object} options  - Request options\n\t\t * @param {number} retries  - Number of retries attempted\n\t\t * @return {Promise} API response promise\n\t\t */\n\t\trequest(endpoint, options = {}, retries = 0) {\n\t\t\tif (!apiFetch) {\n\t\t\t\treturn Promise.reject(\n\t\t\t\t\tnew Error(\n\t\t\t\t\t\t__(\n\t\t\t\t\t\t\t'wp.apiFetch is not available',\n\t\t\t\t\t\t\t'wp-admin-health-suite'\n\t\t\t\t\t\t)\n\t\t\t\t\t)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\tconst path = this.buildPath(endpoint);\n\t\t\tconst maxRetries = options.maxRetries || 2;\n\n\t\t\t// Merge with default options\n\t\t\tconst requestOptions = {\n\t\t\t\tpath,\n\t\t\t\tmethod: options.method || 'GET',\n\t\t\t\t...options,\n\t\t\t};\n\n\t\t\treturn apiFetch(requestOptions).catch((error) => {\n\t\t\t\t// Handle retry for network errors or 5xx errors\n\t\t\t\tif (retries < maxRetries && this.shouldRetry(error)) {\n\t\t\t\t\tconst delay = Math.pow(2, retries) * 1000; // Exponential backoff\n\t\t\t\t\treturn new Promise((resolve) => {\n\t\t\t\t\t\tsetTimeout(() => {\n\t\t\t\t\t\t\tresolve(\n\t\t\t\t\t\t\t\tthis.request(endpoint, options, retries + 1)\n\t\t\t\t\t\t\t);\n\t\t\t\t\t\t}, delay);\n\t\t\t\t\t});\n\t\t\t\t}\n\n\t\t\t\t// Transform error to user-friendly message\n\t\t\t\tconst errorMessage = ErrorHandler.getUserFriendlyMessage(error);\n\t\t\t\tthrow new Error(errorMessage);\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Check if error should trigger a retry\n\t\t *\n\t\t * @param {Error} error - Error object\n\t\t * @return {boolean} True if should retry\n\t\t */\n\t\tshouldRetry(error) {\n\t\t\t// Retry on network errors or server errors (5xx)\n\t\t\tif (!error.response) return true;\n\t\t\tconst status = error.response?.status || 0;\n\t\t\treturn status >= 500 && status < 600;\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// TOAST NOTIFICATION SYSTEM\n\t// ============================================================================\n\n\t/**\n\t * Toast notification system\n\t */\n\tconst Toast = {\n\t\t/**\n\t\t * Container element\n\t\t */\n\t\tcontainer: null,\n\n\t\t/**\n\t\t * Initialize toast container\n\t\t */\n\t\tinit() {\n\t\t\tif (this.container) return;\n\n\t\t\tthis.container = $('<div>', {\n\t\t\t\tclass: 'wpha-toast-container',\n\t\t\t\t'aria-live': 'polite',\n\t\t\t\t'aria-atomic': 'true',\n\t\t\t});\n\n\t\t\t$('body').append(this.container);\n\t\t},\n\n\t\t/**\n\t\t * Show toast notification\n\t\t *\n\t\t * @param {string} message  - Message to display\n\t\t * @param {string} type     - Type: success, error, warning, info\n\t\t * @param {number} duration - Duration in milliseconds (0 = no auto-dismiss)\n\t\t * @return {jQuery} Toast element\n\t\t */\n\t\tshow(message, type = 'info', duration = 5000) {\n\t\t\tthis.init();\n\n\t\t\tconst toast = $('<div>', {\n\t\t\t\tclass: `wpha-toast wpha-toast-${type}`,\n\t\t\t\trole: 'alert',\n\t\t\t});\n\n\t\t\tconst icon = this.getIcon(type);\n\t\t\tconst content = $('<div>', {\n\t\t\t\tclass: 'wpha-toast-content',\n\t\t\t\thtml: `<span class=\"wpha-toast-icon\">${icon}</span><span class=\"wpha-toast-message\">${message}</span>`,\n\t\t\t});\n\n\t\t\tconst closeBtn = $('<button>', {\n\t\t\t\tclass: 'wpha-toast-close',\n\t\t\t\ttype: 'button',\n\t\t\t\t'aria-label': __('Close', 'wp-admin-health-suite'),\n\t\t\t\thtml: '&times;',\n\t\t\t});\n\n\t\t\tcloseBtn.on('click', () => this.dismiss(toast));\n\n\t\t\ttoast.append(content, closeBtn);\n\t\t\tthis.container.append(toast);\n\n\t\t\t// Animate in\n\t\t\tsetTimeout(() => toast.addClass('wpha-toast-show'), 10);\n\n\t\t\t// Auto dismiss\n\t\t\tif (duration > 0) {\n\t\t\t\tsetTimeout(() => this.dismiss(toast), duration);\n\t\t\t}\n\n\t\t\treturn toast;\n\t\t},\n\n\t\t/**\n\t\t * Dismiss toast\n\t\t *\n\t\t * @param {jQuery} toast - Toast element to dismiss\n\t\t */\n\t\tdismiss(toast) {\n\t\t\ttoast.removeClass('wpha-toast-show');\n\t\t\tsetTimeout(() => toast.remove(), 300);\n\t\t},\n\n\t\t/**\n\t\t * Get icon for toast type\n\t\t *\n\t\t * @param {string} type - Toast type\n\t\t * @return {string} Icon HTML\n\t\t */\n\t\tgetIcon(type) {\n\t\t\tconst icons = {\n\t\t\t\tsuccess: '&#10004;',\n\t\t\t\terror: '&#10006;',\n\t\t\t\twarning: '&#9888;',\n\t\t\t\tinfo: '&#8505;',\n\t\t\t};\n\t\t\treturn icons[type] || icons.info;\n\t\t},\n\n\t\t/**\n\t\t * Convenience methods\n\t\t * @param message\n\t\t * @param duration\n\t\t */\n\t\tsuccess(message, duration = 5000) {\n\t\t\treturn this.show(message, 'success', duration);\n\t\t},\n\n\t\terror(message, duration = 7000) {\n\t\t\treturn this.show(message, 'error', duration);\n\t\t},\n\n\t\twarning(message, duration = 6000) {\n\t\t\treturn this.show(message, 'warning', duration);\n\t\t},\n\n\t\tinfo(message, duration = 5000) {\n\t\t\treturn this.show(message, 'info', duration);\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// CONFIRMATION MODAL\n\t// ============================================================================\n\n\t/**\n\t * Confirmation modal helper\n\t */\n\tconst Modal = {\n\t\t/**\n\t\t * Show confirmation modal\n\t\t *\n\t\t * @param {Object} options - Modal options\n\t\t * @return {Promise} Promise that resolves to true/false\n\t\t */\n\t\tconfirm(options = {}) {\n\t\t\tconst defaults = {\n\t\t\t\ttitle: __('Confirm', 'wp-admin-health-suite'),\n\t\t\t\tmessage: __('Are you sure?', 'wp-admin-health-suite'),\n\t\t\t\tconfirmText: __('Confirm', 'wp-admin-health-suite'),\n\t\t\t\tcancelText: __('Cancel', 'wp-admin-health-suite'),\n\t\t\t\tconfirmClass: 'button-primary',\n\t\t\t\tcancelClass: 'button-secondary',\n\t\t\t\tdanger: false,\n\t\t\t};\n\n\t\t\tconst settings = $.extend({}, defaults, options);\n\n\t\t\treturn new Promise((resolve) => {\n\t\t\t\tconst modal = this.createModal(settings, resolve);\n\t\t\t\t$('body').append(modal);\n\t\t\t\tsetTimeout(() => modal.addClass('wpha-modal-show'), 10);\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Create modal element\n\t\t *\n\t\t * @param {Object}   settings - Modal settings\n\t\t * @param {Function} resolve  - Promise resolve function\n\t\t * @return {jQuery} Modal element\n\t\t */\n\t\tcreateModal(settings, resolve) {\n\t\t\tconst overlay = $('<div>', {\n\t\t\t\tclass: 'wpha-modal-overlay',\n\t\t\t\trole: 'dialog',\n\t\t\t\t'aria-modal': 'true',\n\t\t\t\t'aria-labelledby': 'wpha-modal-title',\n\t\t\t});\n\n\t\t\tconst modal = $('<div>', {\n\t\t\t\tclass: 'wpha-modal',\n\t\t\t});\n\n\t\t\tconst header = $('<div>', {\n\t\t\t\tclass: 'wpha-modal-header',\n\t\t\t\thtml: `<h3 id=\"wpha-modal-title\">${settings.title}</h3>`,\n\t\t\t});\n\n\t\t\tconst body = $('<div>', {\n\t\t\t\tclass: 'wpha-modal-body',\n\t\t\t\thtml: `<p>${settings.message}</p>`,\n\t\t\t});\n\n\t\t\tconst footer = $('<div>', {\n\t\t\t\tclass: 'wpha-modal-footer',\n\t\t\t});\n\n\t\t\tconst confirmBtn = $('<button>', {\n\t\t\t\tclass: `button ${settings.confirmClass} ${settings.danger ? 'wpha-danger' : ''}`,\n\t\t\t\ttype: 'button',\n\t\t\t\ttext: settings.confirmText,\n\t\t\t});\n\n\t\t\tconst cancelBtn = $('<button>', {\n\t\t\t\tclass: `button ${settings.cancelClass}`,\n\t\t\t\ttype: 'button',\n\t\t\t\ttext: settings.cancelText,\n\t\t\t});\n\n\t\t\tconfirmBtn.on('click', () => {\n\t\t\t\tthis.closeModal(overlay);\n\t\t\t\tresolve(true);\n\t\t\t});\n\n\t\t\tcancelBtn.on('click', () => {\n\t\t\t\tthis.closeModal(overlay);\n\t\t\t\tresolve(false);\n\t\t\t});\n\n\t\t\t// Close on overlay click\n\t\t\toverlay.on('click', (e) => {\n\t\t\t\tif (e.target === overlay[0]) {\n\t\t\t\t\tthis.closeModal(overlay);\n\t\t\t\t\tresolve(false);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Close on ESC key\n\t\t\t$(document).on('keydown.wpha-modal', (e) => {\n\t\t\t\tif (e.key === 'Escape') {\n\t\t\t\t\tthis.closeModal(overlay);\n\t\t\t\t\tresolve(false);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\tfooter.append(cancelBtn, confirmBtn);\n\t\t\tmodal.append(header, body, footer);\n\t\t\toverlay.append(modal);\n\n\t\t\treturn overlay;\n\t\t},\n\n\t\t/**\n\t\t * Close modal\n\t\t *\n\t\t * @param {jQuery} overlay - Modal overlay element\n\t\t */\n\t\tcloseModal(overlay) {\n\t\t\toverlay.removeClass('wpha-modal-show');\n\t\t\t$(document).off('keydown.wpha-modal');\n\t\t\tsetTimeout(() => overlay.remove(), 300);\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// PROGRESS TRACKER\n\t// ============================================================================\n\n\t/**\n\t * Progress tracker for long-running operations\n\t */\n\tconst Progress = {\n\t\t/**\n\t\t * Active progress bars\n\t\t */\n\t\ttrackers: {},\n\n\t\t/**\n\t\t * Create progress tracker\n\t\t *\n\t\t * @param {string} id      - Unique tracker ID\n\t\t * @param {Object} options - Tracker options\n\t\t * @return {Object} Progress tracker instance\n\t\t */\n\t\tcreate(id, options = {}) {\n\t\t\tconst defaults = {\n\t\t\t\ttitle: __('Processing…', 'wp-admin-health-suite'),\n\t\t\t\tmessage: '',\n\t\t\t\tshowPercentage: true,\n\t\t\t\tcontainer: null,\n\t\t\t};\n\n\t\t\tconst settings = $.extend({}, defaults, options);\n\t\t\tconst tracker = this.buildTracker(id, settings);\n\n\t\t\tif (settings.container) {\n\t\t\t\t$(settings.container).append(tracker.element);\n\t\t\t} else {\n\t\t\t\t$('body').append(tracker.element);\n\t\t\t}\n\n\t\t\tthis.trackers[id] = tracker;\n\t\t\treturn tracker;\n\t\t},\n\n\t\t/**\n\t\t * Build tracker element\n\t\t *\n\t\t * @param {string} id       - Tracker ID\n\t\t * @param {Object} settings - Tracker settings\n\t\t * @return {Object} Tracker object\n\t\t */\n\t\tbuildTracker(id, settings) {\n\t\t\tconst element = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-tracker',\n\t\t\t\tid: `wpha-progress-${id}`,\n\t\t\t\trole: 'progressbar',\n\t\t\t\t'aria-valuenow': '0',\n\t\t\t\t'aria-valuemin': '0',\n\t\t\t\t'aria-valuemax': '100',\n\t\t\t});\n\n\t\t\tconst title = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-title',\n\t\t\t\ttext: settings.title,\n\t\t\t});\n\n\t\t\tconst message = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-message',\n\t\t\t\ttext: settings.message,\n\t\t\t});\n\n\t\t\tconst barContainer = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-bar-container',\n\t\t\t});\n\n\t\t\tconst bar = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-bar',\n\t\t\t\tstyle: 'width: 0%',\n\t\t\t});\n\n\t\t\tconst percentage = $('<div>', {\n\t\t\t\tclass: 'wpha-progress-percentage',\n\t\t\t\ttext: '0%',\n\t\t\t});\n\n\t\t\tbarContainer.append(bar);\n\t\t\telement.append(title, message, barContainer);\n\n\t\t\tif (settings.showPercentage) {\n\t\t\t\telement.append(percentage);\n\t\t\t}\n\n\t\t\treturn {\n\t\t\t\telement,\n\t\t\t\tbar,\n\t\t\t\tmessage,\n\t\t\t\tpercentage,\n\t\t\t\tsettings,\n\t\t\t\tupdate: (progress, msg) => this.update(id, progress, msg),\n\t\t\t\tcomplete: (msg) => this.complete(id, msg),\n\t\t\t\terror: (msg) => this.error(id, msg),\n\t\t\t\tremove: () => this.remove(id),\n\t\t\t};\n\t\t},\n\n\t\t/**\n\t\t * Update progress\n\t\t *\n\t\t * @param {string} id       - Tracker ID\n\t\t * @param {number} progress - Progress percentage (0-100)\n\t\t * @param {string} message  - Optional message\n\t\t */\n\t\tupdate(id, progress, message) {\n\t\t\tconst tracker = this.trackers[id];\n\t\t\tif (!tracker) return;\n\n\t\t\tprogress = Math.max(0, Math.min(100, progress));\n\n\t\t\ttracker.bar.css('width', `${progress}%`);\n\t\t\ttracker.element.attr('aria-valuenow', progress);\n\n\t\t\tif (tracker.settings.showPercentage) {\n\t\t\t\ttracker.percentage.text(`${Math.round(progress)}%`);\n\t\t\t}\n\n\t\t\tif (message) {\n\t\t\t\ttracker.message.text(message);\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Mark progress as complete\n\t\t *\n\t\t * @param {string} id      - Tracker ID\n\t\t * @param {string} message - Completion message\n\t\t */\n\t\tcomplete(id, message) {\n\t\t\tconst tracker = this.trackers[id];\n\t\t\tif (!tracker) return;\n\n\t\t\tthis.update(\n\t\t\t\tid,\n\t\t\t\t100,\n\t\t\t\tmessage || __('Complete!', 'wp-admin-health-suite')\n\t\t\t);\n\t\t\ttracker.element.addClass('wpha-progress-complete');\n\n\t\t\tsetTimeout(() => this.remove(id), 2000);\n\t\t},\n\n\t\t/**\n\t\t * Mark progress as error\n\t\t *\n\t\t * @param {string} id      - Tracker ID\n\t\t * @param {string} message - Error message\n\t\t */\n\t\terror(id, message) {\n\t\t\tconst tracker = this.trackers[id];\n\t\t\tif (!tracker) return;\n\n\t\t\ttracker.element.addClass('wpha-progress-error');\n\t\t\ttracker.message.text(\n\t\t\t\tmessage || __('An error occurred', 'wp-admin-health-suite')\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Remove progress tracker\n\t\t *\n\t\t * @param {string} id - Tracker ID\n\t\t */\n\t\tremove(id) {\n\t\t\tconst tracker = this.trackers[id];\n\t\t\tif (!tracker) return;\n\n\t\t\ttracker.element.fadeOut(300, function () {\n\t\t\t\t$(this).remove();\n\t\t\t});\n\n\t\t\tdelete this.trackers[id];\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// LOCAL STORAGE HELPERS\n\t// ============================================================================\n\n\t/**\n\t * Local storage wrapper with namespacing and error handling\n\t */\n\tconst Storage = {\n\t\t/**\n\t\t * Namespace prefix for storage keys\n\t\t */\n\t\tprefix: 'wpha_',\n\n\t\t/**\n\t\t * Build namespaced key\n\t\t *\n\t\t * @param {string} key - Storage key\n\t\t * @return {string} Namespaced key\n\t\t */\n\t\tbuildKey(key) {\n\t\t\treturn this.prefix + key;\n\t\t},\n\n\t\t/**\n\t\t * Check if localStorage is available\n\t\t *\n\t\t * @return {boolean} True if available\n\t\t */\n\t\tisAvailable() {\n\t\t\ttry {\n\t\t\t\tconst test = '__storage_test__';\n\t\t\t\tlocalStorage.setItem(test, test);\n\t\t\t\tlocalStorage.removeItem(test);\n\t\t\t\treturn true;\n\t\t\t} catch (e) {\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Get item from storage\n\t\t *\n\t\t * @param {string} key          - Storage key\n\t\t * @param {*}      defaultValue - Default value if not found\n\t\t * @return {*} Stored value or default\n\t\t */\n\t\tget(key, defaultValue = null) {\n\t\t\tif (!this.isAvailable()) return defaultValue;\n\n\t\t\ttry {\n\t\t\t\tconst item = localStorage.getItem(this.buildKey(key));\n\t\t\t\treturn item !== null ? JSON.parse(item) : defaultValue;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('Storage.get error:', e);\n\t\t\t\treturn defaultValue;\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Set item in storage\n\t\t *\n\t\t * @param {string} key   - Storage key\n\t\t * @param {*}      value - Value to store\n\t\t * @return {boolean} True if successful\n\t\t */\n\t\tset(key, value) {\n\t\t\tif (!this.isAvailable()) return false;\n\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem(this.buildKey(key), JSON.stringify(value));\n\t\t\t\treturn true;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('Storage.set error:', e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Remove item from storage\n\t\t *\n\t\t * @param {string} key - Storage key\n\t\t * @return {boolean} True if successful\n\t\t */\n\t\tremove(key) {\n\t\t\tif (!this.isAvailable()) return false;\n\n\t\t\ttry {\n\t\t\t\tlocalStorage.removeItem(this.buildKey(key));\n\t\t\t\treturn true;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('Storage.remove error:', e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Clear all namespaced items\n\t\t *\n\t\t * @return {boolean} True if successful\n\t\t */\n\t\tclear() {\n\t\t\tif (!this.isAvailable()) return false;\n\n\t\t\ttry {\n\t\t\t\tconst keys = Object.keys(localStorage);\n\t\t\t\tkeys.forEach((key) => {\n\t\t\t\t\tif (key.startsWith(this.prefix)) {\n\t\t\t\t\t\tlocalStorage.removeItem(key);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn true;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('Storage.clear error:', e);\n\t\t\t\treturn false;\n\t\t\t}\n\t\t},\n\n\t\t/**\n\t\t * Get all namespaced items\n\t\t *\n\t\t * @return {Object} All stored items\n\t\t */\n\t\tgetAll() {\n\t\t\tif (!this.isAvailable()) return {};\n\n\t\t\ttry {\n\t\t\t\tconst items = {};\n\t\t\t\tconst keys = Object.keys(localStorage);\n\t\t\t\tkeys.forEach((key) => {\n\t\t\t\t\tif (key.startsWith(this.prefix)) {\n\t\t\t\t\t\tconst shortKey = key.substring(this.prefix.length);\n\t\t\t\t\t\titems[shortKey] = this.get(shortKey);\n\t\t\t\t\t}\n\t\t\t\t});\n\t\t\t\treturn items;\n\t\t\t} catch (e) {\n\t\t\t\tconsole.error('Storage.getAll error:', e);\n\t\t\t\treturn {};\n\t\t\t}\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// EVENT SYSTEM\n\t// ============================================================================\n\n\t/**\n\t * Custom event system for plugin communication\n\t */\n\tconst Events = {\n\t\t/**\n\t\t * Event listeners registry\n\t\t */\n\t\tlisteners: {},\n\n\t\t/**\n\t\t * Register event listener\n\t\t *\n\t\t * @param {string}   eventName - Event name\n\t\t * @param {Function} callback  - Callback function\n\t\t * @return {Function} Unsubscribe function\n\t\t */\n\t\ton(eventName, callback) {\n\t\t\tif (!this.listeners[eventName]) {\n\t\t\t\tthis.listeners[eventName] = [];\n\t\t\t}\n\n\t\t\tthis.listeners[eventName].push(callback);\n\n\t\t\t// Return unsubscribe function\n\t\t\treturn () => this.off(eventName, callback);\n\t\t},\n\n\t\t/**\n\t\t * Remove event listener\n\t\t *\n\t\t * @param {string}   eventName - Event name\n\t\t * @param {Function} callback  - Callback function\n\t\t */\n\t\toff(eventName, callback) {\n\t\t\tif (!this.listeners[eventName]) return;\n\n\t\t\tthis.listeners[eventName] = this.listeners[eventName].filter(\n\t\t\t\t(cb) => cb !== callback\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Trigger event\n\t\t *\n\t\t * @param {string} eventName - Event name\n\t\t * @param {*}      data      - Event data\n\t\t */\n\t\ttrigger(eventName, data = {}) {\n\t\t\tif (!this.listeners[eventName]) return;\n\n\t\t\tthis.listeners[eventName].forEach((callback) => {\n\t\t\t\ttry {\n\t\t\t\t\tcallback(data);\n\t\t\t\t} catch (e) {\n\t\t\t\t\tconsole.error(\n\t\t\t\t\t\t`Error in event listener for ${eventName}:`,\n\t\t\t\t\t\te\n\t\t\t\t\t);\n\t\t\t\t}\n\t\t\t});\n\n\t\t\t// Also trigger native custom event\n\t\t\tconst event = new CustomEvent(`wpha:${eventName}`, {\n\t\t\t\tdetail: data,\n\t\t\t\tbubbles: true,\n\t\t\t});\n\t\t\tdocument.dispatchEvent(event);\n\t\t},\n\n\t\t/**\n\t\t * One-time event listener\n\t\t *\n\t\t * @param {string}   eventName - Event name\n\t\t * @param {Function} callback  - Callback function\n\t\t */\n\t\tonce(eventName, callback) {\n\t\t\tconst wrapper = (data) => {\n\t\t\t\tcallback(data);\n\t\t\t\tthis.off(eventName, wrapper);\n\t\t\t};\n\n\t\t\tthis.on(eventName, wrapper);\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// ERROR HANDLER\n\t// ============================================================================\n\n\t/**\n\t * Global error handling and user-friendly messages\n\t */\n\tconst ErrorHandler = {\n\t\t/**\n\t\t * Error message mappings\n\t\t */\n\t\tmessages: {\n\t\t\tnetwork_error: __(\n\t\t\t\t'Network error. Please check your connection and try again.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t\tserver_error: __(\n\t\t\t\t'Server error. Please try again later.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t\tpermission_error: __(\n\t\t\t\t'You do not have permission to perform this action.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t\tvalidation_error: __(\n\t\t\t\t'Please check your input and try again.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t\ttimeout_error: __(\n\t\t\t\t'Request timed out. Please try again.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t\tunknown_error: __(\n\t\t\t\t'An unexpected error occurred. Please try again.',\n\t\t\t\t'wp-admin-health-suite'\n\t\t\t),\n\t\t},\n\n\t\t/**\n\t\t * Get user-friendly error message\n\t\t *\n\t\t * @param {Error|Object} error - Error object\n\t\t * @return {string} User-friendly message\n\t\t */\n\t\tgetUserFriendlyMessage(error) {\n\t\t\t// Handle string errors\n\t\t\tif (typeof error === 'string') {\n\t\t\t\treturn error;\n\t\t\t}\n\n\t\t\t// Handle API error responses\n\t\t\tif (error.response) {\n\t\t\t\tconst status = error.response.status;\n\n\t\t\t\tif (status === 403 || status === 401) {\n\t\t\t\t\treturn this.messages.permission_error;\n\t\t\t\t}\n\n\t\t\t\tif (status >= 400 && status < 500) {\n\t\t\t\t\treturn (\n\t\t\t\t\t\terror.response.message || this.messages.validation_error\n\t\t\t\t\t);\n\t\t\t\t}\n\n\t\t\t\tif (status >= 500) {\n\t\t\t\t\treturn this.messages.server_error;\n\t\t\t\t}\n\t\t\t}\n\n\t\t\t// Handle network errors\n\t\t\tif (error.message && error.message.includes('NetworkError')) {\n\t\t\t\treturn this.messages.network_error;\n\t\t\t}\n\n\t\t\t// Handle timeout errors\n\t\t\tif (error.message && error.message.includes('timeout')) {\n\t\t\t\treturn this.messages.timeout_error;\n\t\t\t}\n\n\t\t\t// Return error message or default\n\t\t\treturn error.message || this.messages.unknown_error;\n\t\t},\n\n\t\t/**\n\t\t * Handle error globally\n\t\t *\n\t\t * @param {Error}  error   - Error object\n\t\t * @param {Object} options - Handler options\n\t\t */\n\t\thandle(error, options = {}) {\n\t\t\tconst defaults = {\n\t\t\t\tshowToast: true,\n\t\t\t\tlogToConsole: true,\n\t\t\t\ttriggerEvent: true,\n\t\t\t};\n\n\t\t\tconst settings = $.extend({}, defaults, options);\n\t\t\tconst message = this.getUserFriendlyMessage(error);\n\n\t\t\tif (settings.logToConsole) {\n\t\t\t\tconsole.error('WPAdminHealth Error:', error);\n\t\t\t}\n\n\t\t\tif (settings.showToast) {\n\t\t\t\tToast.error(message);\n\t\t\t}\n\n\t\t\tif (settings.triggerEvent) {\n\t\t\t\tEvents.trigger('error', { error, message });\n\t\t\t}\n\n\t\t\treturn message;\n\t\t},\n\t};\n\n\t// ============================================================================\n\t// PUBLIC API\n\t// ============================================================================\n\n\t// Expose public API\n\t$.extend(window.WPAdminHealth, {\n\t\tAPI,\n\t\tToast,\n\t\tModal,\n\t\tProgress,\n\t\tStorage,\n\t\tEvents,\n\t\tErrorHandler,\n\n\t\t// Utility methods\n\t\tutils: {\n\t\t\t/**\n\t\t\t * Debounce function\n\t\t\t *\n\t\t\t * @param {Function} func - Function to debounce\n\t\t\t * @param {number}   wait - Wait time in milliseconds\n\t\t\t * @return {Function} Debounced function\n\t\t\t */\n\t\t\tdebounce(func, wait) {\n\t\t\t\tlet timeout;\n\t\t\t\treturn function (...args) {\n\t\t\t\t\tclearTimeout(timeout);\n\t\t\t\t\ttimeout = setTimeout(() => func.apply(this, args), wait);\n\t\t\t\t};\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Throttle function\n\t\t\t *\n\t\t\t * @param {Function} func  - Function to throttle\n\t\t\t * @param {number}   limit - Time limit in milliseconds\n\t\t\t * @return {Function} Throttled function\n\t\t\t */\n\t\t\tthrottle(func, limit) {\n\t\t\t\tlet inThrottle;\n\t\t\t\treturn function (...args) {\n\t\t\t\t\tif (!inThrottle) {\n\t\t\t\t\t\tfunc.apply(this, args);\n\t\t\t\t\t\tinThrottle = true;\n\t\t\t\t\t\tsetTimeout(() => (inThrottle = false), limit);\n\t\t\t\t\t}\n\t\t\t\t};\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Format bytes to human-readable string\n\t\t\t *\n\t\t\t * @param {number} bytes    - Bytes value\n\t\t\t * @param {number} decimals - Decimal places\n\t\t\t * @return {string} Formatted string\n\t\t\t */\n\t\t\tformatBytes(bytes, decimals = 2) {\n\t\t\t\tif (bytes === 0) return '0 Bytes';\n\n\t\t\t\tconst k = 1024;\n\t\t\t\tconst dm = decimals < 0 ? 0 : decimals;\n\t\t\t\tconst sizes = ['Bytes', 'KB', 'MB', 'GB', 'TB'];\n\t\t\t\tconst i = Math.floor(Math.log(bytes) / Math.log(k));\n\n\t\t\t\treturn (\n\t\t\t\t\tparseFloat((bytes / Math.pow(k, i)).toFixed(dm)) +\n\t\t\t\t\t' ' +\n\t\t\t\t\tsizes[i]\n\t\t\t\t);\n\t\t\t},\n\n\t\t\t/**\n\t\t\t * Format number with separators\n\t\t\t *\n\t\t\t * @param {number} num - Number to format\n\t\t\t * @return {string} Formatted number\n\t\t\t */\n\t\t\tformatNumber(num) {\n\t\t\t\treturn num.toString().replace(/\\B(?=(\\d{3})+(?!\\d))/g, ',');\n\t\t\t},\n\t\t},\n\t});\n\n\t// ============================================================================\n\t// INITIALIZATION\n\t// ============================================================================\n\n\t$(document).ready(function () {\n\t\t// Initialize toast system\n\t\tToast.init();\n\n\t\t// Set up global error boundary\n\t\twindow.addEventListener('error', function (event) {\n\t\t\tErrorHandler.handle(event.error, { showToast: false });\n\t\t});\n\n\t\t// Set up unhandled promise rejection handler\n\t\twindow.addEventListener('unhandledrejection', function (event) {\n\t\t\tErrorHandler.handle(event.reason, { showToast: false });\n\t\t});\n\n\t\t// Log initialization\n\t\tif (typeof wpAdminHealthData !== 'undefined') {\n\t\t\tconsole.log('WP Admin Health Suite initialized');\n\t\t\tEvents.trigger('ready', { version: wpAdminHealthData.version });\n\t\t}\n\t});\n})(window, jQuery);\n","'use strict';\n\nvar m = require('react-dom');\nif (process.env.NODE_ENV === 'production') {\n  exports.createRoot = m.createRoot;\n  exports.hydrateRoot = m.hydrateRoot;\n} else {\n  var i = m.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED;\n  exports.createRoot = function(c, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.createRoot(c, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n  exports.hydrateRoot = function(c, h, o) {\n    i.usingClientEntryPoint = true;\n    try {\n      return m.hydrateRoot(c, h, o);\n    } finally {\n      i.usingClientEntryPoint = false;\n    }\n  };\n}\n","module.exports = window[\"React\"];","module.exports = window[\"ReactDOM\"];","'use strict';\n\nif (process.env.NODE_ENV === 'production') {\n  module.exports = require('./cjs/react-jsx-runtime.production.min.js');\n} else {\n  module.exports = require('./cjs/react-jsx-runtime.development.js');\n}\n","/**\n * Media Audit JavaScript\n *\n * Handles media audit scanning, filtering, sorting, and bulk operations.\n *\n * @param $\n * @package\n */\n\n(function ($) {\n\t'use strict';\n\n\tconst MediaAudit = {\n\t\t/**\n\t\t * Current tab.\n\t\t */\n\t\tcurrentTab: 'unused',\n\n\t\t/**\n\t\t * Items per page.\n\t\t */\n\t\titemsPerPage: 50,\n\n\t\t/**\n\t\t * Current page for each tab.\n\t\t */\n\t\tcurrentPages: {\n\t\t\tunused: 1,\n\t\t\tduplicates: 1,\n\t\t\t'large-files': 1,\n\t\t\t'missing-alt': 1,\n\t\t},\n\n\t\t/**\n\t\t * Data cache for each tab.\n\t\t */\n\t\tdataCache: {\n\t\t\tstats: null,\n\t\t\tunused: [],\n\t\t\tduplicates: [],\n\t\t\t'large-files': [],\n\t\t\t'missing-alt': [],\n\t\t},\n\n\t\t/**\n\t\t * Current sort for each tab.\n\t\t */\n\t\tcurrentSort: {\n\t\t\tunused: { field: 'date', order: 'desc' },\n\t\t\tduplicates: { field: 'size', order: 'desc' },\n\t\t\t'large-files': { field: 'size', order: 'desc' },\n\t\t\t'missing-alt': { field: 'date', order: 'desc' },\n\t\t},\n\n\t\t/**\n\t\t * Current filters for each tab.\n\t\t */\n\t\tcurrentFilters: {\n\t\t\tunused: { search: '', type: '' },\n\t\t\tduplicates: { search: '' },\n\t\t\t'large-files': { search: '', size: '' },\n\t\t\t'missing-alt': { search: '' },\n\t\t},\n\n\t\t/**\n\t\t * Selected items for each tab.\n\t\t */\n\t\tselectedItems: {\n\t\t\tunused: new Set(),\n\t\t\tduplicates: new Set(),\n\t\t\t'large-files': new Set(),\n\t\t\t'missing-alt': new Set(),\n\t\t},\n\n\t\t/**\n\t\t * Initialize the media audit module.\n\t\t */\n\t\tinit() {\n\t\t\tthis.cacheDom();\n\t\t\tthis.bindEvents();\n\t\t\tthis.loadStats();\n\t\t\tthis.loadTabData(this.currentTab);\n\t\t},\n\n\t\t/**\n\t\t * Cache DOM elements.\n\t\t */\n\t\tcacheDom() {\n\t\t\tthis.$scanBanner = $('.wpha-scan-status-banner');\n\t\t\tthis.$rescanBtn = $('.wpha-rescan-btn');\n\t\t\tthis.$statsCards = $('.wpha-stats-overview');\n\t\t\tthis.$tabBtns = $('.wpha-tab-btn');\n\t\t\tthis.$tabPanels = $('.wpha-tab-panel');\n\t\t},\n\n\t\t/**\n\t\t * Bind events.\n\t\t */\n\t\tbindEvents() {\n\t\t\t// Tab switching\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-tab-btn',\n\t\t\t\tthis.handleTabSwitch.bind(this)\n\t\t\t);\n\n\t\t\t// Rescan button\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-rescan-btn',\n\t\t\t\tthis.handleRescan.bind(this)\n\t\t\t);\n\n\t\t\t// Sorting\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-sortable',\n\t\t\t\tthis.handleSort.bind(this)\n\t\t\t);\n\n\t\t\t// Filtering\n\t\t\t$(document).on(\n\t\t\t\t'input',\n\t\t\t\t'.wpha-search-input',\n\t\t\t\tthis.handleSearchFilter.bind(this)\n\t\t\t);\n\t\t\t$(document).on(\n\t\t\t\t'change',\n\t\t\t\t'.wpha-filter-select',\n\t\t\t\tthis.handleTypeFilter.bind(this)\n\t\t\t);\n\t\t\t$(document).on(\n\t\t\t\t'change',\n\t\t\t\t'.wpha-size-filter-select',\n\t\t\t\tthis.handleSizeFilter.bind(this)\n\t\t\t);\n\n\t\t\t// Checkbox selection\n\t\t\t$(document).on(\n\t\t\t\t'change',\n\t\t\t\t'.wpha-select-all',\n\t\t\t\tthis.handleSelectAll.bind(this)\n\t\t\t);\n\t\t\t$(document).on(\n\t\t\t\t'change',\n\t\t\t\t'.wpha-item-checkbox',\n\t\t\t\tthis.handleItemSelect.bind(this)\n\t\t\t);\n\n\t\t\t// Bulk actions\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-bulk-apply-btn',\n\t\t\t\tthis.handleBulkAction.bind(this)\n\t\t\t);\n\n\t\t\t// Individual actions\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-delete-btn',\n\t\t\t\tthis.handleDelete.bind(this)\n\t\t\t);\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-ignore-btn',\n\t\t\t\tthis.handleIgnore.bind(this)\n\t\t\t);\n\n\t\t\t// Pagination\n\t\t\t$(document).on(\n\t\t\t\t'click',\n\t\t\t\t'.wpha-page-btn',\n\t\t\t\tthis.handlePageChange.bind(this)\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Load statistics.\n\t\t */\n\t\tloadStats() {\n\t\t\twp.apiFetch({\n\t\t\t\tpath: '/wpha/v1/media/stats',\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (response.success && response.data) {\n\t\t\t\t\t\tthis.dataCache.stats = response.data;\n\t\t\t\t\t\tthis.renderStats(response.data);\n\t\t\t\t\t\tthis.renderScanStatus(response.data);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error('Error loading stats:', error);\n\t\t\t\t\tthis.hideSkeletons(this.$statsCards);\n\t\t\t\t\tthis.hideSkeletons(this.$scanBanner);\n\t\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Render statistics cards.\n\t\t * @param data\n\t\t */\n\t\trenderStats(data) {\n\t\t\tconst stats = [\n\t\t\t\t{ value: data.total_count || 0, selector: 0 },\n\t\t\t\t{ value: data.unused_count || 0, selector: 1 },\n\t\t\t\t{ value: data.duplicate_count || 0, selector: 2 },\n\t\t\t\t{\n\t\t\t\t\tvalue: this.formatBytes(data.potential_savings?.bytes || 0),\n\t\t\t\t\tselector: 3,\n\t\t\t\t},\n\t\t\t];\n\n\t\t\tstats.forEach((stat) => {\n\t\t\t\tconst $card = this.$statsCards\n\t\t\t\t\t.find('.wpha-stat-card')\n\t\t\t\t\t.eq(stat.selector);\n\t\t\t\t$card.find('.wpha-stat-value').text(stat.value);\n\t\t\t\t$card.find('.wpha-stat-card-skeleton').hide();\n\t\t\t\t$card.find('.wpha-stat-card-content').show();\n\t\t\t});\n\n\t\t\t// Update tab badges\n\t\t\t$('.wpha-tab-btn[data-tab=\"unused\"] .wpha-tab-badge').text(\n\t\t\t\tdata.unused_count || 0\n\t\t\t);\n\t\t\t$('.wpha-tab-btn[data-tab=\"duplicates\"] .wpha-tab-badge').text(\n\t\t\t\tdata.duplicate_count || 0\n\t\t\t);\n\t\t\t$('.wpha-tab-btn[data-tab=\"large-files\"] .wpha-tab-badge').text(\n\t\t\t\tdata.large_files_count || 0\n\t\t\t);\n\t\t\t$('.wpha-tab-btn[data-tab=\"missing-alt\"] .wpha-tab-badge').text(\n\t\t\t\tdata.missing_alt_count || 0\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Render scan status banner.\n\t\t * @param data\n\t\t */\n\t\trenderScanStatus(data) {\n\t\t\tconst lastScan = data.last_scan\n\t\t\t\t? this.formatDate(data.last_scan)\n\t\t\t\t: wpAdminHealthData.i18n.no_data || 'Never';\n\n\t\t\tthis.$scanBanner.find('.wpha-scan-status-value').text(lastScan);\n\t\t\tthis.$scanBanner.find('.wpha-scan-status-banner-skeleton').hide();\n\t\t\tthis.$scanBanner.find('.wpha-scan-status-content').show();\n\t\t\tthis.$rescanBtn.prop('disabled', false);\n\t\t},\n\n\t\t/**\n\t\t * Handle tab switch.\n\t\t * @param e\n\t\t */\n\t\thandleTabSwitch(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $btn = $(e.currentTarget);\n\t\t\tconst tab = $btn.data('tab');\n\n\t\t\tif (tab === this.currentTab) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t// Update active states\n\t\t\tthis.$tabBtns.removeClass('wpha-tab-active');\n\t\t\t$btn.addClass('wpha-tab-active');\n\n\t\t\tthis.$tabPanels.removeClass('wpha-tab-active');\n\t\t\t$(`.wpha-tab-panel[data-tab=\"${tab}\"]`).addClass('wpha-tab-active');\n\n\t\t\tthis.currentTab = tab;\n\t\t\tthis.loadTabData(tab);\n\t\t},\n\n\t\t/**\n\t\t * Load data for specific tab.\n\t\t * @param tab\n\t\t */\n\t\tloadTabData(tab) {\n\t\t\t// If data is cached, just render it\n\t\t\tif (this.dataCache[tab].length > 0) {\n\t\t\t\tthis.renderTabData(tab);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet apiPath = '';\n\t\t\tswitch (tab) {\n\t\t\t\tcase 'unused':\n\t\t\t\t\tapiPath = '/wpha/v1/media/unused';\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'duplicates':\n\t\t\t\t\tapiPath = '/wpha/v1/media/duplicates';\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'large-files':\n\t\t\t\t\tapiPath = '/wpha/v1/media/large-files';\n\t\t\t\t\tbreak;\n\t\t\t\tcase 'missing-alt':\n\t\t\t\t\tapiPath = '/wpha/v1/media/missing-alt';\n\t\t\t\t\tbreak;\n\t\t\t}\n\n\t\t\tconst $panel = $(`.wpha-tab-panel[data-tab=\"${tab}\"]`);\n\t\t\tconst $skeleton = $panel.find('.wpha-tab-panel-skeleton');\n\n\t\t\t$skeleton.show();\n\n\t\t\twp.apiFetch({\n\t\t\t\tpath: apiPath,\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (response.success && response.data) {\n\t\t\t\t\t\tthis.dataCache[tab] = response.data;\n\t\t\t\t\t\tthis.renderTabData(tab);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error(`Error loading ${tab} data:`, error);\n\t\t\t\t\t$skeleton.hide();\n\t\t\t\t\tthis.showEmptyState($panel);\n\t\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Render data for specific tab.\n\t\t * @param tab\n\t\t */\n\t\trenderTabData(tab) {\n\t\t\tconst $panel = $(`.wpha-tab-panel[data-tab=\"${tab}\"]`);\n\t\t\tconst $skeleton = $panel.find('.wpha-tab-panel-skeleton');\n\n\t\t\t$skeleton.hide();\n\n\t\t\t// Apply filters and sorting\n\t\t\tlet data = this.filterData(tab, this.dataCache[tab]);\n\t\t\tdata = this.sortData(tab, data);\n\n\t\t\t// Render based on tab type\n\t\t\tif (tab === 'duplicates') {\n\t\t\t\tthis.renderDuplicates($panel, data);\n\t\t\t} else {\n\t\t\t\tthis.renderTable($panel, tab, data);\n\t\t\t}\n\n\t\t\tthis.renderPagination($panel, tab, data.length);\n\t\t\tthis.updateBulkActions($panel, tab);\n\t\t},\n\n\t\t/**\n\t\t * Filter data based on current filters.\n\t\t * @param tab\n\t\t * @param data\n\t\t */\n\t\tfilterData(tab, data) {\n\t\t\tconst filters = this.currentFilters[tab];\n\t\t\tlet filtered = [...data];\n\n\t\t\t// Search filter\n\t\t\tif (filters.search) {\n\t\t\t\tconst search = filters.search.toLowerCase();\n\t\t\t\tfiltered = filtered.filter(\n\t\t\t\t\t(item) =>\n\t\t\t\t\t\t(item.filename || '').toLowerCase().includes(search) ||\n\t\t\t\t\t\t(item.title || '').toLowerCase().includes(search)\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Type filter (for unused tab)\n\t\t\tif (filters.type) {\n\t\t\t\tfiltered = filtered.filter(\n\t\t\t\t\t(item) => item.type === filters.type\n\t\t\t\t);\n\t\t\t}\n\n\t\t\t// Size filter (for large files tab)\n\t\t\tif (filters.size) {\n\t\t\t\tconst sizeBytes = {\n\t\t\t\t\t'1mb': 1024 * 1024,\n\t\t\t\t\t'5mb': 5 * 1024 * 1024,\n\t\t\t\t\t'10mb': 10 * 1024 * 1024,\n\t\t\t\t};\n\t\t\t\tconst minSize = sizeBytes[filters.size] || 0;\n\t\t\t\tfiltered = filtered.filter((item) => item.size > minSize);\n\t\t\t}\n\n\t\t\treturn filtered;\n\t\t},\n\n\t\t/**\n\t\t * Sort data based on current sort.\n\t\t * @param tab\n\t\t * @param data\n\t\t */\n\t\tsortData(tab, data) {\n\t\t\tconst sort = this.currentSort[tab];\n\t\t\tconst sorted = [...data];\n\n\t\t\tsorted.sort((a, b) => {\n\t\t\t\tlet aVal = a[sort.field];\n\t\t\t\tlet bVal = b[sort.field];\n\n\t\t\t\t// Handle different data types\n\t\t\t\tif (typeof aVal === 'string') {\n\t\t\t\t\taVal = aVal.toLowerCase();\n\t\t\t\t\tbVal = bVal.toLowerCase();\n\t\t\t\t}\n\n\t\t\t\tif (sort.order === 'asc') {\n\t\t\t\t\treturn aVal > bVal ? 1 : -1;\n\t\t\t\t}\n\t\t\t\treturn aVal < bVal ? 1 : -1;\n\t\t\t});\n\n\t\t\treturn sorted;\n\t\t},\n\n\t\t/**\n\t\t * Render table for tab.\n\t\t * @param $panel\n\t\t * @param tab\n\t\t * @param data\n\t\t */\n\t\trenderTable($panel, tab, data) {\n\t\t\tconst $tbody = $panel.find('.wpha-media-table tbody');\n\t\t\tconst page = this.currentPages[tab];\n\t\t\tconst start = (page - 1) * this.itemsPerPage;\n\t\t\tconst end = start + this.itemsPerPage;\n\t\t\tconst pageData = data.slice(start, end);\n\n\t\t\tif (pageData.length === 0) {\n\t\t\t\t$tbody.html(\n\t\t\t\t\t'<tr><td colspan=\"6\" class=\"wpha-empty-state\">' +\n\t\t\t\t\t\t(wpAdminHealthData.i18n.no_data || 'No items found.') +\n\t\t\t\t\t\t'</td></tr>'\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst html = pageData\n\t\t\t\t.map((item) => this.renderTableRow(tab, item))\n\t\t\t\t.join('');\n\t\t\t$tbody.html(html);\n\n\t\t\t// Lazy load images\n\t\t\tthis.lazyLoadPreviews($tbody);\n\t\t},\n\n\t\t/**\n\t\t * Render table row.\n\t\t * @param tab\n\t\t * @param item\n\t\t */\n\t\trenderTableRow(tab, item) {\n\t\t\tconst isChecked = this.selectedItems[tab].has(item.id);\n\t\t\tconst previewUrl =\n\t\t\t\titem.thumbnail || item.thumbnail_url || item.url || '';\n\t\t\tconst mimeType = item.mime_type || '';\n\t\t\tconst isImage =\n\t\t\t\titem.type === 'image' || mimeType.startsWith('image/');\n\n\t\t\tlet html = '<tr data-id=\"' + item.id + '\">';\n\t\t\thtml += '<td class=\"wpha-col-checkbox\">';\n\t\t\thtml +=\n\t\t\t\t'<input type=\"checkbox\" class=\"wpha-item-checkbox\" data-id=\"' +\n\t\t\t\titem.id +\n\t\t\t\t'\" ' +\n\t\t\t\t(isChecked ? 'checked' : '') +\n\t\t\t\t' />';\n\t\t\thtml += '</td>';\n\n\t\t\thtml += '<td class=\"wpha-col-preview\">';\n\t\t\tif (isImage && previewUrl) {\n\t\t\t\thtml +=\n\t\t\t\t\t'<img class=\"wpha-lazy-preview\" data-src=\"' +\n\t\t\t\t\tpreviewUrl +\n\t\t\t\t\t'\" alt=\"\" width=\"50\" height=\"50\" />';\n\t\t\t} else {\n\t\t\t\thtml +=\n\t\t\t\t\t'<span class=\"dashicons dashicons-media-default\"></span>';\n\t\t\t}\n\t\t\thtml += '</td>';\n\n\t\t\thtml += '<td class=\"wpha-col-filename\">';\n\t\t\thtml +=\n\t\t\t\t'<strong>' +\n\t\t\t\tthis.escapeHtml(item.filename || item.title || 'Untitled') +\n\t\t\t\t'</strong>';\n\t\t\thtml += '</td>';\n\n\t\t\tconst sizeBytes =\n\t\t\t\titem.size || item.file_size || item.current_size || 0;\n\t\t\tif (tab === 'large-files') {\n\t\t\t\thtml +=\n\t\t\t\t\t'<td class=\"wpha-col-size\">' +\n\t\t\t\t\tthis.formatBytes(sizeBytes) +\n\t\t\t\t\t'</td>';\n\t\t\t\thtml +=\n\t\t\t\t\t'<td class=\"wpha-col-dimensions\">' +\n\t\t\t\t\t(item.width && item.height\n\t\t\t\t\t\t? item.width + ' × ' + item.height\n\t\t\t\t\t\t: '--') +\n\t\t\t\t\t'</td>';\n\t\t\t} else if (tab !== 'missing-alt') {\n\t\t\t\thtml +=\n\t\t\t\t\t'<td class=\"wpha-col-size\">' +\n\t\t\t\t\tthis.formatBytes(sizeBytes) +\n\t\t\t\t\t'</td>';\n\t\t\t\thtml +=\n\t\t\t\t\t'<td class=\"wpha-col-date\">' +\n\t\t\t\t\tthis.formatDate(item.date) +\n\t\t\t\t\t'</td>';\n\t\t\t} else {\n\t\t\t\thtml +=\n\t\t\t\t\t'<td class=\"wpha-col-date\">' +\n\t\t\t\t\tthis.formatDate(item.date) +\n\t\t\t\t\t'</td>';\n\t\t\t}\n\n\t\t\thtml += '<td class=\"wpha-col-actions\">';\n\t\t\tif (tab !== 'missing-alt') {\n\t\t\t\thtml +=\n\t\t\t\t\t'<button class=\"button button-small wpha-delete-btn\" data-id=\"' +\n\t\t\t\t\titem.id +\n\t\t\t\t\t'\" title=\"Delete\">';\n\t\t\t\thtml += '<span class=\"dashicons dashicons-trash\"></span>';\n\t\t\t\thtml += '</button> ';\n\t\t\t}\n\t\t\thtml +=\n\t\t\t\t'<button class=\"button button-small wpha-ignore-btn\" data-id=\"' +\n\t\t\t\titem.id +\n\t\t\t\t'\" title=\"Ignore\">';\n\t\t\thtml += '<span class=\"dashicons dashicons-hidden\"></span>';\n\t\t\thtml += '</button>';\n\t\t\thtml += '</td>';\n\n\t\t\thtml += '</tr>';\n\t\t\treturn html;\n\t\t},\n\n\t\t/**\n\t\t * Render duplicates groups.\n\t\t * @param $panel\n\t\t * @param data\n\t\t */\n\t\trenderDuplicates($panel, data) {\n\t\t\tconst $container = $panel.find('.wpha-duplicates-container');\n\t\t\tconst page = this.currentPages.duplicates;\n\t\t\tconst start = (page - 1) * this.itemsPerPage;\n\t\t\tconst end = start + this.itemsPerPage;\n\t\t\tconst pageData = data.slice(start, end);\n\n\t\t\tif (pageData.length === 0) {\n\t\t\t\t$container.html(\n\t\t\t\t\t'<div class=\"wpha-empty-state\">' +\n\t\t\t\t\t\t(wpAdminHealthData.i18n.no_data ||\n\t\t\t\t\t\t\t'No duplicate groups found.') +\n\t\t\t\t\t\t'</div>'\n\t\t\t\t);\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst html = pageData\n\t\t\t\t.map((group) => this.renderDuplicateGroup(group))\n\t\t\t\t.join('');\n\t\t\t$container.html(html);\n\n\t\t\t// Lazy load images\n\t\t\tthis.lazyLoadPreviews($container);\n\t\t},\n\n\t\t/**\n\t\t * Render duplicate group.\n\t\t * @param group\n\t\t */\n\t\trenderDuplicateGroup(group) {\n\t\t\tlet html = '<div class=\"wpha-duplicate-group\">';\n\t\t\thtml += '<div class=\"wpha-duplicate-group-header\">';\n\t\t\thtml +=\n\t\t\t\t'<h4>' +\n\t\t\t\tthis.escapeHtml(group.filename || 'Unnamed Group') +\n\t\t\t\t'</h4>';\n\t\t\thtml +=\n\t\t\t\t'<span class=\"wpha-duplicate-count\">' +\n\t\t\t\tgroup.items.length +\n\t\t\t\t' duplicates • ' +\n\t\t\t\tthis.formatBytes(group.total_size) +\n\t\t\t\t'</span>';\n\t\t\thtml += '</div>';\n\t\t\thtml += '<div class=\"wpha-duplicate-items\">';\n\n\t\t\tgroup.items.forEach((item, index) => {\n\t\t\t\tconst isChecked = this.selectedItems.duplicates.has(item.id);\n\t\t\t\tconst isOriginal = index === 0;\n\t\t\t\tconst previewUrl =\n\t\t\t\t\titem.thumbnail || item.thumbnail_url || item.url || '';\n\n\t\t\t\thtml +=\n\t\t\t\t\t'<div class=\"wpha-duplicate-item\" data-id=\"' +\n\t\t\t\t\titem.id +\n\t\t\t\t\t'\">';\n\t\t\t\thtml += '<div class=\"wpha-duplicate-item-preview\">';\n\t\t\t\tif (previewUrl) {\n\t\t\t\t\thtml +=\n\t\t\t\t\t\t'<img class=\"wpha-lazy-preview\" data-src=\"' +\n\t\t\t\t\t\tpreviewUrl +\n\t\t\t\t\t\t'\" alt=\"\" width=\"100\" height=\"100\" />';\n\t\t\t\t} else {\n\t\t\t\t\thtml +=\n\t\t\t\t\t\t'<span class=\"dashicons dashicons-media-default\"></span>';\n\t\t\t\t}\n\t\t\t\thtml += '</div>';\n\t\t\t\thtml += '<div class=\"wpha-duplicate-item-info\">';\n\t\t\t\thtml +=\n\t\t\t\t\t'<p class=\"wpha-duplicate-filename\">' +\n\t\t\t\t\tthis.escapeHtml(item.filename) +\n\t\t\t\t\t'</p>';\n\t\t\t\thtml +=\n\t\t\t\t\t'<p class=\"wpha-duplicate-meta\">' +\n\t\t\t\t\tthis.formatBytes(\n\t\t\t\t\t\titem.size || item.file_size || item.current_size || 0\n\t\t\t\t\t) +\n\t\t\t\t\t' • ' +\n\t\t\t\t\tthis.formatDate(item.date) +\n\t\t\t\t\t'</p>';\n\t\t\t\thtml += '<div class=\"wpha-duplicate-actions\">';\n\t\t\t\thtml +=\n\t\t\t\t\t'<input type=\"checkbox\" class=\"wpha-item-checkbox\" data-id=\"' +\n\t\t\t\t\titem.id +\n\t\t\t\t\t'\" ' +\n\t\t\t\t\t(isChecked ? 'checked' : '') +\n\t\t\t\t\t' /> ';\n\t\t\t\tif (isOriginal) {\n\t\t\t\t\thtml +=\n\t\t\t\t\t\t'<span class=\"wpha-badge wpha-badge-primary\">Original</span>';\n\t\t\t\t}\n\t\t\t\thtml += '</div>';\n\t\t\t\thtml += '</div>';\n\t\t\t\thtml += '</div>';\n\t\t\t});\n\n\t\t\thtml += '</div>';\n\t\t\thtml += '</div>';\n\t\t\treturn html;\n\t\t},\n\n\t\t/**\n\t\t * Render pagination.\n\t\t * @param $panel\n\t\t * @param tab\n\t\t * @param totalItems\n\t\t */\n\t\trenderPagination($panel, tab, totalItems) {\n\t\t\tconst $pagination = $panel.find('.wpha-pagination-controls');\n\t\t\tconst $info = $panel.find('.wpha-showing-text');\n\t\t\tconst page = this.currentPages[tab];\n\t\t\tconst totalPages = Math.ceil(totalItems / this.itemsPerPage);\n\t\t\tconst start = (page - 1) * this.itemsPerPage + 1;\n\t\t\tconst end = Math.min(page * this.itemsPerPage, totalItems);\n\n\t\t\t// Update info text\n\t\t\tconst unit = tab === 'duplicates' ? 'groups' : 'items';\n\t\t\t$info.text(`Showing ${start}-${end} of ${totalItems} ${unit}`);\n\n\t\t\tif (totalPages <= 1) {\n\t\t\t\t$pagination.html('');\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tlet html = '';\n\n\t\t\t// Previous button\n\t\t\thtml +=\n\t\t\t\t'<button class=\"button wpha-page-btn\" data-page=\"' +\n\t\t\t\t(page - 1) +\n\t\t\t\t'\" ' +\n\t\t\t\t(page === 1 ? 'disabled' : '') +\n\t\t\t\t'>';\n\t\t\thtml += '<span class=\"dashicons dashicons-arrow-left-alt2\"></span>';\n\t\t\thtml += '</button> ';\n\n\t\t\t// Page numbers\n\t\t\tconst maxButtons = 5;\n\t\t\tlet startPage = Math.max(1, page - Math.floor(maxButtons / 2));\n\t\t\tconst endPage = Math.min(totalPages, startPage + maxButtons - 1);\n\n\t\t\tif (endPage - startPage < maxButtons - 1) {\n\t\t\t\tstartPage = Math.max(1, endPage - maxButtons + 1);\n\t\t\t}\n\n\t\t\tif (startPage > 1) {\n\t\t\t\thtml +=\n\t\t\t\t\t'<button class=\"button wpha-page-btn\" data-page=\"1\">1</button> ';\n\t\t\t\tif (startPage > 2) {\n\t\t\t\t\thtml += '<span class=\"wpha-page-dots\">...</span> ';\n\t\t\t\t}\n\t\t\t}\n\n\t\t\tfor (let i = startPage; i <= endPage; i++) {\n\t\t\t\tconst isActive = i === page;\n\t\t\t\thtml +=\n\t\t\t\t\t'<button class=\"button wpha-page-btn' +\n\t\t\t\t\t(isActive ? ' button-primary' : '') +\n\t\t\t\t\t'\" data-page=\"' +\n\t\t\t\t\ti +\n\t\t\t\t\t'\">' +\n\t\t\t\t\ti +\n\t\t\t\t\t'</button> ';\n\t\t\t}\n\n\t\t\tif (endPage < totalPages) {\n\t\t\t\tif (endPage < totalPages - 1) {\n\t\t\t\t\thtml += '<span class=\"wpha-page-dots\">...</span> ';\n\t\t\t\t}\n\t\t\t\thtml +=\n\t\t\t\t\t'<button class=\"button wpha-page-btn\" data-page=\"' +\n\t\t\t\t\ttotalPages +\n\t\t\t\t\t'\">' +\n\t\t\t\t\ttotalPages +\n\t\t\t\t\t'</button> ';\n\t\t\t}\n\n\t\t\t// Next button\n\t\t\thtml +=\n\t\t\t\t'<button class=\"button wpha-page-btn\" data-page=\"' +\n\t\t\t\t(page + 1) +\n\t\t\t\t'\" ' +\n\t\t\t\t(page === totalPages ? 'disabled' : '') +\n\t\t\t\t'>';\n\t\t\thtml +=\n\t\t\t\t'<span class=\"dashicons dashicons-arrow-right-alt2\"></span>';\n\t\t\thtml += '</button>';\n\n\t\t\t$pagination.html(html);\n\t\t},\n\n\t\t/**\n\t\t * Update bulk actions state.\n\t\t * @param $panel\n\t\t * @param tab\n\t\t */\n\t\tupdateBulkActions($panel, tab) {\n\t\t\tconst hasSelection = this.selectedItems[tab].size > 0;\n\t\t\t$panel\n\t\t\t\t.find('.wpha-bulk-action-select, .wpha-bulk-apply-btn')\n\t\t\t\t.prop('disabled', !hasSelection);\n\t\t},\n\n\t\t/**\n\t\t * Handle rescan.\n\t\t * @param e\n\t\t */\n\t\thandleRescan(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $btn = $(e.currentTarget);\n\n\t\t\tif ($btn.prop('disabled')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\t$btn.prop('disabled', true).addClass('wpha-loading');\n\t\t\t$btn.find('.dashicons').addClass('wpha-spin');\n\n\t\t\twp.apiFetch({\n\t\t\t\tpath: '/wpha/v1/media/scan',\n\t\t\t\tmethod: 'POST',\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (response.success) {\n\t\t\t\t\t\t// Clear cache and reload\n\t\t\t\t\t\tObject.keys(this.dataCache).forEach((key) => {\n\t\t\t\t\t\t\tif (key !== 'stats') {\n\t\t\t\t\t\t\t\tthis.dataCache[key] = [];\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\n\t\t\t\t\t\tthis.loadStats();\n\t\t\t\t\t\tthis.loadTabData(this.currentTab);\n\n\t\t\t\t\t\t// Show success message\n\t\t\t\t\t\tthis.showNotice(\n\t\t\t\t\t\t\t'success',\n\t\t\t\t\t\t\twpAdminHealthData.i18n.success ||\n\t\t\t\t\t\t\t\t'Scan completed successfully.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error('Error scanning:', error);\n\t\t\t\t\tthis.showNotice(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\twpAdminHealthData.i18n.error || 'Scan failed.'\n\t\t\t\t\t);\n\t\t\t\t})\n\t\t\t\t.finally(() => {\n\t\t\t\t\t$btn.prop('disabled', false).removeClass('wpha-loading');\n\t\t\t\t\t$btn.find('.dashicons').removeClass('wpha-spin');\n\t\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Handle sort.\n\t\t * @param e\n\t\t */\n\t\thandleSort(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $th = $(e.currentTarget);\n\t\t\tconst field = $th.data('sort');\n\t\t\tconst tab = this.currentTab;\n\t\t\tconst currentSort = this.currentSort[tab];\n\n\t\t\t// Toggle order if same field, otherwise default to desc\n\t\t\tlet order = 'desc';\n\t\t\tif (currentSort.field === field) {\n\t\t\t\torder = currentSort.order === 'asc' ? 'desc' : 'asc';\n\t\t\t}\n\n\t\t\tthis.currentSort[tab] = { field, order };\n\n\t\t\t// Update UI\n\t\t\t$th.siblings('.wpha-sortable')\n\t\t\t\t.removeClass('wpha-sorted-asc wpha-sorted-desc')\n\t\t\t\t.find('.dashicons')\n\t\t\t\t.removeClass('dashicons-arrow-up dashicons-arrow-down')\n\t\t\t\t.addClass('dashicons-sort');\n\n\t\t\t$th.addClass(\n\t\t\t\torder === 'asc' ? 'wpha-sorted-asc' : 'wpha-sorted-desc'\n\t\t\t)\n\t\t\t\t.find('.dashicons')\n\t\t\t\t.removeClass('dashicons-sort')\n\t\t\t\t.addClass(\n\t\t\t\t\torder === 'asc'\n\t\t\t\t\t\t? 'dashicons-arrow-up'\n\t\t\t\t\t\t: 'dashicons-arrow-down'\n\t\t\t\t);\n\n\t\t\tthis.renderTabData(tab);\n\t\t},\n\n\t\t/**\n\t\t * Handle search filter.\n\t\t * @param e\n\t\t */\n\t\thandleSearchFilter(e) {\n\t\t\tconst $input = $(e.currentTarget);\n\t\t\tconst tab = this.currentTab;\n\t\t\tconst value = $input.val().trim();\n\n\t\t\tthis.currentFilters[tab].search = value;\n\t\t\tthis.currentPages[tab] = 1; // Reset to first page\n\t\t\tthis.renderTabData(tab);\n\t\t},\n\n\t\t/**\n\t\t * Handle type filter.\n\t\t * @param e\n\t\t */\n\t\thandleTypeFilter(e) {\n\t\t\tconst $select = $(e.currentTarget);\n\t\t\tconst value = $select.val();\n\n\t\t\tthis.currentFilters.unused.type = value;\n\t\t\tthis.currentPages.unused = 1;\n\t\t\tthis.renderTabData('unused');\n\t\t},\n\n\t\t/**\n\t\t * Handle size filter.\n\t\t * @param e\n\t\t */\n\t\thandleSizeFilter(e) {\n\t\t\tconst $select = $(e.currentTarget);\n\t\t\tconst value = $select.val();\n\n\t\t\tthis.currentFilters['large-files'].size = value;\n\t\t\tthis.currentPages['large-files'] = 1;\n\t\t\tthis.renderTabData('large-files');\n\t\t},\n\n\t\t/**\n\t\t * Handle select all.\n\t\t * @param e\n\t\t */\n\t\thandleSelectAll(e) {\n\t\t\tconst $checkbox = $(e.currentTarget);\n\t\t\tconst isChecked = $checkbox.is(':checked');\n\t\t\tconst tab = this.currentTab;\n\t\t\tconst $panel = $(`.wpha-tab-panel[data-tab=\"${tab}\"]`);\n\n\t\t\t$panel\n\t\t\t\t.find('.wpha-item-checkbox')\n\t\t\t\t.prop('checked', isChecked)\n\t\t\t\t.each((i, el) => {\n\t\t\t\t\tconst id = $(el).data('id');\n\t\t\t\t\tif (isChecked) {\n\t\t\t\t\t\tthis.selectedItems[tab].add(id);\n\t\t\t\t\t} else {\n\t\t\t\t\t\tthis.selectedItems[tab].delete(id);\n\t\t\t\t\t}\n\t\t\t\t});\n\n\t\t\tthis.updateBulkActions($panel, tab);\n\t\t},\n\n\t\t/**\n\t\t * Handle item select.\n\t\t * @param e\n\t\t */\n\t\thandleItemSelect(e) {\n\t\t\tconst $checkbox = $(e.currentTarget);\n\t\t\tconst id = $checkbox.data('id');\n\t\t\tconst isChecked = $checkbox.is(':checked');\n\t\t\tconst tab = this.currentTab;\n\t\t\tconst $panel = $(`.wpha-tab-panel[data-tab=\"${tab}\"]`);\n\n\t\t\tif (isChecked) {\n\t\t\t\tthis.selectedItems[tab].add(id);\n\t\t\t} else {\n\t\t\t\tthis.selectedItems[tab].delete(id);\n\t\t\t}\n\n\t\t\tthis.updateBulkActions($panel, tab);\n\t\t},\n\n\t\t/**\n\t\t * Handle bulk action.\n\t\t * @param e\n\t\t */\n\t\thandleBulkAction(e) {\n\t\t\te.preventDefault();\n\t\t\tconst tab = this.currentTab;\n\t\t\tconst $panel = $(`.wpha-tab-panel[data-tab=\"${tab}\"]`);\n\t\t\tconst action = $panel.find('.wpha-bulk-action-select').val();\n\t\t\tconst items = Array.from(this.selectedItems[tab]);\n\n\t\t\tif (!action || items.length === 0) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst confirmMsg =\n\t\t\t\taction === 'delete'\n\t\t\t\t\t? 'Are you sure you want to delete ' +\n\t\t\t\t\t\titems.length +\n\t\t\t\t\t\t' item(s)? This action cannot be undone.'\n\t\t\t\t\t: 'Are you sure you want to ignore ' +\n\t\t\t\t\t\titems.length +\n\t\t\t\t\t\t' item(s)?';\n\n\t\t\tif (!confirm(confirmMsg)) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.executeBulkAction(action, items, tab);\n\t\t},\n\n\t\t/**\n\t\t * Execute bulk action.\n\t\t * @param action\n\t\t * @param items\n\t\t * @param tab\n\t\t */\n\t\texecuteBulkAction(action, items, tab) {\n\t\t\tconst apiPath =\n\t\t\t\taction === 'delete'\n\t\t\t\t\t? '/wpha/v1/media/delete'\n\t\t\t\t\t: '/wpha/v1/media/ignore';\n\n\t\t\twp.apiFetch({\n\t\t\t\tpath: apiPath,\n\t\t\t\tmethod: 'POST',\n\t\t\t\tdata: { ids: items },\n\t\t\t})\n\t\t\t\t.then((response) => {\n\t\t\t\t\tif (response.success) {\n\t\t\t\t\t\t// Remove from cache\n\t\t\t\t\t\tthis.dataCache[tab] = this.dataCache[tab].filter(\n\t\t\t\t\t\t\t(item) => !items.includes(item.id)\n\t\t\t\t\t\t);\n\n\t\t\t\t\t\t// Clear selection\n\t\t\t\t\t\tthis.selectedItems[tab].clear();\n\n\t\t\t\t\t\t// Re-render\n\t\t\t\t\t\tthis.renderTabData(tab);\n\t\t\t\t\t\tthis.loadStats();\n\n\t\t\t\t\t\tthis.showNotice(\n\t\t\t\t\t\t\t'success',\n\t\t\t\t\t\t\tresponse.data.message ||\n\t\t\t\t\t\t\t\t'Action completed successfully.'\n\t\t\t\t\t\t);\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error('Error executing bulk action:', error);\n\t\t\t\t\tthis.showNotice(\n\t\t\t\t\t\t'error',\n\t\t\t\t\t\twpAdminHealthData.i18n.error || 'Action failed.'\n\t\t\t\t\t);\n\t\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Handle delete.\n\t\t * @param e\n\t\t */\n\t\thandleDelete(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $btn = $(e.currentTarget);\n\t\t\tconst id = $btn.data('id');\n\n\t\t\tif (\n\t\t\t\t!confirm(\n\t\t\t\t\t'Are you sure you want to delete this item? This action cannot be undone.'\n\t\t\t\t)\n\t\t\t) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tthis.executeBulkAction('delete', [id], this.currentTab);\n\t\t},\n\n\t\t/**\n\t\t * Handle ignore.\n\t\t * @param e\n\t\t */\n\t\thandleIgnore(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $btn = $(e.currentTarget);\n\t\t\tconst id = $btn.data('id');\n\n\t\t\tthis.executeBulkAction('ignore', [id], this.currentTab);\n\t\t},\n\n\t\t/**\n\t\t * Handle page change.\n\t\t * @param e\n\t\t */\n\t\thandlePageChange(e) {\n\t\t\te.preventDefault();\n\t\t\tconst $btn = $(e.currentTarget);\n\n\t\t\tif ($btn.prop('disabled')) {\n\t\t\t\treturn;\n\t\t\t}\n\n\t\t\tconst page = parseInt($btn.data('page'));\n\t\t\tconst tab = this.currentTab;\n\n\t\t\tthis.currentPages[tab] = page;\n\t\t\tthis.renderTabData(tab);\n\n\t\t\t// Scroll to top of results\n\t\t\t$('.wpha-results-section')[0].scrollIntoView({\n\t\t\t\tbehavior: 'smooth',\n\t\t\t\tblock: 'start',\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Lazy load preview images.\n\t\t * @param $container\n\t\t */\n\t\tlazyLoadPreviews($container) {\n\t\t\t$container.find('.wpha-lazy-preview').each((i, img) => {\n\t\t\t\tconst $img = $(img);\n\t\t\t\tconst src = $img.data('src');\n\n\t\t\t\tif (src) {\n\t\t\t\t\tconst observer = new IntersectionObserver((entries) => {\n\t\t\t\t\t\tentries.forEach((entry) => {\n\t\t\t\t\t\t\tif (entry.isIntersecting) {\n\t\t\t\t\t\t\t\t$img.attr('src', src);\n\t\t\t\t\t\t\t\tobserver.unobserve(entry.target);\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t});\n\t\t\t\t\t});\n\n\t\t\t\t\tobserver.observe(img);\n\t\t\t\t}\n\t\t\t});\n\t\t},\n\n\t\t/**\n\t\t * Show empty state.\n\t\t * @param $panel\n\t\t */\n\t\tshowEmptyState($panel) {\n\t\t\t$panel\n\t\t\t\t.find('.wpha-tab-panel-content')\n\t\t\t\t.html(\n\t\t\t\t\t'<div class=\"wpha-empty-state\">' +\n\t\t\t\t\t\t(wpAdminHealthData.i18n.no_data ||\n\t\t\t\t\t\t\t'No data available.') +\n\t\t\t\t\t\t'</div>'\n\t\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Show notice.\n\t\t * @param type\n\t\t * @param message\n\t\t */\n\t\tshowNotice(type, message) {\n\t\t\tconst $notice = $(\n\t\t\t\t'<div class=\"notice notice-' +\n\t\t\t\t\ttype +\n\t\t\t\t\t' is-dismissible\"><p>' +\n\t\t\t\t\tmessage +\n\t\t\t\t\t'</p></div>'\n\t\t\t);\n\t\t\t$('.wpha-media-audit-wrap h1').after($notice);\n\n\t\t\t// Auto dismiss after 5 seconds\n\t\t\tsetTimeout(() => {\n\t\t\t\t$notice.fadeOut(() => $notice.remove());\n\t\t\t}, 5000);\n\t\t},\n\n\t\t/**\n\t\t * Format bytes to human readable.\n\t\t * @param bytes\n\t\t */\n\t\tformatBytes(bytes) {\n\t\t\tif (bytes === 0) return '0 Bytes';\n\t\t\tconst k = 1024;\n\t\t\tconst sizes = ['Bytes', 'KB', 'MB', 'GB'];\n\t\t\tconst i = Math.floor(Math.log(bytes) / Math.log(k));\n\t\t\treturn (\n\t\t\t\tMath.round((bytes / Math.pow(k, i)) * 100) / 100 +\n\t\t\t\t' ' +\n\t\t\t\tsizes[i]\n\t\t\t);\n\t\t},\n\n\t\t/**\n\t\t * Format date.\n\t\t * @param dateString\n\t\t */\n\t\tformatDate(dateString) {\n\t\t\tif (!dateString) return '--';\n\t\t\tconst date = new Date(dateString);\n\t\t\treturn date.toLocaleDateString() + ' ' + date.toLocaleTimeString();\n\t\t},\n\n\t\t/**\n\t\t * Escape HTML.\n\t\t * @param text\n\t\t */\n\t\tescapeHtml(text) {\n\t\t\tconst map = {\n\t\t\t\t'&': '&amp;',\n\t\t\t\t'<': '&lt;',\n\t\t\t\t'>': '&gt;',\n\t\t\t\t'\"': '&quot;',\n\t\t\t\t\"'\": '&#039;',\n\t\t\t};\n\t\t\treturn text.replace(/[&<>\"']/g, (m) => map[m]);\n\t\t},\n\n\t\t/**\n\t\t * Hide skeleton loaders.\n\t\t * @param $container\n\t\t */\n\t\thideSkeletons($container) {\n\t\t\t$container.find('[class*=\"-skeleton\"]').hide();\n\t\t},\n\t};\n\n\t// Initialize on document ready\n\t$(document).ready(() => {\n\t\tif ($('.wpha-media-audit').length) {\n\t\t\tMediaAudit.init();\n\t\t}\n\t});\n})(jQuery);\n","// The module cache\nvar __webpack_module_cache__ = {};\n\n// The require function\nfunction __webpack_require__(moduleId) {\n\t// Check if module is in cache\n\tvar cachedModule = __webpack_module_cache__[moduleId];\n\tif (cachedModule !== undefined) {\n\t\treturn cachedModule.exports;\n\t}\n\t// Create a new module (and put it into the cache)\n\tvar module = __webpack_module_cache__[moduleId] = {\n\t\t// no module.id needed\n\t\t// no module.loaded needed\n\t\texports: {}\n\t};\n\n\t// Execute the module function\n\t__webpack_modules__[moduleId](module, module.exports, __webpack_require__);\n\n\t// Return the exports of the module\n\treturn module.exports;\n}\n\n","// getDefaultExport function for compatibility with non-harmony modules\n__webpack_require__.n = (module) => {\n\tvar getter = module && module.__esModule ?\n\t\t() => (module['default']) :\n\t\t() => (module);\n\t__webpack_require__.d(getter, { a: getter });\n\treturn getter;\n};","// define getter functions for harmony exports\n__webpack_require__.d = (exports, definition) => {\n\tfor(var key in definition) {\n\t\tif(__webpack_require__.o(definition, key) && !__webpack_require__.o(exports, key)) {\n\t\t\tObject.defineProperty(exports, key, { enumerable: true, get: definition[key] });\n\t\t}\n\t}\n};","__webpack_require__.o = (obj, prop) => (Object.prototype.hasOwnProperty.call(obj, prop))","/**\n * Metric Card Component\n *\n * A React component that displays metric information with trend indicators.\n * Used in the dashboard to show key metrics like database size, media library count, etc.\n *\n * @package\n */\n\nimport React from 'react';\n\n/**\n * Trend direction types and their corresponding arrow symbols\n */\nconst TREND_INDICATORS = {\n\tup: '↑',\n\tdown: '↓',\n\tneutral: '→',\n};\n\n/**\n * Trend color mapping\n */\nconst TREND_COLORS = {\n\tup: '#d63638', // red (usually negative for metrics like size)\n\tdown: '#00a32a', // green (usually positive for metrics like size reduction)\n\tneutral: '#646970', // gray\n};\n\n/**\n * MetricCard Component\n *\n * @param {Object}        props            - Component props\n * @param {string}        props.title      - Card title (e.g., \"Database Size\")\n * @param {number|string} props.value      - Main metric value to display\n * @param {string}        props.unit       - Unit label (e.g., \"MB\", \"count\")\n * @param {string}        props.trend      - Trend direction: 'up', 'down', or 'neutral'\n * @param {string}        props.trendValue - Percentage change from last scan (e.g., \"5.2\" for 5.2%)\n * @param {string}        props.icon       - Icon class or dashicon name (e.g., \"dashicons-database\")\n * @param {Function}      props.onClick    - Click handler for navigation\n * @return {JSX.Element} Rendered component\n */\nconst MetricCard = ({\n\ttitle,\n\tvalue,\n\tunit = '',\n\ttrend = 'neutral',\n\ttrendValue = null,\n\ticon = 'dashicons-chart-bar',\n\tonClick = null,\n}) => {\n\t// Validate trend direction\n\tconst validTrend = ['up', 'down', 'neutral'].includes(trend)\n\t\t? trend\n\t\t: 'neutral';\n\tconst trendIndicator = TREND_INDICATORS[validTrend];\n\tconst trendColor = TREND_COLORS[validTrend];\n\n\t// Format trend display\n\tconst trendDisplay =\n\t\ttrendValue !== null\n\t\t\t? `${trendIndicator} ${trendValue}%`\n\t\t\t: trendIndicator;\n\n\t// Accessibility label\n\tconst ariaLabel = `${title}: ${value} ${unit}${\n\t\ttrendValue !== null\n\t\t\t? `, trend ${validTrend} by ${trendValue} percent`\n\t\t\t: ''\n\t}`;\n\n\t// Determine if card should be interactive\n\tconst isClickable = typeof onClick === 'function';\n\n\t// Handle keyboard navigation\n\tconst handleKeyPress = (e) => {\n\t\tif (isClickable && (e.key === 'Enter' || e.key === ' ')) {\n\t\t\te.preventDefault();\n\t\t\tonClick();\n\t\t}\n\t};\n\n\t// Base styles\n\tconst cardStyles = {\n\t\tdisplay: 'flex',\n\t\talignItems: 'center',\n\t\tpadding: '20px',\n\t\tbackgroundColor: '#fff',\n\t\tborder: '1px solid #c3c4c7',\n\t\tborderRadius: '4px',\n\t\tcursor: isClickable ? 'pointer' : 'default',\n\t\ttransition: 'all 0.2s ease',\n\t\toutline: 'none',\n\t\tminHeight: '100px',\n\t};\n\n\t// Hover state styles\n\tconst hoverStyles = {\n\t\tboxShadow: '0 4px 8px rgba(0, 0, 0, 0.1)',\n\t\ttransform: 'translateY(-2px)',\n\t\tborderColor: '#2271b1',\n\t};\n\n\t// Icon container styles\n\tconst iconContainerStyles = {\n\t\tdisplay: 'flex',\n\t\talignItems: 'center',\n\t\tjustifyContent: 'center',\n\t\twidth: '48px',\n\t\theight: '48px',\n\t\tmarginRight: '16px',\n\t\tflexShrink: 0,\n\t};\n\n\t// Icon styles (using WordPress dashicons)\n\tconst iconStyles = {\n\t\tfontSize: '32px',\n\t\twidth: '32px',\n\t\theight: '32px',\n\t\tcolor: '#2271b1',\n\t};\n\n\t// Content container styles\n\tconst contentStyles = {\n\t\tflex: 1,\n\t\tminWidth: 0, // Allow text truncation\n\t};\n\n\t// Title styles\n\tconst titleStyles = {\n\t\tmargin: '0 0 8px 0',\n\t\tfontSize: '14px',\n\t\tfontWeight: '600',\n\t\tcolor: '#1d2327',\n\t\tlineHeight: '1.4',\n\t};\n\n\t// Value container styles\n\tconst valueContainerStyles = {\n\t\tdisplay: 'flex',\n\t\talignItems: 'baseline',\n\t\tgap: '8px',\n\t\tflexWrap: 'wrap',\n\t};\n\n\t// Value styles\n\tconst valueStyles = {\n\t\tfontSize: '28px',\n\t\tfontWeight: '700',\n\t\tcolor: '#1d2327',\n\t\tlineHeight: '1.2',\n\t};\n\n\t// Unit styles\n\tconst unitStyles = {\n\t\tfontSize: '14px',\n\t\tfontWeight: '400',\n\t\tcolor: '#646970',\n\t\tlineHeight: '1.2',\n\t};\n\n\t// Trend styles\n\tconst trendStyles = {\n\t\tfontSize: '14px',\n\t\tfontWeight: '600',\n\t\tcolor: trendColor,\n\t\tmarginLeft: '4px',\n\t};\n\n\t// State management for hover\n\tconst [isHovered, setIsHovered] = React.useState(false);\n\n\treturn (\n\t\t<div\n\t\t\tclassName=\"metric-card\"\n\t\t\trole={isClickable ? 'button' : 'article'}\n\t\t\ttabIndex={isClickable ? 0 : undefined}\n\t\t\taria-label={ariaLabel}\n\t\t\tonClick={isClickable ? onClick : undefined}\n\t\t\tonKeyPress={handleKeyPress}\n\t\t\tonMouseEnter={() => setIsHovered(true)}\n\t\t\tonMouseLeave={() => setIsHovered(false)}\n\t\t\tstyle={{\n\t\t\t\t...cardStyles,\n\t\t\t\t...(isHovered && isClickable ? hoverStyles : {}),\n\t\t\t}}\n\t\t>\n\t\t\t{/* Icon */}\n\t\t\t<div style={iconContainerStyles}>\n\t\t\t\t<span\n\t\t\t\t\tclassName={`dashicons ${icon}`}\n\t\t\t\t\tstyle={iconStyles}\n\t\t\t\t\taria-hidden=\"true\"\n\t\t\t\t/>\n\t\t\t</div>\n\n\t\t\t{/* Content */}\n\t\t\t<div style={contentStyles}>\n\t\t\t\t<h3 style={titleStyles}>{title}</h3>\n\t\t\t\t<div style={valueContainerStyles}>\n\t\t\t\t\t<span style={valueStyles}>{value}</span>\n\t\t\t\t\t{unit && <span style={unitStyles}>{unit}</span>}\n\t\t\t\t\t{trendValue !== null && (\n\t\t\t\t\t\t<span\n\t\t\t\t\t\t\tstyle={trendStyles}\n\t\t\t\t\t\t\taria-label={`Trend ${validTrend} by ${trendValue} percent`}\n\t\t\t\t\t\t>\n\t\t\t\t\t\t\t{trendDisplay}\n\t\t\t\t\t\t</span>\n\t\t\t\t\t)}\n\t\t\t\t</div>\n\t\t\t</div>\n\t\t</div>\n\t);\n};\n\nexport default MetricCard;\n","/**\n * Media Audit Entry Point\n *\n * Main entry point for the media audit admin page.\n * Imports and initializes page-specific functionality.\n *\n * @package\n */\n\nimport React from 'react';\nimport { createRoot } from 'react-dom/client';\n\n// Import React components\nimport MetricCard from '../components/MetricCard.jsx';\n\n// Import core admin utilities\nimport '../admin.js';\nimport '../media-audit.js';\n\n// Make components globally available for use in WordPress templates\nwindow.WPAdminHealthComponents = window.WPAdminHealthComponents || {};\nObject.assign(window.WPAdminHealthComponents, {\n\tMetricCard,\n\tReact,\n\tcreateRoot,\n});\n\n// Initialize any media audit-specific functionality\ndocument.addEventListener('DOMContentLoaded', () => {\n\tconsole.log('Media Audit page loaded and ready');\n});\n"],"names":["f","k","Symbol","for","l","m","Object","prototype","hasOwnProperty","n","__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED","ReactCurrentOwner","p","key","ref","__self","__source","q","c","a","g","b","d","e","h","call","defaultProps","$$typeof","type","props","_owner","current","exports","jsx","jsxs","window","$","apiFetch","wp","__","i18n","text","WPAdminHealth","API","namespace","buildPath","endpoint","replace","concat","this","get","params","arguments","length","undefined","request","method","post","data","put","_this","options","retries","Promise","reject","Error","path","maxRetries","requestOptions","_objectSpread","error","shouldRetry","delay","Math","pow","resolve","setTimeout","errorMessage","ErrorHandler","getUserFriendlyMessage","_error$response","response","status","Toast","container","init","class","append","show","message","_this2","duration","toast","role","icon","getIcon","content","html","closeBtn","on","dismiss","addClass","removeClass","remove","icons","success","warning","info","Modal","confirm","_this3","defaults","title","confirmText","cancelText","confirmClass","cancelClass","danger","settings","extend","modal","createModal","_this4","overlay","header","body","footer","confirmBtn","cancelBtn","closeModal","target","document","off","Progress","trackers","create","id","showPercentage","tracker","buildTracker","element","_this5","barContainer","bar","style","percentage","update","progress","msg","complete","max","min","css","attr","round","_this6","fadeOut","Storage","prefix","buildKey","isAvailable","test","localStorage","setItem","removeItem","defaultValue","item","getItem","JSON","parse","set","value","stringify","clear","_this7","keys","forEach","startsWith","getAll","_this8","items","shortKey","substring","Events","listeners","eventName","callback","_this9","push","filter","cb","trigger","event","CustomEvent","detail","bubbles","dispatchEvent","once","_this0","wrapper","messages","network_error","server_error","permission_error","validation_error","timeout_error","unknown_error","includes","handle","showToast","logToConsole","triggerEvent","utils","debounce","func","wait","timeout","_this1","_len","args","Array","_key","clearTimeout","apply","throttle","limit","inThrottle","_len2","_key2","formatBytes","bytes","decimals","dm","i","floor","log","parseFloat","toFixed","formatNumber","num","toString","ready","addEventListener","reason","wpAdminHealthData","version","jQuery","createRoot","hydrateRoot","module","MediaAudit","currentTab","itemsPerPage","currentPages","unused","duplicates","dataCache","stats","currentSort","field","order","currentFilters","search","size","selectedItems","Set","cacheDom","bindEvents","loadStats","loadTabData","$scanBanner","$rescanBtn","$statsCards","$tabBtns","$tabPanels","handleTabSwitch","bind","handleRescan","handleSort","handleSearchFilter","handleTypeFilter","handleSizeFilter","handleSelectAll","handleItemSelect","handleBulkAction","handleDelete","handleIgnore","handlePageChange","then","renderStats","renderScanStatus","hideSkeletons","_data$potential_savin","total_count","selector","unused_count","duplicate_count","potential_savings","stat","$card","find","eq","hide","large_files_count","missing_alt_count","lastScan","last_scan","formatDate","no_data","prop","preventDefault","$btn","currentTarget","tab","renderTabData","apiPath","$panel","$skeleton","showEmptyState","filterData","sortData","renderDuplicates","renderTable","renderPagination","updateBulkActions","filters","filtered","_toConsumableArray","toLowerCase","filename","minSize","sort","sorted","aVal","bVal","$tbody","start","end","pageData","slice","map","renderTableRow","join","lazyLoadPreviews","isChecked","has","previewUrl","thumbnail","thumbnail_url","url","mimeType","mime_type","isImage","escapeHtml","sizeBytes","file_size","current_size","width","height","date","$container","group","renderDuplicateGroup","total_size","index","isOriginal","totalItems","$pagination","$info","page","totalPages","ceil","unit","startPage","maxButtons","endPage","hasSelection","showNotice","$th","siblings","$input","val","trim","is","each","el","add","$checkbox","action","from","confirmMsg","executeBulkAction","ids","parseInt","scrollIntoView","behavior","block","img","$img","src","observer","IntersectionObserver","entries","entry","isIntersecting","unobserve","observe","$notice","after","dateString","Date","toLocaleDateString","toLocaleTimeString","__webpack_module_cache__","__webpack_require__","moduleId","cachedModule","__webpack_modules__","getter","__esModule","definition","o","defineProperty","enumerable","obj","TREND_INDICATORS","up","down","neutral","TREND_COLORS","_ref","_ref$unit","_ref$trend","trend","_ref$trendValue","trendValue","_ref$icon","_ref$onClick","onClick","validTrend","trendIndicator","trendColor","trendDisplay","ariaLabel","isClickable","cardStyles","display","alignItems","padding","backgroundColor","border","borderRadius","cursor","transition","outline","minHeight","trendStyles","fontSize","fontWeight","color","marginLeft","_React$useState2","_slicedToArray","React","isHovered","setIsHovered","_jsxs","className","tabIndex","onKeyPress","onMouseEnter","onMouseLeave","boxShadow","transform","borderColor","children","_jsx","justifyContent","marginRight","flexShrink","flex","minWidth","margin","lineHeight","gap","flexWrap","WPAdminHealthComponents","assign","MetricCard"],"ignoreList":[],"sourceRoot":""}
exec
/bin/zsh -lc "sed -n '1,260p' includes/Assets.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
<?php
/**
 * Assets Class
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Assets class for handling CSS and JavaScript assets.
 *
 * @since 1.0.0
 */
class Assets {
exec
/bin/zsh -lc 'rg -n "wpha/v1|wp-admin-health/v1" assets/js/dist/media-audit.bundle.js | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
1:(()=>{var t={20(t,e,a){"use strict";var n=a(609),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,o=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(t,e,a){var n,i={},l=null,u=null;for(n in void 0!==a&&(l=""+a),void 0!==e.key&&(l=""+e.key),void 0!==e.ref&&(u=e.ref),e)s.call(e,n)&&!c.hasOwnProperty(n)&&(i[n]=e[n]);if(t&&t.defaultProps)for(n in e=t.defaultProps)void 0===i[n]&&(i[n]=e[n]);return{$$typeof:r,type:t,key:l,ref:u,props:i,_owner:o.current}}e.jsx=l,e.jsxs=l},210(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function a(e,a,n){return(a=function(e){var a=function(e,a){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,a||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===a?String:Number)(e)}(e,"string");return"symbol"==t(a)?a:a+""}(a))in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}!function(t,n){"use strict";var r=t.wp&&t.wp.apiFetch,i=(t.wp.i18n||{__:function(t){return t}}).__;t.WPAdminHealth=t.WPAdminHealth||{};var s={namespace:"wp-admin-health/v1",buildPath:function(t){return t=t.replace(/^\//,""),"/".concat(this.namespace,"/").concat(t)},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"GET",params:e})},post:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"POST",data:e})},put:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"PUT",data:e})},delete:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"DELETE",data:e})},request:function(t){var n=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!r)return Promise.reject(new Error(i("wp.apiFetch is not available","wp-admin-health-suite")));var c=this.buildPath(t),l=s.maxRetries||2,u=function(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach(function(e){a(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({path:c,method:s.method||"GET"},s);return r(u).catch(function(e){if(o<l&&n.shouldRetry(e)){var a=1e3*Math.pow(2,o);return new Promise(function(e){setTimeout(function(){e(n.request(t,s,o+1))},a)})}var r=h.getUserFriendlyMessage(e);throw new Error(r)})},shouldRetry:function(t){var e;if(!t.response)return!0;var a=(null===(e=t.response)||void 0===e?void 0:e.status)||0;return a>=500&&a<600}},o={container:null,init:function(){this.container||(this.container=n("<div>",{class:"wpha-toast-container","aria-live":"polite","aria-atomic":"true"}),n("body").append(this.container))},show:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;this.init();var s=n("<div>",{class:"wpha-toast wpha-toast-".concat(a),role:"alert"}),o=this.getIcon(a),c=n("<div>",{class:"wpha-toast-content",html:'<span class="wpha-toast-icon">'.concat(o,'</span><span class="wpha-toast-message">').concat(t,"</span>")}),l=n("<button>",{class:"wpha-toast-close",type:"button","aria-label":i("Close","wp-admin-health-suite"),html:"&times;"});return l.on("click",function(){return e.dismiss(s)}),s.append(c,l),this.container.append(s),setTimeout(function(){return s.addClass("wpha-toast-show")},10),r>0&&setTimeout(function(){return e.dismiss(s)},r),s},dismiss:function(t){t.removeClass("wpha-toast-show"),setTimeout(function(){return t.remove()},300)},getIcon:function(t){var e={success:"&#10004;",error:"&#10006;",warning:"&#9888;",info:"&#8505;"};return e[t]||e.info},success:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"success",e)},error:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;return this.show(t,"error",e)},warning:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6e3;return this.show(t,"warning",e)},info:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"info",e)}},c={confirm:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a={title:i("Confirm","wp-admin-health-suite"),message:i("Are you sure?","wp-admin-health-suite"),confirmText:i("Confirm","wp-admin-health-suite"),cancelText:i("Cancel","wp-admin-health-suite"),confirmClass:"button-primary",cancelClass:"button-secondary",danger:!1},r=n.extend({},a,e);return new Promise(function(e){var a=t.createModal(r,e);n("body").append(a),setTimeout(function(){return a.addClass("wpha-modal-show")},10)})},createModal:function(t,e){var a=this,r=n("<div>",{class:"wpha-modal-overlay",role:"dialog","aria-modal":"true","aria-labelledby":"wpha-modal-title"}),i=n("<div>",{class:"wpha-modal"}),s=n("<div>",{class:"wpha-modal-header",html:'<h3 id="wpha-modal-title">'.concat(t.title,"</h3>")}),o=n("<div>",{class:"wpha-modal-body",html:"<p>".concat(t.message,"</p>")}),c=n("<div>",{class:"wpha-modal-footer"}),l=n("<button>",{class:"button ".concat(t.confirmClass," ").concat(t.danger?"wpha-danger":""),type:"button",text:t.confirmText}),u=n("<button>",{class:"button ".concat(t.cancelClass),type:"button",text:t.cancelText});return l.on("click",function(){a.closeModal(r),e(!0)}),u.on("click",function(){a.closeModal(r),e(!1)}),r.on("click",function(t){t.target===r[0]&&(a.closeModal(r),e(!1))}),n(document).on("keydown.wpha-modal",function(t){"Escape"===t.key&&(a.closeModal(r),e(!1))}),c.append(u,l),i.append(s,o,c),r.append(i),r},closeModal:function(t){t.removeClass("wpha-modal-show"),n(document).off("keydown.wpha-modal"),setTimeout(function(){return t.remove()},300)}},l={trackers:{},create:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a={title:i("Processing…","wp-admin-health-suite"),message:"",showPercentage:!0,container:null},r=n.extend({},a,e),s=this.buildTracker(t,r);return r.container?n(r.container).append(s.element):n("body").append(s.element),this.trackers[t]=s,s},buildTracker:function(t,e){var a=this,r=n("<div>",{class:"wpha-progress-tracker",id:"wpha-progress-".concat(t),role:"progressbar","aria-valuenow":"0","aria-valuemin":"0","aria-valuemax":"100"}),i=n("<div>",{class:"wpha-progress-title",text:e.title}),s=n("<div>",{class:"wpha-progress-message",text:e.message}),o=n("<div>",{class:"wpha-progress-bar-container"}),c=n("<div>",{class:"wpha-progress-bar",style:"width: 0%"}),l=n("<div>",{class:"wpha-progress-percentage",text:"0%"});return o.append(c),r.append(i,s,o),e.showPercentage&&r.append(l),{element:r,bar:c,message:s,percentage:l,settings:e,update:function(e,n){return a.update(t,e,n)},complete:function(e){return a.complete(t,e)},error:function(e){return a.error(t,e)},remove:function(){return a.remove(t)}}},update:function(t,e,a){var n=this.trackers[t];n&&(e=Math.max(0,Math.min(100,e)),n.bar.css("width","".concat(e,"%")),n.element.attr("aria-valuenow",e),n.settings.showPercentage&&n.percentage.text("".concat(Math.round(e),"%")),a&&n.message.text(a))},complete:function(t,e){var a=this,n=this.trackers[t];n&&(this.update(t,100,e||i("Complete!","wp-admin-health-suite")),n.element.addClass("wpha-progress-complete"),setTimeout(function(){return a.remove(t)},2e3))},error:function(t,e){var a=this.trackers[t];a&&(a.element.addClass("wpha-progress-error"),a.message.text(e||i("An error occurred","wp-admin-health-suite")))},remove:function(t){var e=this.trackers[t];e&&(e.element.fadeOut(300,function(){n(this).remove()}),delete this.trackers[t])}},u={prefix:"wpha_",buildKey:function(t){return this.prefix+t},isAvailable:function(){try{var t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.isAvailable())return e;try{var a=localStorage.getItem(this.buildKey(t));return null!==a?JSON.parse(a):e}catch(t){return e}},set:function(t,e){if(!this.isAvailable())return!1;try{return localStorage.setItem(this.buildKey(t),JSON.stringify(e)),!0}catch(t){return!1}},remove:function(t){if(!this.isAvailable())return!1;try{return localStorage.removeItem(this.buildKey(t)),!0}catch(t){return!1}},clear:function(){var t=this;if(!this.isAvailable())return!1;try{return Object.keys(localStorage).forEach(function(e){e.startsWith(t.prefix)&&localStorage.removeItem(e)}),!0}catch(t){return!1}},getAll:function(){var t=this;if(!this.isAvailable())return{};try{var e={};return Object.keys(localStorage).forEach(function(a){if(a.startsWith(t.prefix)){var n=a.substring(t.prefix.length);e[n]=t.get(n)}}),e}catch(t){return{}}}},d={listeners:{},on:function(t,e){var a=this;return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),function(){return a.off(t,e)}},off:function(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(function(t){return t!==e}))},trigger:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.listeners[t]){this.listeners[t].forEach(function(t){try{t(e)}catch(t){}});var a=new CustomEvent("wpha:".concat(t),{detail:e,bubbles:!0});document.dispatchEvent(a)}},once:function(t,e){var a=this,n=function(r){e(r),a.off(t,n)};this.on(t,n)}},h={messages:{network_error:i("Network error. Please check your connection and try again.","wp-admin-health-suite"),server_error:i("Server error. Please try again later.","wp-admin-health-suite"),permission_error:i("You do not have permission to perform this action.","wp-admin-health-suite"),validation_error:i("Please check your input and try again.","wp-admin-health-suite"),timeout_error:i("Request timed out. Please try again.","wp-admin-health-suite"),unknown_error:i("An unexpected error occurred. Please try again.","wp-admin-health-suite")},getUserFriendlyMessage:function(t){if("string"==typeof t)return t;if(t.response){var e=t.response.status;if(403===e||401===e)return this.messages.permission_error;if(e>=400&&e<500)return t.response.message||this.messages.validation_error;if(e>=500)return this.messages.server_error}return t.message&&t.message.includes("NetworkError")?this.messages.network_error:t.message&&t.message.includes("timeout")?this.messages.timeout_error:t.message||this.messages.unknown_error},handle:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=n.extend({},{showToast:!0,logToConsole:!0,triggerEvent:!0},e),r=this.getUserFriendlyMessage(t);return a.logToConsole,a.showToast&&o.error(r),a.triggerEvent&&d.trigger("error",{error:t,message:r}),r}};n.extend(t.WPAdminHealth,{API:s,Toast:o,Modal:c,Progress:l,Storage:u,Events:d,ErrorHandler:h,utils:{debounce:function(t,e){var a;return function(){for(var n=this,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];clearTimeout(a),a=setTimeout(function(){return t.apply(n,i)},e)}},throttle:function(t,e){var a;return function(){if(!a){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];t.apply(this,r),a=!0,setTimeout(function(){return a=!1},e)}}},formatBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===t)return"0 Bytes";var a=e<0?0:e,n=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,n)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB"][n]},formatNumber:function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}}),n(document).ready(function(){o.init(),t.addEventListener("error",function(t){h.handle(t.error,{showToast:!1})}),t.addEventListener("unhandledrejection",function(t){h.handle(t.reason,{showToast:!1})}),"undefined"!=typeof wpAdminHealthData&&d.trigger("ready",{version:wpAdminHealthData.version})})}(window,jQuery)},338(t,e,a){"use strict";var n=a(795);e.H=n.createRoot,n.hydrateRoot},609(t){"use strict";t.exports=window.React},795(t){"use strict";t.exports=window.ReactDOM},848(t,e,a){"use strict";t.exports=a(20)},903(){function t(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,a){if(t){if("string"==typeof t)return e(t,a);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,a):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}!function(e){"use strict";var a={currentTab:"unused",itemsPerPage:50,currentPages:{unused:1,duplicates:1,"large-files":1,"missing-alt":1},dataCache:{stats:null,unused:[],duplicates:[],"large-files":[],"missing-alt":[]},currentSort:{unused:{field:"date",order:"desc"},duplicates:{field:"size",order:"desc"},"large-files":{field:"size",order:"desc"},"missing-alt":{field:"date",order:"desc"}},currentFilters:{unused:{search:"",type:""},duplicates:{search:""},"large-files":{search:"",size:""},"missing-alt":{search:""}},selectedItems:{unused:new Set,duplicates:new Set,"large-files":new Set,"missing-alt":new Set},init:function(){this.cacheDom(),this.bindEvents(),this.loadStats(),this.loadTabData(this.currentTab)},cacheDom:function(){this.$scanBanner=e(".wpha-scan-status-banner"),this.$rescanBtn=e(".wpha-rescan-btn"),this.$statsCards=e(".wpha-stats-overview"),this.$tabBtns=e(".wpha-tab-btn"),this.$tabPanels=e(".wpha-tab-panel")},bindEvents:function(){e(document).on("click",".wpha-tab-btn",this.handleTabSwitch.bind(this)),e(document).on("click",".wpha-rescan-btn",this.handleRescan.bind(this)),e(document).on("click",".wpha-sortable",this.handleSort.bind(this)),e(document).on("input",".wpha-search-input",this.handleSearchFilter.bind(this)),e(document).on("change",".wpha-filter-select",this.handleTypeFilter.bind(this)),e(document).on("change",".wpha-size-filter-select",this.handleSizeFilter.bind(this)),e(document).on("change",".wpha-select-all",this.handleSelectAll.bind(this)),e(document).on("change",".wpha-item-checkbox",this.handleItemSelect.bind(this)),e(document).on("click",".wpha-bulk-apply-btn",this.handleBulkAction.bind(this)),e(document).on("click",".wpha-delete-btn",this.handleDelete.bind(this)),e(document).on("click",".wpha-ignore-btn",this.handleIgnore.bind(this)),e(document).on("click",".wpha-page-btn",this.handlePageChange.bind(this))},loadStats:function(){var t=this;wp.apiFetch({path:"/wpha/v1/media/stats"}).then(function(e){e.success&&e.data&&(t.dataCache.stats=e.data,t.renderStats(e.data),t.renderScanStatus(e.data))}).catch(function(e){t.hideSkeletons(t.$statsCards),t.hideSkeletons(t.$scanBanner)})},renderStats:function(t){var a,n=this;[{value:t.total_count||0,selector:0},{value:t.unused_count||0,selector:1},{value:t.duplicate_count||0,selector:2},{value:this.formatBytes((null===(a=t.potential_savings)||void 0===a?void 0:a.bytes)||0),selector:3}].forEach(function(t){var e=n.$statsCards.find(".wpha-stat-card").eq(t.selector);e.find(".wpha-stat-value").text(t.value),e.find(".wpha-stat-card-skeleton").hide(),e.find(".wpha-stat-card-content").show()}),e('.wpha-tab-btn[data-tab="unused"] .wpha-tab-badge').text(t.unused_count||0),e('.wpha-tab-btn[data-tab="duplicates"] .wpha-tab-badge').text(t.duplicate_count||0),e('.wpha-tab-btn[data-tab="large-files"] .wpha-tab-badge').text(t.large_files_count||0),e('.wpha-tab-btn[data-tab="missing-alt"] .wpha-tab-badge').text(t.missing_alt_count||0)},renderScanStatus:function(t){var e=t.last_scan?this.formatDate(t.last_scan):wpAdminHealthData.i18n.no_data||"Never";this.$scanBanner.find(".wpha-scan-status-value").text(e),this.$scanBanner.find(".wpha-scan-status-banner-skeleton").hide(),this.$scanBanner.find(".wpha-scan-status-content").show(),this.$rescanBtn.prop("disabled",!1)},handleTabSwitch:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("tab");n!==this.currentTab&&(this.$tabBtns.removeClass("wpha-tab-active"),a.addClass("wpha-tab-active"),this.$tabPanels.removeClass("wpha-tab-active"),e('.wpha-tab-panel[data-tab="'.concat(n,'"]')).addClass("wpha-tab-active"),this.currentTab=n,this.loadTabData(n))},loadTabData:function(t){var a=this;if(this.dataCache[t].length>0)this.renderTabData(t);else{var n="";switch(t){case"unused":n="/wpha/v1/media/unused";break;case"duplicates":n="/wpha/v1/media/duplicates";break;case"large-files":n="/wpha/v1/media/large-files";break;case"missing-alt":n="/wpha/v1/media/missing-alt"}var r=e('.wpha-tab-panel[data-tab="'.concat(t,'"]')),i=r.find(".wpha-tab-panel-skeleton");i.show(),wp.apiFetch({path:n}).then(function(e){e.success&&e.data&&(a.dataCache[t]=e.data,a.renderTabData(t))}).catch(function(t){i.hide(),a.showEmptyState(r)})}},renderTabData:function(t){var a=e('.wpha-tab-panel[data-tab="'.concat(t,'"]'));a.find(".wpha-tab-panel-skeleton").hide();var n=this.filterData(t,this.dataCache[t]);n=this.sortData(t,n),"duplicates"===t?this.renderDuplicates(a,n):this.renderTable(a,t,n),this.renderPagination(a,t,n.length),this.updateBulkActions(a,t)},filterData:function(e,a){var n=this.currentFilters[e],r=t(a);if(n.search){var i=n.search.toLowerCase();r=r.filter(function(t){return(t.filename||"").toLowerCase().includes(i)||(t.title||"").toLowerCase().includes(i)})}if(n.type&&(r=r.filter(function(t){return t.type===n.type})),n.size){var s={"1mb":1048576,"5mb":5242880,"10mb":10485760}[n.size]||0;r=r.filter(function(t){return t.size>s})}return r},sortData:function(e,a){var n=this.currentSort[e],r=t(a);return r.sort(function(t,e){var a=t[n.field],r=e[n.field];return"string"==typeof a&&(a=a.toLowerCase(),r=r.toLowerCase()),"asc"===n.order?a>r?1:-1:a<r?1:-1}),r},renderTable:function(t,e,a){var n=this,r=t.find(".wpha-media-table tbody"),i=(this.currentPages[e]-1)*this.itemsPerPage,s=i+this.itemsPerPage,o=a.slice(i,s);if(0!==o.length){var c=o.map(function(t){return n.renderTableRow(e,t)}).join("");r.html(c),this.lazyLoadPreviews(r)}else r.html('<tr><td colspan="6" class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No items found.")+"</td></tr>")},renderTableRow:function(t,e){var a=this.selectedItems[t].has(e.id),n=e.thumbnail||e.thumbnail_url||e.url||"",r=e.mime_type||"",i="image"===e.type||r.startsWith("image/"),s='<tr data-id="'+e.id+'">';s+='<td class="wpha-col-checkbox">',s+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+e.id+'" '+(a?"checked":"")+" />",s+="</td>",s+='<td class="wpha-col-preview">',s+=i&&n?'<img class="wpha-lazy-preview" data-src="'+n+'" alt="" width="50" height="50" />':'<span class="dashicons dashicons-media-default"></span>',s+="</td>",s+='<td class="wpha-col-filename">',s+="<strong>"+this.escapeHtml(e.filename||e.title||"Untitled")+"</strong>",s+="</td>";var o=e.size||e.file_size||e.current_size||0;return"large-files"===t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-dimensions">'+(e.width&&e.height?e.width+" × "+e.height:"--")+"</td>"):"missing-alt"!==t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>"):s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>",s+='<td class="wpha-col-actions">',"missing-alt"!==t&&(s+='<button class="button button-small wpha-delete-btn" data-id="'+e.id+'" title="Delete">',s+='<span class="dashicons dashicons-trash"></span>',s+="</button> "),s+='<button class="button button-small wpha-ignore-btn" data-id="'+e.id+'" title="Ignore">',s+='<span class="dashicons dashicons-hidden"></span>',s+="</button>",s+="</td>",s+="</tr>"},renderDuplicates:function(t,e){var a=this,n=t.find(".wpha-duplicates-container"),r=(this.currentPages.duplicates-1)*this.itemsPerPage,i=r+this.itemsPerPage,s=e.slice(r,i);if(0!==s.length){var o=s.map(function(t){return a.renderDuplicateGroup(t)}).join("");n.html(o),this.lazyLoadPreviews(n)}else n.html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No duplicate groups found.")+"</div>")},renderDuplicateGroup:function(t){var e=this,a='<div class="wpha-duplicate-group">';return a+='<div class="wpha-duplicate-group-header">',a+="<h4>"+this.escapeHtml(t.filename||"Unnamed Group")+"</h4>",a+='<span class="wpha-duplicate-count">'+t.items.length+" duplicates • "+this.formatBytes(t.total_size)+"</span>",a+="</div>",a+='<div class="wpha-duplicate-items">',t.items.forEach(function(t,n){var r=e.selectedItems.duplicates.has(t.id),i=0===n,s=t.thumbnail||t.thumbnail_url||t.url||"";a+='<div class="wpha-duplicate-item" data-id="'+t.id+'">',a+='<div class="wpha-duplicate-item-preview">',a+=s?'<img class="wpha-lazy-preview" data-src="'+s+'" alt="" width="100" height="100" />':'<span class="dashicons dashicons-media-default"></span>',a+="</div>",a+='<div class="wpha-duplicate-item-info">',a+='<p class="wpha-duplicate-filename">'+e.escapeHtml(t.filename)+"</p>",a+='<p class="wpha-duplicate-meta">'+e.formatBytes(t.size||t.file_size||t.current_size||0)+" • "+e.formatDate(t.date)+"</p>",a+='<div class="wpha-duplicate-actions">',a+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+t.id+'" '+(r?"checked":"")+" /> ",i&&(a+='<span class="wpha-badge wpha-badge-primary">Original</span>'),a+="</div>",a+="</div>",a+="</div>"}),a+="</div>",a+="</div>"},renderPagination:function(t,e,a){var n=t.find(".wpha-pagination-controls"),r=t.find(".wpha-showing-text"),i=this.currentPages[e],s=Math.ceil(a/this.itemsPerPage),o=(i-1)*this.itemsPerPage+1,c=Math.min(i*this.itemsPerPage,a),l="duplicates"===e?"groups":"items";if(r.text("Showing ".concat(o,"-").concat(c," of ").concat(a," ").concat(l)),s<=1)n.html("");else{var u="";u+='<button class="button wpha-page-btn" data-page="'+(i-1)+'" '+(1===i?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-left-alt2"></span>',u+="</button> ";var d=Math.max(1,i-Math.floor(2.5)),h=Math.min(s,d+5-1);h-d<4&&(d=Math.max(1,h-5+1)),d>1&&(u+='<button class="button wpha-page-btn" data-page="1">1</button> ',d>2&&(u+='<span class="wpha-page-dots">...</span> '));for(var p=d;p<=h;p++){u+='<button class="button wpha-page-btn'+(p===i?" button-primary":"")+'" data-page="'+p+'">'+p+"</button> "}h<s&&(h<s-1&&(u+='<span class="wpha-page-dots">...</span> '),u+='<button class="button wpha-page-btn" data-page="'+s+'">'+s+"</button> "),u+='<button class="button wpha-page-btn" data-page="'+(i+1)+'" '+(i===s?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-right-alt2"></span>',u+="</button>",n.html(u)}},updateBulkActions:function(t,e){var a=this.selectedItems[e].size>0;t.find(".wpha-bulk-action-select, .wpha-bulk-apply-btn").prop("disabled",!a)},handleRescan:function(t){var a=this;t.preventDefault();var n=e(t.currentTarget);n.prop("disabled")||(n.prop("disabled",!0).addClass("wpha-loading"),n.find(".dashicons").addClass("wpha-spin"),wp.apiFetch({path:"/wpha/v1/media/scan",method:"POST"}).then(function(t){t.success&&(Object.keys(a.dataCache).forEach(function(t){"stats"!==t&&(a.dataCache[t]=[])}),a.loadStats(),a.loadTabData(a.currentTab),a.showNotice("success",wpAdminHealthData.i18n.success||"Scan completed successfully."))}).catch(function(t){a.showNotice("error",wpAdminHealthData.i18n.error||"Scan failed.")}).finally(function(){n.prop("disabled",!1).removeClass("wpha-loading"),n.find(".dashicons").removeClass("wpha-spin")}))},handleSort:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("sort"),r=this.currentTab,i=this.currentSort[r],s="desc";i.field===n&&(s="asc"===i.order?"desc":"asc"),this.currentSort[r]={field:n,order:s},a.siblings(".wpha-sortable").removeClass("wpha-sorted-asc wpha-sorted-desc").find(".dashicons").removeClass("dashicons-arrow-up dashicons-arrow-down").addClass("dashicons-sort"),a.addClass("asc"===s?"wpha-sorted-asc":"wpha-sorted-desc").find(".dashicons").removeClass("dashicons-sort").addClass("asc"===s?"dashicons-arrow-up":"dashicons-arrow-down"),this.renderTabData(r)},handleSearchFilter:function(t){var a=e(t.currentTarget),n=this.currentTab,r=a.val().trim();this.currentFilters[n].search=r,this.currentPages[n]=1,this.renderTabData(n)},handleTypeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters.unused.type=a,this.currentPages.unused=1,this.renderTabData("unused")},handleSizeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters["large-files"].size=a,this.currentPages["large-files"]=1,this.renderTabData("large-files")},handleSelectAll:function(t){var a=this,n=e(t.currentTarget).is(":checked"),r=this.currentTab,i=e('.wpha-tab-panel[data-tab="'.concat(r,'"]'));i.find(".wpha-item-checkbox").prop("checked",n).each(function(t,i){var s=e(i).data("id");n?a.selectedItems[r].add(s):a.selectedItems[r].delete(s)}),this.updateBulkActions(i,r)},handleItemSelect:function(t){var a=e(t.currentTarget),n=a.data("id"),r=a.is(":checked"),i=this.currentTab,s=e('.wpha-tab-panel[data-tab="'.concat(i,'"]'));r?this.selectedItems[i].add(n):this.selectedItems[i].delete(n),this.updateBulkActions(s,i)},handleBulkAction:function(t){t.preventDefault();var a=this.currentTab,n=e('.wpha-tab-panel[data-tab="'.concat(a,'"]')).find(".wpha-bulk-action-select").val(),r=Array.from(this.selectedItems[a]);if(n&&0!==r.length){var i="delete"===n?"Are you sure you want to delete "+r.length+" item(s)? This action cannot be undone.":"Are you sure you want to ignore "+r.length+" item(s)?";confirm(i)&&this.executeBulkAction(n,r,a)}},executeBulkAction:function(t,e,a){var n=this,r="delete"===t?"/wpha/v1/media/delete":"/wpha/v1/media/ignore";wp.apiFetch({path:r,method:"POST",data:{ids:e}}).then(function(t){t.success&&(n.dataCache[a]=n.dataCache[a].filter(function(t){return!e.includes(t.id)}),n.selectedItems[a].clear(),n.renderTabData(a),n.loadStats(),n.showNotice("success",t.data.message||"Action completed successfully."))}).catch(function(t){n.showNotice("error",wpAdminHealthData.i18n.error||"Action failed.")})},handleDelete:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");confirm("Are you sure you want to delete this item? This action cannot be undone.")&&this.executeBulkAction("delete",[a],this.currentTab)},handleIgnore:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");this.executeBulkAction("ignore",[a],this.currentTab)},handlePageChange:function(t){t.preventDefault();var a=e(t.currentTarget);if(!a.prop("disabled")){var n=parseInt(a.data("page")),r=this.currentTab;this.currentPages[r]=n,this.renderTabData(r),e(".wpha-results-section")[0].scrollIntoView({behavior:"smooth",block:"start"})}},lazyLoadPreviews:function(t){t.find(".wpha-lazy-preview").each(function(t,a){var n=e(a),r=n.data("src");if(r){var i=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&(n.attr("src",r),i.unobserve(t.target))})});i.observe(a)}})},showEmptyState:function(t){t.find(".wpha-tab-panel-content").html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No data available.")+"</div>")},showNotice:function(t,a){var n=e('<div class="notice notice-'+t+' is-dismissible"><p>'+a+"</p></div>");e(".wpha-media-audit-wrap h1").after(n),setTimeout(function(){n.fadeOut(function(){return n.remove()})},5e3)},formatBytes:function(t){if(0===t)return"0 Bytes";var e=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,e)*100)/100+" "+["Bytes","KB","MB","GB"][e]},formatDate:function(t){if(!t)return"--";var e=new Date(t);return e.toLocaleDateString()+" "+e.toLocaleTimeString()},escapeHtml:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})},hideSkeletons:function(t){t.find('[class*="-skeleton"]').hide()}};e(document).ready(function(){e(".wpha-media-audit").length&&a.init()})}(jQuery)}},e={};function a(n){var r=e[n];if(void 0!==r)return r.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,a),i.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";var t=a(609),e=a.n(t),n=a(338),r=a(848);function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function s(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function o(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?s(Object(a),!0).forEach(function(e){c(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function c(t,e,a){return(e=function(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var n=a.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function l(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var n,r,i,s,o=[],c=!0,l=!1;try{if(i=(a=a.call(t)).next,0===e){if(Object(a)!==a)return;c=!1}else for(;!(c=(n=i.call(a)).done)&&(o.push(n.value),o.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=a.return&&(s=a.return(),Object(s)!==s))return}finally{if(l)throw r}}return o}}(t,e)||function(t,e){if(t){if("string"==typeof t)return u(t,e);var a={}.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?u(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}var d={up:"↑",down:"↓",neutral:"→"},h={up:"#d63638",down:"#00a32a",neutral:"#646970"};const p=function(t){var a=t.title,n=t.value,i=t.unit,s=void 0===i?"":i,c=t.trend,u=void 0===c?"neutral":c,p=t.trendValue,f=void 0===p?null:p,m=t.icon,b=void 0===m?"dashicons-chart-bar":m,v=t.onClick,w=void 0===v?null:v,g=["up","down","neutral"].includes(u)?u:"neutral",y=d[g],S=h[g],x=null!==f?"".concat(y," ").concat(f,"%"):y,P="".concat(a,": ").concat(n," ").concat(s).concat(null!==f?", trend ".concat(g," by ").concat(f," percent"):""),T="function"==typeof w,k={display:"flex",alignItems:"center",padding:"20px",backgroundColor:"#fff",border:"1px solid #c3c4c7",borderRadius:"4px",cursor:T?"pointer":"default",transition:"all 0.2s ease",outline:"none",minHeight:"100px"},O={fontSize:"14px",fontWeight:"600",color:S,marginLeft:"4px"},C=l(e().useState(!1),2),_=C[0],D=C[1];return(0,r.jsxs)("div",{className:"metric-card",role:T?"button":"article",tabIndex:T?0:void 0,"aria-label":P,onClick:T?w:void 0,onKeyPress:function(t){!T||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),w())},onMouseEnter:function(){return D(!0)},onMouseLeave:function(){return D(!1)},style:o(o({},k),_&&T?{boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",transform:"translateY(-2px)",borderColor:"#2271b1"}:{}),children:[(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"48px",height:"48px",marginRight:"16px",flexShrink:0},children:(0,r.jsx)("span",{className:"dashicons ".concat(b),style:{fontSize:"32px",width:"32px",height:"32px",color:"#2271b1"},"aria-hidden":"true"})}),(0,r.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,r.jsx)("h3",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600",color:"#1d2327",lineHeight:"1.4"},children:a}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"baseline",gap:"8px",flexWrap:"wrap"},children:[(0,r.jsx)("span",{style:{fontSize:"28px",fontWeight:"700",color:"#1d2327",lineHeight:"1.2"},children:n}),s&&(0,r.jsx)("span",{style:{fontSize:"14px",fontWeight:"400",color:"#646970",lineHeight:"1.2"},children:s}),null!==f&&(0,r.jsx)("span",{style:O,"aria-label":"Trend ".concat(g," by ").concat(f," percent"),children:x})]})]})]})};a(210),a(903);window.WPAdminHealthComponents=window.WPAdminHealthComponents||{},Object.assign(window.WPAdminHealthComponents,{MetricCard:p,React:e(),createRoot:n.H}),document.addEventListener("DOMContentLoaded",function(){})})()})();
exec
/bin/zsh -lc 'rg -n "wp-admin-health/v1" -S includes | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 45ms:

exec
/bin/zsh -lc "rg -n \"media\\/stats|media\\/unused|media\\/duplicates|large-files|missing-alt\" assets/js/dist/media-audit.bundle.js | head -n 40" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
1:(()=>{var t={20(t,e,a){"use strict";var n=a(609),r=Symbol.for("react.element"),i=Symbol.for("react.fragment"),s=Object.prototype.hasOwnProperty,o=n.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,c={key:!0,ref:!0,__self:!0,__source:!0};function l(t,e,a){var n,i={},l=null,u=null;for(n in void 0!==a&&(l=""+a),void 0!==e.key&&(l=""+e.key),void 0!==e.ref&&(u=e.ref),e)s.call(e,n)&&!c.hasOwnProperty(n)&&(i[n]=e[n]);if(t&&t.defaultProps)for(n in e=t.defaultProps)void 0===i[n]&&(i[n]=e[n]);return{$$typeof:r,type:t,key:l,ref:u,props:i,_owner:o.current}}e.jsx=l,e.jsxs=l},210(){function t(e){return t="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},t(e)}function e(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function a(e,a,n){return(a=function(e){var a=function(e,a){if("object"!=t(e)||!e)return e;var n=e[Symbol.toPrimitive];if(void 0!==n){var r=n.call(e,a||"default");if("object"!=t(r))return r;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===a?String:Number)(e)}(e,"string");return"symbol"==t(a)?a:a+""}(a))in e?Object.defineProperty(e,a,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[a]=n,e}!function(t,n){"use strict";var r=t.wp&&t.wp.apiFetch,i=(t.wp.i18n||{__:function(t){return t}}).__;t.WPAdminHealth=t.WPAdminHealth||{};var s={namespace:"wp-admin-health/v1",buildPath:function(t){return t=t.replace(/^\//,""),"/".concat(this.namespace,"/").concat(t)},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"GET",params:e})},post:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"POST",data:e})},put:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"PUT",data:e})},delete:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return this.request(t,{method:"DELETE",data:e})},request:function(t){var n=this,s=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0;if(!r)return Promise.reject(new Error(i("wp.apiFetch is not available","wp-admin-health-suite")));var c=this.buildPath(t),l=s.maxRetries||2,u=function(t){for(var n=1;n<arguments.length;n++){var r=null!=arguments[n]?arguments[n]:{};n%2?e(Object(r),!0).forEach(function(e){a(t,e,r[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):e(Object(r)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))})}return t}({path:c,method:s.method||"GET"},s);return r(u).catch(function(e){if(o<l&&n.shouldRetry(e)){var a=1e3*Math.pow(2,o);return new Promise(function(e){setTimeout(function(){e(n.request(t,s,o+1))},a)})}var r=h.getUserFriendlyMessage(e);throw new Error(r)})},shouldRetry:function(t){var e;if(!t.response)return!0;var a=(null===(e=t.response)||void 0===e?void 0:e.status)||0;return a>=500&&a<600}},o={container:null,init:function(){this.container||(this.container=n("<div>",{class:"wpha-toast-container","aria-live":"polite","aria-atomic":"true"}),n("body").append(this.container))},show:function(t){var e=this,a=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"info",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:5e3;this.init();var s=n("<div>",{class:"wpha-toast wpha-toast-".concat(a),role:"alert"}),o=this.getIcon(a),c=n("<div>",{class:"wpha-toast-content",html:'<span class="wpha-toast-icon">'.concat(o,'</span><span class="wpha-toast-message">').concat(t,"</span>")}),l=n("<button>",{class:"wpha-toast-close",type:"button","aria-label":i("Close","wp-admin-health-suite"),html:"&times;"});return l.on("click",function(){return e.dismiss(s)}),s.append(c,l),this.container.append(s),setTimeout(function(){return s.addClass("wpha-toast-show")},10),r>0&&setTimeout(function(){return e.dismiss(s)},r),s},dismiss:function(t){t.removeClass("wpha-toast-show"),setTimeout(function(){return t.remove()},300)},getIcon:function(t){var e={success:"&#10004;",error:"&#10006;",warning:"&#9888;",info:"&#8505;"};return e[t]||e.info},success:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"success",e)},error:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:7e3;return this.show(t,"error",e)},warning:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:6e3;return this.show(t,"warning",e)},info:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:5e3;return this.show(t,"info",e)}},c={confirm:function(){var t=this,e=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},a={title:i("Confirm","wp-admin-health-suite"),message:i("Are you sure?","wp-admin-health-suite"),confirmText:i("Confirm","wp-admin-health-suite"),cancelText:i("Cancel","wp-admin-health-suite"),confirmClass:"button-primary",cancelClass:"button-secondary",danger:!1},r=n.extend({},a,e);return new Promise(function(e){var a=t.createModal(r,e);n("body").append(a),setTimeout(function(){return a.addClass("wpha-modal-show")},10)})},createModal:function(t,e){var a=this,r=n("<div>",{class:"wpha-modal-overlay",role:"dialog","aria-modal":"true","aria-labelledby":"wpha-modal-title"}),i=n("<div>",{class:"wpha-modal"}),s=n("<div>",{class:"wpha-modal-header",html:'<h3 id="wpha-modal-title">'.concat(t.title,"</h3>")}),o=n("<div>",{class:"wpha-modal-body",html:"<p>".concat(t.message,"</p>")}),c=n("<div>",{class:"wpha-modal-footer"}),l=n("<button>",{class:"button ".concat(t.confirmClass," ").concat(t.danger?"wpha-danger":""),type:"button",text:t.confirmText}),u=n("<button>",{class:"button ".concat(t.cancelClass),type:"button",text:t.cancelText});return l.on("click",function(){a.closeModal(r),e(!0)}),u.on("click",function(){a.closeModal(r),e(!1)}),r.on("click",function(t){t.target===r[0]&&(a.closeModal(r),e(!1))}),n(document).on("keydown.wpha-modal",function(t){"Escape"===t.key&&(a.closeModal(r),e(!1))}),c.append(u,l),i.append(s,o,c),r.append(i),r},closeModal:function(t){t.removeClass("wpha-modal-show"),n(document).off("keydown.wpha-modal"),setTimeout(function(){return t.remove()},300)}},l={trackers:{},create:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a={title:i("Processing…","wp-admin-health-suite"),message:"",showPercentage:!0,container:null},r=n.extend({},a,e),s=this.buildTracker(t,r);return r.container?n(r.container).append(s.element):n("body").append(s.element),this.trackers[t]=s,s},buildTracker:function(t,e){var a=this,r=n("<div>",{class:"wpha-progress-tracker",id:"wpha-progress-".concat(t),role:"progressbar","aria-valuenow":"0","aria-valuemin":"0","aria-valuemax":"100"}),i=n("<div>",{class:"wpha-progress-title",text:e.title}),s=n("<div>",{class:"wpha-progress-message",text:e.message}),o=n("<div>",{class:"wpha-progress-bar-container"}),c=n("<div>",{class:"wpha-progress-bar",style:"width: 0%"}),l=n("<div>",{class:"wpha-progress-percentage",text:"0%"});return o.append(c),r.append(i,s,o),e.showPercentage&&r.append(l),{element:r,bar:c,message:s,percentage:l,settings:e,update:function(e,n){return a.update(t,e,n)},complete:function(e){return a.complete(t,e)},error:function(e){return a.error(t,e)},remove:function(){return a.remove(t)}}},update:function(t,e,a){var n=this.trackers[t];n&&(e=Math.max(0,Math.min(100,e)),n.bar.css("width","".concat(e,"%")),n.element.attr("aria-valuenow",e),n.settings.showPercentage&&n.percentage.text("".concat(Math.round(e),"%")),a&&n.message.text(a))},complete:function(t,e){var a=this,n=this.trackers[t];n&&(this.update(t,100,e||i("Complete!","wp-admin-health-suite")),n.element.addClass("wpha-progress-complete"),setTimeout(function(){return a.remove(t)},2e3))},error:function(t,e){var a=this.trackers[t];a&&(a.element.addClass("wpha-progress-error"),a.message.text(e||i("An error occurred","wp-admin-health-suite")))},remove:function(t){var e=this.trackers[t];e&&(e.element.fadeOut(300,function(){n(this).remove()}),delete this.trackers[t])}},u={prefix:"wpha_",buildKey:function(t){return this.prefix+t},isAvailable:function(){try{var t="__storage_test__";return localStorage.setItem(t,t),localStorage.removeItem(t),!0}catch(t){return!1}},get:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:null;if(!this.isAvailable())return e;try{var a=localStorage.getItem(this.buildKey(t));return null!==a?JSON.parse(a):e}catch(t){return e}},set:function(t,e){if(!this.isAvailable())return!1;try{return localStorage.setItem(this.buildKey(t),JSON.stringify(e)),!0}catch(t){return!1}},remove:function(t){if(!this.isAvailable())return!1;try{return localStorage.removeItem(this.buildKey(t)),!0}catch(t){return!1}},clear:function(){var t=this;if(!this.isAvailable())return!1;try{return Object.keys(localStorage).forEach(function(e){e.startsWith(t.prefix)&&localStorage.removeItem(e)}),!0}catch(t){return!1}},getAll:function(){var t=this;if(!this.isAvailable())return{};try{var e={};return Object.keys(localStorage).forEach(function(a){if(a.startsWith(t.prefix)){var n=a.substring(t.prefix.length);e[n]=t.get(n)}}),e}catch(t){return{}}}},d={listeners:{},on:function(t,e){var a=this;return this.listeners[t]||(this.listeners[t]=[]),this.listeners[t].push(e),function(){return a.off(t,e)}},off:function(t,e){this.listeners[t]&&(this.listeners[t]=this.listeners[t].filter(function(t){return t!==e}))},trigger:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};if(this.listeners[t]){this.listeners[t].forEach(function(t){try{t(e)}catch(t){}});var a=new CustomEvent("wpha:".concat(t),{detail:e,bubbles:!0});document.dispatchEvent(a)}},once:function(t,e){var a=this,n=function(r){e(r),a.off(t,n)};this.on(t,n)}},h={messages:{network_error:i("Network error. Please check your connection and try again.","wp-admin-health-suite"),server_error:i("Server error. Please try again later.","wp-admin-health-suite"),permission_error:i("You do not have permission to perform this action.","wp-admin-health-suite"),validation_error:i("Please check your input and try again.","wp-admin-health-suite"),timeout_error:i("Request timed out. Please try again.","wp-admin-health-suite"),unknown_error:i("An unexpected error occurred. Please try again.","wp-admin-health-suite")},getUserFriendlyMessage:function(t){if("string"==typeof t)return t;if(t.response){var e=t.response.status;if(403===e||401===e)return this.messages.permission_error;if(e>=400&&e<500)return t.response.message||this.messages.validation_error;if(e>=500)return this.messages.server_error}return t.message&&t.message.includes("NetworkError")?this.messages.network_error:t.message&&t.message.includes("timeout")?this.messages.timeout_error:t.message||this.messages.unknown_error},handle:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=n.extend({},{showToast:!0,logToConsole:!0,triggerEvent:!0},e),r=this.getUserFriendlyMessage(t);return a.logToConsole,a.showToast&&o.error(r),a.triggerEvent&&d.trigger("error",{error:t,message:r}),r}};n.extend(t.WPAdminHealth,{API:s,Toast:o,Modal:c,Progress:l,Storage:u,Events:d,ErrorHandler:h,utils:{debounce:function(t,e){var a;return function(){for(var n=this,r=arguments.length,i=new Array(r),s=0;s<r;s++)i[s]=arguments[s];clearTimeout(a),a=setTimeout(function(){return t.apply(n,i)},e)}},throttle:function(t,e){var a;return function(){if(!a){for(var n=arguments.length,r=new Array(n),i=0;i<n;i++)r[i]=arguments[i];t.apply(this,r),a=!0,setTimeout(function(){return a=!1},e)}}},formatBytes:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:2;if(0===t)return"0 Bytes";var a=e<0?0:e,n=Math.floor(Math.log(t)/Math.log(1024));return parseFloat((t/Math.pow(1024,n)).toFixed(a))+" "+["Bytes","KB","MB","GB","TB"][n]},formatNumber:function(t){return t.toString().replace(/\B(?=(\d{3})+(?!\d))/g,",")}}}),n(document).ready(function(){o.init(),t.addEventListener("error",function(t){h.handle(t.error,{showToast:!1})}),t.addEventListener("unhandledrejection",function(t){h.handle(t.reason,{showToast:!1})}),"undefined"!=typeof wpAdminHealthData&&d.trigger("ready",{version:wpAdminHealthData.version})})}(window,jQuery)},338(t,e,a){"use strict";var n=a(795);e.H=n.createRoot,n.hydrateRoot},609(t){"use strict";t.exports=window.React},795(t){"use strict";t.exports=window.ReactDOM},848(t,e,a){"use strict";t.exports=a(20)},903(){function t(t){return function(t){if(Array.isArray(t))return e(t)}(t)||function(t){if("undefined"!=typeof Symbol&&null!=t[Symbol.iterator]||null!=t["@@iterator"])return Array.from(t)}(t)||function(t,a){if(t){if("string"==typeof t)return e(t,a);var n={}.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?e(t,a):void 0}}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function e(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}!function(e){"use strict";var a={currentTab:"unused",itemsPerPage:50,currentPages:{unused:1,duplicates:1,"large-files":1,"missing-alt":1},dataCache:{stats:null,unused:[],duplicates:[],"large-files":[],"missing-alt":[]},currentSort:{unused:{field:"date",order:"desc"},duplicates:{field:"size",order:"desc"},"large-files":{field:"size",order:"desc"},"missing-alt":{field:"date",order:"desc"}},currentFilters:{unused:{search:"",type:""},duplicates:{search:""},"large-files":{search:"",size:""},"missing-alt":{search:""}},selectedItems:{unused:new Set,duplicates:new Set,"large-files":new Set,"missing-alt":new Set},init:function(){this.cacheDom(),this.bindEvents(),this.loadStats(),this.loadTabData(this.currentTab)},cacheDom:function(){this.$scanBanner=e(".wpha-scan-status-banner"),this.$rescanBtn=e(".wpha-rescan-btn"),this.$statsCards=e(".wpha-stats-overview"),this.$tabBtns=e(".wpha-tab-btn"),this.$tabPanels=e(".wpha-tab-panel")},bindEvents:function(){e(document).on("click",".wpha-tab-btn",this.handleTabSwitch.bind(this)),e(document).on("click",".wpha-rescan-btn",this.handleRescan.bind(this)),e(document).on("click",".wpha-sortable",this.handleSort.bind(this)),e(document).on("input",".wpha-search-input",this.handleSearchFilter.bind(this)),e(document).on("change",".wpha-filter-select",this.handleTypeFilter.bind(this)),e(document).on("change",".wpha-size-filter-select",this.handleSizeFilter.bind(this)),e(document).on("change",".wpha-select-all",this.handleSelectAll.bind(this)),e(document).on("change",".wpha-item-checkbox",this.handleItemSelect.bind(this)),e(document).on("click",".wpha-bulk-apply-btn",this.handleBulkAction.bind(this)),e(document).on("click",".wpha-delete-btn",this.handleDelete.bind(this)),e(document).on("click",".wpha-ignore-btn",this.handleIgnore.bind(this)),e(document).on("click",".wpha-page-btn",this.handlePageChange.bind(this))},loadStats:function(){var t=this;wp.apiFetch({path:"/wpha/v1/media/stats"}).then(function(e){e.success&&e.data&&(t.dataCache.stats=e.data,t.renderStats(e.data),t.renderScanStatus(e.data))}).catch(function(e){t.hideSkeletons(t.$statsCards),t.hideSkeletons(t.$scanBanner)})},renderStats:function(t){var a,n=this;[{value:t.total_count||0,selector:0},{value:t.unused_count||0,selector:1},{value:t.duplicate_count||0,selector:2},{value:this.formatBytes((null===(a=t.potential_savings)||void 0===a?void 0:a.bytes)||0),selector:3}].forEach(function(t){var e=n.$statsCards.find(".wpha-stat-card").eq(t.selector);e.find(".wpha-stat-value").text(t.value),e.find(".wpha-stat-card-skeleton").hide(),e.find(".wpha-stat-card-content").show()}),e('.wpha-tab-btn[data-tab="unused"] .wpha-tab-badge').text(t.unused_count||0),e('.wpha-tab-btn[data-tab="duplicates"] .wpha-tab-badge').text(t.duplicate_count||0),e('.wpha-tab-btn[data-tab="large-files"] .wpha-tab-badge').text(t.large_files_count||0),e('.wpha-tab-btn[data-tab="missing-alt"] .wpha-tab-badge').text(t.missing_alt_count||0)},renderScanStatus:function(t){var e=t.last_scan?this.formatDate(t.last_scan):wpAdminHealthData.i18n.no_data||"Never";this.$scanBanner.find(".wpha-scan-status-value").text(e),this.$scanBanner.find(".wpha-scan-status-banner-skeleton").hide(),this.$scanBanner.find(".wpha-scan-status-content").show(),this.$rescanBtn.prop("disabled",!1)},handleTabSwitch:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("tab");n!==this.currentTab&&(this.$tabBtns.removeClass("wpha-tab-active"),a.addClass("wpha-tab-active"),this.$tabPanels.removeClass("wpha-tab-active"),e('.wpha-tab-panel[data-tab="'.concat(n,'"]')).addClass("wpha-tab-active"),this.currentTab=n,this.loadTabData(n))},loadTabData:function(t){var a=this;if(this.dataCache[t].length>0)this.renderTabData(t);else{var n="";switch(t){case"unused":n="/wpha/v1/media/unused";break;case"duplicates":n="/wpha/v1/media/duplicates";break;case"large-files":n="/wpha/v1/media/large-files";break;case"missing-alt":n="/wpha/v1/media/missing-alt"}var r=e('.wpha-tab-panel[data-tab="'.concat(t,'"]')),i=r.find(".wpha-tab-panel-skeleton");i.show(),wp.apiFetch({path:n}).then(function(e){e.success&&e.data&&(a.dataCache[t]=e.data,a.renderTabData(t))}).catch(function(t){i.hide(),a.showEmptyState(r)})}},renderTabData:function(t){var a=e('.wpha-tab-panel[data-tab="'.concat(t,'"]'));a.find(".wpha-tab-panel-skeleton").hide();var n=this.filterData(t,this.dataCache[t]);n=this.sortData(t,n),"duplicates"===t?this.renderDuplicates(a,n):this.renderTable(a,t,n),this.renderPagination(a,t,n.length),this.updateBulkActions(a,t)},filterData:function(e,a){var n=this.currentFilters[e],r=t(a);if(n.search){var i=n.search.toLowerCase();r=r.filter(function(t){return(t.filename||"").toLowerCase().includes(i)||(t.title||"").toLowerCase().includes(i)})}if(n.type&&(r=r.filter(function(t){return t.type===n.type})),n.size){var s={"1mb":1048576,"5mb":5242880,"10mb":10485760}[n.size]||0;r=r.filter(function(t){return t.size>s})}return r},sortData:function(e,a){var n=this.currentSort[e],r=t(a);return r.sort(function(t,e){var a=t[n.field],r=e[n.field];return"string"==typeof a&&(a=a.toLowerCase(),r=r.toLowerCase()),"asc"===n.order?a>r?1:-1:a<r?1:-1}),r},renderTable:function(t,e,a){var n=this,r=t.find(".wpha-media-table tbody"),i=(this.currentPages[e]-1)*this.itemsPerPage,s=i+this.itemsPerPage,o=a.slice(i,s);if(0!==o.length){var c=o.map(function(t){return n.renderTableRow(e,t)}).join("");r.html(c),this.lazyLoadPreviews(r)}else r.html('<tr><td colspan="6" class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No items found.")+"</td></tr>")},renderTableRow:function(t,e){var a=this.selectedItems[t].has(e.id),n=e.thumbnail||e.thumbnail_url||e.url||"",r=e.mime_type||"",i="image"===e.type||r.startsWith("image/"),s='<tr data-id="'+e.id+'">';s+='<td class="wpha-col-checkbox">',s+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+e.id+'" '+(a?"checked":"")+" />",s+="</td>",s+='<td class="wpha-col-preview">',s+=i&&n?'<img class="wpha-lazy-preview" data-src="'+n+'" alt="" width="50" height="50" />':'<span class="dashicons dashicons-media-default"></span>',s+="</td>",s+='<td class="wpha-col-filename">',s+="<strong>"+this.escapeHtml(e.filename||e.title||"Untitled")+"</strong>",s+="</td>";var o=e.size||e.file_size||e.current_size||0;return"large-files"===t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-dimensions">'+(e.width&&e.height?e.width+" × "+e.height:"--")+"</td>"):"missing-alt"!==t?(s+='<td class="wpha-col-size">'+this.formatBytes(o)+"</td>",s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>"):s+='<td class="wpha-col-date">'+this.formatDate(e.date)+"</td>",s+='<td class="wpha-col-actions">',"missing-alt"!==t&&(s+='<button class="button button-small wpha-delete-btn" data-id="'+e.id+'" title="Delete">',s+='<span class="dashicons dashicons-trash"></span>',s+="</button> "),s+='<button class="button button-small wpha-ignore-btn" data-id="'+e.id+'" title="Ignore">',s+='<span class="dashicons dashicons-hidden"></span>',s+="</button>",s+="</td>",s+="</tr>"},renderDuplicates:function(t,e){var a=this,n=t.find(".wpha-duplicates-container"),r=(this.currentPages.duplicates-1)*this.itemsPerPage,i=r+this.itemsPerPage,s=e.slice(r,i);if(0!==s.length){var o=s.map(function(t){return a.renderDuplicateGroup(t)}).join("");n.html(o),this.lazyLoadPreviews(n)}else n.html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No duplicate groups found.")+"</div>")},renderDuplicateGroup:function(t){var e=this,a='<div class="wpha-duplicate-group">';return a+='<div class="wpha-duplicate-group-header">',a+="<h4>"+this.escapeHtml(t.filename||"Unnamed Group")+"</h4>",a+='<span class="wpha-duplicate-count">'+t.items.length+" duplicates • "+this.formatBytes(t.total_size)+"</span>",a+="</div>",a+='<div class="wpha-duplicate-items">',t.items.forEach(function(t,n){var r=e.selectedItems.duplicates.has(t.id),i=0===n,s=t.thumbnail||t.thumbnail_url||t.url||"";a+='<div class="wpha-duplicate-item" data-id="'+t.id+'">',a+='<div class="wpha-duplicate-item-preview">',a+=s?'<img class="wpha-lazy-preview" data-src="'+s+'" alt="" width="100" height="100" />':'<span class="dashicons dashicons-media-default"></span>',a+="</div>",a+='<div class="wpha-duplicate-item-info">',a+='<p class="wpha-duplicate-filename">'+e.escapeHtml(t.filename)+"</p>",a+='<p class="wpha-duplicate-meta">'+e.formatBytes(t.size||t.file_size||t.current_size||0)+" • "+e.formatDate(t.date)+"</p>",a+='<div class="wpha-duplicate-actions">',a+='<input type="checkbox" class="wpha-item-checkbox" data-id="'+t.id+'" '+(r?"checked":"")+" /> ",i&&(a+='<span class="wpha-badge wpha-badge-primary">Original</span>'),a+="</div>",a+="</div>",a+="</div>"}),a+="</div>",a+="</div>"},renderPagination:function(t,e,a){var n=t.find(".wpha-pagination-controls"),r=t.find(".wpha-showing-text"),i=this.currentPages[e],s=Math.ceil(a/this.itemsPerPage),o=(i-1)*this.itemsPerPage+1,c=Math.min(i*this.itemsPerPage,a),l="duplicates"===e?"groups":"items";if(r.text("Showing ".concat(o,"-").concat(c," of ").concat(a," ").concat(l)),s<=1)n.html("");else{var u="";u+='<button class="button wpha-page-btn" data-page="'+(i-1)+'" '+(1===i?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-left-alt2"></span>',u+="</button> ";var d=Math.max(1,i-Math.floor(2.5)),h=Math.min(s,d+5-1);h-d<4&&(d=Math.max(1,h-5+1)),d>1&&(u+='<button class="button wpha-page-btn" data-page="1">1</button> ',d>2&&(u+='<span class="wpha-page-dots">...</span> '));for(var p=d;p<=h;p++){u+='<button class="button wpha-page-btn'+(p===i?" button-primary":"")+'" data-page="'+p+'">'+p+"</button> "}h<s&&(h<s-1&&(u+='<span class="wpha-page-dots">...</span> '),u+='<button class="button wpha-page-btn" data-page="'+s+'">'+s+"</button> "),u+='<button class="button wpha-page-btn" data-page="'+(i+1)+'" '+(i===s?"disabled":"")+">",u+='<span class="dashicons dashicons-arrow-right-alt2"></span>',u+="</button>",n.html(u)}},updateBulkActions:function(t,e){var a=this.selectedItems[e].size>0;t.find(".wpha-bulk-action-select, .wpha-bulk-apply-btn").prop("disabled",!a)},handleRescan:function(t){var a=this;t.preventDefault();var n=e(t.currentTarget);n.prop("disabled")||(n.prop("disabled",!0).addClass("wpha-loading"),n.find(".dashicons").addClass("wpha-spin"),wp.apiFetch({path:"/wpha/v1/media/scan",method:"POST"}).then(function(t){t.success&&(Object.keys(a.dataCache).forEach(function(t){"stats"!==t&&(a.dataCache[t]=[])}),a.loadStats(),a.loadTabData(a.currentTab),a.showNotice("success",wpAdminHealthData.i18n.success||"Scan completed successfully."))}).catch(function(t){a.showNotice("error",wpAdminHealthData.i18n.error||"Scan failed.")}).finally(function(){n.prop("disabled",!1).removeClass("wpha-loading"),n.find(".dashicons").removeClass("wpha-spin")}))},handleSort:function(t){t.preventDefault();var a=e(t.currentTarget),n=a.data("sort"),r=this.currentTab,i=this.currentSort[r],s="desc";i.field===n&&(s="asc"===i.order?"desc":"asc"),this.currentSort[r]={field:n,order:s},a.siblings(".wpha-sortable").removeClass("wpha-sorted-asc wpha-sorted-desc").find(".dashicons").removeClass("dashicons-arrow-up dashicons-arrow-down").addClass("dashicons-sort"),a.addClass("asc"===s?"wpha-sorted-asc":"wpha-sorted-desc").find(".dashicons").removeClass("dashicons-sort").addClass("asc"===s?"dashicons-arrow-up":"dashicons-arrow-down"),this.renderTabData(r)},handleSearchFilter:function(t){var a=e(t.currentTarget),n=this.currentTab,r=a.val().trim();this.currentFilters[n].search=r,this.currentPages[n]=1,this.renderTabData(n)},handleTypeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters.unused.type=a,this.currentPages.unused=1,this.renderTabData("unused")},handleSizeFilter:function(t){var a=e(t.currentTarget).val();this.currentFilters["large-files"].size=a,this.currentPages["large-files"]=1,this.renderTabData("large-files")},handleSelectAll:function(t){var a=this,n=e(t.currentTarget).is(":checked"),r=this.currentTab,i=e('.wpha-tab-panel[data-tab="'.concat(r,'"]'));i.find(".wpha-item-checkbox").prop("checked",n).each(function(t,i){var s=e(i).data("id");n?a.selectedItems[r].add(s):a.selectedItems[r].delete(s)}),this.updateBulkActions(i,r)},handleItemSelect:function(t){var a=e(t.currentTarget),n=a.data("id"),r=a.is(":checked"),i=this.currentTab,s=e('.wpha-tab-panel[data-tab="'.concat(i,'"]'));r?this.selectedItems[i].add(n):this.selectedItems[i].delete(n),this.updateBulkActions(s,i)},handleBulkAction:function(t){t.preventDefault();var a=this.currentTab,n=e('.wpha-tab-panel[data-tab="'.concat(a,'"]')).find(".wpha-bulk-action-select").val(),r=Array.from(this.selectedItems[a]);if(n&&0!==r.length){var i="delete"===n?"Are you sure you want to delete "+r.length+" item(s)? This action cannot be undone.":"Are you sure you want to ignore "+r.length+" item(s)?";confirm(i)&&this.executeBulkAction(n,r,a)}},executeBulkAction:function(t,e,a){var n=this,r="delete"===t?"/wpha/v1/media/delete":"/wpha/v1/media/ignore";wp.apiFetch({path:r,method:"POST",data:{ids:e}}).then(function(t){t.success&&(n.dataCache[a]=n.dataCache[a].filter(function(t){return!e.includes(t.id)}),n.selectedItems[a].clear(),n.renderTabData(a),n.loadStats(),n.showNotice("success",t.data.message||"Action completed successfully."))}).catch(function(t){n.showNotice("error",wpAdminHealthData.i18n.error||"Action failed.")})},handleDelete:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");confirm("Are you sure you want to delete this item? This action cannot be undone.")&&this.executeBulkAction("delete",[a],this.currentTab)},handleIgnore:function(t){t.preventDefault();var a=e(t.currentTarget).data("id");this.executeBulkAction("ignore",[a],this.currentTab)},handlePageChange:function(t){t.preventDefault();var a=e(t.currentTarget);if(!a.prop("disabled")){var n=parseInt(a.data("page")),r=this.currentTab;this.currentPages[r]=n,this.renderTabData(r),e(".wpha-results-section")[0].scrollIntoView({behavior:"smooth",block:"start"})}},lazyLoadPreviews:function(t){t.find(".wpha-lazy-preview").each(function(t,a){var n=e(a),r=n.data("src");if(r){var i=new IntersectionObserver(function(t){t.forEach(function(t){t.isIntersecting&&(n.attr("src",r),i.unobserve(t.target))})});i.observe(a)}})},showEmptyState:function(t){t.find(".wpha-tab-panel-content").html('<div class="wpha-empty-state">'+(wpAdminHealthData.i18n.no_data||"No data available.")+"</div>")},showNotice:function(t,a){var n=e('<div class="notice notice-'+t+' is-dismissible"><p>'+a+"</p></div>");e(".wpha-media-audit-wrap h1").after(n),setTimeout(function(){n.fadeOut(function(){return n.remove()})},5e3)},formatBytes:function(t){if(0===t)return"0 Bytes";var e=Math.floor(Math.log(t)/Math.log(1024));return Math.round(t/Math.pow(1024,e)*100)/100+" "+["Bytes","KB","MB","GB"][e]},formatDate:function(t){if(!t)return"--";var e=new Date(t);return e.toLocaleDateString()+" "+e.toLocaleTimeString()},escapeHtml:function(t){var e={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return t.replace(/[&<>"']/g,function(t){return e[t]})},hideSkeletons:function(t){t.find('[class*="-skeleton"]').hide()}};e(document).ready(function(){e(".wpha-media-audit").length&&a.init()})}(jQuery)}},e={};function a(n){var r=e[n];if(void 0!==r)return r.exports;var i=e[n]={exports:{}};return t[n](i,i.exports,a),i.exports}a.n=t=>{var e=t&&t.__esModule?()=>t.default:()=>t;return a.d(e,{a:e}),e},a.d=(t,e)=>{for(var n in e)a.o(e,n)&&!a.o(t,n)&&Object.defineProperty(t,n,{enumerable:!0,get:e[n]})},a.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),(()=>{"use strict";var t=a(609),e=a.n(t),n=a(338),r=a(848);function i(t){return i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t},i(t)}function s(t,e){var a=Object.keys(t);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(t);e&&(n=n.filter(function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable})),a.push.apply(a,n)}return a}function o(t){for(var e=1;e<arguments.length;e++){var a=null!=arguments[e]?arguments[e]:{};e%2?s(Object(a),!0).forEach(function(e){c(t,e,a[e])}):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(a)):s(Object(a)).forEach(function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(a,e))})}return t}function c(t,e,a){return(e=function(t){var e=function(t,e){if("object"!=i(t)||!t)return t;var a=t[Symbol.toPrimitive];if(void 0!==a){var n=a.call(t,e||"default");if("object"!=i(n))return n;throw new TypeError("@@toPrimitive must return a primitive value.")}return("string"===e?String:Number)(t)}(t,"string");return"symbol"==i(e)?e:e+""}(e))in t?Object.defineProperty(t,e,{value:a,enumerable:!0,configurable:!0,writable:!0}):t[e]=a,t}function l(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var a=null==t?null:"undefined"!=typeof Symbol&&t[Symbol.iterator]||t["@@iterator"];if(null!=a){var n,r,i,s,o=[],c=!0,l=!1;try{if(i=(a=a.call(t)).next,0===e){if(Object(a)!==a)return;c=!1}else for(;!(c=(n=i.call(a)).done)&&(o.push(n.value),o.length!==e);c=!0);}catch(t){l=!0,r=t}finally{try{if(!c&&null!=a.return&&(s=a.return(),Object(s)!==s))return}finally{if(l)throw r}}return o}}(t,e)||function(t,e){if(t){if("string"==typeof t)return u(t,e);var a={}.toString.call(t).slice(8,-1);return"Object"===a&&t.constructor&&(a=t.constructor.name),"Map"===a||"Set"===a?Array.from(t):"Arguments"===a||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(a)?u(t,e):void 0}}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function u(t,e){(null==e||e>t.length)&&(e=t.length);for(var a=0,n=Array(e);a<e;a++)n[a]=t[a];return n}var d={up:"↑",down:"↓",neutral:"→"},h={up:"#d63638",down:"#00a32a",neutral:"#646970"};const p=function(t){var a=t.title,n=t.value,i=t.unit,s=void 0===i?"":i,c=t.trend,u=void 0===c?"neutral":c,p=t.trendValue,f=void 0===p?null:p,m=t.icon,b=void 0===m?"dashicons-chart-bar":m,v=t.onClick,w=void 0===v?null:v,g=["up","down","neutral"].includes(u)?u:"neutral",y=d[g],S=h[g],x=null!==f?"".concat(y," ").concat(f,"%"):y,P="".concat(a,": ").concat(n," ").concat(s).concat(null!==f?", trend ".concat(g," by ").concat(f," percent"):""),T="function"==typeof w,k={display:"flex",alignItems:"center",padding:"20px",backgroundColor:"#fff",border:"1px solid #c3c4c7",borderRadius:"4px",cursor:T?"pointer":"default",transition:"all 0.2s ease",outline:"none",minHeight:"100px"},O={fontSize:"14px",fontWeight:"600",color:S,marginLeft:"4px"},C=l(e().useState(!1),2),_=C[0],D=C[1];return(0,r.jsxs)("div",{className:"metric-card",role:T?"button":"article",tabIndex:T?0:void 0,"aria-label":P,onClick:T?w:void 0,onKeyPress:function(t){!T||"Enter"!==t.key&&" "!==t.key||(t.preventDefault(),w())},onMouseEnter:function(){return D(!0)},onMouseLeave:function(){return D(!1)},style:o(o({},k),_&&T?{boxShadow:"0 4px 8px rgba(0, 0, 0, 0.1)",transform:"translateY(-2px)",borderColor:"#2271b1"}:{}),children:[(0,r.jsx)("div",{style:{display:"flex",alignItems:"center",justifyContent:"center",width:"48px",height:"48px",marginRight:"16px",flexShrink:0},children:(0,r.jsx)("span",{className:"dashicons ".concat(b),style:{fontSize:"32px",width:"32px",height:"32px",color:"#2271b1"},"aria-hidden":"true"})}),(0,r.jsxs)("div",{style:{flex:1,minWidth:0},children:[(0,r.jsx)("h3",{style:{margin:"0 0 8px 0",fontSize:"14px",fontWeight:"600",color:"#1d2327",lineHeight:"1.4"},children:a}),(0,r.jsxs)("div",{style:{display:"flex",alignItems:"baseline",gap:"8px",flexWrap:"wrap"},children:[(0,r.jsx)("span",{style:{fontSize:"28px",fontWeight:"700",color:"#1d2327",lineHeight:"1.2"},children:n}),s&&(0,r.jsx)("span",{style:{fontSize:"14px",fontWeight:"400",color:"#646970",lineHeight:"1.2"},children:s}),null!==f&&(0,r.jsx)("span",{style:O,"aria-label":"Trend ".concat(g," by ").concat(f," percent"),children:x})]})]})]})};a(210),a(903);window.WPAdminHealthComponents=window.WPAdminHealthComponents||{},Object.assign(window.WPAdminHealthComponents,{MetricCard:p,React:e(),createRoot:n.H}),document.addEventListener("DOMContentLoaded",function(){})})()})();

thinking
**Investigating grep output**

I noticed that the `grep` command didn't show all results because the file is so huge that the output got truncated. It only printed the first line, even though there are many matches due to it being minified into one line. I can't see the actual path strings. I could try using `node` or `python`, but a better approach might be to use `rg -o` to extract the patterns. I'll try using `rg -o` to see what I can find!
exec
/bin/zsh -lc 'rg -o "media/(stats|unused|duplicates|large|alt-text|delete|restore|large-files|missing-alt)" assets/js/dist/media-audit.bundle.js | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
media/stats
media/unused
media/duplicates
media/large
media/missing-alt
media/delete

thinking
**Evaluating RestController spec**

I'm considering whether the Q06-01 spec about the RestController includes changes to the namespace. It seems like they might have switched from wp-admin-health/v1 to wpha/v1. If that's the case, then rebuilding the JavaScript might be necessary. However, I think the tasks are mainly focused on the review itself. So, I should check the assets in the js/dist/manifest or maybe look at the asset data, like `assets/js/dist/media-audit.asset.php` for dependencies. Let's see what I find!
exec
/bin/zsh -lc 'ls -la assets/js/dist | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 38ms:
total 1704
drwxr-xr-x@ 13 ahmedyounis  staff     416 Jan  7 14:44 .
drwxr-xr-x@ 12 ahmedyounis  staff     384 Jan 16 03:04 ..
-rw-r--r--@  1 ahmedyounis  staff     684 Jan 16 01:01 assets.php
-rw-r--r--@  1 ahmedyounis  staff   72073 Jan 16 01:01 dashboard.bundle.js
-rw-r--r--@  1 ahmedyounis  staff  202186 Jan 16 01:01 dashboard.bundle.js.map
-rw-r--r--@  1 ahmedyounis  staff   38425 Jan 16 01:01 database-health.bundle.js
-rw-r--r--@  1 ahmedyounis  staff  106647 Jan 16 01:01 database-health.bundle.js.map
-rw-r--r--@  1 ahmedyounis  staff   33661 Jan 16 01:01 media-audit.bundle.js
-rw-r--r--@  1 ahmedyounis  staff  102998 Jan 16 01:01 media-audit.bundle.js.map
-rw-r--r--@  1 ahmedyounis  staff   57811 Jan 16 01:01 performance.bundle.js
-rw-r--r--@  1 ahmedyounis  staff  167169 Jan 16 01:01 performance.bundle.js.map
-rw-r--r--@  1 ahmedyounis  staff   12668 Jan 16 01:01 settings.bundle.js
-rw-r--r--@  1 ahmedyounis  staff   45536 Jan 16 01:01 settings.bundle.js.map

thinking
**Inspecting namespace issues**

The dist bundles from January 16 show that they are recently built, so they're not outdated. It seems like the JavaScript namespace 'wp-admin-health/v1' could be intentional, while PHP might not be matching correctly—possibly due to a configurable namespace. The `RestController` shows the namespace as `wpha/v1`, and the plugin might be WP Admin Health. I'll look into the JavaScript source for the API wrapper to understand what namespace they intended, searching in the assets for "wp-admin-health/v1" with rg.
exec
/bin/zsh -lc 'rg -n "wp-admin-health/v1" assets/js | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 55ms:
assets/js/admin.js:42:		namespace: 'wp-admin-health/v1',
exec
/bin/zsh -lc "sed -n '1,120p' assets/js/admin.js" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 50ms:
/**
 * Admin JavaScript - Core
 *
 * Core admin JavaScript for WP Admin Health Suite.
 * Provides utilities, API wrapper, notifications, event system, and error handling.
 *
 * @param window
 * @param $
 * @package
 */

(function (window, $) {
	'use strict';

	// Ensure wp.apiFetch is available
	const apiFetch = window.wp && window.wp.apiFetch;
	if (!apiFetch) {
		console.error(
			'wp.apiFetch is not available. Admin functionality may be limited.'
		);



thinking
**Examining namespace issues**

I've noticed that JavaScript is using the namespace 'wp-admin-health/v1', which should be consistent with PHP controllers too. However, they're currently using 'wpha/v1', suggesting a mismatch that might break the plugin. I wonder if the `RestController` base class should adopt 'wp-admin-health/v1' instead of 'wpha/v1', but that’s what it is now. The Q06-01 review might have opened up changes here, yet the tasks.csv confirms the endpoints as /wpha/v1/. So, maybe the API wrapper should reflect this.
thinking
**Reflecting on implementation details**

I realize that while the current task is to implement Q06-04, there may have been earlier changes in PHP that didn’t affect the JavaScript. The controllers need to match the spec, which uses 'wpha/v1'. I’m also considering that Q06-04 might involve adding endpoints like /media/missing-alt and /wp-admin-health/v1, but the spec doesn't mention this. Since tasks.csv uses 'wpha/v1', I think PHP controllers should align there. Updating JS might help the UI function properly, though the user hasn't specifically requested that. However, aligning both could ensure everything works smoothly together.
thinking
**Investigating namespace compatibility**

I’m looking into the repository tasks for implementing Q06-04. It might be necessary to adjust the controllers to support both namespaces for backward compatibility while migrating JavaScript. I want to verify if other JavaScript uses the same namespace and if the PHP controllers still use 'wpha/v1'. A mismatch across the plugin would be quite significant. I’m considering whether there’s an API router that registers with both namespaces. I’ll search the plugin for the "wp-admin-health/v1" string in PHP to see if there’s a constant or filter related to this.
exec
/bin/zsh -lc 'rg -n "wp-admin-health" includes | head -n 80' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 54ms:
includes/Media/AltTextChecker.php:575:					'wp-admin-health-suite'
includes/Media/AltTextChecker.php:584:				'wp-admin-health-suite'
includes/Media/AltTextChecker.php:591:				'wp-admin-health-suite'
includes/Media/AltTextChecker.php:598:				'wp-admin-health-suite'
includes/REST/Media/MediaScanController.php:106:					'message' => __( 'Media scan has been scheduled to run in the background.', 'wp-admin-health-suite' ),
includes/REST/Media/MediaScanController.php:108:				__( 'Media scan scheduled successfully.', 'wp-admin-health-suite' )
includes/REST/Media/MediaScanController.php:121:			__( 'Media scan completed successfully.', 'wp-admin-health-suite' )
includes/Integrations/AbstractIntegration.php:328:			__( 'WP Admin Health Suite: %1$s integration requires version %3$s or higher. Current version: %2$s', 'wp-admin-health-suite' ),
includes/Integrations/AbstractIntegration.php:330:			$this->get_current_version() ?? __( 'unknown', 'wp-admin-health-suite' ),
includes/Integrations/AbstractIntegration.php:359:			__( 'WP Admin Health Suite: %1$s %2$s reached safety limit after processing %3$d rows (%4$d batches of %5$d). Results may be incomplete for very large sites.', 'wp-admin-health-suite' ),
includes/REST/Media/MediaAltTextController.php:139:			__( 'Images missing alt text retrieved successfully.', 'wp-admin-health-suite' )
includes/REST/Media/MediaAltTextController.php:153:				'description'       => __( 'Cursor for pagination (offset).', 'wp-admin-health-suite' ),
includes/REST/Media/MediaAltTextController.php:161:				'description'       => __( 'Number of items per page.', 'wp-admin-health-suite' ),
includes/Integrations/Elementor.php:508:					__( 'Found %d Elementor CSS cache entries. Clearing and regenerating may improve performance.', 'wp-admin-health-suite' ),
includes/Integrations/Elementor.php:525:					__( 'Found %d orphaned Elementor meta entries. These can be safely removed.', 'wp-admin-health-suite' ),
includes/Multisite.php:75:			__( 'Admin Health Network', 'wp-admin-health-suite' ),
includes/Multisite.php:76:			__( 'Admin Health', 'wp-admin-health-suite' ),
includes/Multisite.php:86:			__( 'Network Dashboard', 'wp-admin-health-suite' ),
includes/Multisite.php:87:			__( 'Dashboard', 'wp-admin-health-suite' ),
includes/Multisite.php:95:			__( 'Network Settings', 'wp-admin-health-suite' ),
exec
/bin/zsh -lc "rg -o \"namespace:\\\"["'^'"\\\"]+\\\"\" assets/js/dist/*.bundle.js | head -n 20" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
assets/js/dist/media-audit.bundle.js:namespace:"wp-admin-health/v1"
assets/js/dist/settings.bundle.js:namespace:"wp-admin-health/v1"
assets/js/dist/database-health.bundle.js:namespace:"wp-admin-health/v1"
assets/js/dist/performance.bundle.js:namespace:"wp-admin-health/v1"
assets/js/dist/dashboard.bundle.js:namespace:"wp-admin-health/v1"



thinking
**Reviewing namespace issues**

I'm examining the bundles which use the namespace "wp-admin-health/v1," suggesting that this should be the correct REST namespace instead of "wpha/v1." If I'm right, it implies the PHP controllers might be wrong, causing UI issues. I see that tasks and documentation might have outdated information. I wonder if the Q06 tasks include reviewing controllers after the namespace change. I’ll need to figure out which namespace we should support while adhering to specifications for security and error handling.
thinking
**Assessing namespace requirements**

I’m considering whether we actually need to adjust the namespace. For the plugin to work, it must align with the JavaScript. However, it seems like the plugin isn't functioning correctly yet. The documentation points to a mismatch since it uses "wpha/v1" instead of "wp-admin-health/v1." I wonder if there are two sets of endpoints. Changing the PHP namespace could impact all controllers, and I’m unsure if that’s what the repository expects given the earlier tasks. I need to verify if the Q06-01 spec has been implemented.
thinking
**Reviewing task sequence**

I’m currently focused on task Q06-04, but I’m considering if tasks Q06-01, Q06-02, Q06-03, and Q06-04 are sequential reviews. It’s possible that previous agents have implemented some or all of these. For instance, I know Claude made changes for Q06-03. Now, I should check the handoff documents for Q06-01 and Q06-02 to see what changes were made. I'll open the files in the handoff directory to gather more details.
exec
/bin/zsh -lc "sed -n '1,240p' .t2/handoff/Q06-01.md 2>/dev/null || true" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
# Handoff: Q06-01

Created: 2026-01-16T17:04:12.526549Z

Spec: .plans/Q06-01.md


## 2026-01-16T17:07:18.167093Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task Q06-01 in this git repository.

1) Read the spec: .plans/Q06-01.md
2) Read handoff/context: .t2/handoff/Q06-01.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
exec
/bin/zsh -lc "sed -n '1,240p' .t2/handoff/Q06-02.md 2>/dev/null || true" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
# Handoff: Q06-02

Created: 2026-01-16T17:07:23.289168Z

Spec: .plans/Q06-02.md


## 2026-01-16T17:11:23.964008Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task Q06-02 in this git repository.

1) Read the spec: .plans/Q06-02.md
2) Read handoff/context: .t2/handoff/Q06-02.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 







thinking
**Evaluating code modifications**

It looks like Q06-01 and Q06-02 were implemented with multiple files modified, like MediaController.php and MediaCleanupController.php. However, our current git status doesn’t show them as modified, which means those changes might have been committed already or the snapshot is outdated. Only ExclusionsInterface and state are modified now. RestController was adjusted for docblock formatting, and I wonder if our earlier version already includes their changes. The Q06 tasks involved minor changes, but they didn’t address the namespace mismatch, so I think we still need to implement Q06-04 and check the codebase for any issues.
thinking
**Inspecting media controller issues**

I've found some details: the function `get_unused` uses `scan_unused_media` based on the total media count instead of just the unused count, which doesn’t align with the documentation. The spec mentions verifying proper pagination, so that needs addressing. Also, we have new controllers, but the spec says to review them too, so changes are needed on both old and new.

MediaController and MediaCleanupController don’t check for safe mode during destructive operations. MediaCleanupController is a new controller for deletions, and while there’s a permissions check in place, it’s concerning that safe mode isn't verified. We should implement that in `safe_delete`. Lastly, exclusions might be affected, as the `safe_delete` methods filter excluded IDs, likely querying the database for each call.
thinking
**Revising MediaController details**

It may feel a bit heavy, but here’s what I found. The `safe_delete` method in MediaController has a messed-up docblock indentation that needs fixing. Also, the `get_attachment_details` method in both MediaHelper and MediaController doesn't validate the upload path, so we'll need to address that too.

Now, about the `/missing-alt` route alias—it wasn't mentioned in the spec concerning safe mode or the alias. Reviewing the commit from Q06-01 shows they only fixed docblock indentations, which is not relevant to our discussion.

For Q06-04, the tasks for Media Audit REST endpoints state that all endpoints should paginate correctly and that processes like delete/restore should work reliably. The current controllers for `/large`, `/duplicates`, and `/alt-text paginate correctly, while `/unused` uses `scan_unused_media`, which might lead to incorrect total attachments. Additionally, `/stats` counts the first 1,000 attachments, which might not be accurate. We should revise `/unused` for correct pagination and consider how `/stats` computes the unused count based on `/unused` totals, but that could be quite complex.
thinking
**Considering scan alternatives**

I’m exploring an alternative approach: using `scan_unused_media` to scan all attachments while still returning the unused list and total unused count. I could compute the unused count by scanning attachments in batches, but the concern is that scanning everything might time out. Using `scanner->find_unused_media` might also lead to timeouts, but it could be acceptable since this is for an audit endpoint. 

The user could trigger the scan, but a RESTful call from the UI might not handle timing well. We could consider a background scan for the unused count, but the current scan task doesn’t account for that and might be out of scope. So, we could leave the unused count approximate and focus on ensuring proper pagination by using cursor/per_page parameters consistently and confirming that the output includes has_more and cursor, which seems to be the case now.
thinking
**Addressing media controller enhancements**

We need to verify and address any issues I found in the MediaController. For `get_attachment_details`, it should validate the upload path, and we need to ensure safe delete operations incorporate safe mode, returning a `WP_Error` with appropriate status codes. 

Moreover, the `safe_delete` method should check that each ID being deleted is indeed an attachment, and we might want to implement additional input validation. We also need to look at pagination for the `/unused` endpoint to ensure it aligns with documentation. 

To efficiently manage unused media IDs, we could implement a caching mechanism in transients to store and reuse these IDs, ultimately reducing the need for repeated heavy scanning. Also, we should include file path validation and enhance error handling for invalid parameters. Overall, it seems like we’re on the right track, focusing on proper validation, handling pagination, and improving performance where necessary.
thinking
**Implementing pagination and security**

We can enhance pagination for the `/unused` endpoint by collecting unused IDs first, ensuring the UI can handle more efficient server-side pagination. Currently, the endpoint scans a limited number of attachments each time, which may lead to incomplete results. It's important to cache these unused IDs for better performance, as implemented in other endpoints.

We should also optimize the `/stats` endpoint by leveraging the cached unused list if available, thus providing accurate counts after a user visits `/unused`. Moreover, for security, we need to update the `safe_delete` methods to strip sensitive file paths from API responses, maintaining only essential IDs. Overall, adhering to best practices for validation and caching will streamline performance and security while minimizing potential issues in the system.
thinking
**Improving error handling and file security**

I’m focusing on restoring media error handling for the `safe_delete` and ensuring it returns appropriate responses. For example, it might be better to return a 404 instead of a 400 when a record isn’t found, although that’s not strictly necessary.

For file operations, I'll verify the upload path before computing the filename and size. If the path is invalid, setting the filename as an empty string is a good approach. I could extract the filename from the URL safely instead of exposing local paths. Lastly, implementing pagination for unused media requires checking if the scanning methods support this correctly.
exec
/bin/zsh -lc "sed -n '1,120p' includes/Contracts/ScannerInterface.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 44ms:
<?php
/**
 * Scanner Interface
 *
 * Contract for media scanning operations.
 *
 * @package WPAdminHealth\Contracts
 */

namespace WPAdminHealth\Contracts;

// Exit if accessed directly.
if ( ! defined( 'ABSPATH' ) ) {
	die;
}

/**
 * Interface ScannerInterface
 *
 * Defines the contract for media scanning operations.





thinking
**Analyzing media scanning methods**

I'm noticing that ScannerInterface has the scan_unused_media method but lacks find_unused_media. This means controllers can access scan_unused_media and get_media_summary, which utilizes find_unused_media internally. Maybe we can use get_media_summary for the unused_count. For pagination, we might need to repeatedly call scan_unused_media to gather IDs of unused attachments, which could be a bit intensive. However, get_media_summary seems only to provide counts, not the full list of unused attachments. I need to consider how to implement this effectively for the /unused endpoint.
thinking
**Considering pagination improvements**

I’m thinking about how to implement better pagination with scan_unused_media by repeatedly scanning until we fill a page with unused items. However, scanning uses an offset into attachments, not directly into unused ones. I could interpret the cursor parameter as an offset into the scanned attachments, which aligns with the current implementation. The documentation expects this offset to refer to unused items, though. Proper pagination requires that the cursor is an integer and has_more is determined correctly, but there are issues here. I might need to adjust the response keys for clarity.
thinking
**Examining scan logic and pagination**

I'm considering the possibility of including scanned and memory-limited counts for better information, but I'm wondering about the specs. The scan_unused_media return does include a scanned count, which indicates the number of attachments processed and can show scanning progress. The controller uses this as the next_cursor, which seems correct, but they don't return this count separately. Now, they set total to scan_result['total'], which represents total attachments. So, in the scanning model, total attachments seem valid, but I need to ensure that the /unused endpoint properly reflects the list of unused attachments.
thinking
**Evaluating scanning and pagination logic**

I'm wondering if they intentionally didn't compute the total unused to avoid extensive scanning, suggesting we should keep the current implementation. The spec might be focusing on other areas, like file operation security. However, it does mention pagination. I'm also thinking about possible pagination issues, like duplicates. They don't seem to include per_page or cursor input properly; in some cases, the cursor is defaulting to 0 but returning a string. There could be a bug in the duplicates endpoint regarding total counts and how has_more is computed for large datasets.
thinking
**Reviewing file operations and alt text handling**

I'm considering scenarios for handling total and pagination in alt_text_checker, like if total is 1000 and cursor is 950, that should work as expected. But error handling needs attention; incorporating safe_mode might be useful. For secure file operations during safe deletes, I need to ensure path sanitization to prevent issues. Also, looking into MediaCleanupController for sanitizing IDs and refining error handling is important. I'm noticing that alt_text_checker's return keys may not match what the controller expects, which seems like a possible mismatch to clarify further. Next, I'll dig deeper into the code to confirm these details.
exec
/bin/zsh -lc "rg -n \"function get_alt_text_coverage\" -n includes/Media/AltTextChecker.php && sed -n '300,380p' includes/Media/AltTextChecker.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
320:	public function get_alt_text_coverage(): array {
					$translated_alt  = get_post_meta( $translation_id, '_wp_attachment_image_alt', true );
					$result[ $lang ] = $translated_alt ? $translated_alt : '';
				}
			}
		}

		return $result;
	}

	/**
	 * Get alt text coverage percentage.
	 *
	 * Returns the percentage of images with alt text.
	 * Decorative images are excluded from the total count.
	 *
	 * @since 1.0.0
	 * @since 1.4.0 Added decorative image exclusion from total count.
	 *
	 * @return array Array with coverage statistics.
exec
/bin/zsh -lc "sed -n '380,520p' includes/Media/AltTextChecker.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
			INNER JOIN {$postmeta_table} pm ON p.ID = pm.post_id
			WHERE p.post_type = %s
			AND p.post_mime_type LIKE %s
			AND pm.meta_key = %s
			AND pm.meta_value != ''",
			'attachment',
			'image/%',
			'_wp_attachment_image_alt'
		);

		$images_with_alt = 0;
		if ( null !== $images_with_alt_query ) {
			$images_with_alt = absint( $this->connection->get_var( $images_with_alt_query ) );
		}

		// Subtract decorative images that may also have alt text from the with_alt count.
		// (Decorative images should not contribute to coverage percentage).
		$images_with_alt     = max( 0, $images_with_alt - $decorative_images );
		$images_without_alt  = max( 0, $effective_total - $images_with_alt );
		$coverage_percentage = ( $effective_total > 0 )
Plan update
Identified improvements for Media REST controllers: tighten file-path handling when reading attachment details, respect safe mode for destructive endpoints, and harden ID sanitization/response payloads.
  ✓ Read spec and handoff docs
  ✓ Inspect codebase and locate changes
  → Implement Q06-04 changes
  • Run lint and tests
  • Summarize and provide verification





thinking
**Planning file updates**

I'm going to implement several changes across different files. For `MediaHelper.php`, I’ll add upload path validation and safe filename logic. In `MediaController.php`, I’ll update functions like `get_attachment_details`, `sanitize_ids`, and ensure the `safe_delete` and `restore_media` methods respect safe mode. 

I’ll also check for duplications in `MediaCleanupController.php` and make necessary adjustments. Lastly, I’m considering a response tweak in `MediaAnalysisController.php` but may opt against it since it's not essential. Time to move forward with these updates!
thinking
**Clarifying route mappings**

Okay, I see that the compiled JavaScript expects the `/media/missing-alt` route, while the MediaController registers `/media/alt-text`. This could create issues if the UI calls for missing-alt but doesn’t find it. While the namespace mismatch is something to consider, I think it's wise to add an alias for `/media/missing-alt` in the controllers. This feels like an important part of the media audit endpoints. 

Also, there's a potential need for an alias for `/media/large-files`, but I need to check the dist files to confirm if it uses that naming.
thinking
**Planning MediaHelper modifications**

Alright, to support both functionalities, I’ll add an alias for `/media/missing-alt`, which seems like a small but necessary change. I’m also considering adding an alias for `/media/large-files` to map to `get_large`. Although the dist may not need this addition, it might still be useful to have.

Now, I need to proceed with implementing modifications carefully using `apply_patch` while ensuring consistency with PHP code style. I plan to open `MediaHelper.php` because it's a small file, and we’ll make necessary updates there. Alright, time to get started!
thinking
**Reviewing MediaHelper pseudocode**

I've created a pseudocode outline for the `MediaHelper` class, which includes a private static property for `$uploads_basedir`. The method `get_uploads_basedir()` checks for this base directory, using WordPress's `wp_upload_dir()` function.

Then, I have a method called `is_valid_upload_path()`, which verifies whether a given file path is valid by checking it against the base upload path. However, I've used `realpath`, which resolves symlinks, and I need to consider how that may influence the validity checks. This feels like a solid start for the implementation!
thinking
**Refining attachment details in MediaController**

I'm thinking about handling Windows directory separators and considering using WordPress's `wp_normalize_path` or a combination of `wp_upload_dir()` and `realpath` with `str_replace`. I want to follow the pattern established in `LargeFiles::is_valid_upload_path`. 

For the `get_attachment_details` function, I’ll ensure that we validate paths and handle any errors from `wp_upload_dir()`. If the file path is invalid and the URL isn't available, I’ll set the filename to an empty string to avoid exposing sensitive information. I'll also adjust the computation order in return arrays to ensure URLs are processed before thumbnails.

Finally, regarding the logic in `MediaController`, I'll explore the idea of calling `MediaHelper::get_attachment_details`, but first, I need to confirm how classes are loaded in `autoload.php`.
exec
/bin/zsh -lc "sed -n '1,220p' includes/autoload.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 42ms:
<?php
/**
 * PSR-4 Autoloader for WP Admin Health Suite
 *
 * Implements PSR-4 autoloading with the following namespace mapping:
 * - WPAdminHealth\ -> includes/
 *
 * Directory structure must match namespace casing:
 * - WPAdminHealth\Database\ -> includes/Database/
 * - WPAdminHealth\Media\ -> includes/Media/
 * - WPAdminHealth\REST\ -> includes/REST/
 * etc.
 *
 * @package WPAdminHealth
 * @since 1.0.0
 */

namespace WPAdminHealth;

// Exit if accessed directly.





thinking
**Refactoring MediaController**

I’m considering replacing MediaController's method with `return MediaHelper::get_attachment_details( (int)$attachment_id );`, but I realize MediaController is in a different namespace, so I’d need to import it. While I could do that, it would lose the validation improvements we’ve added to the helper. 

I must also make sure that MediaController doesn’t cause autoloading loops. Since it’s in the `WPAdminHealth\REST` namespace and MediaHelper is in `WPAdminHealth\REST\Media`, I believe it can be autoloaded. Overall, using the helper reduces code duplication, but I’m weighing that against the desire to keep things minimal.
thinking
**Implementing MediaHelper Integration**

I’m looking at MediaHelper's method, which expects an int, so I need to cast when calling it within my method. Here’s how I’ll implement it:

```php
use WPAdminHealth\REST\Media\MediaHelper;

private function get_attachment_details($attachment_id) {
    return MediaHelper::get_attachment_details((int) $attachment_id);
}
```

This approach simplifies the method by utilizing the helper, which is clean. I confirm that MediaController is in the same namespace and checked the autoloader situation — it seems prepared for MediaHelper. I also need to ensure there are no name conflicts; it looks fine on that front. Next, I’ll implement safe mode for safe_delete and restore_media in MediaController.
thinking
**Implementing Safe Mode for Delete Functionality**

I’m working on the methods that currently call the safe_delete service. I’ll implement it following this outline. First, I’ll set up a pseudo safe_delete method:

```php
public function safe_delete($request) {
    $ids = $request->get_param('ids');
    if (...) return error;
    $safe_mode = $this->is_safe_mode_enabled();
    // Filter excluded items as I’ve done previously.
    if (empty($ids_to_delete)) return error;

    if ($safe_mode) {
        $preview_items = [];
        foreach ($ids_to_delete as $id) {
            $preview_items[] = [
                'attachment_id' => (int) $id,
                'details' => $this->get_attachment_details($id), // maybe?
```

This structure allows me to safely handle deletions while accommodating preview items. I need to finalize the error handling and implement exclusions properly.
thinking
**Finalizing Safe Delete Method**

I’m wrapping up the safe_delete method logic. Right now, I notice there's some duplication in the details when preparing the preview. I’ll build a preview array with parameters, like safe_mode enabled and listing out the IDs to delete. 

For messaging, I’m considering appending something like, "Safe mode enabled. No files were moved to trash." When safe_mode is on, I think I should also avoid logging activity, but I should clarify that the safe_delete method currently logs activity even when it’s destructive. I’ll need to make sure to address that in my implementation.
thinking
**Updating Media Handling Functions**

I need to address how filter_excluded handles numeric strings in the safe_delete function. I’ll also update MediaCleanupController's safe_delete and restore_media for safe mode by removing file paths as necessary. Additionally, I want to adjust the get_attachment_details method in MediaController to rely on MediaHelper, making sure to import it at the top.

Moreover, I might optimize the code by using MediaHelper::get_attachment_details_batch for larger endpoints, though that's mainly for performance. As for security, I need to ensure that MediaHelper's batch method properly validates upload paths. 

Now I’ll implement patches, starting with MediaHelper.php, where I’ll add static properties and methods. While I’m not sure about the exact plugin version annotations, I think I’ll use `@since 1.6.0` for consistency, as I suspect the current version is 1.6. Let’s restructure get_attachment_details in the patch!
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Media/MediaHelper.php
@@ -24,2 +24,72 @@
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
@@ -35,11 +105,21 @@
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
@@ -50,8 +130,3 @@
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
apply_patch(auto_approved=true) exited 0 in 22ms:
Success. Updated the following files:
M includes/REST/Media/MediaHelper.php
file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,

file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,

exec
/bin/zsh -lc "sed -n '1,60p' includes/REST/MediaController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
<?php
/**
 * Media REST Controller
 *
 * @package WPAdminHealth
 */

namespace WPAdminHealth\REST;

use WP_REST_Request;
use WP_REST_Response;
use WP_Error;
use WPAdminHealth\Contracts\ConnectionInterface;
use WPAdminHealth\Contracts\SettingsInterface;
use WPAdminHealth\Contracts\ScannerInterface;
use WPAdminHealth\Contracts\DuplicateDetectorInterface;
use WPAdminHealth\Contracts\LargeFilesInterface;
use WPAdminHealth\Contracts\AltTextCheckerInterface;
use WPAdminHealth\Contracts\ReferenceFinderInterface;
use WPAdminHealth\Contracts\SafeDeleteInterface;
file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,



thinking
**Modifying restore media method**

I'm looking to tweak the `restore_media` method. Currently, it gets the deletion ID and attempts to restore it. If the restoration fails, it returns an error. 

I want to add a check for whether safe mode is enabled. If it is, I’ll create a preview response indicating that no files were restored. 

I think about validating that the deletion ID exists, but that might not be necessary. I also need to ensure logging isn't disrupted. That’s a consideration as I implement changes.
thinking
**Refining media methods**

I'm looking to adjust the `restore_deleted` method to ensure it expects an integer for `$deletion_id`, and the `absint` callback helps with that. I suppose I could also just cast it if necessary.

Next, I want to simplify the `get_attachment_details` function by calling `MediaHelper` directly to avoid duplicate logic. I'll keep the function straightforward and efficient.

I should also update the documentation to reflect that the parameter is an integer, although that's not strictly necessary. Lastly, I need to make sure that `MediaController` uses the `MediaHelper` class properly.
file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/MediaController.php
@@ -21,2 +21,3 @@
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
@@ -246,2 +247,16 @@
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
@@ -699,2 +714,4 @@
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
@@ -718,4 +735,55 @@
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
@@ -723,2 +791,3 @@
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
@@ -765,2 +834,21 @@
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
@@ -794,42 +882,3 @@
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
@@ -876,3 +925,6 @@
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
apply_patch(auto_approved=true) exited 0 in 32ms:
Success. Updated the following files:
M includes/REST/MediaController.php
file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Considering route registration**

I'm thinking about registering an additional route like we did in MediaController, and it seems fine. I wonder if we should handle the large-files alias too. The spec didn't mention it, but adding it in the old controller could be sufficient. For completeness, I should consider whether to add the alias in MediaAltTextController as well. It’s a small change, but I’m hesitant about duplicating the alias. Let’s figure that out. Now, I want to patch MediaCleanupController and check the context around the safe_delete method.
exec
/bin/zsh -lc "rg -n \"public function safe_delete\" -n includes/REST/Media/MediaCleanupController.php && sed -n '200,340p' includes/REST/Media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 53ms:
218:	public function safe_delete( $request ) {
				array(
					'methods'             => \WP_REST_Server::DELETABLE,
					'callback'            => array( $this, 'clear_exclusions' ),
					'permission_callback' => array( $this, 'check_permissions' ),
				),
			)
		);
	}

	/**
	 * Safe delete selected media items.
	 *
	 * @since 1.0.0
	 * @since 1.3.0 Moved to MediaCleanupController.
	 *
	 * @param WP_REST_Request $request Full details about the request.
	 * @return WP_REST_Response|WP_Error Response object on success, or WP_Error object on failure.
	 */
	public function safe_delete( $request ) {
file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Updating methods**

I'm thinking about the safe_delete and restore_media functions. I want to add a safe_mode option that acts similarly. It’s important to strip the file_path while doing that. I'll also update the sanitize_ids method sometime later. My plan is to ensure that the sanitize_ids function is located at the bottom for easy access. Just need to keep everything organized as I make these modifications!
exec
/bin/zsh -lc "rg -n \"function sanitize_ids\" includes/REST/Media/MediaCleanupController.php && sed -n '440,520p' includes/REST/Media/MediaCleanupController.php" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 37ms:
466:	public function sanitize_ids( $value ): array {
		if ( ! $success ) {
			return $this->format_error_response(
				new WP_Error(
					'clear_failed',
					__( 'Failed to clear exclusions.', 'wp-admin-health-suite' )
				),
				400
			);
		}

		return $this->format_response(
			true,
			array(),
			__( 'All exclusions cleared successfully.', 'wp-admin-health-suite' )
		);
	}

	/**
	 * Sanitize IDs array.
file update:
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Media/MediaCleanupController.php
@@ -230,2 +230,4 @@
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
@@ -249,4 +251,55 @@
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
@@ -254,2 +307,3 @@
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
@@ -297,2 +351,21 @@
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
@@ -470,3 +543,6 @@
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
apply_patch(auto_approved=true) exited 0 in 41ms:
Success. Updated the following files:
M includes/REST/Media/MediaCleanupController.php
file update:
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

file update:
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

file update
M /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/includes/REST/Media/MediaAltTextController.php
@@ -93,2 +93,16 @@
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
apply_patch(auto_approved=true) exited 0 in 50ms:
Success. Updated the following files:
M includes/REST/Media/MediaAltTextController.php
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**






thinking
**Evaluating route registration risks**

I’m looking at the potential for duplicate route registration when using the old MediaController along with possible future additions like MediaAltTextController. Currently, only MediaController routes are being registered. However, if both controllers are registered later, it could lead to collisions. WordPress might merge or let the last route registered win. I want to be cautious about conflicts, especially since duplicate base endpoints like /media/alt-text could cause significant issues.
thinking
**Updating route and method validations**

I'm relieved that alias duplication isn't an additional issue. We’ve made some changes to MediaHelper, which is used by MediaAnalysisController, and now I need to update safe delete endpoints in both MediaCleanupController and MediaController. Regarding safe mode for exclusion operations, we haven't implemented that yet, which is okay. I want to make sure there are no syntax errors in the code. 

Now, the MediaHelper class validates file paths via `get_attachment_details`. I also need to think about handling potential issues with `wp_upload_dir` and `realpath` that could lead to double separators, particularly with how we're using the `strpos` function.
thinking
**Addressing file path consistency**

I’m considering how to handle file paths and the directory separator in my code. If `real_path` matches `uploads_basedir`, that's fine, but I need to ensure that file paths start correctly. I know Windows uses `\` as a directory separator, while my code uses `DIRECTORY_SEPARATOR`. That might lead to issues if `realpath` returns a backslash and the base directory has different slashes. 

My comparison method could fail due to these inconsistencies, so maybe I should think about using `wp_normalize_path` to enhance reliability. For now, I'm fine with how the safe mode preview response is set, and MediaController's preview success key setup looks good too.
thinking
**Ensuring safe file handling**

I need to check the translation for the message `'Safe mode enabled. No files were moved to trash.'`, which is using the correct textdomain. I've added comments about not exposing absolute file paths via REST responses.

In the `safe_delete` process, we've ensured that `file_path` is stripped. It seems that prepared items might still include this in the metadata, but we removed it from API output. It's noted that while `safe_delete` sets the original `file_path` in the database, the returned results do not include it, so it seems safe. Still, is `file_path` considered sensitive? Hmm, that might be worth reflecting on.
thinking
**Finalizing updates and testing**

I’m updating the `safe_delete` message to ensure that if the result array doesn’t contain a message, it gets set to an empty string before appending the excluded string. If the result's success is false, it'll return a message that might now exclude the original, but that feels fine. 

We’ve also adjusted `sanitize_ids` to remove duplicates and zeros which could change behaviors. I want to ensure method type hints remain correct, and perhaps update MediaAnalysisController and MediaController to use safe attachment details. I’m planning to run lint and tests after these modifications, but first, I'll check the PHP syntax quickly with `php -l` for any errors in the modified files before proceeding with the npm commands.
exec
/bin/zsh -lc 'php -l includes/REST/MediaController.php && php -l includes/REST/Media/MediaHelper.php && php -l includes/REST/Media/MediaCleanupController.php && php -l includes/REST/Media/MediaAltTextController.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 221ms:
No syntax errors detected in includes/REST/MediaController.php
No syntax errors detected in includes/REST/Media/MediaHelper.php
No syntax errors detected in includes/REST/Media/MediaCleanupController.php
No syntax errors detected in includes/REST/Media/MediaAltTextController.php
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Updating implementation steps**

I’m noting that I've included file size considerations and updated the MediaAnalysisController and MediaController for safe deletion. Now, I think it’s time to proceed to tests. I'll update the plan accordingly: the implementation step is done, and now I'm running lint and tests. This part is crucial to ensure everything works smoothly! I want to make sure there are no issues going forward.
Plan update
Implemented security and safe-mode hardening across Media REST controllers and shared MediaHelper; next run the repository’s lint and test commands.
  ✓ Read spec and handoff docs
  ✓ Inspect codebase and locate changes
  ✓ Implement Q06-04 changes
  → Run lint and tests
  • Summarize and provide verification
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

exec
/bin/zsh -lc 'npm run lint' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 2.20s:

> wp-admin-health-suite@1.0.0 lint
> eslint assets/js --ext .js,.jsx


/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/admin.js
    7:1  warning  Missing JSDoc @param "window" type    jsdoc/require-param-type
    8:1  warning  Missing JSDoc @param "$" type         jsdoc/require-param-type
  276:1  warning  Missing JSDoc @param "message" type   jsdoc/require-param-type
  277:1  warning  Missing JSDoc @param "duration" type  jsdoc/require-param-type

/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/charts.js
  7:1  warning  Missing JSDoc @param "window" type  jsdoc/require-param-type
  8:1  warning  Missing JSDoc @param "$" type       jsdoc/require-param-type

/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/components/HealthScoreCircle.jsx
  31:30  warning  'score' is missing in props validation    react/prop-types
  31:41  warning  'grade' is missing in props validation    react/prop-types
  31:54  warning  'loading' is missing in props validation  react/prop-types
  57:1   warning  Missing JSDoc @param "timestamp" type     jsdoc/require-param-type
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
It looks like the linting process has completed successfully, which is a relief! I only got some warnings, but at least there’s no major issues since the exit code is 0. Now, it’s time to move on to running the tests with npm. I hope everything passes smoothly! It’s always a bit nerve-wracking when you’re not sure what to expect, but I’m feeling optimistic about it. Let's see how the tests go!
exec
/bin/zsh -lc 'npm test' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 1.61s:

> wp-admin-health-suite@1.0.0 test
> jest --passWithNoTests

PASS assets/js/components/QuickActions.test.jsx
PASS assets/js/components/ActivityTimeline.test.jsx
  ● Console

    console.error
      Warning: An update to ActivityTimeline inside a test was not wrapped in act(...).
      
      When testing, code that causes React state updates should be wrapped into act(...):
      
      act(() => {
        /* fire events that update state */
      });
      /* assert on the output */
      
      This ensures that you're testing the behavior the user would see in the browser. Learn more at https://reactjs.org/link/wrap-tests-with-act
          at ActivityTimeline (/Users/ahmedyounis/Documents/Projects/wp-admin-health-suite/assets/js/components/ActivityTimeline.jsx:108:46)
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Updating plan statuses**

I see that the tests passed, even though there were some console warnings, which I think are acceptable for now. Next, I need to go ahead and update the plan step statuses, so I'll mark that the lint and tests have been completed. After that, I can start summarizing what I've accomplished. It's all about keeping track of progress, and I want to be thorough!
Plan update
Lint and Jest tests completed successfully; preparing final summary, verification steps, and follow-ups.
  ✓ Read spec and handoff docs
  ✓ Inspect codebase and locate changes
  ✓ Implement Q06-04 changes
  ✓ Run lint and tests
  → Summarize and provide verification
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Preparing the final response**

I need to finalize the response, noting its status as either DONE or NEEDS-REVIEW. It's important to summarize everything while also checking the commands for verification, along with any associated risks or follow-ups. Before summarizing, I'll check the git diff to confirm all modifications and ensure there are no extraneous details. I’ll execute `git diff --stat` and potentially `git diff`, but I won't include this information in the final answer—it's just for my internal review.
exec
/bin/zsh -lc 'git diff --stat' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 46ms:
 .t2/state.json                                 |   5 +-
 includes/Contracts/ExclusionsInterface.php     |   2 +-
 includes/REST/Media/MediaAltTextController.php |  14 +++
 includes/REST/Media/MediaCleanupController.php |  78 +++++++++++++-
 includes/REST/Media/MediaHelper.php            |  95 ++++++++++++++++--
 includes/REST/MediaController.php              | 134 +++++++++++++++++--------
 6 files changed, 273 insertions(+), 55 deletions(-)
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Evaluating changes in code**

I think we need to decide if we should revert the changes or keep them based on what we find. I want to compare the differences in the file located at includes/Contracts/ExclusionsInterface.php. This will help clarify what modifications were made and whether they are beneficial or problematic. Understanding the changes will be crucial in making an informed decision moving forward. Let's take a detailed look at that diff!
exec
/bin/zsh -lc 'git diff includes/Contracts/ExclusionsInterface.php' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 51ms:
diff --git a/includes/Contracts/ExclusionsInterface.php b/includes/Contracts/ExclusionsInterface.php
index 8dd2da0..b6381a1 100644
--- a/includes/Contracts/ExclusionsInterface.php
+++ b/includes/Contracts/ExclusionsInterface.php
@@ -50,7 +50,7 @@ interface ExclusionsInterface {
 	 *
 	 * @since 1.2.0
 	 *
-	 * @return array<array{id: int, reason: string, added_at: string}> Array of excluded attachment data.
+	 * @return array<array{attachment_id: int, reason: string, excluded_at: string, excluded_by: int}> Array of excluded attachment data.
 	 */
 	public function get_exclusions(): array;
 
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Considering code changes**

I'm noticing that the docblock return type for get_exclusions is changing, and while it might be relevant for media controllers, I think it's not crucial. It seems minimal, so maybe keeping it wouldn't hurt. Now, I’m also curious about the .t2/state.json diff—let’s view what changes were made there! This exploration could help clarify any relationships between the changes.
exec
/bin/zsh -lc 'git diff .t2/state.json' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 39ms:
diff --git a/.t2/state.json b/.t2/state.json
index b209720..122a8c1 100644
--- a/.t2/state.json
+++ b/.t2/state.json
@@ -32,7 +32,8 @@
     "Q05-01",
     "Q05-02",
     "Q06-01",
-    "Q06-02"
+    "Q06-02",
+    "Q06-03"
   ],
   "claude_sessions": {
     "Q01-01": "5e05e067-351c-42d8-b76a-fe63b7a2bad5",
@@ -71,5 +72,5 @@
     "Q06-03": "b059f094-5965-49ed-bfb1-6d207b7daf67"
   },
   "gemini_sessions": {},
-  "updated_at": "2026-01-16T17:14:11.891677Z"
+  "updated_at": "2026-01-16T17:15:55.933412Z"
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Finalizing plan steps**

I'm considering the harness state and how it's not that important right now. It's useful for task tracking, though. Our modifications to the controllers relate to Q06-04, so I'll summarize that. I think checking the new diff for modified files is a good idea to make sure everything's correct. Adding tests could be beneficial, even if not strictly required. I need to ensure step 5 of the final plan is completed before giving my final response. Let's update the plan!
Plan update
All Q06-04 changes implemented and verified with lint/tests; ready for handoff.
  ✓ Read spec and handoff docs
  ✓ Inspect codebase and locate changes
  ✓ Implement Q06-04 changes
  ✓ Run lint and tests
  ✓ Summarize and provide verification
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**





thinking
**Organizing response elements**

I'm considering how to structure my response with specific sections: Status, Summary, How to Verify, and Risks/Follow-ups. It looks like I need to keep everything concise and within 10 lines while including those headings. I also need to list exact commands and mention any files I touched. With the use of headings and bullets, it might still be manageable to keep it concise, balancing detail without overwhelming the user.
thinking
**Structuring the response**

I’m putting together a response that includes specific sections: Status, Summary of changes, How to verify, and Risks/Follow-ups. In the summary, I’m detailing technical changes to ensure clarity, including which files were affected. For verification, I’ll list the commands `npm run lint` and `npm test`. I also need to highlight any risks, especially for clients relying on previous paths, and note that Safe Mode can change deletion dynamics. This should all be concise!
thinking
**Considering file references**

I might want to include references to file line numbers as per guidelines, which say to provide start lines when mentioning files. While it's not strictly required, it seems best to comply with this developer instruction. It could be tricky because I need to get the line numbers accurately, but I can use tools like `rg -n` or `nl -ba` to find these. My plan is to note key changes, particularly for MediaHelper, by identifying where the class starts and where modifications happen.
thinking
**Finding line numbers**

I’m planning to use `nl -ba` along with `sed` to display the line numbers without making the output too large. My goal is to get approximate line numbers for modifications, especially in files like `includes/REST/Media/MediaHelper.php`, where I added a property, likely around line 26. I’ll run the command with `nl -ba | head` to capture those lines and confirm the exact placements. This will help in accurately referencing the changes.
exec
/bin/zsh -lc "nl -ba includes/REST/Media/MediaHelper.php | sed -n '1,120p'" in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 55ms:
     1	<?php
     2	/**
     3	 * Media Helper
     4	 *
     5	 * Provides shared utility methods for media controllers.
     6	 *
     7	 * @package WPAdminHealth\REST\Media
     8	 */
     9	
    10	namespace WPAdminHealth\REST\Media;
    11	
    12	// Exit if accessed directly.
    13	if ( ! defined( 'ABSPATH' ) ) {
    14		die;
    15	}
    16	
    17	/**
    18	 * MediaHelper class for shared media operations.
    19	 *
    20	 * @since 1.3.0
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Locating line numbers**

I see that we now have line numbers, which is great for tracking changes. I need to include these in the final summary file. My next step is to find line numbers for key modifications in the `MediaController.php` file. I’ll specifically look for the `safe_delete` method and its alias route. Using `rg -n`, I can search for references like '/missing-alt' and safe mode messages to get the necessary line numbers.
exec
/bin/zsh -lc 'rg -n "missing-alt|Safe mode enabled|file_path" includes/REST/MediaController.php | head -n 40' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 48ms:
248:		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
251:			'/' . $this->rest_base . '/missing-alt',
747:				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
782:					unset( $item['file_path'] );
842:				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**


thinking
**Checking code functions**

I need to look into the `Safe_delete` function around line 747 and also the `get_attachment_details` delegate. I should figure out the exact line number for both. My next step will be to search for `MediaHelper::get_attachment_details` in the codebase to see where it's defined and how it relates to the `Safe_delete` function. It feels like a blend of housekeeping and ensuring everything's tidy in the code!
exec
/bin/zsh -lc 'rg -n "MediaHelper::get_attachment_details" includes/REST/MediaController.php | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 52ms:
883:		return MediaHelper::get_attachment_details( (int) $attachment_id );
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

exec
/bin/zsh -lc 'rg -n "array_unique" includes/REST/MediaController.php | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 41ms:
927:		$ids = array_values( array_unique( $ids ) );
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

exec
/bin/zsh -lc 'rg -n "Safe mode enabled|file_path|array_unique" includes/REST/Media/MediaCleanupController.php | head -n 60' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 49ms:
263:				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
298:					unset( $item['file_path'] );
359:				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
545:		$ids = array_values( array_unique( $ids ) );
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

exec
/bin/zsh -lc 'rg -n "missing-alt" includes/REST/Media/MediaAltTextController.php | head -n 20' in /Users/ahmedyounis/Documents/Projects/wp-admin-health-suite succeeded in 41ms:
95:		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
98:			'/media/missing-alt',
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**



thinking
**Assessing potential issues**

I need to be cautious here because the user didn't specifically ask for a discussion on this. However, it seems relevant to point out a potential mismatch between JavaScript and PHP. The media-audit bundle is calling endpoints that expect certain values, but it looks like the UI might still be broken unless everything aligns correctly. It's possible we could fix it by changing the RestController namespace, but that could lead to further complications. Still, I wonder if it's something worth mentioning in the plans.
thinking
**Considering risks and alignment**

I'm thinking we should mention the risk of misalignment between the JavaScript API namespace and PHP, as they currently differ. Even though the user didn't specifically ask for it, this could be valuable information. We also need to note changes regarding the `safe_delete` output and possible changes to safe mode. It’s essential to ensure that the final response is clear and doesn’t contain any markdown links since it should be plain text.
codex
Status: DONE

Summary of changes
- Hardened attachment file operations: only read `filesize()` for paths validated inside uploads, with URL-based filename fallback (`includes/REST/Media/MediaHelper.php:22`).
- Made destructive media endpoints respect Safe Mode (preview-only; no move/restore), and removed absolute `file_path` from delete responses (`includes/REST/MediaController.php:687`, `includes/REST/Media/MediaCleanupController.php:218`).
- Added `/wpha/v1/media/missing-alt` alias route and de-duped/filtered ID sanitization (`includes/REST/MediaController.php:248`, `includes/REST/Media/MediaAltTextController.php:95`).

How to verify
- `npm run lint`
- `npm test`

Risks / follow-ups
- If any client relied on `prepared_items[].file_path`, it must be updated (field no longer returned).
- Safe Mode now blocks delete/restore (must disable Safe Mode to execute).
- JS bundles use REST namespace `wp-admin-health/v1` while PHP controllers are on `wpha/v1` (e.g. `assets/js/admin.js:42`); consider aligning/aliasing namespaces if the UI isn’t reaching the endpoints.
file update:
diff --git a/includes/REST/Media/MediaAltTextController.php b/includes/REST/Media/MediaAltTextController.php
index 20a5b79a233de8bd935b430d345b33c3a13a1d39..f38a3d253918cc65cdefd3eb409bfb2dbf18ce98
--- a/includes/REST/Media/MediaAltTextController.php
+++ b/includes/REST/Media/MediaAltTextController.php
@@ -91,6 +91,20 @@
 				),
 			)
 		);
+
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/media/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaCleanupController.php b/includes/REST/Media/MediaCleanupController.php
index 1713af56dfc2ef5dd1385773d386fe8455ce9421..28a7e1f289c445799f9e60fb2bfb82483f446cfa
--- a/includes/REST/Media/MediaCleanupController.php
+++ b/includes/REST/Media/MediaCleanupController.php
@@ -228,6 +228,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -247,11 +249,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'        => true,
+				'safe_mode'      => true,
+				'preview_only'   => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'        => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -295,6 +349,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -468,7 +541,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**
diff --git a/includes/REST/Media/MediaHelper.php b/includes/REST/Media/MediaHelper.php
index 0066a11496a83e1f2d3f8ae3accd574ba79c02ca..845b0bf71b13d0976ef950eab8456351129570f0
--- a/includes/REST/Media/MediaHelper.php
+++ b/includes/REST/Media/MediaHelper.php
@@ -22,6 +22,76 @@
 class MediaHelper {
 
 	/**
+	 * Cached uploads base directory path.
+	 *
+	 * @since 1.6.0
+	 * @var string|null
+	 */
+	private static ?string $uploads_basedir = null;
+
+	/**
+	 * Get the uploads base directory.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @return string The uploads base directory path.
+	 */
+	private static function get_uploads_basedir(): string {
+		if ( null === self::$uploads_basedir ) {
+			$upload_dir = wp_upload_dir();
+			$basedir    = isset( $upload_dir['basedir'] ) ? (string) $upload_dir['basedir'] : '';
+
+			self::$uploads_basedir = $basedir ? ( realpath( $basedir ) ?: $basedir ) : '';
+		}
+
+		return self::$uploads_basedir;
+	}
+
+	/**
+	 * Validate that a file path is within the uploads directory.
+	 *
+	 * Security: Prevents path traversal and local file probing via
+	 * tampered attachment metadata.
+	 *
+	 * @since 1.6.0
+	 *
+	 * @param string $file_path The file path to validate.
+	 * @return bool True if path is valid and within uploads, false otherwise.
+	 */
+	private static function is_valid_upload_path( string $file_path ): bool {
+		$file_path = trim( $file_path );
+
+		if ( '' === $file_path ) {
+			return false;
+		}
+
+		$uploads_basedir = self::get_uploads_basedir();
+		if ( '' === $uploads_basedir ) {
+			return false;
+		}
+
+		// Resolve the real path (resolves symlinks and ../ sequences).
+		$real_path = realpath( $file_path );
+
+		// If realpath fails (file doesn't exist), validate the directory portion.
+		if ( false === $real_path ) {
+			$dir_path = realpath( dirname( $file_path ) );
+			if ( false === $dir_path ) {
+				return false;
+			}
+			$real_path = $dir_path . DIRECTORY_SEPARATOR . basename( $file_path );
+		}
+
+		// Ensure the real path starts with the uploads directory.
+		// Use strict comparison to prevent partial directory name matches.
+		if ( 0 !== strpos( $real_path, $uploads_basedir . DIRECTORY_SEPARATOR ) && $real_path !== $uploads_basedir ) {
+			return false;
+		}
+
+		return true;
+	}
+
+	/**
 	 * Get attachment details with thumbnail URL.
 	 *
 	 * Consolidated method to avoid code duplication across media controllers.
@@ -33,27 +103,32 @@
 	 */
 	public static function get_attachment_details( int $attachment_id ): array {
 		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
 
+		$url = wp_get_attachment_url( $attachment_id );
+
+		$filename  = '';
+		$file_size = 0;
+
+		if ( $file_path && self::is_valid_upload_path( $file_path ) && file_exists( $file_path ) && is_file( $file_path ) ) {
+			$filename = basename( $file_path );
+			$size     = filesize( $file_path );
+			$file_size = false === $size ? 0 : (int) $size;
+		} elseif ( $url ) {
+			$filename = basename( $url );
+		}
+
 		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
 		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
+			$thumbnail_url = $url;
 		}
 
-		$url  = wp_get_attachment_url( $attachment_id );
 		$post = get_post( $attachment_id );
 
 		$title     = $post ? $post->post_title : '';
 		$date      = $post ? $post->post_date : '';
 		$mime_type = get_post_mime_type( $attachment_id );
 
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
+		$type = self::get_media_type( $mime_type ? (string) $mime_type : '' );
 
 		return array(
 			'id'                  => $attachment_id,
diff --git a/includes/REST/MediaController.php b/includes/REST/MediaController.php
index c5548f084c457026b9ff0c7904a0fa27b3355bb5..b7e755212b03660157266f316dee6a9b0ffa316f
--- a/includes/REST/MediaController.php
+++ b/includes/REST/MediaController.php
@@ -19,6 +19,7 @@
 use WPAdminHealth\Contracts\ReferenceFinderInterface;
 use WPAdminHealth\Contracts\SafeDeleteInterface;
 use WPAdminHealth\Contracts\ExclusionsInterface;
+use WPAdminHealth\REST\Media\MediaHelper;
 
 // Exit if accessed directly.
 if ( ! defined( 'ABSPATH' ) ) {
@@ -244,6 +245,20 @@
 			)
 		);
 
+		// GET /wpha/v1/media/missing-alt - Alias for missing alt text endpoint.
+		register_rest_route(
+			$this->namespace,
+			'/' . $this->rest_base . '/missing-alt',
+			array(
+				array(
+					'methods'             => \WP_REST_Server::READABLE,
+					'callback'            => array( $this, 'get_missing_alt_text' ),
+					'permission_callback' => array( $this, 'check_permissions' ),
+					'args'                => $this->get_pagination_params(),
+				),
+			)
+		);
+
 		// POST /wpha/v1/media/scan - Trigger full media scan.
 		register_rest_route(
 			$this->namespace,
@@ -697,6 +712,8 @@
 			);
 		}
 
+		$safe_mode = $this->is_safe_mode_enabled();
+
 		// Filter out excluded attachments - they should not be deleted.
 		$excluded_ids  = array_filter(
 			$ids,
@@ -716,11 +733,63 @@
 			);
 		}
 
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'prepared_items' => array_map(
+					static function ( $attachment_id ) {
+						return array( 'attachment_id' => absint( $attachment_id ) );
+					},
+					$ids_to_delete
+				),
+				'message'      => __( 'Safe mode enabled. No files were moved to trash.', 'wp-admin-health-suite' ),
+			);
+
+			if ( ! empty( $excluded_ids ) ) {
+				$preview['excluded_ids'] = array_values( $excluded_ids );
+				$preview['message']     .= sprintf(
+					' ' . _n(
+						'%d item was skipped because it is excluded.',
+						'%d items were skipped because they are excluded.',
+						count( $excluded_ids ),
+						'wp-admin-health-suite'
+					),
+					count( $excluded_ids )
+				);
+			}
+
+			$this->log_activity( 'media_delete', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->prepare_deletion( $ids_to_delete );
 
+		// Do not expose absolute file paths via REST responses.
+		if ( isset( $result['prepared_items'] ) && is_array( $result['prepared_items'] ) ) {
+			$result['prepared_items'] = array_map(
+				static function ( $item ) {
+					if ( ! is_array( $item ) ) {
+						return $item;
+					}
+
+					unset( $item['file_path'] );
+					return $item;
+				},
+				$result['prepared_items']
+			);
+		}
+
 		// Include info about skipped excluded items in the result.
 		if ( ! empty( $excluded_ids ) ) {
 			$result['excluded_ids'] = array_values( $excluded_ids );
+			$result['message']      = isset( $result['message'] ) ? (string) $result['message'] : '';
 			$result['message']     .= sprintf(
 				' ' . _n(
 					'%d item was skipped because it is excluded.',
@@ -763,6 +832,25 @@
 	public function restore_media( $request ) {
 		$deletion_id = $request->get_param( 'deletion_id' );
 
+		$safe_mode = $this->is_safe_mode_enabled();
+		if ( $safe_mode ) {
+			$preview = array(
+				'success'      => true,
+				'safe_mode'    => true,
+				'preview_only' => true,
+				'deletion_id'  => absint( $deletion_id ),
+				'message'      => __( 'Safe mode enabled. No files were restored from trash.', 'wp-admin-health-suite' ),
+			);
+
+			$this->log_activity( 'media_restore', $preview );
+
+			return $this->format_response(
+				true,
+				$preview,
+				$preview['message']
+			);
+		}
+
 		$result = $this->safe_delete->restore_deleted( $deletion_id );
 
 		if ( ! $result['success'] ) {
@@ -792,46 +880,7 @@
 	 * @return array Attachment details.
 	 */
 	private function get_attachment_details( $attachment_id ) {
-		$file_path = get_attached_file( $attachment_id );
-		$filename  = $file_path ? basename( $file_path ) : '';
-		$file_size = $file_path && file_exists( $file_path ) ? filesize( $file_path ) : 0;
-
-		$thumbnail_url = wp_get_attachment_image_url( $attachment_id, 'thumbnail' );
-		if ( ! $thumbnail_url ) {
-			$thumbnail_url = wp_get_attachment_url( $attachment_id );
-		}
-
-		$url  = wp_get_attachment_url( $attachment_id );
-		$post = get_post( $attachment_id );
-
-		$title     = $post ? $post->post_title : '';
-		$date      = $post ? $post->post_date : '';
-		$mime_type = get_post_mime_type( $attachment_id );
-
-		$type = 'document';
-		if ( $mime_type && strpos( $mime_type, 'image/' ) === 0 ) {
-			$type = 'image';
-		} elseif ( $mime_type && strpos( $mime_type, 'video/' ) === 0 ) {
-			$type = 'video';
-		}
-
-		return array(
-			'id'                 => $attachment_id,
-			'title'              => $title,
-			'filename'           => $filename,
-			'file_size'          => $file_size,
-			'file_size_formatted' => size_format( $file_size ),
-			'mime_type'          => $mime_type,
-			'thumbnail_url'      => $thumbnail_url,
-			'edit_link'          => admin_url( 'post.php?post=' . $attachment_id . '&action=edit' ),
-
-			// UI-friendly aliases.
-			'size'               => $file_size,
-			'thumbnail'          => $thumbnail_url,
-			'url'                => $url,
-			'date'               => $date,
-			'type'               => $type,
-		);
+		return MediaHelper::get_attachment_details( (int) $attachment_id );
 	}
 
 	/**
@@ -874,7 +923,10 @@
 			return array();
 		}
 
-		return array_map( 'absint', $value );
+		$ids = array_filter( array_map( 'absint', $value ) );
+		$ids = array_values( array_unique( $ids ) );
+
+		return $ids;
 	}
 
 	/**

tokens used
201,972
