# Handoff: C02-03

Created: 2026-01-18T08:29:00.001637Z

Spec: .plans/C02-03.md


## 2026-01-18T08:35:18.700064Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-03 in this git repository.

1) Read the spec: .plans/C02-03.md
2) Read handoff/context: .t2/handoff/C02-03.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: cdc4bd08-0469-4cee-ad70-2a6460f6b156

Agent final message (file: C02-03.claude.impl.last.md):

---

## Status: DONE

## Summary of Changes

Refactored the service-locator pattern usage throughout the codebase:

### Container-Managed Services (fallbacks removed)

1. **`includes/Media/Exclusions.php`** - Simplified `get_settings()` to return the injected instance directly (no container lookup)

2. **`includes/REST/RestController.php`** - Changed `get_settings()` and `get_connection()` to throw `RuntimeException` if dependencies not injected (enforces DI)

3. **`includes/Performance/HeartbeatController.php`** - Made `SettingsInterface` required in constructor (removed nullable)

### Edge Adapters (documented, fallbacks kept)

4. **`includes/Settings.php`** - Documented as edge adapter (template facade) - templates instantiate directly

5. **`includes/Installer.php`** - Documented as edge adapter - runs during activation before container is available

6. **`includes/BatchProcessor.php`** - Documented as edge adapter - static utility methods can't receive constructor injection

### Documentation

7. **`docs/developers/edge-adapters.md`** - New file documenting:
   - Edge adapter pattern and rationale
   - List of all edge adapters with explanations
   - List of refactored container-managed classes
   - Guidelines for new code

8. **`templates/admin/settings.php`** - Added comment explaining Settings facade usage

## How to Verify

```bash
npm run lint    # 0 errors (161 warnings pre-existing)
npm test        # 417 tests pass
```

## Risks / Follow-ups

- **RuntimeException in REST controllers**: If someone instantiates `RestController` subclasses outside the container without injecting dependencies, they'll get a clear error message directing them to use `RESTServiceProvider`
- **Edge adapters**: The 3 documented edge adapters (`Settings`, `Installer`, `BatchProcessor`) legitimately need fallbacks due to WordPress lifecycle constraints
- **Future consideration**: The template rendering could eventually be moved to a dedicated service if `render_field()` is added to `SettingsInterface`, but this would require template changes


Repo snapshot:
```
branch: main

status:
M  .github/workflows/ci.yml
A  .logs/C01-01.claude.impl.last.md
A  .logs/C01-01.claude.impl.raw.txt
A  .logs/C01-01.gitcommit.txt
A  .logs/C01-02.claude.impl.last.md
A  .logs/C01-02.claude.impl.raw.txt
A  .logs/C01-02.gitcommit.txt
A  .logs/C01-03.claude.impl.last.md
A  .logs/C01-03.claude.impl.raw.txt
A  .logs/C01-03.gitcommit.txt
A  .logs/C01-04.claude.impl.last.md
A  .logs/C01-04.claude.impl.raw.txt
A  .logs/C01-04.gitcommit.txt
A  .logs/C01-05.claude.impl.last.md
A  .logs/C01-05.claude.impl.raw.txt
A  .logs/C01-05.gitcommit.txt
A  .logs/C01-06.claude.impl.last.md
A  .logs/C01-06.claude.impl.raw.txt
A  .logs/C01-06.gitcommit.txt
A  .logs/C01-07.claude.impl.last.md
A  .logs/C01-07.claude.impl.raw.txt
A  .logs/C01-07.gitcommit.txt
A  .logs/C01-08.claude.impl.last.md
A  .logs/C01-08.claude.impl.raw.txt
A  .logs/C01-08.gitcommit.txt
A  .logs/C01-09.claude.impl.last.md
A  .logs/C01-09.claude.impl.raw.txt
A  .logs/C01-09.gitcommit.txt
A  .logs/C01-10.claude.impl.last.md
A  .logs/C01-10.claude.impl.raw.txt
A  .logs/C01-10.gitcommit.txt
A  .logs/C01-11.claude.impl.last.md
A  .logs/C01-11.claude.impl.raw.txt
A  .logs/C01-11.gitcommit.txt
A  .logs/C01-12.claude.impl.last.md
A  .logs/C01-12.claude.impl.raw.txt
A  .logs/C01-12.gitcommit.txt
A  .logs/C02-01.claude.impl.last.md
A  .logs/C02-01.claude.impl.raw.txt
A  .logs/C02-01.gitcommit.txt
A  .logs/C02-02.claude.impl.last.md
A  .logs/C02-02.claude.impl.raw.txt
A  .plans/C01-01.md
A  .plans/C01-02.md
A  .plans/C01-03.md
A  .plans/C01-04.md
A  .plans/C01-05.md
A  .plans/C01-06.md
A  .plans/C01-07.md
A  .plans/C01-08.md
A  .plans/C01-09.md
A  .plans/C01-10.md
A  .plans/C01-11.md
A  .plans/C01-12.md
A  .plans/C02-01.md
A  .plans/C02-02.md
A  .t2/handoff/C01-01.md
A  .t2/handoff/C01-02.md
A  .t2/handoff/C01-03.md
A  .t2/handoff/C01-04.md
A  .t2/handoff/C01-05.md
A  .t2/handoff/C01-06.md
A  .t2/handoff/C01-07.md
A  .t2/handoff/C01-08.md
A  .t2/handoff/C01-09.md
A  .t2/handoff/C01-10.md
A  .t2/handoff/C01-11.md
A  .t2/handoff/C01-12.md
A  .t2/handoff/C02-01.md
A  .t2/handoff/C02-02.md
MM .t2/state.json
M  CHANGELOG.md
M  README.md
D  admin/Admin.php
M  assets/js/admin.js
M  assets/js/utils/api.js
M  assets/js/utils/api.test.js
M  composer.json
A  docs/architecture-improvement-plan.md
A  docs/decisions/ADR-001-code-organization.md
A  docs/decisions/ADR-002-rest-api-evolution.md
A  docs/decisions/ADR-003-frontend-modernization-scope.md
A  docs/developers/case-sensitivity.md
M  docs/developers/hooks.md
M  docs/developers/rest-api.md
M  docs/getting-started.md
D  includes/Admin.php
A  includes/Admin/MenuRegistrar.php
A  includes/Admin/PageRenderer.php
A  includes/Admin/index.php
M  includes/Assets.php
 M includes/BatchProcessor.php
M  includes/Database.php
 M includes/Installer.php
R  includes/Integrations/Acf.php -> includes/Integrations/ACF.php
 M includes/Media/Exclusions.php
 M includes/Performance/HeartbeatController.php
M  includes/Providers/BootstrapServiceProvider.php
 M includes/REST/RestController.php
M  includes/RestApi.php
 M includes/Settings.php
M  jest.setup.js
A  plan_tasks.csv
D  review_tasks.csv
A  scripts/check-case-sensitivity.sh
D  tasks.csv
 M templates/admin/settings.php
M  wp-admin-health-suite.php
?? .logs/C02-02.gitcommit.txt
?? .logs/C02-03.claude.impl.last.md
?? .logs/C02-03.claude.impl.raw.txt
?? .plans/C02-03.md
?? .t2/handoff/C02-03.md
?? docs/developers/edge-adapters.md

diff --stat:
.t2/state.json                               |  5 +++--
 includes/BatchProcessor.php                  | 14 ++++++++++++++
 includes/Installer.php                       | 14 ++++++++++++++
 includes/Media/Exclusions.php                | 22 +++++-----------------
 includes/Performance/HeartbeatController.php | 14 +++++++-------
 includes/REST/RestController.php             | 16 ++++++++--------
 includes/Settings.php                        | 18 ++++++++++++++++--
 templates/admin/settings.php                 |  4 +++-
 8 files changed, 70 insertions(+), 37 deletions(-)

```
