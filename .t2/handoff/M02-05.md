# Handoff: M02-05

Created: 2026-01-07T19:35:58.337216Z

Spec: .plans/M02-05.md


## 2026-01-07T19:38:20.896275Z — claude — impl

Command:
```
claude -p --output-format json --model sonnet --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task M02-05 in this git repository.

1) Read the spec: .plans/M02-05.md
2) Read handoff/context: .t2/handoff/M02-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 3a64d24e-9929-44d1-ba48-c9159ff302c1

Agent final message (file: M02-05.claude.impl.last.md):

Perfect! The implementation is complete. Let me create a summary of what was implemented:

---

## Status: DONE

## Summary of Changes

Created `includes/database/class-trash-cleaner.php` with the following implementation:

### Methods Implemented:
1. **`get_trashed_posts($post_types)`** - Retrieves trashed posts filtered by post types (lines 37-62)
   - Accepts array of post types to filter
   - Returns array of post objects with ID, title, type, and modified date
   - Uses proper SQL sanitization with `sanitize_key()` and `$wpdb->prepare()`

2. **`get_spam_comments_count()`** - Returns count of spam comments (lines 69-78)

3. **`get_trashed_comments_count()`** - Returns count of trashed comments (lines 85-94)

4. **`delete_trashed_posts($post_types, $older_than_days)`** - Deletes trashed posts with filters (lines 103-168)
   - Filters by post types array
   - Age filter: only deletes posts modified more than X days ago
   - Uses `wp_delete_post($id, true)` for proper cleanup with force_delete
   - Processes in batches (100 items) to prevent timeout
   - Returns deleted count and errors

5. **`delete_spam_comments($older_than_days)`** - Deletes spam comments with age filter (lines 176-233)
   - Age filter based on comment_date
   - Uses `wp_delete_comment($id, true)` for proper cleanup
   - Batch processing for performance

6. **`delete_trashed_comments($older_than_days)`** - Deletes trashed comments with age filter (lines 241-298)
   - Similar to spam deletion but for trashed comments
   - Uses proper WordPress functions

7. **`empty_all_trash()`** - Empties all trash (posts and comments) (lines 308-321)
   - Combines deletion of all trashed posts (all post types)
   - Deletes all trashed comments
   - Returns comprehensive results

### Key Features:
- Uses WordPress native functions (`wp_delete_post`, `wp_delete_comment`) with `force_delete=true`
- Proper SQL injection prevention with `$wpdb->prepare()` and sanitization
- Post type filtering with array support
- Age-based filtering to prevent accidental deletion of recent items
- Batch processing (BATCH_SIZE = 100) to prevent timeouts
- Follows existing codebase patterns and conventions
- Proper PHPDoc comments
- Namespace: `WPAdminHealth\Database`

## How to Verify

Run the verification commands:
```bash
npm run lint  # Already run - no linting configured
npm test      # Already run - no tests configured
```

### Manual Verification:
The class can be instantiated and tested in WordPress:
```php
$cleaner = new \WPAdminHealth\Database\Trash_Cleaner();

// Get trashed posts for specific post types
$trashed = $cleaner->get_trashed_posts(['post', 'page']);

// Get counts
$spam_count = $cleaner->get_spam_comments_count();
$trash_count = $cleaner->get_trashed_comments_count();

// Delete with age filter (30 days)
$result = $cleaner->delete_trashed_posts(['post'], 30);

// Empty all trash
$result = $cleaner->empty_all_trash();
```

## Risks / Follow-ups

### Risks:
- **Data loss**: The deletion methods permanently delete content. The age filter provides protection, but users should be aware this is irreversible
- **Performance**: Large volumes of trashed items could cause timeouts despite batch processing. May need to increase BATCH_SIZE or add progress tracking for very large datasets

### Follow-ups:
- Add unit tests to verify all methods work correctly
- Consider adding logging similar to `Transients_Cleaner::log_deletion()` for audit trail
- May want to add a dry-run mode like `Orphaned_Cleaner` has
- Consider adding progress callbacks for long-running operations
- Could add size estimation methods to show disk space that would be freed


Repo snapshot:
```
branch: main

status:
M .t2/state.json
?? .logs/M02-04.gitcommit.txt
?? .logs/M02-05.claude.impl.last.md
?? .logs/M02-05.claude.impl.raw.txt
?? .plans/M02-05.md
?? .t2/handoff/M02-05.md
?? includes/database/class-trash-cleaner.php

diff --stat:
.t2/state.json | 5 +++--
 1 file changed, 3 insertions(+), 2 deletions(-)

```
