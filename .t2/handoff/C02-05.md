# Handoff: C02-05

Created: 2026-01-18T08:40:53.767282Z

Spec: .plans/C02-05.md


## 2026-01-18T08:47:04.094545Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-05 in this git repository.

1) Read the spec: .plans/C02-05.md
2) Read handoff/context: .t2/handoff/C02-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 5841e126-5341-4785-9947-5f6dc005ae89

Agent final message (file: C02-05.claude.impl.last.md):

## Status: DONE

## Summary of Changes

Refactored the integration system to require injected `ConnectionInterface` and `CacheInterface` dependencies, eliminating internal construction of infrastructure classes:

1. **`includes/Integrations/AbstractIntegration.php`**:
   - Removed imports for `WpdbConnection` and `CacheFactory`
   - Changed constructor from nullable parameters with fallbacks to required parameters
   - No longer internally instantiates `new WpdbConnection()` or `CacheFactory::get_instance()`

2. **`includes/Integrations/WooCommerce.php`**:
   - Changed constructor from nullable to required `ConnectionInterface` and `CacheInterface` parameters

3. **`includes/Integrations/Elementor.php`**:
   - Changed constructor from nullable to required `ConnectionInterface` and `CacheInterface` parameters

4. **`includes/Integrations/Multilingual.php`**:
   - Changed constructor from nullable to required `ConnectionInterface` and `CacheInterface` parameters

5. **`includes/Integrations/ACF.php`**:
   - Changed constructor from nullable to required `ConnectionInterface` and `CacheInterface` parameters

6. **`includes/Integrations/IntegrationManager.php`**:
   - Updated `discover_builtin_integrations()` to require factory (no fallback to direct instantiation)
   - Updated `create_integration()` to require factory for dependency injection
   - Removed fallback code that would call `new $class()` without dependencies

7. **`tests/unit/Integration/IntegrationManagerTest.php`**:
   - Updated `Mock_Integration` constructor to require `ConnectionInterface` and `CacheInterface` as first two parameters
   - Updated all test methods to pass dependencies when creating integrations
   - Fixed method name references (`get_active` → `get_available`, `get_info` → `get_integration_info`, `initialize_all` → `init`)
   - Fixed duplicate registration test (manager replaces, doesn't reject duplicates)

## How to Verify

```bash
# Run linting
npm run lint

# Run tests
npm test
```

Both commands complete successfully:
- Lint: 0 errors, 161 warnings (pre-existing warnings unrelated to this change)
- Tests: 417 passed, 0 failed

## Risks / Follow-ups

1. **Breaking Change for Third-Party Integrations**: Any third-party code that extends `AbstractIntegration` or creates integrations directly (without using the factory) will need to be updated to pass the required dependencies. The `IntegrationServiceProvider` already properly injects dependencies via the container, so the official plugin flow is unaffected.

2. **Factory is Now Required**: The `IntegrationManager` now requires a factory to create integrations. Without a factory, no integrations will be discovered. This is intentional since dependencies cannot be injected otherwise. The plugin's bootstrap path always provides a factory via the container.


Repo snapshot:
```
branch: main

status:
M  .github/workflows/ci.yml
A  .logs/C01-01.claude.impl.last.md
A  .logs/C01-01.claude.impl.raw.txt
A  .logs/C01-01.gitcommit.txt
A  .logs/C01-02.claude.impl.last.md
A  .logs/C01-02.claude.impl.raw.txt
A  .logs/C01-02.gitcommit.txt
A  .logs/C01-03.claude.impl.last.md
A  .logs/C01-03.claude.impl.raw.txt
A  .logs/C01-03.gitcommit.txt
A  .logs/C01-04.claude.impl.last.md
A  .logs/C01-04.claude.impl.raw.txt
A  .logs/C01-04.gitcommit.txt
A  .logs/C01-05.claude.impl.last.md
A  .logs/C01-05.claude.impl.raw.txt
A  .logs/C01-05.gitcommit.txt
A  .logs/C01-06.claude.impl.last.md
A  .logs/C01-06.claude.impl.raw.txt
A  .logs/C01-06.gitcommit.txt
A  .logs/C01-07.claude.impl.last.md
A  .logs/C01-07.claude.impl.raw.txt
A  .logs/C01-07.gitcommit.txt
A  .logs/C01-08.claude.impl.last.md
A  .logs/C01-08.claude.impl.raw.txt
A  .logs/C01-08.gitcommit.txt
A  .logs/C01-09.claude.impl.last.md
A  .logs/C01-09.claude.impl.raw.txt
A  .logs/C01-09.gitcommit.txt
A  .logs/C01-10.claude.impl.last.md
A  .logs/C01-10.claude.impl.raw.txt
A  .logs/C01-10.gitcommit.txt
A  .logs/C01-11.claude.impl.last.md
A  .logs/C01-11.claude.impl.raw.txt
A  .logs/C01-11.gitcommit.txt
A  .logs/C01-12.claude.impl.last.md
A  .logs/C01-12.claude.impl.raw.txt
A  .logs/C01-12.gitcommit.txt
A  .logs/C02-01.claude.impl.last.md
A  .logs/C02-01.claude.impl.raw.txt
A  .logs/C02-01.gitcommit.txt
A  .logs/C02-02.claude.impl.last.md
A  .logs/C02-02.claude.impl.raw.txt
A  .logs/C02-02.gitcommit.txt
A  .logs/C02-03.claude.impl.last.md
A  .logs/C02-03.claude.impl.raw.txt
A  .logs/C02-03.gitcommit.txt
A  .logs/C02-04.claude.impl.last.md
A  .logs/C02-04.claude.impl.raw.txt
A  .plans/C01-01.md
A  .plans/C01-02.md
A  .plans/C01-03.md
A  .plans/C01-04.md
A  .plans/C01-05.md
A  .plans/C01-06.md
A  .plans/C01-07.md
A  .plans/C01-08.md
A  .plans/C01-09.md
A  .plans/C01-10.md
A  .plans/C01-11.md
A  .plans/C01-12.md
A  .plans/C02-01.md
A  .plans/C02-02.md
A  .plans/C02-03.md
A  .plans/C02-04.md
A  .t2/handoff/C01-01.md
A  .t2/handoff/C01-02.md
A  .t2/handoff/C01-03.md
A  .t2/handoff/C01-04.md
A  .t2/handoff/C01-05.md
A  .t2/handoff/C01-06.md
A  .t2/handoff/C01-07.md
A  .t2/handoff/C01-08.md
A  .t2/handoff/C01-09.md
A  .t2/handoff/C01-10.md
A  .t2/handoff/C01-11.md
A  .t2/handoff/C01-12.md
A  .t2/handoff/C02-01.md
A  .t2/handoff/C02-02.md
A  .t2/handoff/C02-03.md
A  .t2/handoff/C02-04.md
MM .t2/state.json
M  CHANGELOG.md
M  README.md
D  admin/Admin.php
M  assets/js/admin.js
M  assets/js/utils/api.js
M  assets/js/utils/api.test.js
M  composer.json
A  docs/architecture-improvement-plan.md
A  docs/decisions/ADR-001-code-organization.md
A  docs/decisions/ADR-002-rest-api-evolution.md
A  docs/decisions/ADR-003-frontend-modernization-scope.md
A  docs/developers/case-sensitivity.md
A  docs/developers/edge-adapters.md
M  docs/developers/hooks.md
M  docs/developers/rest-api.md
M  docs/getting-started.md
D  includes/Admin.php
A  includes/Admin/MenuRegistrar.php
A  includes/Admin/PageRenderer.php
A  includes/Admin/index.php
M  includes/Assets.php
M  includes/BatchProcessor.php
A  includes/Contracts/IntegrationFactoryInterface.php
M  includes/Database.php
M  includes/Installer.php
RM includes/Integrations/Acf.php -> includes/Integrations/ACF.php
 M includes/Integrations/AbstractIntegration.php
 M includes/Integrations/Elementor.php
A  includes/Integrations/IntegrationFactory.php
MM includes/Integrations/IntegrationManager.php
 M includes/Integrations/Multilingual.php
 M includes/Integrations/WooCommerce.php
M  includes/Media/Exclusions.php
M  includes/Performance/HeartbeatController.php
M  includes/Providers/BootstrapServiceProvider.php
M  includes/Providers/IntegrationServiceProvider.php
M  includes/REST/RestController.php
M  includes/RestApi.php
M  includes/Settings.php
M  jest.setup.js
A  plan_tasks.csv
D  review_tasks.csv
A  scripts/check-case-sensitivity.sh
D  tasks.csv
M  templates/admin/settings.php
 M tests/unit/Integration/IntegrationManagerTest.php
M  wp-admin-health-suite.php
?? .logs/C02-04.gitcommit.txt
?? .logs/C02-05.claude.impl.last.md
?? .logs/C02-05.claude.impl.raw.txt
?? .plans/C02-05.md
?? .t2/handoff/C02-05.md

diff --stat:
.t2/state.json                                    |  5 +-
 includes/Integrations/ACF.php                     |  8 +--
 includes/Integrations/AbstractIntegration.php     | 14 ++--
 includes/Integrations/Elementor.php               |  8 +--
 includes/Integrations/IntegrationManager.php      | 52 +++++++-------
 includes/Integrations/Multilingual.php            |  8 +--
 includes/Integrations/WooCommerce.php             |  8 +--
 tests/unit/Integration/IntegrationManagerTest.php | 84 +++++++++--------------
 8 files changed, 83 insertions(+), 104 deletions(-)

```


## 2026-01-18T15:44:30.174145Z — copilot — impl

Command:
```
copilot --prompt You are implementing task C02-05 in this git repository.

1) Read the spec: .plans/C02-05.md
2) Read handoff/context: .t2/handoff/C02-05.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups
 --allow-all-tools
```

Return code: 0

Agent final message (file: C02-05.copilot.impl.last.md):

I’ll read the spec and handoff, then implement the required changes and run lint/tests to verify.

I’m going to locate the existing Performance application layer and related interfaces, then implement `CollectMetrics` and add/update unit tests around its returned schema and safe-mode behavior.

I’m going to locate how metrics/health checks are currently exposed and then implement `CollectMetrics` with a stable response schema plus unit tests.

I’m going to inspect existing performance UI/API expectations, then implement `CollectMetrics` to return a stable aggregated schema and add unit tests for schema + safe-mode.

I’m going to implement the `CollectMetrics` application service (with dependency injection + stable schema) and add standalone unit tests to cover schema + safe-mode behavior, then run `npm run lint` and `npm test`.

I’m going to implement `CollectMetrics` with the required injected services, then add PHPUnit standalone tests covering schema + safe-mode behavior.

I’m going to implement `CollectMetrics` with injected dependencies, update any container/test instantiation, add standalone PHPUnit tests, then run `npm run lint` and `npm test`.

I’m going to implement `CollectMetrics` with injected dependencies + stable schema, then update/add standalone PHPUnit tests and run the requested JS lint/tests.

Implementing CollectMetrics plus focused standalone tests, and updating the DI provider and failing ApplicationLayerTest to match constructor injection.

Status: DONE

Summary of changes:
- Implemented `includes/Application/Performance/CollectMetrics.php` with constructor DI (`SettingsInterface`, `AutoloadAnalyzerInterface`, `QueryMonitorInterface`, `PluginProfilerInterface`, `CacheChecker`, optional `ActivityLoggerInterface`) and a stable metrics schema (`autoload`, `queries`, `plugins`, `cache`) + safe-mode behavior (skips slow-query capture + plugin profiling; no logging).
- Registered `CollectMetrics` in `includes/Providers/RESTServiceProvider.php` (class + alias `application.performance.collect_metrics`).
- Added standalone PHPUnit coverage: `tests/unit-standalone/Application/Performance/CollectMetricsTest.php` and updated `tests/unit-standalone/Application/ApplicationLayerTest.php` to avoid instantiating DI-required use-cases with no args.

How to verify:
- `npm run lint`
- `npm test`
- (PHP unit tests) `./vendor/bin/phpunit -c phpunit-standalone.xml --filter CollectMetricsTest --no-coverage`

Risks / follow-ups:
- `CollectMetrics` calls `CacheChecker->get_cache_status()` / `get_cache_recommendations()` which can be environment-dependent; current tests mock `CacheChecker` to keep schema stable.


Repo snapshot:
```
branch: main

status:
M includes/Application/Performance/CollectMetrics.php
 M includes/Providers/RESTServiceProvider.php
 M tests/unit-standalone/Application/ApplicationLayerTest.php
?? .logs/C02-05.copilot.impl.last.md
?? .logs/C02-05.copilot.impl.raw.txt
?? tests/unit-standalone/Application/Performance/

diff --stat:
.../Application/Performance/CollectMetrics.php     | 312 ++++++++++++++++++++-
 includes/Providers/RESTServiceProvider.php         |  29 ++
 .../Application/ApplicationLayerTest.php           |  76 ++---
 3 files changed, 355 insertions(+), 62 deletions(-)

```
