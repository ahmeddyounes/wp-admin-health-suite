# Handoff: C02-04

Created: 2026-01-18T08:35:32.129547Z

Spec: .plans/C02-04.md


## 2026-01-18T08:40:40.579591Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-04 in this git repository.

1) Read the spec: .plans/C02-04.md
2) Read handoff/context: .t2/handoff/C02-04.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: 8cb2f158-79b7-4939-a010-2a8cf8d1753b

Agent final message (file: C02-04.claude.impl.last.md):

---

**Status: DONE**

## Summary of Changes

### New Files Created
1. **`includes/Contracts/IntegrationFactoryInterface.php`** - New interface defining the contract for creating integration instances via the container. Methods: `create()`, `can_create()`, `get_available_ids()`.

2. **`includes/Integrations/IntegrationFactory.php`** - Implementation that resolves integrations from the container using a service map. Includes `register()` method to map integration IDs to container service identifiers.

### Modified Files
3. **`includes/Integrations/IntegrationManager.php`**:
   - Added constructor accepting optional `IntegrationFactoryInterface`
   - Added `$factory` property
   - Refactored `discover()` to use new `discover_builtin_integrations()` method
   - Added `create_integration()` method that tries factory first, then falls back to direct instantiation
   - Added `set_factory()` and `get_factory()` methods for lazy injection
   - Fixed ACF class reference from `Acf` to `ACF` (case-sensitivity fix)

4. **`includes/Providers/IntegrationServiceProvider.php`**:
   - Registers each built-in integration (WooCommerce, Elementor, ACF, Multilingual) in the container with proper `ConnectionInterface` and `CacheInterface` dependencies
   - Registers the `IntegrationFactory` as a singleton with built-in integrations pre-registered
   - Creates `IntegrationManager` with factory injection
   - Added new hook `wpha_configure_integration_factory` for third-party factory registration

5. **`docs/developers/hooks.md`**:
   - Added new "Integration Hooks" section documenting:
     - `wpha_register_integrations`
     - `wpha_configure_integration_factory`
     - `wpha_before_integration_discovery`
     - `wpha_integrations_loaded`
     - `wpha_integration_initialized`
     - `wpha_integration_deactivated`

## How to Verify

1. **Lint**: `npm run lint` - Passes (warnings only, no errors)
2. **Tests**: `npm test` - All 417 tests pass

## Risks / Follow-ups

1. **Backward Compatibility**: The factory is optional - if not provided, IntegrationManager falls back to direct instantiation, preserving backward compatibility.

2. **Third-Party Integration Registration**: Two methods are now available:
   - Use `wpha_register_integrations` hook with `$manager->register($integration)` (existing approach)
   - Use `wpha_configure_integration_factory` hook with `$factory->register($id, $class)` for container-based resolution (new approach)

3. **PHP Unit Tests**: No PHP unit tests were run (only JS tests). Consider adding PHP unit tests for `IntegrationFactory` and the updated `IntegrationManager`.


Repo snapshot:
```
branch: main

status:
M  .github/workflows/ci.yml
A  .logs/C01-01.claude.impl.last.md
A  .logs/C01-01.claude.impl.raw.txt
A  .logs/C01-01.gitcommit.txt
A  .logs/C01-02.claude.impl.last.md
A  .logs/C01-02.claude.impl.raw.txt
A  .logs/C01-02.gitcommit.txt
A  .logs/C01-03.claude.impl.last.md
A  .logs/C01-03.claude.impl.raw.txt
A  .logs/C01-03.gitcommit.txt
A  .logs/C01-04.claude.impl.last.md
A  .logs/C01-04.claude.impl.raw.txt
A  .logs/C01-04.gitcommit.txt
A  .logs/C01-05.claude.impl.last.md
A  .logs/C01-05.claude.impl.raw.txt
A  .logs/C01-05.gitcommit.txt
A  .logs/C01-06.claude.impl.last.md
A  .logs/C01-06.claude.impl.raw.txt
A  .logs/C01-06.gitcommit.txt
A  .logs/C01-07.claude.impl.last.md
A  .logs/C01-07.claude.impl.raw.txt
A  .logs/C01-07.gitcommit.txt
A  .logs/C01-08.claude.impl.last.md
A  .logs/C01-08.claude.impl.raw.txt
A  .logs/C01-08.gitcommit.txt
A  .logs/C01-09.claude.impl.last.md
A  .logs/C01-09.claude.impl.raw.txt
A  .logs/C01-09.gitcommit.txt
A  .logs/C01-10.claude.impl.last.md
A  .logs/C01-10.claude.impl.raw.txt
A  .logs/C01-10.gitcommit.txt
A  .logs/C01-11.claude.impl.last.md
A  .logs/C01-11.claude.impl.raw.txt
A  .logs/C01-11.gitcommit.txt
A  .logs/C01-12.claude.impl.last.md
A  .logs/C01-12.claude.impl.raw.txt
A  .logs/C01-12.gitcommit.txt
A  .logs/C02-01.claude.impl.last.md
A  .logs/C02-01.claude.impl.raw.txt
A  .logs/C02-01.gitcommit.txt
A  .logs/C02-02.claude.impl.last.md
A  .logs/C02-02.claude.impl.raw.txt
A  .logs/C02-02.gitcommit.txt
A  .logs/C02-03.claude.impl.last.md
A  .logs/C02-03.claude.impl.raw.txt
A  .plans/C01-01.md
A  .plans/C01-02.md
A  .plans/C01-03.md
A  .plans/C01-04.md
A  .plans/C01-05.md
A  .plans/C01-06.md
A  .plans/C01-07.md
A  .plans/C01-08.md
A  .plans/C01-09.md
A  .plans/C01-10.md
A  .plans/C01-11.md
A  .plans/C01-12.md
A  .plans/C02-01.md
A  .plans/C02-02.md
A  .plans/C02-03.md
A  .t2/handoff/C01-01.md
A  .t2/handoff/C01-02.md
A  .t2/handoff/C01-03.md
A  .t2/handoff/C01-04.md
A  .t2/handoff/C01-05.md
A  .t2/handoff/C01-06.md
A  .t2/handoff/C01-07.md
A  .t2/handoff/C01-08.md
A  .t2/handoff/C01-09.md
A  .t2/handoff/C01-10.md
A  .t2/handoff/C01-11.md
A  .t2/handoff/C01-12.md
A  .t2/handoff/C02-01.md
A  .t2/handoff/C02-02.md
A  .t2/handoff/C02-03.md
MM .t2/state.json
M  CHANGELOG.md
M  README.md
D  admin/Admin.php
M  assets/js/admin.js
M  assets/js/utils/api.js
M  assets/js/utils/api.test.js
M  composer.json
A  docs/architecture-improvement-plan.md
A  docs/decisions/ADR-001-code-organization.md
A  docs/decisions/ADR-002-rest-api-evolution.md
A  docs/decisions/ADR-003-frontend-modernization-scope.md
A  docs/developers/case-sensitivity.md
A  docs/developers/edge-adapters.md
MM docs/developers/hooks.md
M  docs/developers/rest-api.md
M  docs/getting-started.md
D  includes/Admin.php
A  includes/Admin/MenuRegistrar.php
A  includes/Admin/PageRenderer.php
A  includes/Admin/index.php
M  includes/Assets.php
M  includes/BatchProcessor.php
M  includes/Database.php
M  includes/Installer.php
R  includes/Integrations/Acf.php -> includes/Integrations/ACF.php
 M includes/Integrations/IntegrationManager.php
M  includes/Media/Exclusions.php
M  includes/Performance/HeartbeatController.php
M  includes/Providers/BootstrapServiceProvider.php
 M includes/Providers/IntegrationServiceProvider.php
M  includes/REST/RestController.php
M  includes/RestApi.php
M  includes/Settings.php
M  jest.setup.js
A  plan_tasks.csv
D  review_tasks.csv
A  scripts/check-case-sensitivity.sh
D  tasks.csv
M  templates/admin/settings.php
M  wp-admin-health-suite.php
?? .logs/C02-03.gitcommit.txt
?? .logs/C02-04.claude.impl.last.md
?? .logs/C02-04.claude.impl.raw.txt
?? .plans/C02-04.md
?? .t2/handoff/C02-04.md
?? includes/Contracts/IntegrationFactoryInterface.php
?? includes/Integrations/IntegrationFactory.php

diff --stat:
.t2/state.json                                    |   5 +-
 docs/developers/hooks.md                          | 149 ++++++++++++++++++++++
 includes/Integrations/IntegrationManager.php      | 139 +++++++++++++++++---
 includes/Providers/IntegrationServiceProvider.php | 115 ++++++++++++++++-
 4 files changed, 386 insertions(+), 22 deletions(-)

```
