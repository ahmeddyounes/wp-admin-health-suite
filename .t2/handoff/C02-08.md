# Handoff: C02-08

Created: 2026-01-18T08:57:45.549373Z

Spec: .plans/C02-08.md


## 2026-01-18T09:02:37.172177Z — claude — impl

Command:
```
claude -p --output-format json --model opus --permission-mode acceptEdits --dangerously-skip-permissions You are implementing task C02-08 in this git repository.

1) Read the spec: .plans/C02-08.md
2) Read handoff/context: .t2/handoff/C02-08.md

Implement the spec fully.

Verification commands (run if non-empty):
- format: 
- lint: npm run lint
- test: npm test

In your final response, include:
- Status: DONE or NEEDS-REVIEW
- Summary of changes
- How to verify (exact commands)
- Risks / follow-ups

```

Return code: 0

Session: a004eaaa-411a-4764-9bd5-25e5dc664c90

Agent final message (file: C02-08.claude.impl.last.md):

The changes for C02-08 are:
1. `includes/Admin/SettingsViewModel.php` - New file (untracked)
2. `includes/Admin/PageRenderer.php` - Modified (AM status indicates new in index + working tree modifications)
3. `includes/Providers/BootstrapServiceProvider.php` - Modified (MM status indicates index + working tree modifications)
4. `templates/admin/settings.php` - Modified (MM status)

Let me provide the final summary.

---

## Status: DONE

## Summary of Changes

This implementation addresses **C02-08: Clean up legacy Settings facade usage** by introducing a view model pattern that eliminates service location in templates while keeping the Settings facade for backward compatibility.

### Files Created

1. **`includes/Admin/SettingsViewModel.php`** (new)
   - A container-managed view model that provides template-ready data for the settings page
   - Wraps `SettingsInterface` and provides `render_field()` for HTML generation
   - Designed to be injected via dependency injection rather than instantiated directly in templates
   - Includes `get_template_data()` method for bundling all settings data

### Files Modified

2. **`includes/Admin/PageRenderer.php`**
   - Added optional `SettingsViewModel` dependency to constructor
   - Updated `render_settings()` to pass `$settings_obj` to the template when view model is available
   - Maintains backward compatibility if view model is not injected

3. **`includes/Providers/BootstrapServiceProvider.php`**
   - Added `SettingsViewModel::class` to `$provides` array
   - Registered `SettingsViewModel` as a singleton with `SettingsInterface` injection
   - Updated `PageRenderer` binding to inject `SettingsViewModel`
   - Added `admin.settings_view_model` alias

4. **`templates/admin/settings.php`**
   - Updated to check for injected `$settings_obj` (SettingsViewModel) first
   - Falls back to instantiating `Settings` facade only if no view model is available
   - Added deprecation comment on the fallback path
   - Maintains full backward compatibility

### Architecture

```
Container (SettingsInterface)
    ↓ injected into
SettingsViewModel
    ↓ injected into  
PageRenderer
    ↓ passes as $settings_obj to
settings.php template
```

The Settings facade (`includes/Settings.php`) remains untouched and available for any legacy code that may need it.

## How to Verify

```bash
# PHP syntax check
php -l includes/Admin/SettingsViewModel.php
php -l includes/Admin/PageRenderer.php
php -l includes/Providers/BootstrapServiceProvider.php
php -l templates/admin/settings.php

# PHP CodeSniffer (new PHP files only)
./vendor/bin/phpcs --standard=phpcs.xml includes/Admin/SettingsViewModel.php includes/Admin/PageRenderer.php includes/Providers/BootstrapServiceProvider.php

# Standalone PHP unit tests
./vendor/bin/phpunit -c phpunit-standalone.xml --no-coverage

# JS lint and tests
npm run lint
npm test
```

## Risks / Follow-ups

1. **Template variable scope**: The template checks for `$settings_obj instanceof \WPAdminHealth\Admin\SettingsViewModel` - this works correctly due to how `PageRenderer::render()` uses `extract()` to pass data

2. **Pre-existing phpcs errors**: The `templates/admin/settings.php` file has pre-existing phpcs violations (non-prefixed global variables, Yoda conditions) that existed before this change and are unrelated to this task

3. **Future cleanup**: The fallback path in the template (instantiating Settings facade) can be removed in a future major version once all integrations use the injected view model

4. **Other services**: `HeartbeatController` and `Installer` were audited and already properly use `SettingsInterface` via DI - no changes needed


Repo snapshot:
```
branch: main

status:
M  .github/workflows/ci.yml
A  .logs/C01-01.claude.impl.last.md
A  .logs/C01-01.claude.impl.raw.txt
A  .logs/C01-01.gitcommit.txt
A  .logs/C01-02.claude.impl.last.md
A  .logs/C01-02.claude.impl.raw.txt
A  .logs/C01-02.gitcommit.txt
A  .logs/C01-03.claude.impl.last.md
A  .logs/C01-03.claude.impl.raw.txt
A  .logs/C01-03.gitcommit.txt
A  .logs/C01-04.claude.impl.last.md
A  .logs/C01-04.claude.impl.raw.txt
A  .logs/C01-04.gitcommit.txt
A  .logs/C01-05.claude.impl.last.md
A  .logs/C01-05.claude.impl.raw.txt
A  .logs/C01-05.gitcommit.txt
A  .logs/C01-06.claude.impl.last.md
A  .logs/C01-06.claude.impl.raw.txt
A  .logs/C01-06.gitcommit.txt
A  .logs/C01-07.claude.impl.last.md
A  .logs/C01-07.claude.impl.raw.txt
A  .logs/C01-07.gitcommit.txt
A  .logs/C01-08.claude.impl.last.md
A  .logs/C01-08.claude.impl.raw.txt
A  .logs/C01-08.gitcommit.txt
A  .logs/C01-09.claude.impl.last.md
A  .logs/C01-09.claude.impl.raw.txt
A  .logs/C01-09.gitcommit.txt
A  .logs/C01-10.claude.impl.last.md
A  .logs/C01-10.claude.impl.raw.txt
A  .logs/C01-10.gitcommit.txt
A  .logs/C01-11.claude.impl.last.md
A  .logs/C01-11.claude.impl.raw.txt
A  .logs/C01-11.gitcommit.txt
A  .logs/C01-12.claude.impl.last.md
A  .logs/C01-12.claude.impl.raw.txt
A  .logs/C01-12.gitcommit.txt
A  .logs/C02-01.claude.impl.last.md
A  .logs/C02-01.claude.impl.raw.txt
A  .logs/C02-01.gitcommit.txt
A  .logs/C02-02.claude.impl.last.md
A  .logs/C02-02.claude.impl.raw.txt
A  .logs/C02-02.gitcommit.txt
A  .logs/C02-03.claude.impl.last.md
A  .logs/C02-03.claude.impl.raw.txt
A  .logs/C02-03.gitcommit.txt
A  .logs/C02-04.claude.impl.last.md
A  .logs/C02-04.claude.impl.raw.txt
A  .logs/C02-04.gitcommit.txt
A  .logs/C02-05.claude.impl.last.md
A  .logs/C02-05.claude.impl.raw.txt
A  .logs/C02-05.gitcommit.txt
A  .logs/C02-06.claude.impl.last.md
A  .logs/C02-06.claude.impl.raw.txt
A  .logs/C02-06.gitcommit.txt
A  .logs/C02-07.claude.impl.last.md
A  .logs/C02-07.claude.impl.raw.txt
A  .plans/C01-01.md
A  .plans/C01-02.md
A  .plans/C01-03.md
A  .plans/C01-04.md
A  .plans/C01-05.md
A  .plans/C01-06.md
A  .plans/C01-07.md
A  .plans/C01-08.md
A  .plans/C01-09.md
A  .plans/C01-10.md
A  .plans/C01-11.md
A  .plans/C01-12.md
A  .plans/C02-01.md
A  .plans/C02-02.md
A  .plans/C02-03.md
A  .plans/C02-04.md
A  .plans/C02-05.md
A  .plans/C02-06.md
A  .plans/C02-07.md
A  .t2/handoff/C01-01.md
A  .t2/handoff/C01-02.md
A  .t2/handoff/C01-03.md
A  .t2/handoff/C01-04.md
A  .t2/handoff/C01-05.md
A  .t2/handoff/C01-06.md
A  .t2/handoff/C01-07.md
A  .t2/handoff/C01-08.md
A  .t2/handoff/C01-09.md
A  .t2/handoff/C01-10.md
A  .t2/handoff/C01-11.md
A  .t2/handoff/C01-12.md
A  .t2/handoff/C02-01.md
A  .t2/handoff/C02-02.md
A  .t2/handoff/C02-03.md
A  .t2/handoff/C02-04.md
A  .t2/handoff/C02-05.md
A  .t2/handoff/C02-06.md
A  .t2/handoff/C02-07.md
MM .t2/state.json
M  CHANGELOG.md
M  README.md
D  admin/Admin.php
M  assets/js/admin.js
M  assets/js/utils/api.js
M  assets/js/utils/api.test.js
M  composer.json
A  docs/architecture-improvement-plan.md
A  docs/decisions/ADR-001-code-organization.md
A  docs/decisions/ADR-002-rest-api-evolution.md
A  docs/decisions/ADR-003-frontend-modernization-scope.md
A  docs/developers/case-sensitivity.md
A  docs/developers/container.md
A  docs/developers/edge-adapters.md
M  docs/developers/hooks.md
M  docs/developers/rest-api.md
M  docs/getting-started.md
D  includes/Admin.php
A  includes/Admin/MenuRegistrar.php
AM includes/Admin/PageRenderer.php
A  includes/Admin/index.php
M  includes/Assets.php
M  includes/BatchProcessor.php
A  includes/Contracts/IntegrationFactoryInterface.php
M  includes/Database.php
M  includes/Installer.php
R  includes/Integrations/Acf.php -> includes/Integrations/ACF.php
M  includes/Integrations/AbstractIntegration.php
M  includes/Integrations/Elementor.php
A  includes/Integrations/IntegrationFactory.php
M  includes/Integrations/IntegrationManager.php
M  includes/Integrations/Multilingual.php
M  includes/Integrations/WooCommerce.php
M  includes/Media/Exclusions.php
M  includes/Performance/HeartbeatController.php
M  includes/Providers/AIServiceProvider.php
MM includes/Providers/BootstrapServiceProvider.php
M  includes/Providers/DatabaseServiceProvider.php
M  includes/Providers/IntegrationServiceProvider.php
M  includes/Providers/RESTServiceProvider.php
M  includes/REST/RestController.php
M  includes/RestApi.php
M  includes/Settings.php
M  includes/Settings/SettingsServiceProvider.php
M  jest.setup.js
A  plan_tasks.csv
D  review_tasks.csv
A  scripts/check-case-sensitivity.sh
A  scripts/check-forbidden-patterns.sh
D  tasks.csv
MM templates/admin/settings.php
M  tests/unit/Integration/IntegrationManagerTest.php
M  wp-admin-health-suite.php
?? .logs/C02-07.gitcommit.txt
?? .logs/C02-08.claude.impl.last.md
?? .logs/C02-08.claude.impl.raw.txt
?? .plans/C02-08.md
?? .t2/handoff/C02-08.md
?? includes/Admin/SettingsViewModel.php

diff --stat:
.t2/state.json                                  |  5 ++--
 includes/Admin/PageRenderer.php                 | 38 +++++++++++++++++++++----
 includes/Providers/BootstrapServiceProvider.php | 18 +++++++++++-
 templates/admin/settings.php                    | 16 +++++++----
 4 files changed, 62 insertions(+), 15 deletions(-)

```
